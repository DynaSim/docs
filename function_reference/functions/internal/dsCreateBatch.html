<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of dsCreateBatch</title>
  <meta name="keywords" content="dsCreateBatch">
  <meta name="description" content="CREATEBATCH - create and submit jobs to run sets of simulations or analyses.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>

<a name="_top"></a>
<div><a href="../../menu.html">Home</a> &gt;  <a href="../menu.html">functions</a> &gt; <a href="menu.html">internal</a> &gt; dsCreateBatch.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../menu.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for functions/internal&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>dsCreateBatch
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>CREATEBATCH - create and submit jobs to run sets of simulations or analyses.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [studyinfo, cmd] = dsCreateBatch(base_model,modifications_set,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">CREATEBATCH - create and submit jobs to run sets of simulations or analyses.

 Usage:
   studyinfo=dsCreateBatch(model,varargin)

 Inputs:
   - DynaSim model (see dsGenerateModel)
   - modifications_set (as returned by dsVary2Modifications())
     - options:
       'compile_flag'  : whether to compile simulation using coder instead of
                         interpreting Matlab {0 or 1} (default: 0)
       'verbose_flag'  : whether to display informative messages/logs (default: 0)
       'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)
     - options for cluster computing:
       'sims_per_job'  : number of simulations to run per cluster job (default: 1)
       'memory_limit'  : memory to allocate per cluster job (default: '8G')
       'batch_dir'     : where to save job scripts
       'qsub_mode'     : whether to use SGE -t array for 1 qsub, mode: 'array'; or
                         qsub in csh for loop, mode: 'loop'. (default: 'loop').
     - options for parallel computing: (requires Parallel Computing Toolbox)
       - Note: parallel computing has been DISABLED for debugging...
       'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)
       'num_cores'     : number of cores to specify in the parallel pool

 Outputs:
   - DynaSim studyinfo (see dsCheckStudyinfo for schema info)

 Dependencies: dsSetupStudy, dsUpdateStudy

 See also: <a href="dsGenerateModel.html" class="code" title="function [model,name_map] = dsGenerateModel(specification, varargin)">dsGenerateModel</a>, dsSimulate, <a href="dsCheckStudyinfo.html" class="code" title="function studyinfo = dsCheckStudyinfo(studyinfo, varargin)">dsCheckStudyinfo</a>, <a href="dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a>

 Author: Jason Sherfey, PhD &lt;jssherfey@gmail.com&gt;
 Copyright (C) 2016 Jason Sherfey, Boston University, USA</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="dsCheckStudyinfo.html" class="code" title="function studyinfo = dsCheckStudyinfo(studyinfo, varargin)">dsCheckStudyinfo</a>	CHECKSTUDYINFO - Standardize studyinfo structure and auto-populate missing fields</li><li><a href="dsGetRootPath.html" class="code" title="function ds_root_path = dsGetRootPath()">dsGetRootPath</a>	getRootPath - get path to main ds directory</li><li><a href="dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>	GETSOLVEFILE - helper function that creates or retrieves the desired solver file.</li><li><a href="dsLocateModelFiles.html" class="code" title="function [paths,files] = dsLocateModelFiles(input)">dsLocateModelFiles</a>	LOCATEMODELFILES - locate mechanism files associated with DynaSim specifications.</li><li><a href="dsMonitorStudy.html" class="code" title="function [studyinfo,study_status] = dsMonitorStudy(studyinfo,varargin)">dsMonitorStudy</a>	MONITORSTUDY - display information on study progress.</li><li><a href="dsSetupStudy.html" class="code" title="function [studyinfo,options] = dsSetupStudy(base_model,varargin)">dsSetupStudy</a>	SETUPSTUDY - Initialize DynaSim studyinfo structure, prepare list of output file names, and create output directories</li><li><a href="dsStudyinfoIO.html" class="code" title="function studyinfo = dsStudyinfoIO(studyinfo,study_file,id,verbose_flag)">dsStudyinfoIO</a>	STUDYINFOIO - use lock files to manage concurrent access to a shared studyinfo</li><li><a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestDir.html" class="code" title="function dsUnitSaveAutoGenTestDir(argin, argout, dirIn, dirOut, localFn_flag)">dsUnitSaveAutoGenTestDir</a>	Inputs:</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../functions/dsSimulate.html" class="code" title="function [data,studyinfo,result] = dsSimulate(model,varargin)">dsSimulate</a>	% data=dsSimulate(model,'option',value,...)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function WriteSimJob(sim_ids,job_file)</a></li><li><a href="#_sub2" class="code">function removeStudyinfo()</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [studyinfo, cmd] = dsCreateBatch(base_model,modifications_set,varargin)</a>
0002 <span class="comment">%CREATEBATCH - create and submit jobs to run sets of simulations or analyses.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Usage:</span>
0005 <span class="comment">%   studyinfo=dsCreateBatch(model,varargin)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%   - DynaSim model (see dsGenerateModel)</span>
0009 <span class="comment">%   - modifications_set (as returned by dsVary2Modifications())</span>
0010 <span class="comment">%     - options:</span>
0011 <span class="comment">%       'compile_flag'  : whether to compile simulation using coder instead of</span>
0012 <span class="comment">%                         interpreting Matlab {0 or 1} (default: 0)</span>
0013 <span class="comment">%       'verbose_flag'  : whether to display informative messages/logs (default: 0)</span>
0014 <span class="comment">%       'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)</span>
0015 <span class="comment">%     - options for cluster computing:</span>
0016 <span class="comment">%       'sims_per_job'  : number of simulations to run per cluster job (default: 1)</span>
0017 <span class="comment">%       'memory_limit'  : memory to allocate per cluster job (default: '8G')</span>
0018 <span class="comment">%       'batch_dir'     : where to save job scripts</span>
0019 <span class="comment">%       'qsub_mode'     : whether to use SGE -t array for 1 qsub, mode: 'array'; or</span>
0020 <span class="comment">%                         qsub in csh for loop, mode: 'loop'. (default: 'loop').</span>
0021 <span class="comment">%     - options for parallel computing: (requires Parallel Computing Toolbox)</span>
0022 <span class="comment">%       - Note: parallel computing has been DISABLED for debugging...</span>
0023 <span class="comment">%       'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)</span>
0024 <span class="comment">%       'num_cores'     : number of cores to specify in the parallel pool</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Outputs:</span>
0027 <span class="comment">%   - DynaSim studyinfo (see dsCheckStudyinfo for schema info)</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Dependencies: dsSetupStudy, dsUpdateStudy</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% See also: dsGenerateModel, dsSimulate, dsCheckStudyinfo, dsVary2Modifications</span>
0032 <span class="comment">%</span>
0033 <span class="comment">% Author: Jason Sherfey, PhD &lt;jssherfey@gmail.com&gt;</span>
0034 <span class="comment">% Copyright (C) 2016 Jason Sherfey, Boston University, USA</span>
0035 
0036 <span class="comment">%% check inputs</span>
0037 options=<a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="keyword">...</span>
0038   <span class="string">'compile_flag'</span>,0,{0,1},<span class="keyword">...</span>
0039   <span class="string">'parallel_flag'</span>,0,{0,1},<span class="keyword">...</span>
0040   <span class="string">'num_cores'</span>,4,[],<span class="keyword">...</span><span class="comment"> % # cores for parallel processing (SCC supports 1-12)</span>
0041   <span class="string">'sims_per_job'</span>,1,[],<span class="keyword">...</span><span class="comment"> % how many sims to run per cluster job</span>
0042   <span class="string">'memory_limit'</span>,<span class="string">'8G'</span>,[],<span class="keyword">...</span><span class="comment"> % how much memory to allocate per cluster job</span>
0043   <span class="string">'batch_dir'</span>,[],[],<span class="keyword">...</span>
0044   <span class="string">'simulator_options'</span>,[],[],<span class="keyword">...</span>
0045   <span class="string">'verbose_flag'</span>,0,{0,1},<span class="keyword">...</span>
0046   <span class="string">'overwrite_flag'</span>,0,{0,1},<span class="keyword">...</span>
0047   <span class="string">'process_id'</span>,[],[],<span class="keyword">...</span><span class="comment"> % process identifier for loading studyinfo if necessary</span>
0048   <span class="string">'qsub_mode'</span>,<span class="string">'loop'</span>,{<span class="string">'loop'</span>,<span class="string">'array'</span>},<span class="keyword">...</span><span class="comment"> % whether to submit jobs as an array using qsub -t or in a for loop</span>
0049   <span class="string">'one_solve_file_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % use only 1 solve file of each type, but can't vary mechs yet</span>
0050   <span class="string">'solver'</span>,<span class="string">'rk4'</span>,{<span class="string">'euler'</span>,<span class="string">'rk1'</span>,<span class="string">'rk2'</span>,<span class="string">'rk4'</span>,<span class="string">'modified_euler'</span>,<span class="string">'rungekutta'</span>,<span class="string">'rk'</span>,<span class="string">'ode23'</span>,<span class="string">'ode45'</span>,<span class="keyword">...</span>
0051     <span class="string">'ode1'</span>,<span class="string">'ode2'</span>,<span class="string">'ode3'</span>,<span class="string">'ode4'</span>,<span class="string">'ode5'</span>,<span class="string">'ode8'</span>,<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>},<span class="keyword">...</span><span class="comment"> % DynaSim and built-in Matlab solvers</span>
0052   <span class="string">'auto_gen_test_data_flag'</span>,0,{0,1},<span class="keyword">...</span>
0053   <span class="string">'unit_test_flag'</span>,0,{0,1},<span class="keyword">...</span>
0054   },false);
0055 
0056 <span class="comment">%% auto_gen_test_data_flag argin</span>
0057 <span class="keyword">if</span> options.auto_gen_test_data_flag
0058   varargs = varargin;
0059   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0060   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0061   argin = [{base_model},{modifications_set}, varargs]; <span class="comment">% specific to this function</span>
0062 <span class="keyword">end</span>
0063 
0064 <span class="comment">%% Main function.</span>
0065 <span class="comment">%% Set up studyinfo structure, study directory and output file names</span>
0066 [studyinfo,options.simulator_options]=<a href="dsSetupStudy.html" class="code" title="function [studyinfo,options] = dsSetupStudy(base_model,varargin)">dsSetupStudy</a>(base_model,<span class="string">'modifications_set'</span>,modifications_set,<span class="string">'simulator_options'</span>,options.simulator_options,<span class="string">'process_id'</span>,options.process_id);
0067 study_file=fullfile(studyinfo.study_dir,<span class="string">'studyinfo.mat'</span>);
0068 num_simulations=length(modifications_set);
0069 
0070 <span class="comment">%% check whether study has already completed</span>
0071 <span class="comment">% if options.overwrite_flag==0</span>
0072   [~,s]=<a href="dsMonitorStudy.html" class="code" title="function [studyinfo,study_status] = dsMonitorStudy(studyinfo,varargin)">dsMonitorStudy</a>(studyinfo.study_dir,<span class="string">'verbose_flag'</span>,0,<span class="string">'process_id'</span>,options.process_id);
0073   <span class="keyword">if</span> s==1 <span class="comment">% study finished</span>
0074     <span class="keyword">if</span> options.verbose_flag
0075       fprintf(<span class="string">'Study already finished. Not creating new batch.\n'</span>);
0076     <span class="keyword">end</span>
0077 
0078     studyinfo=<a href="dsCheckStudyinfo.html" class="code" title="function studyinfo = dsCheckStudyinfo(studyinfo, varargin)">dsCheckStudyinfo</a>(studyinfo.study_dir,<span class="string">'process_id'</span>,options.process_id, varargin{:});
0079 
0080     <span class="keyword">return</span>;
0081   <span class="keyword">end</span>
0082 <span class="comment">% end</span>
0083 
0084 <span class="comment">%% Check if attempting to compile Experiment</span>
0085 <span class="keyword">if</span> isa(options.simulator_options.experiment,<span class="string">'function_handle'</span>) &amp;&amp; options.compile_flag
0086   options.compile_flag=0;
0087   options.simulator_options.compile_flag=0;
0088   wprintf(<span class="string">'solver compilation is not available for experiments run on the cluster.'</span>);
0089 <span class="keyword">end</span>
0090 
0091 <span class="comment">%% create base solve_file (m- or MEX-file)</span>
0092 solve_file = <a href="dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>(base_model,studyinfo,options.simulator_options);
0093 
0094 <span class="comment">%% add appropriate MEX extension if compiled</span>
0095 <span class="comment">%   NOTE: the extension depends on whether a 32-bit or 64-bit machine is used</span>
0096 <span class="keyword">if</span> options.compile_flag
0097   <span class="comment">% get directory where solve_file is located and the file name</span>
0098   [fpath,fname]=fileparts2(solve_file);
0099 
0100   <span class="comment">% get list of files in solve directory</span>
0101   D=dir(fpath);
0102 
0103   <span class="comment">% get extension of files with matching names</span>
0104   tmp=regexp({D.name},[fname <span class="string">'\.(\w+)$'</span>],<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0105   tmp=unique([tmp{:}]);
0106 
0107   <span class="comment">% append extension to solve_file if regular mex (not non supported matlab solver mex)</span>
0108   <span class="keyword">if</span> ~any(strcmp(options.solver, {<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>})) <span class="comment">% not mex supported)</span>
0109     full_solve_file=[solve_file <span class="string">'.'</span> tmp{1}];
0110 
0111     <span class="comment">% remove '_mex' suffix from solve_file for compatibility with dsGetSolveFile()</span>
0112     solve_file=regexp(solve_file,<span class="string">'(.+)_mex$'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0113     solve_file=solve_file{1};
0114   <span class="keyword">else</span>
0115     full_solve_file=solve_file;
0116   <span class="keyword">end</span>
0117 <span class="keyword">else</span>
0118   full_solve_file=solve_file;
0119 <span class="keyword">end</span>
0120 studyinfo.base_solve_file=solve_file;
0121 
0122 <span class="comment">%% set name of batch_dir for this study</span>
0123 <span class="comment">% get study-specific timestamp</span>
0124 <span class="comment">% timestamp = datestr(studyinfo.study_id,'yyyymmddHHMMSS');</span>
0125 
0126 <span class="comment">% get home directory of the current user</span>
0127 [~,home]=system(<span class="string">'echo $HOME'</span>);
0128 
0129 <span class="comment">%% create batch directory</span>
0130 study_dir_full_path = fileparts2(studyinfo.study_dir); <span class="comment">% convert to path with closing slash</span>
0131 [~, study_dir_name, study_dir_suffix] = fileparts(study_dir_full_path); <span class="comment">% get final directory</span>
0132 study_dir_name=[study_dir_name study_dir_suffix];
0133 
0134 <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0135   main_batch_dir = fullfile(strtrim(home),<span class="string">'batchdirs'</span>);
0136 
0137   <span class="comment">% create main batch_dir</span>
0138   <span class="keyword">if</span> ~exist(main_batch_dir,<span class="string">'dir'</span>)
0139     mkdir(main_batch_dir);
0140   <span class="keyword">end</span>
0141 
0142   batch_dir = fullfile(main_batch_dir,study_dir_name);
0143   <span class="comment">%batch_dir = fullfile(strtrim(home),'batchdirs',['Batch' timestamp]);</span>
0144 <span class="keyword">else</span>
0145   study_dir = fileparts2(studyinfo.study_dir);
0146   [~, rel_study_dir] = fileparts(study_dir);
0147   batch_dir = fullfile(rel_study_dir,<span class="string">'batchdirs'</span>,study_dir_name);
0148 <span class="keyword">end</span>
0149 
0150 <span class="keyword">if</span> options.verbose_flag
0151   fprintf(<span class="string">'\nPREPARING BATCH:\n'</span>);
0152 <span class="keyword">end</span>
0153 
0154 <span class="comment">%% create batch_dir to hold m-file jobs and more for this study</span>
0155 <span class="keyword">if</span> ~exist(batch_dir,<span class="string">'dir'</span>)
0156   <span class="keyword">if</span> options.verbose_flag
0157     fprintf(<span class="string">'Creating batch jobs directory: %s\n'</span>,batch_dir);
0158   <span class="keyword">end</span>
0159   mkdir(batch_dir);
0160 <span class="keyword">end</span>
0161 
0162 <span class="comment">%% copy study_file to batchdir</span>
0163 [success,msg]=copyfile(study_file,batch_dir);
0164 <span class="keyword">if</span> ~success
0165   error(msg)
0166 <span class="keyword">end</span>
0167 
0168 <span class="comment">%% locate DynaSim toolbox</span>
0169 dynasim_path = <a href="dsGetRootPath.html" class="code" title="function ds_root_path = dsGetRootPath()">dsGetRootPath</a>(); <span class="comment">% root is one level up from directory containing this function</span>
0170 dynasim_functions=fullfile(dynasim_path,<span class="string">'functions'</span>);
0171 
0172 <span class="comment">%% locate mechanism files</span>
0173 [mech_paths,mech_files]=<a href="dsLocateModelFiles.html" class="code" title="function [paths,files] = dsLocateModelFiles(input)">dsLocateModelFiles</a>(base_model);
0174 
0175 <span class="comment">%% add paths to studyinfo structure</span>
0176 studyinfo.paths.dynasim_functions = dynasim_functions;
0177 studyinfo.paths.mechanisms = mech_paths;
0178 studyinfo.paths.batch_dir = batch_dir;
0179 
0180 <span class="comment">%% edit simulator_options so that subsequent single simulations do not create further batches</span>
0181 options.simulator_options.parallel_flag = 0;
0182 options.simulator_options.cluster_flag = 0;
0183 options.simulator_options.verbose_flag = 1; <span class="comment">% turn on verbose for cluster logs (stdout)</span>
0184 
0185 <span class="comment">% collect paths to add to all jobs</span>
0186 <span class="comment">% reason: adding paths to jobs supports m-files stored/associated with mechanism files</span>
0187 <span class="comment">% add dynasim root path (where functions are located)</span>
0188 addpaths=cat(2,dynasim_path,regexp(genpath(dynasim_functions),<span class="string">':'</span>,<span class="string">'split'</span>));
0189 <span class="comment">%addpaths={dynasim_path,dynasim_functions};</span>
0190 <span class="comment">% add the toolbox models directory and all subdirectories</span>
0191   <span class="comment">% note: users can store their models as subdirectories of dynasim/models</span>
0192   <span class="comment">% and incorporate them in their models without worrying about paths.</span>
0193 addpaths=cat(2,addpaths,fullfile(dynasim_path,<span class="string">'models'</span>));
0194 <span class="comment">%addpaths=regexp(genpath(dynasim_path),':','split');</span>
0195 <span class="keyword">if</span> ~isempty(mech_paths)
0196   addpaths=cat(2,addpaths,mech_paths);
0197   addpaths=unique(addpaths);
0198 <span class="keyword">end</span>
0199 
0200 <span class="comment">%% create jobs (k)</span>
0201 jobs={};
0202 skip_sims=[];
0203 sim_cnt=0;
0204 num_jobs=ceil(num_simulations/options.sims_per_job);
0205 
0206 <span class="keyword">if</span> options.verbose_flag &amp;&amp; ~options.one_solve_file_flag
0207   fprintf(<span class="string">'Creating %g cluster jobs in batch directory for %g simulations...\n'</span>,num_jobs,num_simulations);
0208 <span class="keyword">end</span>
0209 
0210 <span class="keyword">if</span> ~options.one_solve_file_flag
0211   <span class="keyword">for</span> k = 1:num_jobs
0212     job_file=fullfile(batch_dir,sprintf(<span class="string">'sim_job%g.m'</span>,k));
0213     sim_ids=sim_cnt+(1:options.sims_per_job);
0214     sim_ids=sim_ids(sim_ids&lt;=num_simulations);
0215     sim_cnt=sim_cnt+options.sims_per_job;
0216 
0217     <span class="comment">% only run simulations if data_file does not exist (unless overwrite_flag=1)</span>
0218     proc_sims=[]; <span class="comment">% simulations to run in this job</span>
0219     <span class="keyword">for</span> j=1:length(sim_ids)
0220       <span class="keyword">if</span> (options.simulator_options.save_data_flag &amp;&amp; ~exist(studyinfo.simulations(sim_ids(j)).data_file,<span class="string">'file'</span>)) || <span class="keyword">...</span>
0221           (options.simulator_options.save_results_flag &amp;&amp; ~exist(studyinfo.simulations(sim_ids(j)).result_files{1},<span class="string">'file'</span>)) || <span class="keyword">...</span>
0222           options.overwrite_flag
0223         proc_sims=[proc_sims sim_ids(j)];
0224       <span class="keyword">end</span>
0225     <span class="keyword">end</span>
0226 
0227     <span class="keyword">if</span> isempty(proc_sims)
0228       skip_sims=[skip_sims sim_ids];
0229       <span class="keyword">continue</span>; <span class="comment">% skip this job</span>
0230     <span class="keyword">else</span>
0231       skip_sims=[skip_sims setdiff(sim_ids,proc_sims)];
0232     <span class="keyword">end</span>
0233 
0234     <a href="#_sub1" class="code" title="subfunction WriteSimJob(sim_ids,job_file)">WriteSimJob</a>(proc_sims,job_file); <span class="comment">% create job script</span>
0235 
0236     jobs{end+1}=job_file;
0237 
0238     <span class="comment">% add job_file to studyinfo</span>
0239     <span class="keyword">for</span> j=1:length(proc_sims)
0240       studyinfo.simulations(proc_sims(j)).job_file=job_file;
0241     <span class="keyword">end</span>
0242 
0243   <span class="keyword">end</span> <span class="comment">%for</span>
0244 <span class="keyword">else</span> <span class="comment">%one_solve_file_flag</span>
0245   job_file=fullfile(batch_dir, <span class="string">'sim_job.m'</span>); <span class="comment">%always use this file</span>
0246 
0247   <a href="#_sub1" class="code" title="subfunction WriteSimJob(sim_ids,job_file)">WriteSimJob</a>([], job_file); <span class="comment">% create job script</span>
0248 
0249   <span class="comment">% TODO: compile job_file</span>
0250 <span class="comment">%   if options.compile_flag</span>
0251 <span class="comment">%     job_file = dsPrepareMEX(job_file, options); %compile the job file</span>
0252 <span class="comment">%   end</span>
0253 
0254   <span class="comment">% add job_file to studyinfo</span>
0255   [studyinfo.simulations.job_file] = deal(job_file); <span class="comment">%same job file for all sims</span>
0256 <span class="keyword">end</span> <span class="comment">%if</span>
0257 
0258 <span class="comment">% TODO: have job scripts create lock for each sim; then, check for lock</span>
0259 <span class="comment">%   file in this function and skip simulations if they're already running</span>
0260 <span class="comment">%   (similar to skipping if data_file already exists).</span>
0261 
0262 <span class="comment">%% exit if there are no simulations to run</span>
0263 <span class="keyword">if</span> numel(skip_sims)==num_simulations
0264   <span class="keyword">if</span> options.verbose_flag
0265     fprintf(<span class="string">'Data exists for all simulations in study. nothing to do.\n'</span>);
0266   <span class="keyword">end</span>
0267 
0268   <span class="keyword">return</span>;
0269 <span class="keyword">end</span>
0270 
0271 <span class="comment">%% create script_filename (list of vars or jobs)</span>
0272 <span class="keyword">if</span> strcmp(options.qsub_mode, <span class="string">'loop'</span>)
0273   script_filename = fullfile(batch_dir,<span class="string">'scriptlist.txt'</span>);
0274   <span class="keyword">if</span> options.verbose_flag
0275     fprintf(<span class="string">'Creating file listing jobs in batch directory: %s\n'</span>,script_filename);
0276   <span class="keyword">end</span>
0277 
0278   <span class="comment">% write to file</span>
0279   fScript=fopen(script_filename,<span class="string">'wt'</span>);
0280 
0281   <span class="keyword">for</span> j=1:length(jobs)
0282     [~,thisFilename]=fileparts2(jobs{j});
0283     fprintf(fScript,<span class="string">'%s\n'</span>,thisFilename);
0284   <span class="keyword">end</span>
0285 
0286   fclose(fScript);
0287 <span class="keyword">end</span>
0288 
0289 <span class="keyword">if</span> ~options.one_solve_file_flag
0290   <span class="comment">% copy solve_file to each sim-specific solve sub-directory: &lt;study_dir&gt;/solve/sim&lt;k&gt;/&lt;solve_file&gt;</span>
0291   <span class="comment">%   and set sim-specific studyinfo</span>
0292   <span class="keyword">if</span> options.verbose_flag
0293     fprintf(<span class="string">'Creating distinct solver sub-directories for %g simulations...\n'</span>,num_simulations);
0294   <span class="keyword">end</span>
0295   <span class="comment">%[solve_path,solve_name,solve_ext]=fileparts2(solve_file);</span>
0296   [solve_path,solve_name,solve_ext]=fileparts2(full_solve_file);
0297 
0298   <span class="comment">% prepare studyinfo with simulation-specific metadata</span>
0299   <span class="keyword">for</span> sim=1:num_simulations
0300     <span class="keyword">if</span> ismember(sim,skip_sims)
0301       <span class="keyword">continue</span>; <span class="comment">% do nothing with this simulation</span>
0302     <span class="keyword">end</span>
0303 
0304     this_solve_path=fullfile(solve_path,[<span class="string">'sim'</span> num2str(sim)]);
0305 
0306     <span class="keyword">if</span> ~exist(this_solve_path,<span class="string">'dir'</span>)
0307       <span class="comment">%if options.verbose_flag</span>
0308       <span class="comment">%  fprintf('creating solver sub-directory for simulation #%g: %s\n',sim,this_solve_path);</span>
0309       <span class="comment">%end</span>
0310       mkdir(this_solve_path);
0311     <span class="keyword">end</span>
0312 
0313     [success,msg]=copyfile(full_solve_file,this_solve_path); <span class="comment">% creates solve sub-directory and copies the base solve file to it</span>
0314 
0315     <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0316 
0317     <span class="comment">% set studyinfo solve_file to use for this simulation</span>
0318     this_solve_file=fullfile(this_solve_path,[solve_name solve_ext]);
0319     studyinfo.simulations(sim).solve_file=this_solve_file;
0320     studyinfo.simulations(sim).batch_dir=batch_dir;
0321     studyinfo.simulations(sim).simulator_options=options.simulator_options;
0322 
0323     <span class="comment">% set solve_file for this simulation (will be passed to dsSimulate as an option)</span>
0324     <span class="keyword">if</span> isa(options.simulator_options.experiment,<span class="string">'function_handle'</span>)
0325       studyinfo.simulations(sim).simulator_options.solve_file=[];
0326     <span class="keyword">else</span>
0327       studyinfo.simulations(sim).simulator_options.solve_file=this_solve_file;
0328     <span class="keyword">end</span>
0329 
0330     <span class="comment">% set vary to [] to avoid each sim expanding to a new set</span>
0331     studyinfo.simulations(sim).simulator_options.vary=[];
0332     studyinfo.simulations(sim).simulator_options.sim_id=studyinfo.simulations(sim).sim_id;
0333     studyinfo.simulations(sim).error_log=<span class="string">''</span>;
0334 
0335   <span class="keyword">end</span> <span class="comment">%sim</span>
0336 
0337   <span class="comment">% copy studyinfo file to batch_dir for each simulation</span>
0338   <span class="keyword">for</span> sim=1:num_simulations
0339     this_study_file=fullfile(batch_dir,sprintf(<span class="string">'studyinfo_%g.mat'</span>,sim));
0340 
0341     <span class="keyword">if</span> sim==1
0342       <span class="keyword">try</span>
0343         save(this_study_file,<span class="string">'studyinfo'</span>,<span class="string">'-v7'</span>);
0344         <span class="keyword">if</span> ~strcmp(reportUI,<span class="string">'matlab'</span>)
0345           [wrn_msg,wrn_id] = lastwarn;
0346           <span class="keyword">if</span> strcmp(wrn_msg,<span class="string">'save: wrong type argument ''function handle'''</span>)
0347             error(<span class="string">'save: wrong type argument ''function handle'''</span>);
0348           <span class="keyword">end</span>
0349         <span class="keyword">end</span>
0350       <span class="keyword">catch</span>
0351         fprintf(<span class="string">'Data is not ''-v7'' compatible. Saving in hdf5 format.\n'</span>)
0352         save(this_study_file,<span class="string">'studyinfo'</span>,<span class="string">'-hdf5'</span>);
0353       <span class="keyword">end</span>
0354       first_study_file=this_study_file;
0355     <span class="keyword">else</span>
0356       <span class="comment">% use copyfile() after saving first b/c &gt;10x faster than save()</span>
0357       [success,msg]=copyfile(first_study_file,this_study_file);
0358 
0359       <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0360     <span class="keyword">end</span>
0361   <span class="keyword">end</span> <span class="comment">%sim</span>
0362 
0363 <span class="keyword">else</span> <span class="comment">%one_solve_file_flag</span>
0364   <span class="comment">% set studyinfo solve_file to use for this simulation</span>
0365   [studyinfo.simulations.solve_file] = deal(full_solve_file);
0366   [studyinfo.simulations.batch_dir] = deal(batch_dir);
0367   [studyinfo.simulations.simulator_options] = deal(options.simulator_options);
0368 
0369   <span class="comment">% set vary to [] to avoid each sim expanding to a new set</span>
0370   <span class="keyword">for</span> iSim = 1:num_simulations
0371     studyinfo.simulations(iSim).simulator_options.vary = [];
0372     studyinfo.simulations(iSim).simulator_options.sim_id = studyinfo.simulations(iSim).sim_id;
0373   <span class="keyword">end</span>
0374   [studyinfo.simulations.error_log] = deal(<span class="string">''</span>);
0375 
0376   <span class="comment">% copy studyinfo file to batch_dir since more information now</span>
0377   batch_study_file = fullfile(batch_dir,<span class="string">'studyinfo.mat'</span>);
0378   <span class="keyword">try</span>
0379     save(batch_study_file,<span class="string">'studyinfo'</span>,<span class="string">'-v7'</span>);
0380     <span class="keyword">if</span> ~strcmp(reportUI,<span class="string">'matlab'</span>)
0381       [wrn_msg,wrn_id] = lastwarn;
0382       <span class="keyword">if</span> strcmp(wrn_msg,<span class="string">'save: wrong type argument ''function handle'''</span>)
0383         error(<span class="string">'save: wrong type argument ''function handle'''</span>);
0384       <span class="keyword">end</span>
0385     <span class="keyword">end</span>
0386   <span class="keyword">catch</span>
0387     fprintf(<span class="string">'Data is not ''-v7'' compatible. Saving in hdf5 format.\n'</span>)
0388     save(batch_study_file,<span class="string">'studyinfo'</span>,<span class="string">'-hdf5'</span>);
0389   <span class="keyword">end</span>
0390 <span class="keyword">end</span>
0391 
0392 <span class="comment">%% update studyinfo on disk</span>
0393 <a href="dsStudyinfoIO.html" class="code" title="function studyinfo = dsStudyinfoIO(studyinfo,study_file,id,verbose_flag)">dsStudyinfoIO</a>(studyinfo,study_file,options.simulator_options.sim_id,options.verbose_flag);
0394 
0395 <span class="comment">% TODO: remove old lock files ..</span>
0396 
0397 <span class="comment">%% check for qsub on system</span>
0398 [status,result]=system(<span class="string">'which qsub'</span>);
0399 
0400 <span class="keyword">if</span> options.auto_gen_test_data_flag || options.unit_test_flag
0401   status = 0;
0402   result = 1;
0403 <span class="keyword">end</span>
0404 
0405 <span class="keyword">if</span> isempty(result)
0406   [~,host] = system(<span class="string">'hostname'</span>);
0407   fprintf(<span class="string">'qsub not found on host (%s).\n'</span>,strtrim(host));
0408   fprintf(<span class="string">'Jobs NOT submitted to cluster queue.\n'</span>);
0409 <span class="keyword">else</span> <span class="comment">% on cluster with qsub</span>
0410   <span class="comment">% submit jobs (e.g., fScripjobs_memlimit batch_dir 32G)</span>
0411   <span class="comment">% check status of study</span>
0412   [~,s]=<a href="dsMonitorStudy.html" class="code" title="function [studyinfo,study_status] = dsMonitorStudy(studyinfo,varargin)">dsMonitorStudy</a>(studyinfo.study_dir,<span class="string">'verbose_flag'</span>,0);
0413 
0414   <span class="keyword">if</span> s~=1 <span class="comment">% study not finished</span>
0415     <span class="comment">% submit jobs using shell script</span>
0416     <span class="keyword">if</span> options.auto_gen_test_data_flag || options.unit_test_flag
0417       batch_dir = rel_study_dir;
0418     <span class="keyword">end</span>
0419 
0420     [batch_dir_path,batch_dir_name,batch_suffix]=fileparts(batch_dir);
0421     batch_dir_name=[batch_dir_name batch_suffix];
0422 
0423     <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0424       dsFnPath = fileparts(mfilename(<span class="string">'fullpath'</span>));
0425     <span class="keyword">else</span>
0426       dsFnPath = <span class="string">'dsFnPath'</span>;
0427     <span class="keyword">end</span>
0428 
0429     <span class="keyword">if</span> options.parallel_flag
0430       warning(<span class="string">'jobs in the cluster use a single thread'</span>)
0431     <span class="keyword">end</span>
0432 
0433     <span class="keyword">if</span> strcmp(options.qsub_mode, <span class="string">'array'</span>) &amp;&amp; ~options.one_solve_file_flag
0434       <span class="comment">% TODO: remove old error and output files; put e and o in their own dirs</span>
0435       cmd = sprintf(<span class="string">'echo ''%s/qsub_jobs_array %s sim_job'' | qsub -V -hard -l ''h_vmem=%s'' -wd %s -N %s_sim_job -t 1-%i'</span>,<span class="keyword">...</span>
0436         dsFnPath, batch_dir, options.memory_limit, batch_dir, batch_dir_name, num_jobs);
0437     <span class="keyword">elseif</span> strcmp(options.qsub_mode, <span class="string">'array'</span>) &amp;&amp; options.one_solve_file_flag
0438       [~, job_filename] = fileparts2(job_file); <span class="comment">%remove path and extension</span>
0439       cmd = sprintf(<span class="string">'echo ''%s/qsub_jobs_array_one_file %s %s'' | qsub -V -hard -l ''h_vmem=%s'' -wd %s -N %s_sim_job -t 1-%i:%i'</span>,<span class="keyword">...</span>
0440         dsFnPath, batch_dir, job_filename, options.memory_limit, batch_dir, batch_dir_name, num_simulations, options.sims_per_job);
0441       <span class="comment">% NOTE: using num_simulations, not num_jobs, since the job_file will</span>
0442       <span class="comment">%   determine it's own sims to run</span>
0443     <span class="keyword">elseif</span> strcmp(options.qsub_mode, <span class="string">'loop'</span>)
0444       <span class="keyword">if</span> strcmp(reportUI,<span class="string">'matlab'</span>)
0445         ui_command = <span class="string">'&quot;matlab -nodisplay -singleCompThread -r&quot;'</span>;
0446         l_directives = [<span class="string">'-l mem_total='</span>,options.memory_limit];
0447       <span class="keyword">else</span>
0448         ui_command = <span class="string">'&quot;octave-cli --eval&quot;'</span>;
0449         l_directives = [<span class="string">'-l centos7=TRUE -l mem_total='</span>,options.memory_limit];
0450       <span class="keyword">end</span>
0451       cmd = sprintf(<span class="string">'%s/qsub_jobs_loop %s ''%s'' ''%s'''</span>,dsFnPath,batch_dir_name,ui_command,l_directives);
0452     <span class="keyword">end</span>
0453 
0454     <span class="comment">% add shell script to linux path if not already there</span>
0455     setenv(<span class="string">'PATH'</span>, [getenv(<span class="string">'PATH'</span>) <span class="string">':'</span> dynasim_functions <span class="string">':'</span> fullfile(dynasim_functions, <span class="string">'internal'</span>)]);
0456 
0457     <span class="keyword">if</span> options.verbose_flag
0458       fprintf(<span class="string">'Submitting cluster jobs with shell command: &quot;%s&quot;\n'</span>,cmd);
0459     <span class="keyword">end</span>
0460 
0461     <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0462       [status,result]=system(cmd);
0463     <span class="keyword">end</span>
0464 
0465     <span class="keyword">if</span> status &gt; 0
0466       <span class="keyword">if</span> options.verbose_flag
0467         fprintf(<span class="string">'Submit command failed: &quot;%s&quot;\n'</span>,cmd);
0468         disp(result);
0469       <span class="keyword">end</span>
0470       <span class="keyword">return</span>;
0471     <span class="keyword">else</span>
0472       <span class="keyword">if</span> options.verbose_flag
0473         fprintf(<span class="string">'Submit command status: \n'</span>);
0474         disp(result);
0475       <span class="keyword">end</span>
0476     <span class="keyword">end</span>
0477 
0478     <span class="keyword">if</span> options.verbose_flag
0479       <span class="comment">%fprintf('%g jobs successfully submitted!\ntip: use dsMonitorStudy(''%s'') or dsMonitorStudy(studyinfo) to track status of cluster jobs.\n',num_jobs,studyinfo.study_dir);</span>
0480       fprintf(<span class="string">'%g jobs successfully submitted!\n'</span>,num_jobs);
0481     <span class="keyword">end</span>
0482   <span class="keyword">elseif</span> s==1 <span class="comment">% study is finished</span>
0483     <span class="keyword">if</span> options.verbose_flag
0484       fprintf(<span class="string">'Study already finished. not submitting jobs.\n'</span>);
0485     <span class="keyword">end</span>
0486   <span class="keyword">end</span>
0487 <span class="keyword">end</span>
0488 
0489 <span class="comment">%% auto_gen_test_data_flag argout</span>
0490 <span class="keyword">if</span> options.auto_gen_test_data_flag
0491   dirIn = studyinfo.study_dir;
0492   <a href="#_sub2" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>()
0493 
0494   <span class="keyword">if</span> ~isempty(studyinfo)
0495     studyinfo = [];
0496   <span class="keyword">end</span>
0497   argout = {studyinfo, cmd}; <span class="comment">% specific to this function</span>
0498 
0499   <a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestDir.html" class="code" title="function dsUnitSaveAutoGenTestDir(argin, argout, dirIn, dirOut, localFn_flag)">dsUnitSaveAutoGenTestDir</a>(argin, argout, [], dirIn);
0500 <span class="keyword">end</span>
0501 
0502 <span class="comment">%% unit test</span>
0503 <span class="keyword">if</span> options.unit_test_flag
0504   <span class="comment">% remove fields that cause issues in unit testing</span>
0505   <a href="#_sub2" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>()
0506   <span class="keyword">if</span> ~isempty(studyinfo)
0507     studyinfo = [];
0508   <span class="keyword">end</span>
0509 <span class="keyword">end</span>
0510 
0511 
0512 
0513 <span class="comment">%% NESTED FUNCTIONS</span>
0514   <a name="_sub1" href="#_subfunctions" class="code">function WriteSimJob(sim_ids,job_file)</a>
0515     <span class="comment">% purpose: write m-file to job_file to run simulations of sim_ids</span>
0516 
0517     <span class="comment">% create job file</span>
0518     fjob=fopen(job_file,<span class="string">'wt'</span>);
0519 
0520     <span class="comment">% load studyinfo using helper function to avoid busy file errors</span>
0521     <span class="comment">%fprintf(fjob,'studyinfo=dsCheckStudyinfo(''%s'',''process_id'',%g);\n',study_file,sim_ids(1), varargin{:});</span>
0522     <span class="comment">%fprintf(fjob,'load(''%s'',''studyinfo'');\n',study_file);</span>
0523 
0524     [~, job_filename] = fileparts(job_file); <span class="comment">%remove path and extension</span>
0525 
0526     <span class="keyword">if</span> ~options.one_solve_file_flag
0527       <span class="comment">% function declaration</span>
0528       fprintf(fjob, <span class="string">'function %s\n\n'</span>, job_filename);
0529 
0530       <span class="comment">% set IDs of simulations to run</span>
0531       fprintf(fjob,<span class="string">'SimIDs=[%s]\n'</span>,num2str(sim_ids));
0532     <span class="keyword">else</span> <span class="comment">%only 1 file</span>
0533       <span class="comment">% function declaration</span>
0534       fprintf(fjob, <span class="string">'function %s(simIDstart, simIDstep, simIDlast)\n\n'</span>, job_filename);
0535 
0536       <span class="keyword">if</span> options.compile_flag
0537         fprintf(fjob, <span class="string">'assert(isa(simIDstart, ''double''));\n'</span>);
0538         fprintf(fjob, <span class="string">'assert(isa(simIDstep, ''double''));\n'</span>);
0539         fprintf(fjob, <span class="string">'assert(isa(simIDlast, ''double''));\n'</span>);
0540       <span class="keyword">end</span>
0541 
0542       <span class="comment">% set IDs of simulations to run</span>
0543       fprintf(fjob,<span class="string">'SimIDs = simIDstart:min(simIDlast,simIDstart+simIDstep-1);\n'</span>);
0544     <span class="keyword">end</span>
0545 
0546     <span class="comment">% add paths</span>
0547     <span class="keyword">for</span> p=1:length(addpaths)
0548       <span class="keyword">if</span> ~isempty(addpaths{p})
0549         fprintf(fjob,<span class="string">'addpath %s\n'</span>,addpaths{p});
0550       <span class="keyword">end</span>
0551     <span class="keyword">end</span>
0552 
0553     <span class="comment">% loop over and run simulations in this job</span>
0554     <span class="keyword">if</span> options.parallel_flag
0555       <span class="comment">% set parallel computing options</span>
0556       <span class="comment">%fprintf(fjob,'started=0;\npool=gcp(''nocreate'');\n');</span>
0557       <span class="comment">%fprintf(fjob,'if isempty(pool), parpool(%g); started=1; end\n',options.num_cores);</span>
0558       fprintf(fjob,<span class="string">'c=parcluster;\nsaveAsProfile(c,''local_%g'');\nparpool(c,%g);\n'</span>,k,options.num_cores);
0559 
0560       <span class="comment">% use parfor loop</span>
0561       fprintf(fjob,<span class="string">'parfor s=1:length(SimIDs)\n'</span>);
0562     <span class="keyword">else</span>
0563       <span class="comment">% use for loop</span>
0564       fprintf(fjob,<span class="string">'for s=1:length(SimIDs)\n'</span>);
0565     <span class="keyword">end</span>
0566 
0567     fprintf(fjob,<span class="string">'\tSimID=SimIDs(s);\n'</span>);
0568 
0569     <span class="comment">% each job should have try-catch to capture studyinfo.simulations(k).error_log</span>
0570     fprintf(fjob,<span class="string">'\ttry\n'</span>);
0571 
0572     <span class="comment">% load studyinfo for this simulation</span>
0573     <span class="keyword">if</span> ~options.one_solve_file_flag
0574       fprintf(fjob,<span class="string">'\t\tload(fullfile(''%s'',sprintf(''studyinfo_%%g.mat'',SimID)),''studyinfo'');\n'</span>,batch_dir);
0575     <span class="keyword">else</span>
0576       fprintf(fjob,<span class="string">'\t\tload(fullfile(''%s'',''studyinfo.mat''),''studyinfo'');\n'</span>,batch_dir);
0577     <span class="keyword">end</span>
0578     <span class="comment">% compare paths between compute machine and studyinfo startup</span>
0579     fprintf(fjob,<span class="string">'\t\t[valid,message]=dsCheckHostPaths(studyinfo);\n'</span>);
0580 
0581     <span class="keyword">if</span> ~options.one_solve_file_flag
0582       fprintf(fjob,<span class="string">'\t\tif ~valid\n\t\t  lasterr(message);\n\t\t  for s=1:length(SimIDs), dsUpdateStudy(studyinfo.study_dir,''sim_id'',SimIDs(s),''status'',''failed''); end\n\t\t  continue;\n\t\tend\n'</span>);
0583     <span class="keyword">end</span>
0584 
0585     <span class="comment">% simulate model with proper modifications and options</span>
0586     fprintf(fjob,<span class="string">'\t\tsiminfo=studyinfo.simulations(SimID);\n'</span>);
0587     fprintf(fjob,<span class="string">'\t\toptions=rmfield(siminfo.simulator_options,{''modifications'',''studyinfo'',''analysis_functions'',''plot_functions'',''sim_id''});\n'</span>);
0588     fprintf(fjob,<span class="string">'\t\tkeyvals=dsOptions2Keyval(options);\n'</span>);
0589     fprintf(fjob,<span class="string">'\t\tfprintf(''-----------------------------------------------------\\n'');\n'</span>);
0590     fprintf(fjob,<span class="string">'\t\tfprintf(''Processing simulation %%g (%%g of %%g in this job)...\\n'',SimID,s,length(SimIDs));\n'</span>);
0591     fprintf(fjob,<span class="string">'\t\tfprintf(''-----------------------------------------------------\\n'');\n'</span>);
0592     fprintf(fjob,<span class="string">'\t\tdata=dsSimulate(studyinfo.base_model,''modifications'',siminfo.modifications,''studyinfo'',studyinfo,''sim_id'',SimID,keyvals{:});\n'</span>);
0593     fprintf(fjob,<span class="string">'\t\tfor i=1:length(siminfo.result_functions)\n'</span>);
0594     fprintf(fjob,<span class="string">'\t\t\tdsAnalyze(data,siminfo.result_functions{i},''result_file'',siminfo.result_files{i},''save_data_flag'',1,siminfo.result_options{i}{:});\n'</span>);
0595     fprintf(fjob,<span class="string">'\t\tend\n'</span>);
0596 
0597     <span class="comment">% add error handling</span>
0598     fprintf(fjob,<span class="string">'\tcatch err\n'</span>);
0599 
0600     <span class="comment">%fprintf(fjob,'\t\ttry delete(fullfile(studyinfo.study_dir,[''.locked_'' num2str(SimID)])); end\n');</span>
0601     fprintf(fjob,<span class="string">'\t\tdisplayError(err);\n'</span>);
0602     fprintf(fjob,<span class="string">'\tend\n'</span>);
0603 
0604     <span class="comment">% end loop over simulations in this job</span>
0605     fprintf(fjob,<span class="string">'end\n'</span>);
0606     <span class="keyword">if</span> options.parallel_flag
0607       <span class="comment">%fprintf(fjob,'if started, delete(gcp); end\n');</span>
0608       fprintf(fjob,<span class="string">'delete(gcp)\n'</span>);
0609     <span class="keyword">end</span>
0610 
0611     <span class="comment">% exit script</span>
0612     [status,result]=system(<span class="string">'which qsub'</span>);
0613     <span class="keyword">if</span> ~isempty(result) <span class="comment">% on cluster</span>
0614       fprintf(fjob,<span class="string">'exit\n'</span>);
0615     <span class="keyword">end</span>
0616 
0617     <span class="comment">% close job file</span>
0618     fclose(fjob);
0619   <span class="keyword">end</span> <span class="comment">% WriteSimJob</span>
0620 
0621   <a name="_sub2" href="#_subfunctions" class="code">function removeStudyinfo()</a>
0622     <span class="comment">% Problem: studyinfo files have many timestamps and absolute paths</span>
0623     <span class="comment">% Solution: remove studyinfo files</span>
0624 
0625     studyDirFiles = rls(studyinfo.study_dir);
0626     studyinfoFiles = studyDirFiles(~cellfun(@isempty, strfind(studyDirFiles, <span class="string">'studyinfo'</span>)));
0627     <span class="keyword">for</span> k = 1:length(studyinfoFiles)
0628       thisFile = studyinfoFiles{k};
0629       delete(thisFile)
0630     <span class="keyword">end</span>
0631   <span class="keyword">end</span>
0632 
0633 <span class="keyword">end</span> <span class="comment">% main fn</span>
0634 
0635 <span class="comment">% -------------------</span>
0636 <span class="comment">% in dsCreateBatch():</span>
0637 <span class="comment">% -------------------</span>
0638 <span class="comment">% create solve_file</span>
0639 <span class="comment">% for each sim k</span>
0640 <span class="comment">%   copy to this_solve_file = /solve/sim&lt;k&gt;/solve_file</span>
0641 <span class="comment">%   set studyinfo.simulations(k).solve_file=this_solve_file</span>
0642 <span class="comment">% ...</span>
0643 <span class="comment">% in sim job.m:</span>
0644 <span class="comment">% dsSimulate(model{k},'solve_file',solve_file{k},...)</span>
0645 <span class="comment">% where solve_file{k}=studyinfo.simulations(k).solve_file</span></pre></div>
<hr><address>Generated on Tue 12-Dec-2017 11:32:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>