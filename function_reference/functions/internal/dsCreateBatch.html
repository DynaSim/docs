<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of dsCreateBatch</title>
  <meta name="keywords" content="dsCreateBatch">
  <meta name="description" content="CREATEBATCH - create and submit jobs to run sets of simulations or analyses.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html functions --><!-- menu.html internal -->
<h1>dsCreateBatch
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>CREATEBATCH - create and submit jobs to run sets of simulations or analyses.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [studyinfo, cmd] = dsCreateBatch(base_model,modifications_set,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">CREATEBATCH - create and submit jobs to run sets of simulations or analyses.

 Usage:
   studyinfo=dsCreateBatch(model,varargin)

 Inputs:
   - DynaSim model (see dsGenerateModel)
   - modifications_set (as returned by dsVary2Modifications())
     - options:
       'compile_flag'  : whether to compile simulation using coder instead of
                         interpreting Matlab {0 or 1} (default: 0)
       'verbose_flag'  : whether to display informative messages/logs (default: 0)
       'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)
     - options for cluster computing:
       'sims_per_job'  : number of simulations to run per cluster job (default: 1)
       'memory_limit'  : memory to allocate per cluster job (default: '8G')
       'batch_dir'     : where to save job scripts
       'qsub_mode'     : whether to use SGE -t array for 1 qsub, mode: 'array'; or
                         qsub in csh for loop, mode: 'loop'. (default: 'loop').
     - options for parallel computing: (requires Parallel Computing Toolbox)
       - Note: parallel computing has been DISABLED for debugging...
       'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)
       'num_cores'     : number of cores to specify in the parallel pool

 Outputs:
   - DynaSim studyinfo (see dsCheckStudyinfo for schema info)

 Dependencies: dsSetupStudy, dsUpdateStudy

 See also: <a href="dsGenerateModel.html" class="code" title="function [model,name_map] = dsGenerateModel(specification, varargin)">dsGenerateModel</a>, dsSimulate, <a href="dsCheckStudyinfo.html" class="code" title="function studyinfo = dsCheckStudyinfo(studyinfo, varargin)">dsCheckStudyinfo</a>, <a href="dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="dsCheckStudyinfo.html" class="code" title="function studyinfo = dsCheckStudyinfo(studyinfo, varargin)">dsCheckStudyinfo</a>	CHECKSTUDYINFO - Standardize studyinfo structure and auto-populate missing fields</li><li><a href="dsGetRootPath.html" class="code" title="function ds_root_path = dsGetRootPath()">dsGetRootPath</a>	getRootPath - get path to main ds directory</li><li><a href="dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>	GETSOLVEFILE - helper function that creates or retrieves the desired solver file.</li><li><a href="dsLocateModelFiles.html" class="code" title="function [paths,files] = dsLocateModelFiles(input)">dsLocateModelFiles</a>	LOCATEMODELFILES - locate mechanism files associated with DynaSim specifications.</li><li><a href="dsMonitorStudy.html" class="code" title="function [studyinfo,study_status] = dsMonitorStudy(studyinfo,varargin)">dsMonitorStudy</a>	MONITORSTUDY - display information on study progress.</li><li><a href="dsSetupStudy.html" class="code" title="function [studyinfo,options] = dsSetupStudy(base_model,varargin)">dsSetupStudy</a>	SETUPSTUDY - Initialize DynaSim studyinfo structure, prepare list of output file names, and create output directories</li><li><a href="dsStudyinfoIO.html" class="code" title="function studyinfo = dsStudyinfoIO(studyinfo,study_file,id,verbose_flag)">dsStudyinfoIO</a>	STUDYINFOIO - use lock files to manage concurrent access to a shared studyinfo</li><li><a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestDir.html" class="code" title="function dsUnitSaveAutoGenTestDir(argin, argout, dirIn, dirOut, localFn_flag)">dsUnitSaveAutoGenTestDir</a>	Inputs:</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../functions/dsSimulate.html" class="code" title="function [data,studyinfo,result] = dsSimulate(model,varargin)">dsSimulate</a>	% data=dsSimulate(model,'option',value,...)</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function WriteSimJob(sim_ids,job_file)</a></li><li><a href="#_sub2" class="code">function removeStudyinfo()</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [studyinfo, cmd] = dsCreateBatch(base_model,modifications_set,varargin)</a>
0002 <span class="comment">%CREATEBATCH - create and submit jobs to run sets of simulations or analyses.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Usage:</span>
0005 <span class="comment">%   studyinfo=dsCreateBatch(model,varargin)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%   - DynaSim model (see dsGenerateModel)</span>
0009 <span class="comment">%   - modifications_set (as returned by dsVary2Modifications())</span>
0010 <span class="comment">%     - options:</span>
0011 <span class="comment">%       'compile_flag'  : whether to compile simulation using coder instead of</span>
0012 <span class="comment">%                         interpreting Matlab {0 or 1} (default: 0)</span>
0013 <span class="comment">%       'verbose_flag'  : whether to display informative messages/logs (default: 0)</span>
0014 <span class="comment">%       'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)</span>
0015 <span class="comment">%     - options for cluster computing:</span>
0016 <span class="comment">%       'sims_per_job'  : number of simulations to run per cluster job (default: 1)</span>
0017 <span class="comment">%       'memory_limit'  : memory to allocate per cluster job (default: '8G')</span>
0018 <span class="comment">%       'batch_dir'     : where to save job scripts</span>
0019 <span class="comment">%       'qsub_mode'     : whether to use SGE -t array for 1 qsub, mode: 'array'; or</span>
0020 <span class="comment">%                         qsub in csh for loop, mode: 'loop'. (default: 'loop').</span>
0021 <span class="comment">%     - options for parallel computing: (requires Parallel Computing Toolbox)</span>
0022 <span class="comment">%       - Note: parallel computing has been DISABLED for debugging...</span>
0023 <span class="comment">%       'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)</span>
0024 <span class="comment">%       'num_cores'     : number of cores to specify in the parallel pool</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Outputs:</span>
0027 <span class="comment">%   - DynaSim studyinfo (see dsCheckStudyinfo for schema info)</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Dependencies: dsSetupStudy, dsUpdateStudy</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% See also: dsGenerateModel, dsSimulate, dsCheckStudyinfo, dsVary2Modifications</span>
0032 
0033 <span class="comment">% check inputs</span>
0034 options=<a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="keyword">...</span>
0035   <span class="string">'compile_flag'</span>,0,{0,1},<span class="keyword">...</span>
0036   <span class="string">'parallel_flag'</span>,0,{0,1},<span class="keyword">...</span>
0037   <span class="string">'num_cores'</span>,4,[],<span class="keyword">...</span><span class="comment"> % # cores for parallel processing (SCC supports 1-12)</span>
0038   <span class="string">'sims_per_job'</span>,1,[],<span class="keyword">...</span><span class="comment"> % how many sims to run per cluster job</span>
0039   <span class="string">'memory_limit'</span>,<span class="string">'8G'</span>,[],<span class="keyword">...</span><span class="comment"> % how much memory to allocate per cluster job</span>
0040   <span class="string">'batch_dir'</span>,[],[],<span class="keyword">...</span>
0041   <span class="string">'simulator_options'</span>,[],[],<span class="keyword">...</span>
0042   <span class="string">'verbose_flag'</span>,0,{0,1},<span class="keyword">...</span>
0043   <span class="string">'overwrite_flag'</span>,0,{0,1},<span class="keyword">...</span>
0044   <span class="string">'process_id'</span>,[],[],<span class="keyword">...</span><span class="comment"> % process identifier for loading studyinfo if necessary</span>
0045   <span class="string">'qsub_mode'</span>,<span class="string">'loop'</span>,{<span class="string">'loop'</span>,<span class="string">'array'</span>},<span class="keyword">...</span><span class="comment"> % whether to submit jobs as an array using qsub -t or in a for loop</span>
0046   <span class="string">'one_solve_file_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % use only 1 solve file of each type, but can't vary mechs yet</span>
0047   <span class="string">'solver'</span>,<span class="string">'rk4'</span>,{<span class="string">'euler'</span>,<span class="string">'rk1'</span>,<span class="string">'rk2'</span>,<span class="string">'rk4'</span>,<span class="string">'modified_euler'</span>,<span class="string">'rungekutta'</span>,<span class="string">'rk'</span>,<span class="string">'ode23'</span>,<span class="string">'ode45'</span>,<span class="keyword">...</span>
0048     <span class="string">'ode1'</span>,<span class="string">'ode2'</span>,<span class="string">'ode3'</span>,<span class="string">'ode4'</span>,<span class="string">'ode5'</span>,<span class="string">'ode8'</span>,<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>},<span class="keyword">...</span><span class="comment"> % DynaSim and built-in Matlab solvers</span>
0049   <span class="string">'auto_gen_test_data_flag'</span>,0,{0,1},<span class="keyword">...</span>
0050   <span class="string">'unit_test_flag'</span>,0,{0,1},<span class="keyword">...</span>
0051   },false);
0052 
0053 <span class="comment">%% auto_gen_test_data_flag argin</span>
0054 <span class="keyword">if</span> options.auto_gen_test_data_flag
0055   varargs = varargin;
0056   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0057   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0058   argin = [{base_model},{modifications_set}, varargs]; <span class="comment">% specific to this function</span>
0059 <span class="keyword">end</span>
0060 
0061 <span class="comment">%% main fn</span>
0062 <span class="comment">% Set up studyinfo structure, study directory and output file names</span>
0063 <span class="comment">%[studyinfo,options.simulator_options]=dsSetupStudy(base_model,modifications_set,options.simulator_options);</span>
0064 [studyinfo,options.simulator_options]=<a href="dsSetupStudy.html" class="code" title="function [studyinfo,options] = dsSetupStudy(base_model,varargin)">dsSetupStudy</a>(base_model,<span class="string">'modifications_set'</span>,modifications_set,<span class="string">'simulator_options'</span>,options.simulator_options,<span class="string">'process_id'</span>,options.process_id);
0065 study_file=fullfile(studyinfo.study_dir,<span class="string">'studyinfo.mat'</span>);
0066 num_simulations=length(modifications_set);
0067 
0068 <span class="comment">% check whether study has already completed</span>
0069 <span class="comment">% if options.overwrite_flag==0</span>
0070   [~,s]=<a href="dsMonitorStudy.html" class="code" title="function [studyinfo,study_status] = dsMonitorStudy(studyinfo,varargin)">dsMonitorStudy</a>(studyinfo.study_dir,<span class="string">'verbose_flag'</span>,0,<span class="string">'process_id'</span>,options.process_id);
0071   <span class="keyword">if</span> s==1 <span class="comment">% study finished</span>
0072     <span class="keyword">if</span> options.verbose_flag
0073       fprintf(<span class="string">'Study already finished. Not creating new batch.\n'</span>);
0074     <span class="keyword">end</span>
0075 
0076     studyinfo=<a href="dsCheckStudyinfo.html" class="code" title="function studyinfo = dsCheckStudyinfo(studyinfo, varargin)">dsCheckStudyinfo</a>(studyinfo.study_dir,<span class="string">'process_id'</span>,options.process_id, varargin{:});
0077 
0078     <span class="keyword">return</span>;
0079   <span class="keyword">end</span>
0080 <span class="comment">% end</span>
0081 
0082 <span class="comment">% Check if attempting to compile Experiment</span>
0083 <span class="keyword">if</span> isa(options.simulator_options.experiment,<span class="string">'function_handle'</span>) &amp;&amp; options.compile_flag
0084   options.compile_flag=0;
0085   options.simulator_options.compile_flag=0;
0086   wprintf(<span class="string">'solver compilation is not available for experiments run on the cluster.'</span>);
0087 <span class="keyword">end</span>
0088 
0089 <span class="comment">% create base solve_file (m- or MEX-file)</span>
0090 solve_file = <a href="dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>(base_model,studyinfo,options.simulator_options);
0091 
0092 <span class="comment">% add appropriate MEX extension if compiled</span>
0093 <span class="comment">%   NOTE: the extension depends on whether a 32-bit or 64-bit machine is used</span>
0094 <span class="keyword">if</span> options.compile_flag
0095   <span class="comment">% get directory where solve_file is located and the file name</span>
0096   [fpath,fname]=fileparts2(solve_file);
0097 
0098   <span class="comment">% get list of files in solve directory</span>
0099   D=dir(fpath);
0100 
0101   <span class="comment">% get extension of files with matching names</span>
0102   tmp=regexp({D.name},[fname <span class="string">'\.(\w+)$'</span>],<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0103   tmp=unique([tmp{:}]);
0104 
0105   <span class="comment">% append extension to solve_file if regular mex (not non supported matlab solver mex)</span>
0106   <span class="keyword">if</span> ~any(strcmp(options.solver, {<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>})) <span class="comment">% not mex supported)</span>
0107     full_solve_file=[solve_file <span class="string">'.'</span> tmp{1}];
0108 
0109     <span class="comment">% remove '_mex' suffix from solve_file for compatibility with dsGetSolveFile()</span>
0110     solve_file=regexp(solve_file,<span class="string">'(.+)_mex$'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0111     solve_file=solve_file{1};
0112   <span class="keyword">else</span>
0113     full_solve_file=solve_file;
0114   <span class="keyword">end</span>
0115 <span class="keyword">else</span>
0116   full_solve_file=solve_file;
0117 <span class="keyword">end</span>
0118 studyinfo.base_solve_file=solve_file;
0119 
0120 <span class="comment">% set name of batch_dir for this study</span>
0121 <span class="comment">% get study-specific timestamp</span>
0122 <span class="comment">% timestamp = datestr(studyinfo.study_id,'yyyymmddHHMMSS');</span>
0123 
0124 <span class="comment">% get home directory of the current user</span>
0125 [o,home]=system(<span class="string">'echo $HOME'</span>);
0126 
0127 <span class="comment">% create batch directory</span>
0128 study_dir_full_path = fileparts2(studyinfo.study_dir); <span class="comment">% convert to path with closing slash</span>
0129 [study_dir_path, study_dir_name, study_dir_suffix] = fileparts(study_dir_full_path); <span class="comment">% get final directory</span>
0130 study_dir_name=[study_dir_name study_dir_suffix];
0131 
0132 <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0133   main_batch_dir = fullfile(strtrim(home),<span class="string">'batchdirs'</span>);
0134   
0135   <span class="comment">% create main batch_dir</span>
0136   <span class="keyword">if</span> ~exist(main_batch_dir,<span class="string">'dir'</span>)
0137     mkdir(main_batch_dir);
0138   <span class="keyword">end</span>
0139 
0140   batch_dir = fullfile(main_batch_dir,study_dir_name);
0141   <span class="comment">%batch_dir = fullfile(strtrim(home),'batchdirs',['Batch' timestamp]);</span>
0142 <span class="keyword">else</span>
0143   study_dir = fileparts2(studyinfo.study_dir);
0144   [~, rel_study_dir] = fileparts(study_dir);
0145   batch_dir = fullfile(rel_study_dir,<span class="string">'batchdirs'</span>,study_dir_name);
0146 <span class="keyword">end</span>
0147 
0148 <span class="keyword">if</span> options.verbose_flag
0149   fprintf(<span class="string">'\nPREPARING BATCH:\n'</span>);
0150 <span class="keyword">end</span>
0151 
0152 <span class="comment">% create batch_dir to hold m-file jobs and more for this study</span>
0153 <span class="keyword">if</span> ~exist(batch_dir,<span class="string">'dir'</span>)
0154   <span class="keyword">if</span> options.verbose_flag
0155     fprintf(<span class="string">'Creating batch jobs directory: %s\n'</span>,batch_dir);
0156   <span class="keyword">end</span>
0157   mkdir(batch_dir);
0158 <span class="keyword">end</span>
0159 
0160 <span class="comment">% copy study_file to batchdir</span>
0161 [success,msg]=copyfile(study_file,batch_dir);
0162 <span class="keyword">if</span> ~success
0163   error(msg)
0164 <span class="keyword">end</span>
0165 
0166 <span class="comment">% locate DynaSim toolbox</span>
0167 dynasim_path = <a href="dsGetRootPath.html" class="code" title="function ds_root_path = dsGetRootPath()">dsGetRootPath</a>(); <span class="comment">% root is one level up from directory containing this function</span>
0168 dynasim_functions=fullfile(dynasim_path,<span class="string">'functions'</span>);
0169 
0170 <span class="comment">% locate mechanism files</span>
0171 [mech_paths,mech_files]=<a href="dsLocateModelFiles.html" class="code" title="function [paths,files] = dsLocateModelFiles(input)">dsLocateModelFiles</a>(base_model);
0172 
0173 <span class="comment">% add paths to studyinfo structure</span>
0174 studyinfo.paths.dynasim_functions = dynasim_functions;
0175 studyinfo.paths.mechanisms = mech_paths;
0176 studyinfo.paths.batch_dir = batch_dir;
0177 
0178 <span class="comment">% edit simulator_options so that subsequent single simulations do not create further batches</span>
0179 options.simulator_options.parallel_flag = 0;
0180 options.simulator_options.cluster_flag = 0;
0181 options.simulator_options.verbose_flag = 1; <span class="comment">% turn on verbose for cluster logs (stdout)</span>
0182 
0183 <span class="comment">% create jobs (k)</span>
0184 jobs={};
0185 skip_sims=[];
0186 sim_cnt=0;
0187 num_jobs=ceil(num_simulations/options.sims_per_job);
0188 
0189 <span class="keyword">if</span> options.verbose_flag &amp;&amp; ~options.one_solve_file_flag
0190   fprintf(<span class="string">'Creating %g cluster jobs in batch directory for %g simulations...\n'</span>,num_jobs,num_simulations);
0191 <span class="keyword">end</span>
0192 
0193 <span class="keyword">if</span> ~options.one_solve_file_flag
0194   <span class="keyword">for</span> k = 1:num_jobs
0195     job_file=fullfile(batch_dir,sprintf(<span class="string">'sim_job%g.m'</span>,k));
0196     sim_ids=sim_cnt+(1:options.sims_per_job);
0197     sim_ids=sim_ids(sim_ids&lt;=num_simulations);
0198     sim_cnt=sim_cnt+options.sims_per_job;
0199 
0200     <span class="comment">% only run simulations if data_file does not exist (unless overwrite_flag=1)</span>
0201     proc_sims=[]; <span class="comment">% simulations to run in this job</span>
0202     <span class="keyword">for</span> j=1:length(sim_ids)
0203       <span class="comment">%if ~exist(studyinfo.simulations(sim_ids(j)).data_file,'file') || options.overwrite_flag</span>
0204       <span class="keyword">if</span> (options.simulator_options.save_data_flag &amp;&amp; ~exist(studyinfo.simulations(sim_ids(j)).data_file,<span class="string">'file'</span>)) || <span class="keyword">...</span>
0205           (options.simulator_options.save_results_flag &amp;&amp; ~exist(studyinfo.simulations(sim_ids(j)).result_files{1},<span class="string">'file'</span>)) || <span class="keyword">...</span>
0206           options.overwrite_flag
0207         proc_sims=[proc_sims sim_ids(j)];
0208       <span class="keyword">end</span>
0209     <span class="keyword">end</span>
0210 
0211     <span class="keyword">if</span> isempty(proc_sims)
0212       skip_sims=[skip_sims sim_ids];
0213       <span class="keyword">continue</span>; <span class="comment">% skip this job</span>
0214     <span class="keyword">else</span>
0215       skip_sims=[skip_sims setdiff(sim_ids,proc_sims)];
0216     <span class="keyword">end</span>
0217 
0218     <a href="#_sub1" class="code" title="subfunction WriteSimJob(sim_ids,job_file)">WriteSimJob</a>(proc_sims,job_file); <span class="comment">% create job script</span>
0219 
0220     jobs{end+1}=job_file;
0221 
0222     <span class="comment">% add job_file to studyinfo</span>
0223     <span class="keyword">for</span> j=1:length(proc_sims)
0224       studyinfo.simulations(proc_sims(j)).job_file=job_file;
0225     <span class="keyword">end</span>
0226 
0227   <span class="keyword">end</span> <span class="comment">%for</span>
0228 <span class="keyword">else</span> <span class="comment">%one_solve_file_flag</span>
0229   job_file=fullfile(batch_dir, <span class="string">'sim_job.m'</span>); <span class="comment">%always use this file</span>
0230 
0231   <a href="#_sub1" class="code" title="subfunction WriteSimJob(sim_ids,job_file)">WriteSimJob</a>([], job_file); <span class="comment">% create job script</span>
0232 
0233   <span class="comment">% TODO: compile job_file</span>
0234 <span class="comment">%   if options.compile_flag</span>
0235 <span class="comment">%     job_file = dsPrepareMEX(job_file, options); %compile the job file</span>
0236 <span class="comment">%   end</span>
0237 
0238   <span class="comment">% add job_file to studyinfo</span>
0239   [studyinfo.simulations.job_file] = deal(job_file); <span class="comment">%same job file for all sims</span>
0240 <span class="keyword">end</span> <span class="comment">%if</span>
0241 
0242 <span class="comment">% TODO: have job scripts create lock for each sim; then, check for lock</span>
0243 <span class="comment">%   file in this function and skip simulations if they're already running</span>
0244 <span class="comment">%   (similar to skipping if data_file already exists).</span>
0245 
0246 <span class="comment">% exit if there are no simulations to run</span>
0247 <span class="keyword">if</span> numel(skip_sims)==num_simulations
0248   <span class="keyword">if</span> options.verbose_flag
0249     fprintf(<span class="string">'Data exists for all simulations in study. nothing to do.\n'</span>);
0250   <span class="keyword">end</span>
0251 
0252   <span class="keyword">return</span>;
0253 <span class="keyword">end</span>
0254 
0255 <span class="comment">% create script_filename (list of vars or jobs)</span>
0256 <span class="keyword">if</span> strcmp(options.qsub_mode, <span class="string">'loop'</span>)
0257   script_filename = fullfile(batch_dir,<span class="string">'scriptlist.txt'</span>);
0258   <span class="keyword">if</span> options.verbose_flag
0259     fprintf(<span class="string">'Creating file listing jobs in batch directory: %s\n'</span>,script_filename);
0260   <span class="keyword">end</span>
0261 <span class="keyword">end</span>
0262 
0263 <span class="comment">% write to file</span>
0264 <span class="keyword">if</span> strcmp(options.qsub_mode, <span class="string">'loop'</span>)
0265   fScript=fopen(script_filename,<span class="string">'wt'</span>);
0266 
0267   <span class="keyword">for</span> j=1:length(jobs)
0268     [~,thisFilename]=fileparts2(jobs{j});
0269     fprintf(fScript,<span class="string">'%s\n'</span>,thisFilename);
0270   <span class="keyword">end</span>
0271 
0272   fclose(fScript);
0273 <span class="keyword">end</span>
0274 
0275 <span class="keyword">if</span> ~options.one_solve_file_flag
0276   <span class="comment">% copy solve_file to each sim-specific solve sub-directory: &lt;study_dir&gt;/solve/sim&lt;k&gt;/&lt;solve_file&gt;</span>
0277   <span class="comment">%   and set sim-specific studyinfo</span>
0278   <span class="keyword">if</span> options.verbose_flag
0279     fprintf(<span class="string">'Creating distinct solver sub-directories for %g simulations...\n'</span>,num_simulations);
0280   <span class="keyword">end</span>
0281   <span class="comment">%[solve_path,solve_name,solve_ext]=fileparts2(solve_file);</span>
0282   [solve_path,solve_name,solve_ext]=fileparts2(full_solve_file);
0283 
0284   <span class="comment">% prepare studyinfo with simulation-specific metadata</span>
0285   <span class="keyword">for</span> sim=1:num_simulations
0286     <span class="keyword">if</span> ismember(sim,skip_sims)
0287       <span class="keyword">continue</span>; <span class="comment">% do nothing with this simulation</span>
0288     <span class="keyword">end</span>
0289 
0290     this_solve_path=fullfile(solve_path,[<span class="string">'sim'</span> num2str(sim)]);
0291 
0292     <span class="keyword">if</span> ~exist(this_solve_path,<span class="string">'dir'</span>)
0293       <span class="comment">%if options.verbose_flag</span>
0294       <span class="comment">%  fprintf('creating solver sub-directory for simulation #%g: %s\n',sim,this_solve_path);</span>
0295       <span class="comment">%end</span>
0296       mkdir(this_solve_path);
0297     <span class="keyword">end</span>
0298 
0299     [success,msg]=copyfile(full_solve_file,this_solve_path); <span class="comment">% creates solve sub-directory and copies the base solve file to it</span>
0300 
0301     <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0302 
0303     <span class="comment">% set studyinfo solve_file to use for this simulation</span>
0304     this_solve_file=fullfile(this_solve_path,[solve_name solve_ext]);
0305     studyinfo.simulations(sim).solve_file=this_solve_file;
0306     studyinfo.simulations(sim).batch_dir=batch_dir;
0307     studyinfo.simulations(sim).simulator_options=options.simulator_options;
0308 
0309     <span class="comment">% set solve_file for this simulation (will be passed to dsSimulate as an option)</span>
0310     <span class="keyword">if</span> isa(options.simulator_options.experiment,<span class="string">'function_handle'</span>)
0311       studyinfo.simulations(sim).simulator_options.solve_file=[];
0312     <span class="keyword">else</span>
0313       studyinfo.simulations(sim).simulator_options.solve_file=this_solve_file;
0314     <span class="keyword">end</span>
0315 
0316     <span class="comment">% set vary to [] to avoid each sim expanding to a new set</span>
0317     studyinfo.simulations(sim).simulator_options.vary=[];
0318     studyinfo.simulations(sim).simulator_options.sim_id=studyinfo.simulations(sim).sim_id;
0319     studyinfo.simulations(sim).error_log=<span class="string">''</span>;
0320 
0321     <span class="comment">% copy studyinfo to batch_dir for each simulation</span>
0322     <span class="comment">%this_study_file=fullfile(batch_dir,sprintf('studyinfo_%g.mat',sim));</span>
0323     <span class="comment">%save(this_study_file,'studyinfo');</span>
0324 
0325     <span class="comment">% copy studyinfo file to batch_dir for each simulation</span>
0326     <span class="keyword">for</span> sim=1:num_simulations
0327       this_study_file=fullfile(batch_dir,sprintf(<span class="string">'studyinfo_%g.mat'</span>,sim));
0328 
0329       <span class="keyword">if</span> sim==1
0330         save(this_study_file,<span class="string">'studyinfo'</span>);
0331         first_study_file=this_study_file;
0332       <span class="keyword">else</span>
0333         <span class="comment">% use copyfile() after saving first b/c &gt;10x faster than save()</span>
0334         [success,msg]=copyfile(first_study_file,this_study_file);
0335 
0336         <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0337       <span class="keyword">end</span>
0338     <span class="keyword">end</span>
0339 
0340   <span class="keyword">end</span> <span class="comment">%sim</span>
0341 <span class="keyword">else</span> <span class="comment">%one_solve_file_flag</span>
0342   <span class="comment">% set studyinfo solve_file to use for this simulation</span>
0343   [studyinfo.simulations.solve_file] = deal(full_solve_file);
0344   [studyinfo.simulations.batch_dir] = deal(batch_dir);
0345   [studyinfo.simulations.simulator_options] = deal(options.simulator_options);
0346 
0347   <span class="comment">% set vary to [] to avoid each sim expanding to a new set</span>
0348   <span class="keyword">for</span> iSim = 1:num_simulations
0349     studyinfo.simulations(iSim).simulator_options.vary = [];
0350     studyinfo.simulations(iSim).simulator_options.sim_id = studyinfo.simulations(iSim).sim_id;
0351   <span class="keyword">end</span>
0352   [studyinfo.simulations.error_log] = deal(<span class="string">''</span>);
0353 
0354   <span class="comment">% copy studyinfo file to batch_dir since more information now</span>
0355   batch_study_file = fullfile(batch_dir,<span class="string">'studyinfo.mat'</span>);
0356   save(batch_study_file,<span class="string">'studyinfo'</span>);
0357 <span class="keyword">end</span>
0358 
0359 <span class="comment">% update studyinfo on disk</span>
0360 <a href="dsStudyinfoIO.html" class="code" title="function studyinfo = dsStudyinfoIO(studyinfo,study_file,id,verbose_flag)">dsStudyinfoIO</a>(studyinfo,study_file,options.simulator_options.sim_id,options.verbose_flag);
0361 
0362 <span class="comment">% TODO: remove old lock files ..</span>
0363 
0364 <span class="comment">% check for qsub on system</span>
0365 [status,result]=system(<span class="string">'which qsub'</span>);
0366 
0367 <span class="keyword">if</span> options.auto_gen_test_data_flag || options.unit_test_flag
0368   status = 0;
0369   result = 1;
0370 <span class="keyword">end</span>
0371 
0372 <span class="keyword">if</span> isempty(result)
0373   [~,host] = system(<span class="string">'hostname'</span>);
0374   fprintf(<span class="string">'qsub not found on host (%s).\n'</span>,strtrim(host));
0375   fprintf(<span class="string">'Jobs NOT submitted to cluster queue.\n'</span>);
0376 <span class="keyword">else</span> <span class="comment">% on cluster with qsub</span>
0377   <span class="comment">% submit jobs (e.g., fScripjobs_memlimit batch_dir 32G)</span>
0378   <span class="comment">% check status of study</span>
0379   [~,s]=<a href="dsMonitorStudy.html" class="code" title="function [studyinfo,study_status] = dsMonitorStudy(studyinfo,varargin)">dsMonitorStudy</a>(studyinfo.study_dir,<span class="string">'verbose_flag'</span>,0);
0380 
0381   <span class="keyword">if</span> s~=1 <span class="comment">% study not finished</span>
0382     <span class="comment">% submit jobs using shell script</span>
0383     <span class="keyword">if</span> options.auto_gen_test_data_flag || options.unit_test_flag
0384       batch_dir = rel_study_dir;
0385     <span class="keyword">end</span>
0386 
0387     [batch_dir_path,batch_dir_name,batch_suffix]=fileparts(batch_dir);
0388     batch_dir_name=[batch_dir_name batch_suffix];
0389 
0390     <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0391       dsFnPath = fileparts(mfilename(<span class="string">'fullpath'</span>));
0392     <span class="keyword">else</span>
0393       dsFnPath = <span class="string">'dsFnPath'</span>;
0394     <span class="keyword">end</span>
0395 
0396     <span class="keyword">if</span> options.parallel_flag
0397       cmd=sprintf(<span class="string">'qmatjobs_pct %s %s %g'</span>,batch_dir_name,options.memory_limit,options.num_cores);
0398       <span class="comment">%status=system('which qmatjobs_pct');</span>
0399     <span class="keyword">else</span>
0400       <span class="keyword">if</span> strcmp(options.qsub_mode, <span class="string">'array'</span>) &amp;&amp; ~options.one_solve_file_flag
0401         <span class="comment">% TODO: remove old error and output files; put e and o in their own dirs</span>
0402         cmd = sprintf(<span class="string">'echo ''%s/qmatjob_array %s sim_job'' | qsub -V -hard -l ''h_vmem=%s'' -wd %s -N %s_sim_job -t 1-%i'</span>,<span class="keyword">...</span>
0403           dsFnPath, batch_dir, options.memory_limit, batch_dir, batch_dir_name, num_jobs);
0404       <span class="keyword">elseif</span> strcmp(options.qsub_mode, <span class="string">'array'</span>) &amp;&amp; options.one_solve_file_flag
0405         [~, job_filename] = fileparts2(job_file); <span class="comment">%remove path and extension</span>
0406         cmd = sprintf(<span class="string">'echo ''%s/qmatjob_array_one_file %s %s'' | qsub -V -hard -l ''h_vmem=%s'' -wd %s -N %s_sim_job -t 1-%i:%i'</span>,<span class="keyword">...</span>
0407           dsFnPath, batch_dir, job_filename, options.memory_limit, batch_dir, batch_dir_name, num_simulations, options.sims_per_job);
0408         <span class="comment">% NOTE: using num_simulations, not num_jobs, since the job_file will</span>
0409         <span class="comment">%   determine it's own sims to run</span>
0410       <span class="keyword">elseif</span> strcmp(options.qsub_mode, <span class="string">'loop'</span>)
0411         cmd = sprintf(<span class="string">'%s/qmatjobs_memlimit_loop %s %s'</span>,dsFnPath, batch_dir_name,options.memory_limit);
0412       <span class="keyword">end</span>
0413       <span class="comment">%status=system('which qmatjobs_memlimit');</span>
0414     <span class="keyword">end</span>
0415 
0416     <span class="comment">% add shell script to linux path if not already there</span>
0417     <span class="comment">%if status~=0</span>
0418       setenv(<span class="string">'PATH'</span>, [getenv(<span class="string">'PATH'</span>) <span class="string">':'</span> dynasim_functions <span class="string">':'</span> fullfile(dynasim_functions, <span class="string">'internal'</span>)]);
0419     <span class="comment">%end</span>
0420 
0421     <span class="keyword">if</span> options.verbose_flag
0422       fprintf(<span class="string">'Submitting cluster jobs with shell command: &quot;%s&quot;\n'</span>,cmd);
0423     <span class="keyword">end</span>
0424 
0425     <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0426       [status,result]=system(cmd);
0427     <span class="keyword">end</span>
0428 
0429     <span class="keyword">if</span> status &gt; 0
0430       <span class="keyword">if</span> options.verbose_flag
0431         fprintf(<span class="string">'Submit command failed: &quot;%s&quot;\n'</span>,cmd);
0432         disp(result);
0433       <span class="keyword">end</span>
0434       <span class="keyword">return</span>;
0435     <span class="keyword">else</span>
0436       <span class="keyword">if</span> options.verbose_flag
0437         fprintf(<span class="string">'Submit command status: \n'</span>);
0438         disp(result);
0439       <span class="keyword">end</span>
0440     <span class="keyword">end</span>
0441 
0442     <span class="keyword">if</span> options.verbose_flag
0443       <span class="comment">%fprintf('%g jobs successfully submitted!\ntip: use dsMonitorStudy(''%s'') or dsMonitorStudy(studyinfo) to track status of cluster jobs.\n',num_jobs,studyinfo.study_dir);</span>
0444       fprintf(<span class="string">'%g jobs successfully submitted!\n'</span>,num_jobs);
0445     <span class="keyword">end</span>
0446   <span class="keyword">elseif</span> s==1 <span class="comment">% study is finished</span>
0447     <span class="keyword">if</span> options.verbose_flag
0448       fprintf(<span class="string">'Study already finished. not submitting jobs.\n'</span>);
0449     <span class="keyword">end</span>
0450   <span class="keyword">end</span>
0451 <span class="keyword">end</span>
0452 
0453 <span class="comment">%% auto_gen_test_data_flag argout</span>
0454 <span class="keyword">if</span> options.auto_gen_test_data_flag
0455   dirIn = studyinfo.study_dir;
0456   <a href="#_sub2" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>()
0457 
0458   <span class="keyword">if</span> ~isempty(studyinfo)
0459     studyinfo = [];
0460   <span class="keyword">end</span>
0461   argout = {studyinfo, cmd}; <span class="comment">% specific to this function</span>
0462 
0463   <a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestDir.html" class="code" title="function dsUnitSaveAutoGenTestDir(argin, argout, dirIn, dirOut, localFn_flag)">dsUnitSaveAutoGenTestDir</a>(argin, argout, [], dirIn);
0464 <span class="keyword">end</span>
0465 
0466 <span class="comment">%% unit test</span>
0467 <span class="keyword">if</span> options.unit_test_flag
0468   <span class="comment">% remove fields that cause issues in unit testing</span>
0469   <a href="#_sub2" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>()
0470   <span class="keyword">if</span> ~isempty(studyinfo)
0471     studyinfo = [];
0472   <span class="keyword">end</span>
0473 <span class="keyword">end</span>
0474 
0475 
0476 
0477 <span class="comment">%% NESTED FUNCTIONS</span>
0478   <a name="_sub1" href="#_subfunctions" class="code">function WriteSimJob(sim_ids,job_file)</a>
0479     <span class="comment">% purpose: write m-file to job_file to run simulations of sim_ids</span>
0480 
0481     <span class="comment">% create job file</span>
0482     fjob=fopen(job_file,<span class="string">'wt'</span>);
0483 
0484     <span class="comment">% load studyinfo using helper function to avoid busy file errors</span>
0485     <span class="comment">%fprintf(fjob,'studyinfo=dsCheckStudyinfo(''%s'',''process_id'',%g);\n',study_file,sim_ids(1), varargin{:});</span>
0486     <span class="comment">%fprintf(fjob,'load(''%s'',''studyinfo'');\n',study_file);</span>
0487 
0488     [~, job_filename] = fileparts(job_file); <span class="comment">%remove path and extension</span>
0489 
0490     <span class="keyword">if</span> ~options.one_solve_file_flag
0491       <span class="comment">% function declaration</span>
0492       fprintf(fjob, <span class="string">'function %s\n\n'</span>, job_filename);
0493 
0494       <span class="comment">% set IDs of simulations to run</span>
0495       fprintf(fjob,<span class="string">'SimIDs=[%s]\n'</span>,num2str(sim_ids));
0496     <span class="keyword">else</span> <span class="comment">%only 1 file</span>
0497       <span class="comment">% function declaration</span>
0498       fprintf(fjob, <span class="string">'function %s(simIDstart, simIDstep, simIDlast)\n\n'</span>, job_filename);
0499 
0500       <span class="keyword">if</span> options.compile_flag
0501         fprintf(fjob, <span class="string">'assert(isa(simIDstart, ''double''));\n'</span>);
0502         fprintf(fjob, <span class="string">'assert(isa(simIDstep, ''double''));\n'</span>);
0503         fprintf(fjob, <span class="string">'assert(isa(simIDlast, ''double''));\n'</span>);
0504       <span class="keyword">end</span>
0505 
0506       <span class="comment">% set IDs of simulations to run</span>
0507       fprintf(fjob,<span class="string">'SimIDs = simIDstart:min(simIDlast,simIDstart+simIDstep-1);\n'</span>);
0508     <span class="keyword">end</span>
0509 
0510     <span class="comment">% loop over and run simulations in this job</span>
0511     <span class="keyword">if</span> options.parallel_flag
0512       <span class="comment">% set parallel computing options</span>
0513       <span class="comment">%fprintf(fjob,'started=0;\npool=gcp(''nocreate'');\n');</span>
0514       <span class="comment">%fprintf(fjob,'if isempty(pool), parpool(%g); started=1; end\n',options.num_cores);</span>
0515       fprintf(fjob,<span class="string">'c=parcluster;\nsaveAsProfile(c,''local_%g'');\nparpool(c,%g);\n'</span>,k,options.num_cores);
0516 
0517       <span class="comment">% use parfor loop</span>
0518       fprintf(fjob,<span class="string">'parfor s=1:length(SimIDs)\n'</span>);
0519     <span class="keyword">else</span>
0520       <span class="comment">% use for loop</span>
0521       fprintf(fjob,<span class="string">'for s=1:length(SimIDs)\n'</span>);
0522     <span class="keyword">end</span>
0523 
0524     fprintf(fjob,<span class="string">'\tSimID=SimIDs(s);\n'</span>);
0525 
0526     <span class="comment">% each job should have try-catch to capture studyinfo.simulations(k).error_log</span>
0527     fprintf(fjob,<span class="string">'\ttry\n'</span>);
0528 
0529     <span class="comment">% load studyinfo for this simulation</span>
0530     <span class="keyword">if</span> ~options.one_solve_file_flag
0531       fprintf(fjob,<span class="string">'\t\tload(fullfile(''%s'',sprintf(''studyinfo_%%g.mat'',SimID)),''studyinfo'');\n'</span>,batch_dir);
0532     <span class="keyword">else</span>
0533       fprintf(fjob,<span class="string">'\t\tload(fullfile(''%s'',''studyinfo.mat''),''studyinfo'');\n'</span>,batch_dir);
0534     <span class="keyword">end</span>
0535     <span class="comment">% compare paths between compute machine and studyinfo startup</span>
0536     fprintf(fjob,<span class="string">'\t\t[valid,message]=dsCheckHostPaths(studyinfo);\n'</span>);
0537 
0538     <span class="keyword">if</span> ~options.one_solve_file_flag
0539       fprintf(fjob,<span class="string">'\t\tif ~valid\n\t\t  lasterr(message);\n\t\t  for s=1:length(SimIDs), dsUpdateStudy(studyinfo.study_dir,''sim_id'',SimIDs(s),''status'',''failed''); end\n\t\t  continue;\n\t\tend\n'</span>);
0540     <span class="keyword">end</span>
0541 
0542     <span class="comment">% simulate model with proper modifications and options</span>
0543     fprintf(fjob,<span class="string">'\t\tsiminfo=studyinfo.simulations(SimID);\n'</span>);
0544     fprintf(fjob,<span class="string">'\t\toptions=rmfield(siminfo.simulator_options,{''modifications'',''studyinfo'',''analysis_functions'',''plot_functions'',''sim_id''});\n'</span>);
0545     fprintf(fjob,<span class="string">'\t\tkeyvals=dsOptions2Keyval(options);\n'</span>);
0546     fprintf(fjob,<span class="string">'\t\tfprintf(''-----------------------------------------------------\\n'');\n'</span>);
0547     fprintf(fjob,<span class="string">'\t\tfprintf(''Processing simulation %%g (%%g of %%g in this job)...\\n'',SimID,s,length(SimIDs));\n'</span>);
0548     fprintf(fjob,<span class="string">'\t\tfprintf(''-----------------------------------------------------\\n'');\n'</span>);
0549     fprintf(fjob,<span class="string">'\t\tdata=dsSimulate(studyinfo.base_model,''modifications'',siminfo.modifications,''studyinfo'',studyinfo,''sim_id'',SimID,keyvals{:});\n'</span>);
0550     fprintf(fjob,<span class="string">'\t\tfor i=1:length(siminfo.result_functions)\n'</span>);
0551     fprintf(fjob,<span class="string">'\t\t\tdsAnalyze(data,siminfo.result_functions{i},''result_file'',siminfo.result_files{i},''save_data_flag'',1,siminfo.result_options{i}{:});\n'</span>);
0552     fprintf(fjob,<span class="string">'\t\tend\n'</span>);
0553 
0554     <span class="comment">% add error handling</span>
0555     fprintf(fjob,<span class="string">'\tcatch err\n'</span>);
0556 
0557     <span class="comment">%fprintf(fjob,'\t\ttry delete(fullfile(studyinfo.study_dir,[''.locked_'' num2str(SimID)])); end\n');</span>
0558     fprintf(fjob,<span class="string">'\t\tdisplayError(err);\n'</span>);
0559     fprintf(fjob,<span class="string">'\tend\n'</span>);
0560 
0561     <span class="comment">% end loop over simulations in this job</span>
0562     fprintf(fjob,<span class="string">'end\n'</span>);
0563     <span class="keyword">if</span> options.parallel_flag
0564       <span class="comment">%fprintf(fjob,'if started, delete(gcp); end\n');</span>
0565       fprintf(fjob,<span class="string">'delete(gcp)\n'</span>);
0566     <span class="keyword">end</span>
0567 
0568     <span class="comment">% exit script</span>
0569     [status,result]=system(<span class="string">'which qsub'</span>);
0570     <span class="keyword">if</span> ~isempty(result) <span class="comment">% on cluster</span>
0571       fprintf(fjob,<span class="string">'exit\n'</span>);
0572     <span class="keyword">end</span>
0573 
0574     <span class="comment">% close job file</span>
0575     fclose(fjob);
0576   <span class="keyword">end</span> <span class="comment">% WriteSimJob</span>
0577 
0578   <a name="_sub2" href="#_subfunctions" class="code">function removeStudyinfo()</a>
0579     <span class="comment">% Problem: studyinfo files have many timestamps and absolute paths</span>
0580     <span class="comment">% Solution: remove studyinfo files</span>
0581 
0582     studyDirFiles = rls(studyinfo.study_dir);
0583     studyinfoFiles = studyDirFiles(~cellfun(@isempty, strfind(studyDirFiles, <span class="string">'studyinfo'</span>)));
0584     <span class="keyword">for</span> k = 1:length(studyinfoFiles)
0585       thisFile = studyinfoFiles{k};
0586       delete(thisFile)
0587     <span class="keyword">end</span>
0588   <span class="keyword">end</span>
0589 
0590 <span class="keyword">end</span> <span class="comment">% main fn</span>
0591 
0592 <span class="comment">% -------------------</span>
0593 <span class="comment">% in dsCreateBatch():</span>
0594 <span class="comment">% -------------------</span>
0595 <span class="comment">% create solve_file</span>
0596 <span class="comment">% for each sim k</span>
0597 <span class="comment">%   copy to this_solve_file = /solve/sim&lt;k&gt;/solve_file</span>
0598 <span class="comment">%   set studyinfo.simulations(k).solve_file=this_solve_file</span>
0599 <span class="comment">% ...</span>
0600 <span class="comment">% in sim job.m:</span>
0601 <span class="comment">% dsSimulate(model{k},'solve_file',solve_file{k},...)</span>
0602 <span class="comment">% where solve_file{k}=studyinfo.simulations(k).solve_file</span></pre></div>
<hr><address>Generated on Fri 23-Jun-2017 18:15:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>