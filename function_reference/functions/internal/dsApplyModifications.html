<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of dsApplyModifications</title>
  <meta name="keywords" content="dsApplyModifications">
  <meta name="description" content="APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>

<a name="_top"></a>
<div><a href="../../menu.html">Home</a> &gt;  <a href="../menu.html">functions</a> &gt; <a href="menu.html">internal</a> &gt; dsApplyModifications.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../menu.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for functions/internal&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>dsApplyModifications
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [output,modifications] = dsApplyModifications(model, modifications, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure

 dsApplyModifications returns the same kind of structure with
 modifications applied. In all cases it first modifies the specification
 (model.specification if input is a model structure). Then it returns
 the modified specification or regenerates the model using the new
 specification.

 Inputs:
   - model: DynaSim model or specification structure
     - see dsCheckModel and dsCheckSpecification for details
   - modifications: modifications to make to specification structure
       {X,Y,Z; X,Y,Z; ...}
       X = population name or connection source-&gt;target
       Y = thing to modify ('name', 'size', or parameter name)
       set Y=Z if Y = name, size, or value
       Note: (X1,X2) or (Y1,Y2): modify these simultaneously in the same way
       Note: Z can be a scalar, row vector, column vector, or matrix. Columns
       of Z are applied across items Y1, Y2, etc (e.g. parameters); rows of
       Z are applied to X1, X2, etc (e.g. population names). See examples
       in dsVary2Modifications.

 Outputs:
   - TODO

 Examples:
   - modifying population size and parameters:
       modifications={'E','size',5; 'E','gNa',120};
       model=dsApplyModifications(model,modifications);

   - modifying mechanism_list:
       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','-iNa'});
       m.populations.mechanism_list
       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','+iCa'});
       m.populations.mechanism_list
       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','+(iCa,iCan,CaBuffer)'});
       m.populations.mechanism_list

   - modifying equations (using special &quot;cat()&quot; operator or direct substitution)
       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','equations','cat(dv/dt,+I)'});
       m.populations.equations
       m=dsApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','cat(I(t),+sin(2*pi*t))'});
       m.populations.equations
       m=dsApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','dv/dt=10+@current'});
       m.populations.equations
       m.populations.mechanism_list

   - modifying equations with reserved keywords &quot;ODEn&quot; and &quot;FUNCTIONn&quot;
     - Note:
       'ODEn' = reserved keyword referencing the n-th ODE in equations
       'ODE' = aliases ODE1
       similarly: 'FUNCTIONn' and 'FUNCTION'

       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','equations','cat(ODE,+I)'});
       m.populations.equations
       m=dsApplyModifications('dv/dt=10+@current; du/dt=-u; {iNa,iK}',...
                            {'pop1','equations','cat(ODE2,+I)'});
       m.populations.equations
       m=dsApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','cat(FUNCTION,+sin(2*pi*t))'});
       m.populations.equations

 See also: <a href="dsGenerateModel.html" class="code" title="function [model,name_map] = dsGenerateModel(specification, varargin)">dsGenerateModel</a>, dsSimulate, <a href="dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a>

 Author: Jason Sherfey, PhD &lt;jssherfey@gmail.com&gt;
 Copyright (C) 2016 Jason Sherfey, Boston University, USA</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="dsCheckSpecification.html" class="code" title="function spec = dsCheckSpecification(specification, varargin)">dsCheckSpecification</a>	CHECKSPECIFICATION - standardize specification structure and auto-populate missing fields</li><li><a href="dsGenerateModel.html" class="code" title="function [model,name_map] = dsGenerateModel(specification, varargin)">dsGenerateModel</a>	GENERATEMODEL - Parse DynaSim specification and organize model data in DynaSim model structure</li><li><a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestData.html" class="code" title="function dsUnitSaveAutoGenTestData(argin, argout, localFn_flag)">dsUnitSaveAutoGenTestData</a>	Inputs:</li><li><a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestDataLocalFn.html" class="code" title="function dsUnitSaveAutoGenTestDataLocalFn(argin, argout)">dsUnitSaveAutoGenTestDataLocalFn</a>	% saveAutoGenTestDataLocalFn(argin, argout)</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../functions/dsSimulate.html" class="code" title="function [data,studyinfo,result] = dsSimulate(model,varargin)">dsSimulate</a>	% data=dsSimulate(model,'option',value,...)</li><li><a href="dsGenerateModel.html" class="code" title="function [model,name_map] = dsGenerateModel(specification, varargin)">dsGenerateModel</a>	GENERATEMODEL - Parse DynaSim specification and organize model data in DynaSim model structure</li><li><a href="dsProbeCellProperties.html" class="code" title="function data = dsProbeCellProperties(model,varargin)">dsProbeCellProperties</a>	data = dsProbeCellProperties(model,'option1',option1,...)</li><li><a href="dsProbeFI.html" class="code" title="function data = dsProbeFI(model,varargin)">dsProbeFI</a>	% data=dsProbeFI(model,varargin)</li><li><a href="dsWriteDynaSimSolver.html" class="code" title="function [outfile,options] = dsWriteDynaSimSolver(model,varargin)">dsWriteDynaSimSolver</a>	WRITEDYNASIMSOLVER - write m-file that numerically inteegrates the model</li><li><a href="dsWriteMatlabSolver.html" class="code" title="function solve_ode_filepath = dsWriteMatlabSolver(model,varargin)">dsWriteMatlabSolver</a>	WRITEMATLABSOLVER - write m-file that numerically integrates the model</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function modifications = standardize_modifications(modifications,specification, varargin)</a></li><li><a href="#_sub2" class="code">function spec = modify_specification(spec,mods, varargin)</a></li><li><a href="#_sub3" class="code">function modifications=backward_compatibility(modifications)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [output,modifications] = dsApplyModifications(model, modifications, varargin)</a>
0002 <span class="comment">%APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% dsApplyModifications returns the same kind of structure with</span>
0005 <span class="comment">% modifications applied. In all cases it first modifies the specification</span>
0006 <span class="comment">% (model.specification if input is a model structure). Then it returns</span>
0007 <span class="comment">% the modified specification or regenerates the model using the new</span>
0008 <span class="comment">% specification.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Inputs:</span>
0011 <span class="comment">%   - model: DynaSim model or specification structure</span>
0012 <span class="comment">%     - see dsCheckModel and dsCheckSpecification for details</span>
0013 <span class="comment">%   - modifications: modifications to make to specification structure</span>
0014 <span class="comment">%       {X,Y,Z; X,Y,Z; ...}</span>
0015 <span class="comment">%       X = population name or connection source-&gt;target</span>
0016 <span class="comment">%       Y = thing to modify ('name', 'size', or parameter name)</span>
0017 <span class="comment">%       set Y=Z if Y = name, size, or value</span>
0018 <span class="comment">%       Note: (X1,X2) or (Y1,Y2): modify these simultaneously in the same way</span>
0019 <span class="comment">%       Note: Z can be a scalar, row vector, column vector, or matrix. Columns</span>
0020 <span class="comment">%       of Z are applied across items Y1, Y2, etc (e.g. parameters); rows of</span>
0021 <span class="comment">%       Z are applied to X1, X2, etc (e.g. population names). See examples</span>
0022 <span class="comment">%       in dsVary2Modifications.</span>
0023 <span class="comment">%</span>
0024 <span class="comment">% Outputs:</span>
0025 <span class="comment">%   - TODO</span>
0026 <span class="comment">%</span>
0027 <span class="comment">% Examples:</span>
0028 <span class="comment">%   - modifying population size and parameters:</span>
0029 <span class="comment">%       modifications={'E','size',5; 'E','gNa',120};</span>
0030 <span class="comment">%       model=dsApplyModifications(model,modifications);</span>
0031 <span class="comment">%</span>
0032 <span class="comment">%   - modifying mechanism_list:</span>
0033 <span class="comment">%       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0034 <span class="comment">%                            {'pop1','mechanism_list','-iNa'});</span>
0035 <span class="comment">%       m.populations.mechanism_list</span>
0036 <span class="comment">%       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0037 <span class="comment">%                            {'pop1','mechanism_list','+iCa'});</span>
0038 <span class="comment">%       m.populations.mechanism_list</span>
0039 <span class="comment">%       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0040 <span class="comment">%                            {'pop1','mechanism_list','+(iCa,iCan,CaBuffer)'});</span>
0041 <span class="comment">%       m.populations.mechanism_list</span>
0042 <span class="comment">%</span>
0043 <span class="comment">%   - modifying equations (using special &quot;cat()&quot; operator or direct substitution)</span>
0044 <span class="comment">%       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0045 <span class="comment">%                            {'pop1','equations','cat(dv/dt,+I)'});</span>
0046 <span class="comment">%       m.populations.equations</span>
0047 <span class="comment">%       m=dsApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0048 <span class="comment">%                            {'pop1','equations','cat(I(t),+sin(2*pi*t))'});</span>
0049 <span class="comment">%       m.populations.equations</span>
0050 <span class="comment">%       m=dsApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0051 <span class="comment">%                            {'pop1','equations','dv/dt=10+@current'});</span>
0052 <span class="comment">%       m.populations.equations</span>
0053 <span class="comment">%       m.populations.mechanism_list</span>
0054 <span class="comment">%</span>
0055 <span class="comment">%   - modifying equations with reserved keywords &quot;ODEn&quot; and &quot;FUNCTIONn&quot;</span>
0056 <span class="comment">%     - Note:</span>
0057 <span class="comment">%       'ODEn' = reserved keyword referencing the n-th ODE in equations</span>
0058 <span class="comment">%       'ODE' = aliases ODE1</span>
0059 <span class="comment">%       similarly: 'FUNCTIONn' and 'FUNCTION'</span>
0060 <span class="comment">%</span>
0061 <span class="comment">%       m=dsApplyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0062 <span class="comment">%                            {'pop1','equations','cat(ODE,+I)'});</span>
0063 <span class="comment">%       m.populations.equations</span>
0064 <span class="comment">%       m=dsApplyModifications('dv/dt=10+@current; du/dt=-u; {iNa,iK}',...</span>
0065 <span class="comment">%                            {'pop1','equations','cat(ODE2,+I)'});</span>
0066 <span class="comment">%       m.populations.equations</span>
0067 <span class="comment">%       m=dsApplyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0068 <span class="comment">%                            {'pop1','equations','cat(FUNCTION,+sin(2*pi*t))'});</span>
0069 <span class="comment">%       m.populations.equations</span>
0070 <span class="comment">%</span>
0071 <span class="comment">% See also: dsGenerateModel, dsSimulate, dsVary2Modifications</span>
0072 <span class="comment">%</span>
0073 <span class="comment">% Author: Jason Sherfey, PhD &lt;jssherfey@gmail.com&gt;</span>
0074 <span class="comment">% Copyright (C) 2016 Jason Sherfey, Boston University, USA</span>
0075 
0076 <span class="comment">%% localfn output</span>
0077 <span class="keyword">if</span> ~nargin
0078   output = localfunctions; <span class="comment">% output var name specific to this fn</span>
0079   <span class="keyword">return</span>
0080 <span class="keyword">end</span>
0081 
0082 <span class="comment">%% auto_gen_test_data_flag argin</span>
0083 options = <a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="string">'auto_gen_test_data_flag'</span>,0,{0,1}},false);
0084 <span class="keyword">if</span> options.auto_gen_test_data_flag
0085   varargs = varargin;
0086   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0087   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0088   argin = [{model},{modifications}, varargs]; <span class="comment">% specific to this function</span>
0089 <span class="keyword">end</span>
0090 
0091 <span class="comment">%%</span>
0092 <span class="comment">% check for modifications</span>
0093 <span class="keyword">if</span> isempty(modifications)
0094   <span class="comment">% nothing to do</span>
0095   output = model;
0096   <span class="keyword">return</span>;
0097 <span class="keyword">end</span>
0098 
0099 <span class="comment">% check input type</span>
0100 <span class="keyword">if</span> ~isfield(model,<span class="string">'state_variables'</span>)
0101   ismodel = 0;
0102 <span class="keyword">else</span>
0103   ismodel = 1;
0104 <span class="keyword">end</span>
0105 
0106 <span class="comment">% check specification</span>
0107 <span class="keyword">if</span> ismodel
0108   specification=<a href="dsCheckSpecification.html" class="code" title="function spec = dsCheckSpecification(specification, varargin)">dsCheckSpecification</a>(model.specification, varargin{:});
0109 <span class="keyword">else</span>
0110   specification=<a href="dsCheckSpecification.html" class="code" title="function spec = dsCheckSpecification(specification, varargin)">dsCheckSpecification</a>(model, varargin{:});
0111 <span class="keyword">end</span>
0112 
0113 <span class="comment">% update specification with whatever is in modifications</span>
0114 modifications = <a href="#_sub1" class="code" title="subfunction modifications = standardize_modifications(modifications,specification, varargin)">standardize_modifications</a>(modifications,specification,varargin{:});
0115 <span class="comment">% if ismodel % TODO: test this</span>
0116   specification = <a href="#_sub2" class="code" title="subfunction spec = modify_specification(spec,mods, varargin)">modify_specification</a>(specification,modifications,varargin{:});
0117 <span class="comment">% end</span>
0118 
0119 <span class="comment">% update model if input was a model structure</span>
0120 <span class="keyword">if</span> ismodel
0121   output=<a href="dsGenerateModel.html" class="code" title="function [model,name_map] = dsGenerateModel(specification, varargin)">dsGenerateModel</a>(specification);
0122 <span class="keyword">else</span>
0123   output = specification;
0124 <span class="keyword">end</span>
0125 
0126 
0127 <span class="comment">%% auto_gen_test_data_flag argout</span>
0128 <span class="keyword">if</span> options.auto_gen_test_data_flag
0129   argout = {output, modifications}; <span class="comment">% specific to this function</span>
0130 
0131   <a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestData.html" class="code" title="function dsUnitSaveAutoGenTestData(argin, argout, localFn_flag)">dsUnitSaveAutoGenTestData</a>(argin, argout);
0132 <span class="keyword">end</span>
0133 
0134 <span class="keyword">end</span>
0135 
0136 <a name="_sub1" href="#_subfunctions" class="code">function modifications = standardize_modifications(modifications,specification, varargin)</a>
0137 <span class="comment">% convert all modifications into 3-column cell matrix format</span>
0138 <span class="comment">% (namespace,variable,value)</span>
0139 
0140 <span class="comment">% 1. modifications structure</span>
0141 <span class="comment">% 2. partial specification structure</span>
0142 
0143 <span class="comment">%% auto_gen_test_data_flag argin</span>
0144 options = <a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="string">'auto_gen_test_data_flag'</span>,0,{0,1}},false);
0145 <span class="keyword">if</span> options.auto_gen_test_data_flag
0146   varargs = varargin;
0147   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0148   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0149   argin = [{modifications},{specification}, varargs]; <span class="comment">% specific to this function</span>
0150 <span class="keyword">end</span>
0151 
0152 <span class="keyword">if</span> isstruct(modifications)
0153   <span class="comment">% TODO</span>
0154   <span class="comment">% convert structure to cell matrix</span>
0155   <span class="comment">% ...</span>
0156 <span class="keyword">end</span>
0157 
0158 <span class="comment">% check backward compatibility</span>
0159 modifications=<a href="#_sub3" class="code" title="subfunction modifications=backward_compatibility(modifications)">backward_compatibility</a>(modifications);
0160 
0161 <span class="comment">% check for empty object specification</span>
0162 missing_objects=find(cellfun(@isempty,modifications(:,1)));
0163 <span class="keyword">if</span> any(missing_objects)
0164   <span class="comment">% set to default population name</span>
0165   <span class="keyword">for</span> i=1:length(missing_objects)
0166     modifications{missing_objects(i),1}=specification.populations(1).name;<span class="comment">%'pop1';</span>
0167   <span class="keyword">end</span>
0168 <span class="keyword">end</span>
0169 
0170 <span class="comment">% support modifying multiple elements (of namespace or variable) simultaneously</span>
0171 <span class="comment">% approach -- add extra entry for each thing to modify</span>
0172 <span class="comment">% eg) expand {'(E,I)','Cm',2} to {'E','Cm',2; 'I','Cm',2}</span>
0173 <span class="comment">% note: should be able to support {'(E,I)','(EK,EK2)',-80}</span>
0174 <span class="keyword">if</span> any(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'^\(.*\)$'</span>))) || <span class="keyword">...</span>
0175    any(~cellfun(@isempty,regexp(modifications(:,2),<span class="string">'^\(.*\)$'</span>)))
0176 
0177   <span class="comment">% loop over modifications</span>
0178   modifications_={};
0179   <span class="keyword">for</span> i=1:size(modifications,1)
0180     <span class="comment">% check namespace for ()</span>
0181     namespaces=regexp(modifications{i,1},<span class="string">'[\w\.\-&lt;&gt;]+'</span>,<span class="string">'match'</span>);
0182 
0183     <span class="comment">% check variable for ()</span>
0184     variables=regexp(modifications{i,2},<span class="string">'[\w\.-]+'</span>,<span class="string">'match'</span>);
0185 
0186     <span class="keyword">if</span> ischar(modifications{i,3})
0187 
0188         <span class="comment">% expand list of modifications</span>
0189         <span class="keyword">for</span> j=1:length(namespaces)
0190             <span class="keyword">for</span> k=1:length(variables)
0191                 modifications_(end+1,1:3)={namespaces{j},variables{k},modifications{i,3}};
0192             <span class="keyword">end</span>
0193         <span class="keyword">end</span>
0194 
0195     <span class="keyword">elseif</span> isnumeric(modifications{i,3})
0196 
0197         <span class="comment">% check size of values matches number of namespaces, variables</span>
0198         <span class="keyword">if</span> isscalar(modifications{i,3}) <span class="comment">% in case number of values is one</span>
0199             modifications{i,3} = repmat(modifications{i,3},length(variables),length(namespaces));
0200         <span class="keyword">else</span>
0201             <span class="keyword">if</span> size(modifications{i,3},1) ~= length(variables) || size(modifications{i,3},2) ~= length(namespaces)
0202                 <span class="comment">% in case values is number of variables x 1</span>
0203                 <span class="keyword">if</span> size(modifications{i,3},1) == length(variables) &amp;&amp; size(modifications{i,3},2) == 1
0204                     modifications{i,3} = repmat(modifications{i,3},1,length(namespaces));
0205                     <span class="comment">% in case values is 1 x number of namespaces</span>
0206                 <span class="keyword">elseif</span> size(modifications{i,3},2) == length(namespaces) &amp;&amp; size(modifications{i,3},1) == 1
0207                     modifications{i,3} = repmat(modifications{i,3},length(variables),1);
0208                     <span class="comment">% TODO: char inputs</span>
0209                     <span class="comment">% elseif ischar(modifications{i,3})</span>
0210                     <span class="comment">% string input</span>
0211                 <span class="keyword">else</span> <span class="comment">% if ~ischar(modifications{i,3})</span>
0212                     error([<span class="string">'Numerical values varied over must be in array format,'</span>,<span class="keyword">...</span>
0213                         <span class="string">'where dimensions 1, 2, and 3 correspond to mechanisms, values, and populations varied over.'</span>])
0214                 <span class="keyword">end</span>
0215             <span class="keyword">end</span>
0216         <span class="keyword">end</span>
0217 
0218         <span class="comment">% expand list of modifications</span>
0219         <span class="keyword">for</span> j=1:length(namespaces)
0220             <span class="keyword">for</span> k=1:length(variables)
0221                 modifications_(end+1,1:3)={namespaces{j},variables{k},modifications{i,3}(k,j)};
0222             <span class="keyword">end</span>
0223         <span class="keyword">end</span>
0224 
0225     <span class="keyword">end</span>
0226 
0227   <span class="keyword">end</span>
0228 
0229   modifications=modifications_;
0230 
0231 <span class="keyword">end</span>
0232 
0233 <span class="comment">%% auto_gen_test_data_flag argout</span>
0234 <span class="keyword">if</span> options.auto_gen_test_data_flag
0235   argout = {modifications}; <span class="comment">% specific to this function</span>
0236 
0237   <a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestDataLocalFn.html" class="code" title="function dsUnitSaveAutoGenTestDataLocalFn(argin, argout)">dsUnitSaveAutoGenTestDataLocalFn</a>(argin, argout); <span class="comment">% localfn</span>
0238 <span class="keyword">end</span>
0239 
0240 <span class="keyword">end</span>
0241 
0242 
0243 <a name="_sub2" href="#_subfunctions" class="code">function spec = modify_specification(spec,mods, varargin)</a>
0244 <span class="comment">%% auto_gen_test_data_flag argin</span>
0245 options = <a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="string">'auto_gen_test_data_flag'</span>,0,{0,1}},false);
0246 <span class="keyword">if</span> options.auto_gen_test_data_flag
0247   varargs = varargin;
0248   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0249   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0250   argin = [{spec},{mods}, varargs]; <span class="comment">% specific to this function</span>
0251 <span class="keyword">end</span>
0252 
0253 precision=8; <span class="comment">% number of digits allowed for user-supplied values</span>
0254 predefined_variables={<span class="string">'name'</span>,<span class="string">'size'</span>,<span class="string">'parameters'</span>,<span class="string">'mechanism_list'</span>,<span class="string">'equations'</span>};
0255 pop_names={spec.populations.name};
0256 <span class="keyword">if</span> ~isempty(spec.connections)
0257   con_names=arrayfun(@(x)[x.source <span class="string">'-&gt;'</span> x.target],spec.connections,<span class="string">'uni'</span>,0);
0258 <span class="keyword">else</span>
0259   con_names=[];
0260 <span class="keyword">end</span>
0261 
0262 <span class="comment">% loop over modifications to apply</span>
0263 <span class="keyword">for</span> i=1:size(mods,1)
0264   obj=mods{i,1}; <span class="comment">% population name or connection source-target</span>
0265   fld=mods{i,2}; <span class="comment">% population name, size, or parameter name</span>
0266 
0267   <span class="keyword">if</span> ~ischar(obj)
0268     error(<span class="string">'modification must be applied to population name or connection source-target'</span>);
0269   <span class="keyword">end</span>
0270 
0271   <span class="keyword">if</span> ~ischar(fld) <span class="comment">%|| ~ismember(fld,{'name','size','parameters','mechanism_list','equations'})</span>
0272     error(<span class="string">'modification must be applied to population ''name'',''size'',or a parameter referenced by its name'</span>);
0273   <span class="keyword">end</span>
0274 
0275   <span class="comment">% standardize connection object: convert target&lt;-source to source-&gt;target</span>
0276   <span class="keyword">if</span> any(strfind(obj,<span class="string">'&lt;-'</span>))
0277     ind=strfind(obj,<span class="string">'&lt;-'</span>);
0278     obj=[obj(ind(1)+2:end) <span class="string">'-&gt;'</span> obj(1:ind(1)-1)];
0279   <span class="keyword">end</span>
0280 
0281   <span class="comment">% check and adjust for mechanism-specific parameter identifier</span>
0282 <span class="comment">%   MECH='';</span>
0283   <span class="keyword">if</span> any(obj==<span class="string">'.'</span>) <span class="comment">% OBJECT.MECH</span>
0284     tmp=regexp(obj,<span class="string">'\.'</span>,<span class="string">'split'</span>);
0285     obj=tmp{1};
0286     MECH=tmp{2};
0287     fld=[MECH <span class="string">'.'</span> fld];
0288   <span class="keyword">end</span>
0289 <span class="comment">%   if any(fld=='.') % MECH.PARAM</span>
0290 <span class="comment">%     tmp=regexp(fld,'\.','split');</span>
0291 <span class="comment">%     MECH=tmp{1};</span>
0292 <span class="comment">%     fld=tmp{2};</span>
0293 <span class="comment">%   end</span>
0294 <span class="comment">%   if ~isempty(MECH)</span>
0295 <span class="comment">%     fld=[MECH '.' fld];</span>
0296 <span class="comment">%   end</span>
0297 
0298   val=mods{i,3}; <span class="comment">% value for population name or size, or parameter to modify</span>
0299   <span class="keyword">if</span> ismember(obj,pop_names)
0300     type=<span class="string">'populations'</span>;
0301     names=pop_names;
0302   <span class="keyword">elseif</span> ismember(obj,con_names)
0303     type=<span class="string">'connections'</span>;
0304     names=con_names;
0305   <span class="keyword">else</span>
0306     warning(<span class="string">'name of object to modify not found in populations or connections.'</span>);
0307     <span class="keyword">continue</span>
0308   <span class="keyword">end</span>
0309 
0310   index=ismember(names,obj);
0311 
0312   <span class="keyword">if</span> strcmp(fld,<span class="string">'mechanism_list'</span>)
0313     <span class="comment">% support --</span>
0314     <span class="comment">% 'E'    'mechanism_list'    '(iNa,iK)'</span>
0315     <span class="comment">% 'E'    'mechanism_list'    '-(iNa,iK)'</span>
0316     <span class="comment">% 'E'    'mechanism_list'    '+(iK)'</span>
0317     <span class="comment">% 'E'    'mechanism_list'    '+iK'</span>
0318     <span class="comment">% 'E'    'mechanism_list'    'iK'</span>
0319 
0320     elems=regexp(val,<span class="string">'[\w@]+'</span>,<span class="string">'match'</span>);
0321 
0322     <span class="keyword">if</span> strcmp(val(1),<span class="string">'+'</span>)
0323       <span class="comment">% add mechanisms to existing list</span>
0324       spec.(type)(index).mechanism_list=unique_wrapper(cat(2,spec.(type)(index).mechanism_list,elems),<span class="string">'stable'</span>);
0325     <span class="keyword">elseif</span> strcmp(val(1),<span class="string">'-'</span>)
0326       <span class="comment">% remove mechanisms from existing list</span>
0327       spec.(type)(index).mechanism_list=setdiff(spec.(type)(index).mechanism_list,elems,<span class="string">'stable'</span>);
0328     <span class="keyword">else</span>
0329       <span class="comment">% redefine mechanism list</span>
0330       spec.(type)(index).mechanism_list=elems;
0331     <span class="keyword">end</span>
0332   <span class="keyword">elseif</span> strcmp(fld,<span class="string">'equations'</span>) &amp;&amp; ~isempty(regexp(val,<span class="string">'^cat('</span>,<span class="string">'once'</span>))
0333     <span class="comment">% process special case: cat(TARGET,EXPRESSION)</span>
0334     eqns=spec.(type)(index).equations;
0335     args=regexp(val,<span class="string">'cat\((.+)\)'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0336     ind=find(args{1}==<span class="string">','</span>,1,<span class="string">'first'</span>);
0337     target=args{1}(1:ind-1);
0338     expression=args{1}(ind+1:end);
0339 <span class="comment">%     args=regexp(args{1},',','split');</span>
0340 <span class="comment">%     target=args{1};</span>
0341 <span class="comment">%     expression=args{2};</span>
0342     <span class="comment">% support keywords: ODEn, ODE=ODE1, FUNCTIONn, FUNCTION=FUNCTION1</span>
0343     <span class="keyword">if</span> strncmp(<span class="string">'ODE'</span>,target,3)
0344       <span class="comment">% support target = ODEn and ODE=ODE1</span>
0345       <span class="comment">% replace target by n-th ODE LHS</span>
0346       lines=cellfun(@strtrim,strsplit(eqns,<span class="string">';'</span>),<span class="string">'uni'</span>,0); <span class="comment">% split equations into statements</span>
0347       lines=lines(~cellfun(@isempty,lines)); <span class="comment">% eliminate empty elements</span>
0348       pattern=<span class="string">'^((\w+'')|(d\w+/dt))\s*='</span>; <span class="comment">% pattern for ODEs</span>
0349       inds=regexp(lines,pattern,<span class="string">'once'</span>); <span class="comment">% indices to ODE statements</span>
0350       inds=find(~cellfun(@isempty,inds));
0351       <span class="comment">% get index to the ODE statement to modify</span>
0352       <span class="keyword">if</span> strcmp(target,<span class="string">'ODE'</span>)
0353         ind=inds(1);
0354       <span class="keyword">else</span>
0355         n=str2num(target(4:end));
0356         ind=inds(n);
0357       <span class="keyword">end</span>
0358       <span class="comment">% get LHS of ODE</span>
0359       <span class="comment">%LHS=regexp(lines{ind},'^(.+)=','tokens','once');</span>
0360       LHS=regexp(lines{ind},<span class="string">'^([^=]+)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0361       target=LHS{1};
0362     <span class="keyword">elseif</span> strncmp(<span class="string">'FUNCTION'</span>,target,8)
0363       <span class="comment">% support target = FUNCTIONn and FUNCTION=FUNCTION1</span>
0364       <span class="comment">% replace target by n-th FUNCTION LHS</span>
0365       lines=cellfun(@strtrim,strsplit(eqns,<span class="string">';'</span>),<span class="string">'uni'</span>,0); <span class="comment">% split equations into statements</span>
0366       lines=lines(~cellfun(@isempty,lines)); <span class="comment">% eliminate empty elements</span>
0367       pattern=<span class="string">'^\w+\([a-zA-Z][\w,]*\)\s*='</span>; <span class="comment">% pattern for functions</span>
0368       inds=regexp(lines,pattern,<span class="string">'once'</span>); <span class="comment">% indices to function statements</span>
0369       inds=find(~cellfun(@isempty,inds));
0370 
0371       <span class="comment">% get index to the function statement to modify</span>
0372       <span class="keyword">if</span> strcmp(target,<span class="string">'FUNCTION'</span>)
0373         ind=inds(1);
0374       <span class="keyword">else</span>
0375         n=str2num(target(9:end));
0376         ind=inds(n);
0377       <span class="keyword">end</span>
0378       <span class="comment">% get LHS of ODE</span>
0379       <span class="comment">%LHS=regexp(lines{ind},'^(.+)=','tokens','once');</span>
0380       LHS=regexp(lines{ind},<span class="string">'^([^=]+)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0381       target=LHS{1};
0382     <span class="keyword">end</span>
0383     <span class="comment">% add escape character for using regular expression to match function statements</span>
0384     target=strrep(target,<span class="string">'('</span>,<span class="string">'\('</span>);
0385     target=strrep(target,<span class="string">')'</span>,<span class="string">'\)'</span>);
0386 
0387     <span class="comment">% modify equations</span>
0388     old=regexp(eqns,[target <span class="string">'\s*=[^;]+'</span>],<span class="string">'match'</span>);
0389     <span class="keyword">if</span> ~isempty(old)
0390       eqns=strrep(eqns,old{1},[old{1} expression]);
0391       spec.(type)(index).equations=eqns;
0392     <span class="keyword">end</span>
0393   <span class="keyword">elseif</span> ismember(fld,predefined_variables) <span class="comment">% not a single parameter to modify</span>
0394     spec.(type)(index).(fld)=val;
0395     <span class="keyword">if</span> strcmp(type,<span class="string">'populations'</span>) &amp;&amp; strcmp(fld,<span class="string">'name'</span>)
0396       <span class="comment">% update name in connections</span>
0397       <span class="keyword">for</span> j=1:length(spec.connections)
0398         <span class="keyword">if</span> strcmp(pop_names{index},spec.connections(j).source)
0399           spec.connections(j).source=val;
0400         <span class="keyword">end</span>
0401 
0402         <span class="keyword">if</span> strcmp(pop_names{index},spec.connections(j).target)
0403           spec.connections(j).target=val;
0404         <span class="keyword">end</span>
0405       <span class="keyword">end</span>
0406     <span class="keyword">end</span>
0407   <span class="keyword">else</span> <span class="comment">% modify a single parameter in the populations.parameters cell array</span>
0408     param_names=spec.(type)(index).parameters(1:2:end);
0409     <span class="keyword">if</span> isempty(spec.(type)(index).parameters)
0410       <span class="comment">% no parameters set; start cell array of parameters</span>
0411       spec.(type)(index).parameters={fld,val};<span class="comment">%toString(val2,precision)};</span>
0412     <span class="keyword">elseif</span> ismember(fld,param_names)
0413       <span class="comment">% parameter found in list; update its value</span>
0414       val_pos=2*find(ismember(param_names,fld));
0415       spec.(type)(index).parameters{val_pos}=val;<span class="comment">%toString(val2,precision);</span>
0416     <span class="keyword">else</span>
0417       <span class="comment">% parameter not in existing list; append to end</span>
0418       spec.(type)(index).parameters{end+1}=fld;
0419       spec.(type)(index).parameters{end+1}=val;<span class="comment">%toString(val2,precision);</span>
0420     <span class="keyword">end</span>
0421   <span class="keyword">end</span>
0422 <span class="keyword">end</span>
0423 
0424 <span class="comment">% todo: split X.MECH, set (type,index) from X, store {MECH.fld,val} in .parameters</span>
0425 
0426 <span class="comment">%% auto_gen_test_data_flag argout</span>
0427 <span class="keyword">if</span> options.auto_gen_test_data_flag
0428   argout = {spec}; <span class="comment">% specific to this function</span>
0429 
0430   <a href="../../functions/internal/unit-test/dsUnitSaveAutoGenTestDataLocalFn.html" class="code" title="function dsUnitSaveAutoGenTestDataLocalFn(argin, argout)">dsUnitSaveAutoGenTestDataLocalFn</a>(argin, argout); <span class="comment">% localfn</span>
0431 <span class="keyword">end</span>
0432 
0433 <span class="keyword">end</span>
0434 
0435 
0436 <a name="_sub3" href="#_subfunctions" class="code">function modifications=backward_compatibility(modifications)</a>
0437 <span class="comment">% convert 2-column specification to 3-column specification with empty object name</span>
0438 <span class="keyword">if</span> size(modifications,2)==2
0439   tmp={};
0440   <span class="keyword">for</span> i=1:size(modifications,1)
0441     tmp{i,1}=<span class="string">''</span>;
0442     tmp{i,2}=modifications{i,1};
0443     tmp{i,3}=modifications{i,2};
0444   <span class="keyword">end</span>
0445   modifications=tmp;
0446 <span class="keyword">end</span>
0447 
0448 <span class="comment">% convert 4-column specification to 3-column</span>
0449 <span class="keyword">if</span> size(modifications,2)==4
0450   <span class="keyword">for</span> i=1:size(modifications,1)
0451     <span class="keyword">if</span> strcmp(modifications{i,2},<span class="string">'parameters'</span>)
0452       <span class="comment">% shift parameter name to 2nd column</span>
0453       modifications{i,2}=modifications{i,3};
0454 
0455       <span class="comment">% shift parameter value to 3rd column</span>
0456       modifications{i,3}=modifications{i,4};
0457     <span class="keyword">end</span>
0458   <span class="keyword">end</span>
0459 
0460   <span class="comment">% remove fourth column</span>
0461   modifications=modifications(:,1:3);
0462 <span class="keyword">end</span>
0463 
0464 <span class="comment">% convert connection reference source-target to source-&gt;target</span>
0465 <span class="keyword">if</span> any(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'\w-\w'</span>)))
0466   <span class="comment">% find elements to adjust</span>
0467   inds=find(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'\w-\w'</span>)));
0468   <span class="keyword">for</span> i=1:length(inds)
0469     modifications{inds(i),1}=strrep(modifications{inds(i),1},<span class="string">'-'</span>,<span class="string">'-&gt;'</span>);
0470   <span class="keyword">end</span>
0471 <span class="keyword">end</span>
0472 
0473 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 12-Dec-2017 11:32:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>