<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of dsWriteDynaSimSolver</title>
  <meta name="keywords" content="dsWriteDynaSimSolver">
  <meta name="description" content="WRITEDYNASIMSOLVER - write m-file that numerically inteegrates the model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html functions --><!-- menu.html internal -->
<h1>dsWriteDynaSimSolver
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>WRITEDYNASIMSOLVER - write m-file that numerically inteegrates the model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [outfile,options] = dsWriteDynaSimSolver(model,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">WRITEDYNASIMSOLVER - write m-file that numerically inteegrates the model

 Usage:
   solver_file=dsWriteDynaSimSolver(model,varargin)

 Inputs:
   - model: DynaSim model structure (see dsGenerateModel)
   - options:
     'solver'     : solver for numerical integration (see dsGetSolveFile)
                    {'euler'/'rk1', 'rk2'/'modified_euler', 'rungekutta'/'rk'/'rk4'} (default: 'rk4')
     'tspan'      : time limits of simulation [begin,end] (default: [0 100]) [ms]
                    - Note: units must be consistent with dt and model equations
     'dt'         : time step used for DynaSim solvers (default: .01) [ms]
     'downsample_factor': downsampling applied during simulation (default: 1, no downsampling) 
                          - Note: only every downsample_factor-time point is
                                  stored in memory and/or written to disk
     'ic'         : numeric array of initial conditions, one value per state
                    variable. This overrides definition in model structure (default:
                    all zeros)
     'random_seed': seed for random number generator (default: 'shuffle', set
                    randomly) (usage: rng(options.random_seed))
     'disk_flag'  : whether to write to disk during simulation instead of
                    storing in memory {0 or 1} (default: 0)

 Outputs:
   - solver_file (e.g., solve_ode.m): function that numerically integrates the model

 Examples:
   - Example 1: test solver production, display function in standard output
       model=dsGenerateModel; % test model
       without writing anything to disk:
       dsWriteDynaSimSolver(model,'fileID',1,'save_parameters_flag',0,'solver','rk4');
       dsWriteDynaSimSolver(model,'fileID',1,'save_parameters_flag',1,'solver','rk4');
       model=dsPropagateFunctions(model);
       dsWriteDynaSimSolver(model,'fileID',1,'save_parameters_flag',0,'solver','rk4');
       dsWriteDynaSimSolver(model,'fileID',1,'save_parameters_flag',1,'solver','rk4');

   - Example 2: real-time downsampling
       dsWriteDynaSimSolver(model,'downsample_factor',10,'fileID',1,'solver','rk4');

   - Example 3: real-time writing data to disk (reduce memory demand)
       dsWriteDynaSimSolver(model,'disk_flag',1,'fileID',1,'solver','rk4');

   - Example 4: maximally conserve memory: downsample and write to disk
       dsWriteDynaSimSolver(model,'disk_flag',1,'downsample_factor',10,'fileID',1,'solver','rk4');

 More Examples:
     dsWriteDynaSimSolver(model,'solver','euler');
     dsWriteDynaSimSolver(model,'solver','rk2');
     dsWriteDynaSimSolver(model,'solver','rk4');

     model=dsGenerateModel; % test model
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',0,'reduce_function_calls_flag',0,'solver','rk4','filename','solve_ode.m'); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',0,'solver','rk4','filename','solve_ode.m'); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',0,'reduce_function_calls_flag',1,'solver','rk4','filename','solve_ode.m'); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk4','filename','solve_ode.m'); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk2','filename','solve_ode.m'); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk1','filename','solve_ode.m'); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk1','filename','solve_ode.m','downsample_factor',10); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk2','filename','solve_ode.m','dt',.001,'downsample_factor',10); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk1','filename','solve_ode.m','dt',.001,'downsample_factor',10); v=solve_ode; plot(v); toc
     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk1','filename','solve_ode.m','dt',.005,'tspan',[0 200],'downsample_factor',10); v=solve_ode; plot(v); toc

 Dependencies: dsCheckOptions, dsCheckModel

 See also: <a href="dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>, dsSimulate, <a href="dsWriteMatlabSolver.html" class="code" title="function solve_ode_filepath = dsWriteMatlabSolver(model,varargin)">dsWriteMatlabSolver</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>	APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</li><li><a href="dsCheckModel.html" class="code" title="function model = dsCheckModel(model, varargin)">dsCheckModel</a>	CHECKMODEL - Standardize model structure and auto-populate missing fields</li><li><a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="dsCheckSolverOptions.html" class="code" title="function options = dsCheckSolverOptions(options)">dsCheckSolverOptions</a>	CHECKSOLVEROPTIONS - standardize simulation options appended to params.mat</li><li><a href="dsGetOutputCounts.html" class="code" title="function [state_var_counts,monitor_counts] = dsGetOutputCounts(model)">dsGetOutputCounts</a>	GETOUTPUTCOUNTS - determine how many copies of each state variable and monitor will be produced by simulating the model.</li><li><a href="dsPropagateFunctions.html" class="code" title="function model = dsPropagateFunctions(model, varargin)">dsPropagateFunctions</a>	PROPAGATEFUNCTIONS - eliminate internal function calls from model ODEs, ICs, monitors, and conditionals.</li><li><a href="dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>	PROPAGATEPARAMETERS - substitute parameter values or prepend parameter names with prefix across all model equations.</li><li><a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>	STRREP - replace full words by new character strings, ignoring matches that appear as sub-strings.</li><li><a href="dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a>	VARY2MODIFICATIONS - convert specification of things to vary into a set of modifications indicating how to vary the desired things.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>	GETSOLVEFILE - helper function that creates or retrieves the desired solver file.</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function update_vars(index_nexts_, varargin)</a></li><li><a href="#_sub2" class="code">function print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)</a></li><li><a href="#_sub3" class="code">function odes_out=update_odes(odes,suffix_k,increment,state_variables,index_lasts, varargin)</a></li><li><a href="#_sub4" class="code">function print_var_update(fid,index_nexts,index_lasts,update_term,state_variables)</a></li><li><a href="#_sub5" class="code">function print_var_update_last(fid,index_nexts,state_variables)</a></li><li><a href="#_sub6" class="code">function print_conditional_update(fid,conditionals,index_nexts,state_variables, varargin)</a></li><li><a href="#_sub7" class="code">function print_monitor_update(fid,monitors,index_nexts,state_variables,index_lasts, varargin)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [outfile,options] = dsWriteDynaSimSolver(model,varargin)</a>
0002 <span class="comment">%WRITEDYNASIMSOLVER - write m-file that numerically inteegrates the model</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Usage:</span>
0005 <span class="comment">%   solver_file=dsWriteDynaSimSolver(model,varargin)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%   - model: DynaSim model structure (see dsGenerateModel)</span>
0009 <span class="comment">%   - options:</span>
0010 <span class="comment">%     'solver'     : solver for numerical integration (see dsGetSolveFile)</span>
0011 <span class="comment">%                    {'euler'/'rk1', 'rk2'/'modified_euler', 'rungekutta'/'rk'/'rk4'} (default: 'rk4')</span>
0012 <span class="comment">%     'tspan'      : time limits of simulation [begin,end] (default: [0 100]) [ms]</span>
0013 <span class="comment">%                    - Note: units must be consistent with dt and model equations</span>
0014 <span class="comment">%     'dt'         : time step used for DynaSim solvers (default: .01) [ms]</span>
0015 <span class="comment">%     'downsample_factor': downsampling applied during simulation (default: 1, no downsampling)</span>
0016 <span class="comment">%                          - Note: only every downsample_factor-time point is</span>
0017 <span class="comment">%                                  stored in memory and/or written to disk</span>
0018 <span class="comment">%     'ic'         : numeric array of initial conditions, one value per state</span>
0019 <span class="comment">%                    variable. This overrides definition in model structure (default:</span>
0020 <span class="comment">%                    all zeros)</span>
0021 <span class="comment">%     'random_seed': seed for random number generator (default: 'shuffle', set</span>
0022 <span class="comment">%                    randomly) (usage: rng(options.random_seed))</span>
0023 <span class="comment">%     'disk_flag'  : whether to write to disk during simulation instead of</span>
0024 <span class="comment">%                    storing in memory {0 or 1} (default: 0)</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Outputs:</span>
0027 <span class="comment">%   - solver_file (e.g., solve_ode.m): function that numerically integrates the model</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Examples:</span>
0030 <span class="comment">%   - Example 1: test solver production, display function in standard output</span>
0031 <span class="comment">%       model=dsGenerateModel; % test model</span>
0032 <span class="comment">%       without writing anything to disk:</span>
0033 <span class="comment">%       dsWriteDynaSimSolver(model,'fileID',1,'save_parameters_flag',0,'solver','rk4');</span>
0034 <span class="comment">%       dsWriteDynaSimSolver(model,'fileID',1,'save_parameters_flag',1,'solver','rk4');</span>
0035 <span class="comment">%       model=dsPropagateFunctions(model);</span>
0036 <span class="comment">%       dsWriteDynaSimSolver(model,'fileID',1,'save_parameters_flag',0,'solver','rk4');</span>
0037 <span class="comment">%       dsWriteDynaSimSolver(model,'fileID',1,'save_parameters_flag',1,'solver','rk4');</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%   - Example 2: real-time downsampling</span>
0040 <span class="comment">%       dsWriteDynaSimSolver(model,'downsample_factor',10,'fileID',1,'solver','rk4');</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%   - Example 3: real-time writing data to disk (reduce memory demand)</span>
0043 <span class="comment">%       dsWriteDynaSimSolver(model,'disk_flag',1,'fileID',1,'solver','rk4');</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%   - Example 4: maximally conserve memory: downsample and write to disk</span>
0046 <span class="comment">%       dsWriteDynaSimSolver(model,'disk_flag',1,'downsample_factor',10,'fileID',1,'solver','rk4');</span>
0047 <span class="comment">%</span>
0048 <span class="comment">% More Examples:</span>
0049 <span class="comment">%     dsWriteDynaSimSolver(model,'solver','euler');</span>
0050 <span class="comment">%     dsWriteDynaSimSolver(model,'solver','rk2');</span>
0051 <span class="comment">%     dsWriteDynaSimSolver(model,'solver','rk4');</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%     model=dsGenerateModel; % test model</span>
0054 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',0,'reduce_function_calls_flag',0,'solver','rk4','filename','solve_ode.m'); v=solve_ode; plot(v); toc</span>
0055 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',0,'solver','rk4','filename','solve_ode.m'); v=solve_ode; plot(v); toc</span>
0056 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',0,'reduce_function_calls_flag',1,'solver','rk4','filename','solve_ode.m'); v=solve_ode; plot(v); toc</span>
0057 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk4','filename','solve_ode.m'); v=solve_ode; plot(v); toc</span>
0058 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk2','filename','solve_ode.m'); v=solve_ode; plot(v); toc</span>
0059 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk1','filename','solve_ode.m'); v=solve_ode; plot(v); toc</span>
0060 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk1','filename','solve_ode.m','downsample_factor',10); v=solve_ode; plot(v); toc</span>
0061 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk2','filename','solve_ode.m','dt',.001,'downsample_factor',10); v=solve_ode; plot(v); toc</span>
0062 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk1','filename','solve_ode.m','dt',.001,'downsample_factor',10); v=solve_ode; plot(v); toc</span>
0063 <span class="comment">%     tic; dsWriteDynaSimSolver(model,'save_parameters_flag',1,'reduce_function_calls_flag',1,'solver','rk1','filename','solve_ode.m','dt',.005,'tspan',[0 200],'downsample_factor',10); v=solve_ode; plot(v); toc</span>
0064 <span class="comment">%</span>
0065 <span class="comment">% Dependencies: dsCheckOptions, dsCheckModel</span>
0066 <span class="comment">%</span>
0067 <span class="comment">% See also: dsGetSolveFile, dsSimulate, dsWriteMatlabSolver</span>
0068 
0069 <span class="comment">% Check inputs</span>
0070 options=<a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="keyword">...</span>
0071   <span class="string">'tspan'</span>,[0 100],[],<span class="keyword">...</span><span class="comment">          % [beg,end] (units must be consistent with dt and equations)</span>
0072   <span class="string">'downsample_factor'</span>,1,[],<span class="keyword">...</span><span class="comment">    % downsampling applied during simulation (only every downsample_factor-time point is stored in memory or written to disk)</span>
0073   <span class="string">'dt'</span>,.01,[],<span class="keyword">...</span><span class="comment">                 % time step used for fixed step DynaSim solvers</span>
0074   <span class="string">'random_seed'</span>,<span class="string">'shuffle'</span>,[],<span class="keyword">...</span><span class="comment">        % seed for random number generator (usage: rng(random_seed))</span>
0075   <span class="string">'solver'</span>,<span class="string">'rk4'</span>,{<span class="string">'euler'</span>,<span class="string">'rk1'</span>,<span class="string">'rk2'</span>,<span class="string">'rk4'</span>,<span class="string">'modified_euler'</span>,<span class="string">'rungekutta'</span>,<span class="string">'rk'</span>},<span class="keyword">...</span><span class="comment"> % DynaSim solvers</span>
0076   <span class="string">'disk_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment">            % whether to write to disk during simulation instead of storing in memory</span>
0077   <span class="string">'reduce_function_calls_flag'</span>,1,{0,1},<span class="keyword">...</span><span class="comment">   % whether to eliminate internal (anonymous) function calls</span>
0078   <span class="string">'save_parameters_flag'</span>,1,{0,1},<span class="keyword">...</span>
0079   <span class="string">'filename'</span>,[],[],<span class="keyword">...</span><span class="comment">         % name of solver file that integrates model</span>
0080   <span class="string">'data_file'</span>,<span class="string">'data.csv'</span>,[],<span class="keyword">...</span><span class="comment"> % name of data file if disk_flag=1</span>
0081   <span class="string">'fileID'</span>,1,[],<span class="keyword">...</span>
0082   <span class="string">'compile_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % whether to prepare script for being compiled using coder instead of interpreting Matlab</span>
0083   <span class="string">'verbose_flag'</span>,1,{0,1},<span class="keyword">...</span>
0084   <span class="string">'one_solve_file_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % use only 1 solve file of each type, but can't vary mechs yet</span>
0085   <span class="string">'benchmark_flag'</span>,0,{0,1},<span class="keyword">...</span>
0086   },false);
0087 model=<a href="dsCheckModel.html" class="code" title="function model = dsCheckModel(model, varargin)">dsCheckModel</a>(model, varargin{:});
0088 separator=<span class="string">','</span>; <span class="comment">% ',', '\\t'</span>
0089 
0090 <span class="comment">%% 1.0 prepare model info</span>
0091 parameter_prefix=<span class="string">'p.'</span>;<span class="comment">%'pset.p.';</span>
0092 state_variables=model.state_variables;
0093 
0094 <span class="comment">% 1.1 eliminate internal (anonymous) function calls from model equations</span>
0095 <span class="keyword">if</span> options.reduce_function_calls_flag==1
0096   model=<a href="dsPropagateFunctions.html" class="code" title="function model = dsPropagateFunctions(model, varargin)">dsPropagateFunctions</a>(model, varargin{:});
0097 <span class="keyword">end</span>
0098 
0099 <span class="comment">% 1.1 prepare parameters</span>
0100 <span class="keyword">if</span> options.save_parameters_flag
0101   <span class="comment">% add parameter struct prefix to parameters in model equations</span>
0102   model=<a href="dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>(model,<span class="string">'action'</span>,<span class="string">'prepend'</span>, <span class="string">'prop_prefix'</span>,parameter_prefix, varargin{:});
0103   
0104   <span class="comment">% set and capture numeric seed value</span>
0105   <span class="keyword">if</span> options.compile_flag==1
0106     <span class="comment">% todo: make seed string (eg, 'shuffle') from param struct work with coder (options.compile_flag=1)</span>
0107     <span class="comment">% (currently raises error: &quot;String input must be constant&quot;)</span>
0108     <span class="comment">% workaround: (shuffle here and get numeric seed for MEX-compatible params.mat)</span>
0109     rng(options.random_seed);
0110     options.random_seed=getfield(rng,<span class="string">'Seed'</span>);  <span class="comment">% &lt;-- current active seed</span>
0111   <span class="keyword">end</span>
0112   
0113   <span class="comment">% set parameter file name (save with m-file)</span>
0114   [fpath,fname,fext]=fileparts2(options.filename);
0115   param_file_path = fullfile(fpath,<span class="string">'params.mat'</span>);
0116   
0117   <span class="comment">% save parameters to disk</span>
0118   warning(<span class="string">'off'</span>,<span class="string">'catstruct:DuplicatesFound'</span>);
0119   p = catstruct(<a href="dsCheckSolverOptions.html" class="code" title="function options = dsCheckSolverOptions(options)">dsCheckSolverOptions</a>(options),model.parameters);
0120   
0121   <span class="keyword">if</span> options.one_solve_file_flag
0122     <span class="comment">% fill p flds that were varied with vectors of length = nSims</span>
0123     
0124     vary=<a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="string">'vary'</span>,[],[],},false);
0125     vary = vary.vary;
0126 
0127     mod_set = <a href="dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a>(vary);
0128     <span class="comment">% The first 2 cols of modifications_set are idenitical to vary, it just</span>
0129     <span class="comment">% has the last column distributed out to the number of sims</span>
0130     
0131     
0132     <span class="comment">% Get param names</span>
0133     iMod = 1;
0134     <span class="comment">% Split extra entries in first 2 cols of mods, so each row is a single pop and param</span>
0135     [~, first_mod_set] = <a href="dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>([],mod_set{iMod}, varargin{:});
0136 
0137     <span class="comment">% replace '-&gt;' with '_'</span>
0138     first_mod_set(:,1) = strrep(first_mod_set(:,1), <span class="string">'-&gt;'</span>, <span class="string">'_'</span>);
0139 
0140     <span class="comment">% add col of underscores</span>
0141     first_mod_set = cat(2,first_mod_set(:,1), repmat({<span class="string">'_'</span>},size(first_mod_set,1), 1), first_mod_set(:,2:end));
0142     nParamMods = size(first_mod_set, 1);
0143     
0144     <span class="comment">% get param names</span>
0145     mod_params = cell(nParamMods,1);
0146     <span class="keyword">for</span> iRow = 1:nParamMods
0147       mod_params{iRow} = [first_mod_set{iRow,1:3}];
0148 
0149       <span class="comment">%check if variable in namespace</span>
0150       <span class="keyword">if</span> ~any(strcmp(model.namespaces(:,2), mod_params{iRow}))
0151         <span class="comment">% find correct entry based on param and pop</span>
0152         nsInd = logical(~cellfun(@isempty, strfind(model.namespaces(:,2), [first_mod_set{iRow,1} <span class="string">'_'</span>])) .* <span class="keyword">...</span>
0153           ~cellfun(@isempty, strfind(model.namespaces(:,2), first_mod_set{iRow,3})));
0154         
0155         assert(sum(nsInd) == 1)
0156         
0157         <span class="comment">% add mech names using namespace</span>
0158         mod_params{iRow} = model.namespaces{nsInd,2};
0159       <span class="keyword">end</span>
0160     <span class="keyword">end</span>
0161 
0162     <span class="comment">% Get param values for each sim</span>
0163     param_values = nan(nParamMods, length(mod_set));
0164     <span class="keyword">for</span> iMod = 1:length(mod_set)
0165       <span class="comment">% Split extra entries in first 2 cols of mods, so each row is a single pop and param</span>
0166       [~, mod_set{iMod}] = <a href="dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>([],mod_set{iMod}, varargin{:});
0167       
0168       <span class="comment">% Get scalar values as vector</span>
0169       param_values(:, iMod) = [mod_set{iMod}{:,3}];
0170     <span class="keyword">end</span>
0171     
0172     <span class="comment">% Assign value vectors to params</span>
0173     <span class="keyword">for</span> iParam = 1:nParamMods
0174       p.(mod_params{iParam}) = param_values(iParam,:);
0175     <span class="keyword">end</span>
0176   <span class="keyword">end</span> <span class="comment">% one_solve_file_flag</span>
0177   
0178   <span class="keyword">if</span> options.verbose_flag
0179     fprintf(<span class="string">'Saving params.mat\n'</span>);
0180   <span class="keyword">end</span>
0181   save(param_file_path,<span class="string">'p'</span>);
0182 <span class="keyword">else</span>
0183   <span class="comment">% insert parameter values into model expressions</span>
0184   model=<a href="dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>(model,<span class="string">'action'</span>,<span class="string">'substitute'</span>, varargin{:});
0185 <span class="keyword">end</span>
0186 
0187 <span class="comment">% 1.2 prepare list of outputs (state variables and monitors)</span>
0188 tmp=cellfun(@(x)[x <span class="string">','</span>],model.state_variables,<span class="string">'uni'</span>,0);
0189 tmp=[tmp{:}];
0190 output_string=tmp(1:end-1);
0191 
0192 <span class="keyword">if</span> ~isempty(model.monitors)
0193   tmp=cellfun(@(x)[x <span class="string">','</span>],fieldnames(model.monitors),<span class="string">'uni'</span>,0);
0194   tmp=[tmp{:}];
0195   output_string=[output_string <span class="string">','</span> tmp(1:end-1)];
0196 <span class="keyword">end</span>
0197 
0198 <span class="keyword">if</span> ~isempty(model.fixed_variables)
0199   tmp=cellfun(@(x)[x <span class="string">','</span>],fieldnames(model.fixed_variables),<span class="string">'uni'</span>,0);
0200   tmp=[tmp{:}];
0201   output_string=[output_string <span class="string">','</span> tmp(1:end-1)];
0202 <span class="keyword">end</span>
0203 
0204 output_string=[<span class="string">'[T,'</span> output_string <span class="string">']'</span>]; <span class="comment">% state vars, monitors, time vector</span>
0205 
0206 <span class="comment">% HACK to get IC to work</span>
0207 <span class="keyword">if</span> options.downsample_factor == 1
0208   <span class="keyword">for</span> fieldNameC = fieldnames(model.ICs)'
0209     model.ICs.(fieldNameC{1}) = regexprep(model.ICs.(fieldNameC{1}), <span class="string">'_last'</span>, <span class="string">'(1,:)'</span>);
0210   <span class="keyword">end</span>
0211 <span class="keyword">end</span>
0212 
0213 <span class="comment">%% 2.0 write m-file solver</span>
0214 <span class="comment">% 2.1 create mfile</span>
0215 <span class="keyword">if</span> ~isempty(options.filename)
0216   <span class="keyword">if</span> options.verbose_flag
0217     fprintf(<span class="string">'Creating solver file: %s\n'</span>,options.filename);
0218   <span class="keyword">end</span>
0219   
0220   fid=fopen(options.filename,<span class="string">'wt'</span>);
0221 <span class="keyword">else</span>
0222   fid=options.fileID;
0223 <span class="keyword">end</span>
0224 
0225 outfile=fopen(fid);
0226 
0227 <span class="keyword">if</span> options.disk_flag==1
0228   <span class="keyword">if</span> ~options.one_solve_file_flag
0229     fprintf(fid,<span class="string">'function data_file=solve_ode\n'</span>);
0230   <span class="keyword">else</span>
0231     fprintf(fid,<span class="string">'function data_file=solve_ode(simID)\n'</span>);
0232     <span class="keyword">if</span> options.compile_flag
0233       fprintf(fid, <span class="string">'assert(isa(simID, ''double''));\n'</span>);
0234     <span class="keyword">end</span>
0235   <span class="keyword">end</span>
0236   
0237   <span class="comment">% create output data file</span>
0238   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0239   fprintf(fid,<span class="string">'%% Open output data file:\n'</span>);
0240   fprintf(fid,<span class="string">'data_file=''%s'';\n'</span>,options.data_file);
0241   
0242   <span class="comment">%fprintf(fid,'fileID=fopen(data_file,''wt'');\n'); % &lt;-- 'wt' does not</span>
0243     <span class="comment">% compile in linux. 't' may be necessary on PC. may need to look into this</span>
0244   fprintf(fid,<span class="string">'fileID=fopen(data_file,''w'');\n'</span>);
0245   
0246   <span class="comment">% write headers</span>
0247   [state_var_counts,monitor_counts]=<a href="dsGetOutputCounts.html" class="code" title="function [state_var_counts,monitor_counts] = dsGetOutputCounts(model)">dsGetOutputCounts</a>(model);
0248   fprintf(fid,<span class="string">'fprintf(fileID,''time%s'');\n'</span>,separator);
0249   
0250   <span class="keyword">if</span> ~isempty(model.state_variables)
0251     <span class="keyword">for</span> i=1:length(model.state_variables)
0252       fprintf(fid,<span class="string">'for i=1:%g, fprintf(fileID,''%s%s''); end\n'</span>,state_var_counts(i),model.state_variables{i},separator);
0253     <span class="keyword">end</span>
0254   <span class="keyword">end</span>
0255   
0256   <span class="keyword">if</span> ~isempty(model.monitors)
0257     monitor_names=fieldnames(model.monitors);
0258     <span class="keyword">for</span> i=1:length(monitor_names)
0259       fprintf(fid,<span class="string">'for i=1:%g, fprintf(fileID,''%s%s''); end\n'</span>,monitor_counts(i),monitor_names{i},separator);
0260     <span class="keyword">end</span>
0261   <span class="keyword">end</span>
0262   
0263   fprintf(fid,<span class="string">'fprintf(fileID,''\\n'');\n'</span>);
0264 <span class="keyword">else</span> <span class="comment">%options.disk_flag==0</span>
0265   <span class="keyword">if</span> ~options.one_solve_file_flag
0266     fprintf(fid,<span class="string">'function %s=solve_ode\n'</span>,output_string);
0267   <span class="keyword">else</span>
0268     fprintf(fid,<span class="string">'function %s=solve_ode(simID)\n'</span>,output_string);
0269     <span class="keyword">if</span> options.compile_flag
0270       fprintf(fid, <span class="string">'assert(isa(simID, ''double''));\n'</span>);
0271     <span class="keyword">end</span>
0272   <span class="keyword">end</span>
0273 <span class="keyword">end</span>
0274 
0275 <span class="comment">% Benchmark tic</span>
0276 <span class="keyword">if</span> options.benchmark_flag
0277   fprintf(fid, <span class="string">'tic;'</span>);
0278 <span class="keyword">end</span>
0279 
0280 <span class="comment">% 2.3 load parameters</span>
0281 <span class="keyword">if</span> options.save_parameters_flag
0282   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0283   fprintf(fid,<span class="string">'%% Parameters:\n'</span>);
0284   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0285   fprintf(fid,<span class="string">'params = load(''params.mat'',''p'');\n'</span>);
0286   
0287   <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; options.compile_flag
0288     fprintf(fid,<span class="string">'pVecs = params.p;\n'</span>);
0289   <span class="keyword">else</span>
0290      fprintf(fid,<span class="string">'p = params.p;\n'</span>);
0291   <span class="keyword">end</span>
0292 <span class="keyword">end</span>
0293 
0294 <span class="keyword">if</span> options.one_solve_file_flag
0295   <span class="comment">% loop through p and for any vector, take simID index of it (ignores tspan)</span>
0296   <span class="keyword">if</span> ~options.compile_flag
0297     fprintf(fid,<span class="string">'\n%% For vector params, select index for this simID\n'</span>);
0298     fprintf(fid,<span class="string">'flds = fields(rmfield(p,''tspan''));\n'</span>); <span class="comment">% remove tspan</span>
0299     fprintf(fid,<span class="string">'for fld = flds''\n'</span>);
0300     fprintf(fid,<span class="string">'  fld = fld{1};\n'</span>);
0301     fprintf(fid,<span class="string">'  if isnumeric(p.(fld)) &amp;&amp; length(p.(fld)) &gt; 1\n'</span>);
0302     fprintf(fid,<span class="string">'    p.(fld) = p.(fld)(simID);\n'</span>);
0303     fprintf(fid,<span class="string">'  end\n'</span>);
0304     fprintf(fid,<span class="string">'end\n\n'</span>);
0305   <span class="keyword">else</span> <span class="comment">%compile_flag</span>
0306     <span class="comment">% slice scalar from vector params</span>
0307     <span class="keyword">for</span> iParam = 1:nParamMods
0308       fprintf(fid,<span class="string">'p.%s = pVecs.%s(simID);\n'</span>, mod_params{iParam}, mod_params{iParam});
0309     <span class="keyword">end</span>
0310     
0311     <span class="comment">% take scalar from scalar params</span>
0312     [~,sharedFlds] = intersect(fields(p), mod_params);
0313     scalar_params = fields(p);
0314     scalar_params(sharedFlds) = [];
0315     nScalarParams = length(scalar_params);
0316     <span class="keyword">for</span> iParam = 1:nScalarParams
0317       fprintf(fid,<span class="string">'p.%s = pVecs.%s;\n'</span>, scalar_params{iParam}, scalar_params{iParam});
0318     <span class="keyword">end</span>
0319   <span class="keyword">end</span>
0320 <span class="keyword">end</span>
0321 
0322 <span class="comment">% write tspan, dt, and downsample_factor</span>
0323 <span class="keyword">if</span> options.save_parameters_flag
0324   fprintf(fid,<span class="string">'downsample_factor=%sdownsample_factor;\n'</span>,parameter_prefix);
0325   fprintf(fid,<span class="string">'dt=%sdt;\n'</span>,parameter_prefix);
0326   fprintf(fid,<span class="string">'T=(%stspan(1):dt:%stspan(2))'';\n'</span>,parameter_prefix,parameter_prefix);
0327 <span class="keyword">else</span>
0328   fprintf(fid,<span class="string">'tspan=[%g %g];\ndt=%g;\ndownsample_factor=%g;\n'</span>,options.tspan,options.dt,options.downsample_factor);
0329   fprintf(fid,<span class="string">'T=(tspan(1):dt:tspan(2))'';\n'</span>);
0330 <span class="keyword">end</span>
0331 
0332 <span class="comment">% write calculation of time vector and derived parameters: ntime, nsamp</span>
0333 fprintf(fid,<span class="string">'ntime=length(T);\nnsamp=length(1:downsample_factor:ntime);\n'</span>);
0334 
0335 <span class="comment">% 2.4 evaluate fixed variables</span>
0336 <span class="keyword">if</span> ~isempty(model.fixed_variables)
0337   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0338   fprintf(fid,<span class="string">'%% Fixed variables:\n'</span>);
0339   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0340   names=fieldnames(model.fixed_variables);
0341   expressions=struct2cell(model.fixed_variables);
0342   <span class="keyword">for</span> i=1:length(names)
0343     fprintf(fid,<span class="string">'%s = %s;\n'</span>,names{i},expressions{i});
0344   <span class="keyword">end</span>
0345 <span class="keyword">end</span>
0346 
0347 <span class="comment">% 2.5 evaluate function handles</span>
0348 <span class="keyword">if</span> ~isempty(model.functions) &amp;&amp; options.reduce_function_calls_flag==0
0349   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0350   fprintf(fid,<span class="string">'%% Functions:\n'</span>);
0351   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0352   names=fieldnames(model.functions);
0353   expressions=struct2cell(model.functions);
0354   <span class="keyword">for</span> i=1:length(names)
0355     fprintf(fid,<span class="string">'%s = %s;\n'</span>,names{i},expressions{i});
0356   <span class="keyword">end</span>
0357 <span class="keyword">end</span>
0358 
0359 <span class="comment">% 2.6 prepare storage</span>
0360 fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0361 fprintf(fid,<span class="string">'%% Initial conditions:\n'</span>);
0362 fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0363 
0364 <span class="comment">% 2.2 set random seed</span>
0365 fprintf(fid,<span class="string">'%% seed the random number generator\n'</span>);
0366 <span class="keyword">if</span> options.save_parameters_flag
0367   fprintf(fid,<span class="string">'rng(%srandom_seed);\n'</span>,parameter_prefix);
0368 <span class="keyword">else</span>
0369   <span class="keyword">if</span> ischar(options.random_seed)
0370     fprintf(fid,<span class="string">'rng(''%s'');\n'</span>,options.random_seed);
0371   <span class="keyword">elseif</span> isnumeric(options.random_seed)
0372     fprintf(fid,<span class="string">'rng(%g);\n'</span>,options.random_seed);
0373   <span class="keyword">end</span>
0374 <span class="keyword">end</span>
0375 
0376 <span class="comment">% initialize time</span>
0377 fprintf(fid,<span class="string">'t=0; k=1;\n'</span>);
0378 
0379 <span class="comment">% todo: get coder varsize working with new format:</span>
0380 
0381 <span class="comment">% prepare for compilation</span>
0382 <span class="comment">% if options.compile_flag==1</span>
0383 <span class="comment">%   for i = 1:length(state_variables)</span>
0384 <span class="comment">%     %fprintf(fid,'coder.varsize(''%s'',[1e4,1],[true,false]);\n',state_variables{i}); % population size up to 1e4 for variable initial conditions</span>
0385 <span class="comment">%     fprintf(fid,'coder.varsize(''%s'',[1e8,1e4],[true,true]);\n',state_variables{i}); % population size up to 1e4 for variable initial conditions</span>
0386 <span class="comment">%   end</span>
0387 <span class="comment">% end</span>
0388 
0389 <span class="comment">% preallocate and initialize matrices to store results</span>
0390 <span class="keyword">if</span> options.disk_flag==1
0391   <span class="comment">% add time zero to output data file</span>
0392   fprintf(fid,<span class="string">'fprintf(fileID,''0%s'');\n'</span>,separator);
0393 <span class="keyword">end</span>
0394 
0395 <span class="comment">%% STATE_VARIABLES</span>
0396 fprintf(fid,<span class="string">'\n%% STATE_VARIABLES:\n'</span>);
0397 nvals_per_var=zeros(1,length(state_variables));
0398 IC_expressions=struct2cell(model.ICs);
0399 <span class="keyword">for</span> i=1:length(state_variables)
0400   <span class="comment">% initialize var_last</span>
0401   <span class="keyword">if</span> options.downsample_factor&gt;1 || options.disk_flag==1
0402     <span class="comment">% set var_last=IC;</span>
0403     fprintf(fid,<span class="string">'%s_last = %s;\n'</span>,state_variables{i},IC_expressions{i});
0404   <span class="keyword">end</span>
0405   
0406   <span class="keyword">if</span> options.disk_flag==1
0407     <span class="comment">% print var_last</span>
0408     var_last=sprintf(<span class="string">'%s_last'</span>,state_variables{i});
0409     fprintf(fid,<span class="string">'for i=1:numel(%s), fprintf(fileID,''%%g%s'',%s(i)); end\n'</span>,var_last,separator,var_last);
0410   <span class="keyword">else</span>
0411     <span class="comment">% preallocate state variables</span>
0412     parts=regexp(state_variables{i},<span class="string">'_'</span>,<span class="string">'split'</span>);
0413     
0414     <span class="keyword">if</span> numel(parts)==4 <span class="comment">% has connection mechanism namespace: target_source_mechanism</span>
0415       <span class="comment">% state variables defined in connection mechanisms are assumed to</span>
0416       <span class="comment">% have dimensionality of the source population</span>
0417       part=parts{2};
0418     <span class="keyword">else</span> <span class="comment">% has intrinsic mechanism or population namespace: target_mechanism</span>
0419       <span class="comment">% state variables defined in intrinsic mechanisms or population</span>
0420       <span class="comment">% equations have dimensionality of the target population</span>
0421       part=parts{1};
0422     <span class="keyword">end</span>
0423     
0424     <span class="keyword">if</span> options.save_parameters_flag
0425       fprintf(fid,<span class="string">'%s = zeros(nsamp,%s%s_Npop);\n'</span>,state_variables{i},parameter_prefix,part);
0426     <span class="keyword">else</span>
0427       fprintf(fid,<span class="string">'%s = zeros(nsamp,%g);\n'</span>,state_variables{i},model.parameters.([part <span class="string">'_Npop'</span>]));
0428     <span class="keyword">end</span>
0429     nvals_per_var(i)=model.parameters.([part <span class="string">'_Npop'</span>]);
0430     
0431     <span class="comment">% initialize state variables</span>
0432     <span class="keyword">if</span> options.downsample_factor==1
0433       <span class="comment">% set var(1,:)=IC;</span>
0434       fprintf(fid,<span class="string">'  %s(1,:) = %s;\n'</span>,state_variables{i},IC_expressions{i});
0435     <span class="keyword">else</span>
0436       <span class="comment">% set var(1,:)=var_last;</span>
0437       fprintf(fid,<span class="string">'  %s(1,:) = %s_last;\n'</span>,state_variables{i},state_variables{i});
0438     <span class="keyword">end</span>
0439   <span class="keyword">end</span> <span class="comment">%disk_flag</span>
0440 <span class="keyword">end</span> <span class="comment">%state_variables</span>
0441 
0442 <span class="comment">%% MONITORS</span>
0443 <span class="keyword">if</span> ~isempty(model.monitors)
0444   fprintf(fid,<span class="string">'\n%% MONITORS:\n'</span>);
0445   
0446   monitor_names=fieldnames(model.monitors);
0447   monitor_expression=struct2cell(model.monitors);
0448   
0449   <span class="keyword">for</span> i=1:length(monitor_names)
0450     <span class="keyword">if</span> ~isempty(regexp(monitor_names{i},<span class="string">'_spikes$'</span>,<span class="string">'once'</span>))
0451     <span class="comment">% set expression if monitoring spikes</span>
0452       <span class="keyword">if</span> options.disk_flag==1
0453         error(<span class="string">'spike monitoring is not supported for writing data to disk at this time.'</span>);
0454         <span class="comment">% todo: add support for spike monitoring with data written to</span>
0455         <span class="comment">% disk. approach: load data at end of simulation and do post-hoc</span>
0456         <span class="comment">% spike finding. if saving *.mat, use matfile() to load only the</span>
0457         <span class="comment">% variables in which to search. add spikes to output data file.</span>
0458       <span class="keyword">end</span>
0459       
0460       <span class="keyword">if</span> isempty(monitor_expression{i})
0461         spike_threshold=0;
0462       <span class="keyword">elseif</span> isempty(regexp(monitor_expression{i},<span class="string">'[^\d]'</span>,<span class="string">'once'</span>))
0463         spike_threshold=str2num(monitor_expression{i});
0464         monitor_expression{i}=[];
0465       <span class="keyword">else</span>
0466         spike_threshold=monitor_expression{i};
0467         monitor_expression{i}=[];
0468       <span class="keyword">end</span>
0469       
0470       <span class="comment">% approach: add conditional check for upward threshold crossing</span>
0471       var_spikes=regexp(monitor_names{i},<span class="string">'(.*)_spikes$'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0472       var_spikes=var_spikes{1}; <span class="comment">% variable to monitor</span>
0473       
0474       <span class="keyword">if</span> ismember(var_spikes,model.state_variables)
0475         model.conditionals(end+1).namespace=<span class="string">'spike_monitor'</span>;
0476         
0477         <span class="keyword">if</span> isnumeric(spike_threshold)
0478           model.conditionals(end).condition=<span class="keyword">...</span>
0479             sprintf(<span class="string">'%s(n,:)&gt;=%g&amp;%s(n-1,:)&lt;%g'</span>,var_spikes,spike_threshold,var_spikes,spike_threshold);
0480         <span class="keyword">else</span>
0481           model.conditionals(end).condition=<span class="keyword">...</span>
0482             sprintf(<span class="string">'%s(n,:)&gt;=%s&amp;%s(n-1,:)&lt;%s'</span>,var_spikes,spike_threshold,var_spikes,spike_threshold);
0483         <span class="keyword">end</span>
0484         
0485         model.conditionals(end).action=sprintf(<span class="string">'%s(n,conditional_test)=1'</span>,monitor_names{i});
0486         model.conditionals(end).else=[];
0487         <span class="comment">% move spike monitor to first position (ie.., to evaluate before other conditionals)</span>
0488         model.conditionals=model.conditionals([length(model.conditionals) 1:length(model.conditionals)-1]);
0489         <span class="comment">% remove from monitor list</span>
0490         model.monitors=rmfield(model.monitors,monitor_names{i});
0491       <span class="keyword">end</span>
0492     <span class="keyword">elseif</span> isempty(monitor_expression{i}) &amp;&amp; isfield(model.functions,monitor_names{i})
0493     <span class="comment">% set expression if monitoring function referenced by name</span>
0494       tmp=regexp(model.functions.(monitor_names{i}),<span class="string">'@\([a-zA-Z][\w,]*\)\s*(.*)'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0495       monitor_expression{i}=tmp{1};
0496       model.monitors.(monitor_names{i})=tmp{1};
0497     <span class="keyword">end</span>
0498     
0499     <span class="comment">% initialize mon_last</span>
0500     <span class="keyword">if</span> options.downsample_factor&gt;1 || options.disk_flag==1
0501       <span class="comment">% set mon_last=f(IC);</span>
0502       tmp=cell2struct({monitor_expression{i}},{monitor_names{i}},1);
0503       <a href="#_sub7" class="code" title="subfunction print_monitor_update(fid,monitors,index_nexts,state_variables,index_lasts, varargin)">print_monitor_update</a>(fid,tmp,<span class="string">'_last'</span>,state_variables,<span class="string">'_last'</span>, varargin{:});
0504     <span class="keyword">end</span>
0505     
0506     <span class="keyword">if</span> options.disk_flag==1
0507       <span class="comment">% print mon_last</span>
0508       mon_last=sprintf(<span class="string">'%s_last'</span>,monitor_names{i});
0509       fprintf(fid,<span class="string">'for i=1:numel(%s), fprintf(fileID,''%%g%s'',%s(i)); end\n'</span>,mon_last,separator,mon_last);
0510     <span class="keyword">else</span>
0511       <span class="comment">% preallocate monitors</span>
0512       parts=regexp(monitor_names{i},<span class="string">'_'</span>,<span class="string">'split'</span>);
0513       <span class="keyword">if</span> options.save_parameters_flag
0514         fprintf(fid,<span class="string">'%s = zeros(nsamp,%s%s_Npop);\n'</span>,monitor_names{i},parameter_prefix,parts{1});
0515       <span class="keyword">else</span>
0516         fprintf(fid,<span class="string">'%s = zeros(nsamp,%g);\n'</span>,monitor_names{i},model.parameters.([parts{1} <span class="string">'_Npop'</span>]));
0517       <span class="keyword">end</span>
0518       
0519       <span class="keyword">if</span> isempty(monitor_expression{i})
0520         <span class="keyword">continue</span>;
0521       <span class="keyword">end</span>
0522       
0523       <span class="comment">% initialize monitors</span>
0524       <span class="keyword">if</span> options.downsample_factor==1
0525         <span class="comment">% set mon(1,:)=f(IC);</span>
0526         tmp=cell2struct({monitor_expression{i}},{monitor_names{i}},1);
0527         <a href="#_sub7" class="code" title="subfunction print_monitor_update(fid,monitors,index_nexts,state_variables,index_lasts, varargin)">print_monitor_update</a>(fid,tmp,<span class="string">'(1,:)'</span>,state_variables,<span class="string">'(1,:)'</span>, varargin{:});
0528       <span class="keyword">else</span>
0529         <span class="comment">% set mon(1,:)=mon_last;</span>
0530         tmp=cell2struct({monitor_expression{i}},{monitor_names{i}},1);
0531         <a href="#_sub7" class="code" title="subfunction print_monitor_update(fid,monitors,index_nexts,state_variables,index_lasts, varargin)">print_monitor_update</a>(fid,tmp,<span class="string">'(1,:)'</span>,state_variables,<span class="string">'_last'</span>, varargin{:});
0532       <span class="keyword">end</span>
0533     <span class="keyword">end</span> <span class="comment">%disk_flag</span>
0534   <span class="keyword">end</span> <span class="comment">%monitor_names</span>
0535 <span class="keyword">end</span> <span class="comment">%monitors</span>
0536 
0537 <span class="keyword">if</span> options.disk_flag==1
0538   <span class="comment">% go to new line for next time point</span>
0539   fprintf(fid,<span class="string">'fprintf(fileID,''\\n'');\n'</span>);
0540 <span class="keyword">end</span>
0541 
0542 <span class="comment">% determine how to index each state variable based on how often state</span>
0543 <span class="comment">% variables are stored, whether they are written to disk or stored in</span>
0544 <span class="comment">% memory, and whether the state variable matrix is one- or two-dimensional</span>
0545 index_lasts=cell(1,length(state_variables));
0546 index_nexts=cell(1,length(state_variables));
0547 index_temps=repmat({<span class="string">'_last'</span>},[1 length(state_variables)]);
0548 <span class="keyword">for</span> i=1:length(state_variables)
0549   <span class="keyword">if</span> options.downsample_factor==1 &amp;&amp; options.disk_flag==0
0550     <span class="comment">% store state directly into state variables on each integration step</span>
0551     <span class="keyword">if</span> nvals_per_var(i)&gt;1 <span class="comment">% use full 2D matrix indexing</span>
0552       index_lasts{i}=<span class="string">'(n-1,:)'</span>;
0553       index_nexts{i}=<span class="string">'(n,:)'</span>;
0554     <span class="keyword">else</span> <span class="comment">% use more concise 1D indexing because it is much faster for some Matlab-specific reason...</span>
0555       index_lasts{i}=<span class="string">'(n-1)'</span>;
0556       index_nexts{i}=<span class="string">'(n)'</span>;
0557     <span class="keyword">end</span>
0558   <span class="keyword">elseif</span> options.downsample_factor&gt;1 &amp;&amp; options.disk_flag==0
0559     <span class="comment">% store state in var_last then update state variables on each downsample_factor integration step</span>
0560     index_lasts{i}=<span class="string">'_last'</span>;
0561     <span class="keyword">if</span> nvals_per_var(i)&gt;1
0562       index_nexts{i}=<span class="string">'(n,:)'</span>;
0563     <span class="keyword">else</span>
0564       index_nexts{i}=<span class="string">'(n)'</span>;
0565     <span class="keyword">end</span>
0566   <span class="keyword">elseif</span> options.disk_flag==1
0567     <span class="comment">% always store state in var_last and write on each downsample_factor integration step</span>
0568       index_lasts{i}=<span class="string">'_last'</span>;
0569       index_nexts{i}=<span class="string">'_last'</span>;
0570   <span class="keyword">end</span>
0571 <span class="keyword">end</span>
0572 
0573 <span class="comment">% add index to state variables in ODEs</span>
0574 odes = struct2cell(model.ODEs);
0575 <span class="keyword">for</span> i=1:length(odes)
0576   <span class="keyword">for</span> j=1:length(state_variables)
0577     odes{i}=<a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>(odes{i}, state_variables{j}, [state_variables{j} index_lasts{j}], <span class="string">''</span>, <span class="string">''</span>, varargin{:});
0578   <span class="keyword">end</span>
0579 <span class="keyword">end</span>
0580 
0581 <span class="comment">%% Numerical integration</span>
0582 <span class="comment">% write code to do numerical integration</span>
0583 fprintf(fid,<span class="string">'%% ###########################################################\n'</span>);
0584 fprintf(fid,<span class="string">'%% Numerical integration:\n'</span>);
0585 fprintf(fid,<span class="string">'%% ###########################################################\n'</span>);
0586 fprintf(fid,<span class="string">'n=2;\n'</span>);
0587 fprintf(fid,<span class="string">'for k=2:ntime\n'</span>); <span class="comment">% time index</span>
0588 fprintf(fid,<span class="string">'  t=T(k-1);\n'</span>);
0589 <span class="keyword">if</span> options.downsample_factor==1 &amp;&amp; options.disk_flag==0 <span class="comment">% store every time point, do not use var_last</span>
0590   <span class="comment">% update_vars;      % var(:,k-1)-&gt;var(k,:) or var(k-1)-&gt;var(k)</span>
0591   <a href="#_sub1" class="code" title="subfunction update_vars(index_nexts_, varargin)">update_vars</a>(index_nexts, varargin{:});
0592   
0593   <span class="comment">% conditionals;     % var(k,:)-&gt;var(k,:) or var(k)-&gt;var(k)</span>
0594   <a href="#_sub6" class="code" title="subfunction print_conditional_update(fid,conditionals,index_nexts,state_variables, varargin)">print_conditional_update</a>(fid,model.conditionals,index_nexts,state_variables)
0595   
0596   <span class="comment">% update_monitors;  % mon(:,k-1)-&gt;mon(k,:) or mon(k-1)-&gt;mon(k)</span>
0597   <a href="#_sub7" class="code" title="subfunction print_monitor_update(fid,monitors,index_nexts,state_variables,index_lasts, varargin)">print_monitor_update</a>(fid,model.monitors,index_nexts,state_variables, [], varargin{:});
0598   
0599   fprintf(fid,<span class="string">'  n=n+1;\n'</span>);
0600 <span class="keyword">else</span> <span class="comment">% store every downsample_factor time point in memory or on disk</span>
0601   <span class="comment">% update_vars;      % var_last-&gt;var_last</span>
0602   <a href="#_sub1" class="code" title="subfunction update_vars(index_nexts_, varargin)">update_vars</a>(index_temps, varargin{:});
0603   
0604   <span class="comment">% conditionals;     % var_last-&gt;var_last</span>
0605   <a href="#_sub6" class="code" title="subfunction print_conditional_update(fid,conditionals,index_nexts,state_variables, varargin)">print_conditional_update</a>(fid,model.conditionals,index_temps,state_variables, varargin{:});
0606   
0607   <span class="comment">% check if it is time to store data</span>
0608   fprintf(fid,<span class="string">'if mod(k,downsample_factor)==0 %% store this time point\n'</span>);
0609   
0610   <span class="keyword">if</span> options.disk_flag==1 <span class="comment">% write to disk</span>
0611     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0612     fprintf(fid,<span class="string">'  %% Write state variables and monitors to disk:\n'</span>);
0613     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0614     
0615     <span class="comment">% print current time point to data file</span>
0616     fprintf(fid,<span class="string">'  fprintf(fileID,''%%g%s'',T(k));\n'</span>,separator);
0617     
0618     <span class="comment">% print state variables</span>
0619     <span class="keyword">for</span> i=1:length(state_variables)
0620       var_last=sprintf(<span class="string">'%s_last'</span>,state_variables{i});
0621       fprintf(fid,<span class="string">'  for i=1:numel(%s), fprintf(fileID,''%%g%s'',%s(i)); end\n'</span>,var_last,separator,var_last);
0622     <span class="keyword">end</span>
0623     
0624     <span class="comment">% print monitors</span>
0625     <span class="keyword">if</span> ~isempty(model.monitors)
0626       <span class="keyword">for</span> i=1:length(monitor_names)
0627           mon_last=sprintf(<span class="string">'%s_last'</span>,monitor_names{i});
0628           fprintf(fid,<span class="string">'  for i=1:numel(%s), fprintf(fileID,''%%g%s'',%s(i)); end\n'</span>,mon_last,separator,mon_last);
0629       <span class="keyword">end</span>
0630     <span class="keyword">end</span>
0631     
0632     fprintf(fid,<span class="string">'  fprintf(fileID,''\\n'');\n'</span>);
0633   <span class="keyword">else</span>            <span class="comment">% store in memory</span>
0634     <span class="comment">% update_vars;    % var_last -&gt; var(n,:) or var(n)</span>
0635     <a href="#_sub5" class="code" title="subfunction print_var_update_last(fid,index_nexts,state_variables)">print_var_update_last</a>(fid,index_nexts,state_variables)
0636     <span class="comment">% update_monitors;% f(var_last) -&gt; mon(n,:) or mon(n)</span>
0637     <a href="#_sub7" class="code" title="subfunction print_monitor_update(fid,monitors,index_nexts,state_variables,index_lasts, varargin)">print_monitor_update</a>(fid,model.monitors,index_nexts,state_variables, [], varargin{:});
0638   <span class="keyword">end</span> <span class="comment">%disk_flag</span>
0639   
0640   fprintf(fid,<span class="string">'  n=n+1;\n'</span>);
0641   fprintf(fid,<span class="string">'end\n'</span>);
0642 <span class="keyword">end</span>
0643 
0644 fprintf(fid,<span class="string">'end\n'</span>);
0645 fprintf(fid,<span class="string">'T=T(1:downsample_factor:ntime);\n'</span>);
0646 
0647 <span class="comment">% cleanup</span>
0648 <span class="keyword">if</span> options.disk_flag==1
0649   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0650   fprintf(fid,<span class="string">'%% Close output data file:\n'</span>);
0651   fprintf(fid,<span class="string">'fclose(fileID);\n'</span>);
0652   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0653 <span class="keyword">end</span>
0654 
0655 <span class="comment">%% Benchmark toc</span>
0656 <span class="keyword">if</span> options.benchmark_flag
0657   fprintf(fid, <span class="string">'fprintf(''Sim Time: %%g seconds\\n'', toc);'</span>);
0658 <span class="keyword">end</span>
0659 
0660 <span class="comment">%% end solve function</span>
0661 fprintf(fid,<span class="string">'\nend\n\n'</span>);
0662 
0663 <span class="keyword">if</span> ~strcmp(outfile,<span class="string">'&quot;stdout&quot;'</span>)
0664   fclose(fid);
0665   <span class="comment">% wait for file before continuing to simulation</span>
0666   <span class="keyword">while</span> ~exist(outfile,<span class="string">'file'</span>)
0667     pause(.01);
0668   <span class="keyword">end</span>
0669 <span class="keyword">end</span>
0670 
0671   <span class="comment">% ########################################</span>
0672   <span class="comment">% NESTED FUNCTIONS</span>
0673   <span class="comment">% ########################################</span>
0674   <a name="_sub1" href="#_subfunctions" class="code">function update_vars(index_nexts_, varargin)</a>
0675     <span class="keyword">switch</span> options.solver
0676       <span class="keyword">case</span> {<span class="string">'euler'</span>,<span class="string">'rk1'</span>}
0677         <a href="#_sub2" class="code" title="subfunction print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)">print_k</a>(fid,odes,<span class="string">'_k1'</span>,state_variables);                              <span class="comment">% write k1 using model.ODEs</span>
0678         
0679         <span class="comment">% write update for state variables</span>
0680         <a href="#_sub4" class="code" title="subfunction print_var_update(fid,index_nexts,index_lasts,update_term,state_variables)">print_var_update</a>(fid,index_nexts_,index_lasts,<span class="keyword">...</span>
0681           <span class="string">'dt*%s_k1'</span>,state_variables);
0682       <span class="keyword">case</span> {<span class="string">'rk2'</span>,<span class="string">'modified_euler'</span>}
0683         <a href="#_sub2" class="code" title="subfunction print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)">print_k</a>(fid,odes,<span class="string">'_k1'</span>,state_variables);                              <span class="comment">% write k1 using model.ODEs</span>
0684         
0685         odes_k2=<a href="#_sub3" class="code" title="subfunction odes_out=update_odes(odes,suffix_k,increment,state_variables,index_lasts, varargin)">update_odes</a>(odes,<span class="string">'_k1'</span>,<span class="string">'.5*dt'</span>,state_variables,index_lasts, varargin{:});   <span class="comment">% F(*,yn+dt*k1/2)</span>
0686         fprintf(fid,<span class="string">'  t=t+.5*dt;\n'</span>);                                          <span class="comment">% update t before writing k2</span>
0687         <a href="#_sub2" class="code" title="subfunction print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)">print_k</a>(fid,odes_k2,<span class="string">'_k2'</span>,state_variables);                           <span class="comment">% write k2 using odes_k2</span>
0688         
0689         <span class="comment">% write update for state variables</span>
0690         <a href="#_sub4" class="code" title="subfunction print_var_update(fid,index_nexts,index_lasts,update_term,state_variables)">print_var_update</a>(fid,index_nexts_,index_lasts,<span class="keyword">...</span>
0691           <span class="string">'dt*%s_k2'</span>,state_variables);
0692       <span class="keyword">case</span> {<span class="string">'rk4'</span>,<span class="string">'rungekutta'</span>,<span class="string">'rk'</span>}
0693         <a href="#_sub2" class="code" title="subfunction print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)">print_k</a>(fid,odes,<span class="string">'_k1'</span>,state_variables);                              <span class="comment">% write k1 using model.ODEs</span>
0694         
0695         odes_k2=<a href="#_sub3" class="code" title="subfunction odes_out=update_odes(odes,suffix_k,increment,state_variables,index_lasts, varargin)">update_odes</a>(odes,<span class="string">'_k1'</span>,<span class="string">'.5*dt'</span>,state_variables,index_lasts, varargin{:});   <span class="comment">% F(*,yn+dt*k1/2)</span>
0696         fprintf(fid,<span class="string">'  t=t+.5*dt;\n'</span>);                                          <span class="comment">% update t before writing k2</span>
0697         <a href="#_sub2" class="code" title="subfunction print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)">print_k</a>(fid,odes_k2,<span class="string">'_k2'</span>,state_variables);                           <span class="comment">% write k2 using odes_k2</span>
0698         
0699         odes_k3=<a href="#_sub3" class="code" title="subfunction odes_out=update_odes(odes,suffix_k,increment,state_variables,index_lasts, varargin)">update_odes</a>(odes,<span class="string">'_k2'</span>,<span class="string">'.5*dt'</span>,state_variables,index_lasts, varargin{:});   <span class="comment">% F(*,yn+dt*k2/2)</span>
0700         <a href="#_sub2" class="code" title="subfunction print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)">print_k</a>(fid,odes_k3,<span class="string">'_k3'</span>,state_variables);                           <span class="comment">% write k3 using odes_k3</span>
0701         
0702         odes_k4=<a href="#_sub3" class="code" title="subfunction odes_out=update_odes(odes,suffix_k,increment,state_variables,index_lasts, varargin)">update_odes</a>(odes,<span class="string">'_k3'</span>,<span class="string">'dt'</span>,state_variables,index_lasts, varargin{:});      <span class="comment">% F(*,yn+dt*k3)</span>
0703         fprintf(fid,<span class="string">'  t=t+.5*dt;\n'</span>);                                          <span class="comment">% update t before writing k4</span>
0704         <a href="#_sub2" class="code" title="subfunction print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)">print_k</a>(fid,odes_k4,<span class="string">'_k4'</span>,state_variables);                           <span class="comment">% write k4 using odes_k4</span>
0705         
0706         <span class="comment">% write update for state variables</span>
0707         <a href="#_sub4" class="code" title="subfunction print_var_update(fid,index_nexts,index_lasts,update_term,state_variables)">print_var_update</a>(fid,index_nexts_,index_lasts,<span class="keyword">...</span>
0708           <span class="string">'(dt/6)*(%s_k1+2*(%s_k2+%s_k3)+%s_k4)'</span>,state_variables);
0709     <span class="keyword">end</span>
0710   <span class="keyword">end</span>
0711 
0712 <span class="keyword">end</span> <span class="comment">%main</span>
0713 
0714 
0715 <span class="comment">% ########################################</span>
0716 <span class="comment">%% SUBFUNCTIONS</span>
0717 <span class="comment">% ########################################</span>
0718 
0719 <a name="_sub2" href="#_subfunctions" class="code">function print_k(fid,odes_k,suffix_k,state_variables,nvals_per_var)</a>
0720   <span class="comment">% purpose: write auxiliary calculations (k1-k4) for runge-kutta</span>
0721   <span class="keyword">for</span> i=1:length(odes_k)
0722     fprintf(fid,<span class="string">'  %s%s=%s;\n'</span>,state_variables{i},suffix_k,odes_k{i});
0723   <span class="keyword">end</span>
0724 <span class="keyword">end</span>
0725 
0726 <a name="_sub3" href="#_subfunctions" class="code">function odes_out=update_odes(odes,suffix_k,increment,state_variables,index_lasts, varargin)</a>
0727   <span class="comment">% purpose: update expressions for axiliary calculations (k1-k4)</span>
0728   odes_out=odes;
0729   <span class="keyword">for</span> i=1:length(odes)
0730     <span class="keyword">for</span> j=1:length(odes)
0731       odes_out{i}=<a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>(odes_out{i}, [state_variables{j} index_lasts{j}], sprintf(<span class="string">'(%s%s+%s*%s%s)'</span>, state_variables{j}, index_lasts{j}, increment, state_variables{j}, suffix_k), <span class="string">'('</span>,<span class="string">')'</span>, varargin{:});
0732     <span class="keyword">end</span>
0733   <span class="keyword">end</span>
0734 <span class="keyword">end</span>
0735 
0736 <a name="_sub4" href="#_subfunctions" class="code">function print_var_update(fid,index_nexts,index_lasts,update_term,state_variables)</a>
0737   <span class="comment">% purpose: write statements to update state variables according to their dynamics</span>
0738   <span class="comment">% example:</span>
0739   <span class="comment">%   update_term='(dt/6)*(%s_k1+2*(%s_k2+%s_k3)+%s_k4)';</span>
0740   <span class="comment">%   state_variable='A_v';</span>
0741   
0742   <span class="keyword">if</span> ~isempty(state_variables)
0743     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0744     fprintf(fid,<span class="string">'  %% Update state variables:\n'</span>);
0745     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0746   <span class="keyword">else</span>
0747     <span class="keyword">return</span>;
0748   <span class="keyword">end</span>
0749   
0750   <span class="keyword">for</span> i=1:length(state_variables)
0751     this_update_term=strrep(update_term,<span class="string">'%s'</span>,state_variables{i});
0752     this_update_expression=sprintf(<span class="string">'%s%s=%s%s+%s;'</span>,state_variables{i},index_nexts{i},state_variables{i},index_lasts{i},this_update_term);
0753     fprintf(fid,<span class="string">'  %s\n'</span>,this_update_expression);
0754   <span class="keyword">end</span>
0755 <span class="keyword">end</span>
0756 
0757 <a name="_sub5" href="#_subfunctions" class="code">function print_var_update_last(fid,index_nexts,state_variables)</a>
0758   <span class="keyword">if</span> ~isempty(state_variables)
0759     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0760     fprintf(fid,<span class="string">'  %% Store state variables:\n'</span>);
0761     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0762   <span class="keyword">else</span>
0763     <span class="keyword">return</span>;
0764   <span class="keyword">end</span>
0765   
0766   <span class="keyword">for</span> i=1:length(state_variables)
0767     this_update_expression=sprintf(<span class="string">'%s%s=%s_last;\n'</span>,state_variables{i},index_nexts{i},state_variables{i});
0768     fprintf(fid,<span class="string">'  %s'</span>,this_update_expression);
0769   <span class="keyword">end</span>
0770 <span class="keyword">end</span>
0771 
0772 <a name="_sub6" href="#_subfunctions" class="code">function print_conditional_update(fid,conditionals,index_nexts,state_variables, varargin)</a>
0773   <span class="comment">% purpose: write statements to perform conditional actions (that may</span>
0774   <span class="comment">%   include updating state variables).</span>
0775   <span class="keyword">if</span> ~isempty(conditionals)
0776     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0777     fprintf(fid,<span class="string">'  %% Conditional actions:\n'</span>);
0778     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0779   <span class="keyword">else</span>
0780     <span class="keyword">return</span>;
0781   <span class="keyword">end</span>
0782   
0783   <span class="keyword">switch</span> index_nexts{1}(1)
0784     <span class="keyword">case</span> <span class="string">'('</span>
0785       action_index=<span class="string">'(n,conditional_test)'</span>;
0786     <span class="keyword">case</span> <span class="string">'_'</span>
0787       action_index=<span class="string">'_last(conditional_test)'</span>;
0788   <span class="keyword">end</span>
0789   
0790   <span class="keyword">for</span> i=1:length(conditionals)
0791     condition=conditionals(i).condition;
0792     action=conditionals(i).action;
0793     elseaction=conditionals(i).else;
0794     
0795     <span class="comment">% add indexes to state variables in conditional actions</span>
0796     <span class="keyword">for</span> j=1:length(state_variables)
0797       <span class="keyword">if</span> strcmp(<span class="string">'spike_monitor'</span>,conditionals(i).namespace)
0798         <span class="comment">% do nothing if spike_monitor</span>
0799       <span class="keyword">else</span>
0800         condition=<a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>(condition, state_variables{j}, [state_variables{j} index_nexts{j}], <span class="string">''</span>, <span class="string">''</span>, varargin{:});
0801       <span class="keyword">end</span>
0802       
0803       action=<a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>(action, state_variables{j}, [state_variables{j} action_index], <span class="string">''</span>, <span class="string">''</span>, varargin{:});
0804       
0805       <span class="keyword">if</span> ~isempty(elseaction)
0806         elseaction=<a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>(elseaction, state_variables{j}, [state_variables{j} action_index], <span class="string">''</span>, <span class="string">''</span>, varargin{:});
0807       <span class="keyword">end</span>
0808     <span class="keyword">end</span>
0809     
0810     <span class="comment">% write conditional to solver function</span>
0811     fprintf(fid,<span class="string">'  conditional_test=(%s);\n'</span>,condition);
0812     action=<a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>(action, <span class="string">'\(n,:'</span>, <span class="string">'(n,conditional_test'</span>, <span class="string">''</span>, <span class="string">''</span>, varargin{:});
0813     fprintf(fid,<span class="string">'  if any(conditional_test), %s; '</span>,action);
0814     
0815     <span class="keyword">if</span> ~isempty(elseaction)
0816       elseaction=<a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>(elseaction, <span class="string">'(n,:'</span>, <span class="string">'(n,conditional_test'</span>, <span class="string">''</span>, <span class="string">''</span>, varargin{:});
0817       fprintf(<span class="string">'else %s; '</span>,elseaction);
0818     <span class="keyword">end</span>
0819     
0820     fprintf(fid,<span class="string">'end\n'</span>);
0821   <span class="keyword">end</span>
0822 <span class="keyword">end</span>
0823 
0824 <a name="_sub7" href="#_subfunctions" class="code">function print_monitor_update(fid,monitors,index_nexts,state_variables,index_lasts, varargin)</a>
0825   <span class="keyword">if</span> ~isempty(monitors) &amp;&amp; iscell(index_nexts) <span class="comment">% being called from within the integrator loop</span>
0826     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0827     fprintf(fid,<span class="string">'  %% Update monitors:\n'</span>);
0828     fprintf(fid,<span class="string">'  %% ------------------------------------------------------------\n'</span>);
0829   <span class="keyword">end</span>
0830   
0831   <span class="keyword">if</span> nargin&lt;5 || isempty(index_lasts)
0832     index_lasts=index_nexts;
0833   <span class="keyword">end</span>
0834   
0835   <span class="comment">% account for inputs from monitor initialization</span>
0836   
0837   <span class="keyword">if</span> ~iscell(index_nexts), index_nexts={index_nexts}; <span class="keyword">end</span>
0838   
0839   <span class="keyword">if</span> ~iscell(index_lasts), index_lasts={index_lasts}; <span class="keyword">end</span>
0840   
0841   <span class="keyword">if</span> length(index_lasts)~=length(state_variables)
0842     index_lasts=repmat(index_lasts,[1 length(state_variables)]);
0843   <span class="keyword">end</span>
0844   
0845   <span class="keyword">if</span> isequal(index_nexts{1},<span class="string">'(1,:)'</span>)
0846     monitor_index=<span class="string">'(1,:)'</span>;
0847   <span class="keyword">else</span>
0848     <span class="keyword">switch</span> index_nexts{1}(1)
0849       <span class="keyword">case</span> <span class="string">'('</span>
0850         monitor_index=<span class="string">'(n,:)'</span>;
0851       <span class="keyword">case</span> <span class="string">'_'</span>
0852         monitor_index=<span class="string">'_last'</span>;
0853     <span class="keyword">end</span>
0854   <span class="keyword">end</span>
0855   
0856   <span class="comment">% purpose: write statements to update monitors given current state variables</span>
0857   <span class="comment">%   note: only run this every time a point is recorded (not necessarily on</span>
0858   <span class="comment">%   every step of the integration).</span>
0859   <span class="keyword">if</span> isempty(monitors)
0860     <span class="keyword">return</span>;
0861   <span class="keyword">end</span>
0862   
0863   monitor_name=fieldnames(monitors);
0864   monitor_expression=struct2cell(monitors);
0865   
0866   <span class="comment">% add indexes to state variables in monitors</span>
0867   <span class="keyword">for</span> i=1:length(monitor_name)
0868     <span class="keyword">for</span> j=1:length(state_variables)
0869       <span class="comment">%monitor_expression{i}=dsStrrep(monitor_expression{i}, state_variables{j}, [state_variables{j} index_lasts{j}], '', '', varargin{:});</span>
0870       monitor_expression{i}=<a href="dsStrrep.html" class="code" title="function str = dsStrrep(str,oldstr,newstr,lpad,rpad, varargin)">dsStrrep</a>(monitor_expression{i}, state_variables{j}, [state_variables{j} monitor_index], <span class="string">''</span>, <span class="string">''</span>, varargin{:});
0871     <span class="keyword">end</span>
0872     
0873     <span class="comment">% write monitors to solver function</span>
0874     fprintf(fid,<span class="string">'  %s%s=%s;\n'</span>,monitor_name{i},monitor_index,monitor_expression{i});
0875   <span class="keyword">end</span>
0876 <span class="keyword">end</span>
0877 
0878 
0879 <span class="comment">%{</span>
0880 PSEUDOCODE:
0881 <span class="comment">% --------------------------------------------------------------------------------</span>
0882 <span class="comment">% setup (parameters, fixed_variables, functions)</span>
0883 <span class="comment">% preallocation and initial conditions</span>
0884 <span class="keyword">if</span> downsample_factor&gt;1 || disk_flag==1
0885   <span class="comment">% var_last=IC;</span>
0886   <span class="comment">% mon_last=f(IC);</span>
0887 <span class="keyword">end</span>
0888 <span class="keyword">if</span> disk_flag==1
0889   fid=fopen(options.filename,<span class="string">'wt'</span>);
0890   <span class="comment">% print var_last</span>
0891   <span class="comment">% print mon_last</span>
0892 <span class="keyword">else</span>
0893   <span class="comment">% var=zeros(npop,nsamp);</span>
0894   <span class="comment">% mon=zeros(npop,nsamp);</span>
0895   <span class="keyword">if</span> downsample_factor==1
0896     <span class="comment">% var(1,:)=IC;</span>
0897     <span class="comment">% mon(1,:)=f(IC);</span>
0898   <span class="keyword">else</span>
0899     <span class="comment">% var(1,:)=var_last;</span>
0900     <span class="comment">% mon(1,:)=mon_last;</span>
0901   <span class="keyword">end</span>
0902 <span class="keyword">end</span>
0903 
0904 <span class="comment">% numerical integration</span>
0905 <span class="comment">% n=1; % storage index</span>
0906 <span class="comment">% for k=2:ntime % time index</span>
0907   <span class="keyword">if</span> downsample_factor==1 &amp;&amp; disk_flag==0 <span class="comment">% do not use var_last</span>
0908     <span class="comment">% update_vars;      % var(:,k-1)-&gt;var(k,:) or var(k-1)-&gt;var(k)</span>
0909     <span class="comment">% conditionals;     % var(k,:)-&gt;var(k,:) or var(k)-&gt;var(k)</span>
0910     <span class="comment">% update_monitors;  % mon(:,k-1)-&gt;mon(k,:) or mon(k-1)-&gt;mon(k)</span>
0911   <span class="keyword">else</span> <span class="comment">% downsample_factor&gt;1 and/or disk_flag==1</span>
0912     <span class="comment">% update_vars;      % var_last-&gt;var_last</span>
0913     <span class="comment">% conditionals;     % var_last-&gt;var_last</span>
0914     <span class="keyword">if</span> mod(t,downsample_factor)==0 <span class="comment">% store this time point</span>
0915       <span class="keyword">if</span> disk_flag==1 <span class="comment">% write to disk</span>
0916         <span class="comment">% write_vars;     % print: var_last</span>
0917         <span class="comment">% write_monitors; % print: mon=f(var_last)</span>
0918       <span class="keyword">else</span>            <span class="comment">% store in memory</span>
0919         <span class="comment">% update_vars;    % var_last -&gt; var(n,:) or var(n)</span>
0920         <span class="comment">% update_monitors;% f(var_last) -&gt; mon(n,:) or mon(n)</span>
0921       <span class="keyword">end</span>
0922       <span class="comment">% n=n+1;</span>
0923     <span class="keyword">end</span>
0924   <span class="keyword">end</span>
0925 <span class="comment">% end</span>
0926 <span class="comment">% --------------------------------------------------------------------------------</span>
0927 <span class="comment">%}</span></pre></div>
<hr><address>Generated on Fri 23-Jun-2017 18:15:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>