<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of dsSimulate</title>
  <meta name="keywords" content="dsSimulate">
  <meta name="description" content="% data=dsSimulate(model,'option',value,...)">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>

<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">functions</a> &gt; dsSimulate.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for functions&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>dsSimulate
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>% data=dsSimulate(model,'option',value,...)</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [data,studyinfo,result] = dsSimulate(model,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">% data=dsSimulate(model,'option',value,...)
 Purpose: manage simulation of a DynaSim model. This high-level function
 offers many options to control the number of simulations, how the model is
 optionally varied across simulations, and how the numerical integration
 is performed. It can optionally save the simulated data and create/submit
 simulation jobs to a compute cluster.
 Inputs:
   model: DynaSim model structure or equations (see dsGenerateModel and
          dsCheckModel for more details)

   solver options (provided as key/value pairs: 'option1',value1,'option2',value2,...):
     'solver'      : solver for numerical integration (see dsGetSolveFile)
                     {'euler','rk2','rk4', or any built-in matlab solver} (default: 'rk4')
     'tspan'       : time limits of simulation [begin,end] (default: [0 100]) [ms]
                     note: units must be consistent with dt and model equations
     'dt'          : time step used for DynaSim solvers (default: .01) [ms]
     'downsample_factor': downsampling applied during simulation (default: 1, no downsampling)
                     (only every downsample_factor-time point is stored in memory and/or written to disk)
     'ic'          : numeric array of initial conditions, one value per state
                     variable (default: all zeros). overrides definition in model structure
     'random_seed' : seed for random number generator (default: 'shuffle', set randomly) (usage: rng(options.random_seed))
     'compile_flag': whether to compile simulation using coder instead of
                     interpreting Matlab {0 or 1} (default: 0)
     'sparse_flag' : whether to convert numeric fixed variables to sparse matrices {0 or 1} (default: 0)

   options for running sets of simulations:
     'vary'        : (default: [], vary nothing): cell matrix specifying model
                     components to vary across simulations (see NOTE 1 and dsVary2Modifications)

   options to control saved data:
     'matCompatibility_flag': whether to save mat files in compatible mode, vs to prioritize &gt; 2GB VARs {0 or 1} (default: 1)
     'save_results_flag': whether to save results of analysis and plotting
     'save_data_flag': whether to save simulated data to disk after completion {0 or 1} (default: 0)
     'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)
     'study_dir'     : relative or absolute path to output directory (default: current directory)
     'prefix'        : string to prepend to all output file names (default: 'study')
     'disk_flag'     : whether to write to disk during simulation instead of storing in memory {0 or 1} (default: 0)
     'precision'     : {'single','double'} precision of simulated data saved to disk (default: 'single')

   options for cluster computing:
     'cluster_flag'  : whether to run simulations on a cluster submitted
                     using qsub (see dsCreateBatch) {0 or 1} (default: 0)
     'sims_per_job'  : number of simulations to run per batch job (default: 1)
     'memory_limit'  : memory to allocate per batch job (default: '8G')
     'qsub_mode'     : whether to use SGE -t array for 1 qsub, mode: 'array'; or
                         qsub in csh for loop, mode: 'loop'. (default: 'loop').
     'one_solve_file_flag': only use 1 file of each time when solving (default: 0)
     'optimize_big_vary': Select best options for doing many sims {0 or 1} (default: 0)

   options for parallel computing: (requires Parallel Computing Toolbox)
     'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)
     'num_cores'     : number of cores to specify in the parallel pool
     *note: parallel computing has been disabled for debugging...

   options for post-processing:
     'analysis_functions': cell array of analysis function handles
     'analysis_options'  : cell array of option cell arrays {'option1',value1,...}
     'plot_functions'    : cell array of plot function handles
     'plot_options'      : cell array of option cell arrays {'option1',value1,...}

   other options:
     'verbose_flag'  : whether to display informative messages/logs (default: 0)
     'modifications' : how to modify DynaSim specification structure component before simulation (see dsApplyModifications)
     'experiment'    : function handle of experiment function (see NOTE 2)
     'experiment_options' : single cell array of key/value options for experiment function
     'optimization'  : function handle of optimization function (see NOTE 2)
     'debug_flag'    : set to debug mode
     'benchmark_flag': set to benchmark mode. will add tic/toc to sims.

 Outputs:
   DynaSim data structure:
     data.labels           : list of state variables and monitors recorded
     data.(state_variables): state variable data matrix [time x cells]
     data.(monitors)       : monitor data matrix [time x cells]
     data.time             : time vector [time x 1]
     data.simulator_options: simulator options used to generate simulated data
     data.model            : model used to generate simulated data
     [data.varied]         : list of varied model components (present only if anything was varied)

   DynaSim studyinfo structure (only showing select fields, see dsCheckStudyinfo for more details)
     studyinfo.study_dir
     studyinfo.base_model (=[]): original model from which a set of simulations was derived
     studyinfo.base_simulator_options (=[])
     studyinfo.base_solve_file (='')
     studyinfo.simulations(k): metadata for each simulation in a set of simulations
                           .sim_id         : unique identifier in study
                           .modifications  : modifications made to the base model during this simulation
                           .data_file      : full filename of eventual output file
                           .batch_dir (=[]): directory where batch jobs were saved (if cluster_flag=1)
                           .job_file (=[]) : m-file batch job that runs this simulation (if cluster_flag=1)
                           .simulator_options: simulator options for this simulation
                           .solve_file     : full filename of m- or mex-file that numerically integrated the model

 NOTE 1: 'vary' indicates the variable to vary, the values
 it should take, and the object whose variable should be varied.
 Syntax: vary={object, variable, values; ...}. For instance, to vary
 parameter 'gNa', taking on values 100 and 120, in population 'E', set
 vary={'E','gNa',[100 120]}. To additionally vary 'gSYN' in the connection
 mechanism from 'E' to 'I', set vary={'E','gNa',[100 120];'E-&gt;I','gSYN',[0 1]}.
 Mechanism lists and equations can also be varied. (see dsVary2Modifications
 for more details and examples).

 EXAMPLES:
 Example 1: Lorenz equations with phase plot
   eqns={
     's=10; r=27; b=2.666';
     'dx/dt=s*(y-x)';
     'dy/dt=r*x-y-x*z';
     'dz/dt=-b*z+x*y';
   };
   data=dsSimulate(eqns,'tspan',[0 100],'ic',[1 2 .5]);
   plot(data.pop1_x,data.pop1_z); title('Lorenz equations'); xlabel('x'); ylabel('z')

 Example 2: Leaky integrate-and-fire with spike monitor
   eqns={
     'tau=10; R=10; E=-70; I=1.55; thresh=-55; reset=-75';
     'dV/dt=(E-V+R*I)/tau; if(V&gt;thresh)(V=reset)';
     'monitor V.spikes(thresh)';
   };
   data=dsSimulate(eqns,'tspan',[0 200],'ic',-75);
   data.pop1_V(data.pop1_V_spikes==1)=20; % insert spike
   plot(data.time,data.pop1_V); xlabel('time (ms)'); ylabel('V'); title('LIF with spikes')

 Example 3: Hodgkin-Huxley-type Intrinsically Bursting neuron
   eqns='dv/dt=5+@current; {iNaF,iKDR,iM}; gNaF=100; gKDR=5; gM=1.5; v(0)=-70';
   data=dsSimulate(eqns,'tspan',[0 200]);
   figure; plot(data.time,data.(data.labels{1}))
   xlabel('time (ms)'); ylabel('membrane potential (mV)'); title('Intrinsically Bursting neuron')

 Example 4: varying max Na+ conductance in Hodgkin-Huxley neuron
   eqns='dv/dt=@current+10; {iNa,iK}; v(0)=-60';
   data=dsSimulate(eqns,'vary',{'','gNa',[50 100 200]});
   % plot how mean firing rate varies with parameter
   dsPlotFR(data,'bin_size',30,'bin_shift',10); % bin_size and bin_shift in [ms]

 Example 5: simulate predefined Hodgkin-Huxley neuron with Iapp=10
   data = dsSimulate('HH','vary',{'HH','Iapp',10});
   figure; plot(data.time,data.HH_V);

 Example 6: Sparse Pyramidal-Interneuron-Network-Gamma rhythm with rastergram
   % define equations of cell model (same for E and I populations)
   eqns={
     'dv/dt=Iapp+@current/Cm+noise*randn(1,N_pop)*sqrt(dt)/dt';
     'monitor v.spikes, iGABAa.functions, iAMPA.functions'
   };
   % define specification for two-population network model
   s=[];
   s.populations(1).name='E';
   s.populations(1).size=80;
   s.populations(1).equations=eqns;
   s.populations(1).mechanism_list={'iNa','iK'};
   s.populations(1).parameters={'Iapp',5,'gNa',120,'gK',36,'Cm',1,'noise',4};
   s.populations(2).name='I';
   s.populations(2).size=20;
   s.populations(2).equations=eqns;
   s.populations(2).mechanism_list={'iNa','iK'};
   s.populations(2).parameters={'Iapp',0,'gNa',120,'gK',36,'Cm',1,'noise',4};
   s.connections(1).source='I';
   s.connections(1).target='E';
   s.connections(1).mechanism_list={'iGABAa'};
   s.connections(1).parameters={'tauD',10,'gSYN',.1,'netcon','ones(N_pre,N_post)'};
   s.connections(2).source='E';
   s.connections(2).target='I';
   s.connections(2).mechanism_list={'iAMPA'};
   s.connections(2).parameters={'tauD',2,'gSYN',.1,'netcon',ones(80,20)};
   % simulate model
   data=dsSimulate(s);
   % plot voltages and rastergram
   figure;
   subplot(2,1,1); % voltage traces
   plot(data.time,data.E_v,'b-',data.time,data.I_v,'r-')
   title('Sparse Pyramidal-Interneuron-Network-Gamma (sPING)'); ylabel('membrane potential (mV)');
   subplot(2,1,2); % rastergram
   E_spikes=nan(size(data.E_v_spikes)); E_spikes(data.E_v_spikes==1)=1;
   I_spikes=nan(size(data.I_v_spikes)); I_spikes(data.I_v_spikes==1)=1;
   plot(data.time,E_spikes+repmat(1:80,[length(data.time) 1]),'bo'); hold on
   plot(data.time,I_spikes+repmat(80+(1:20),[length(data.time) 1]),'ro'); axis([0 100 0 100]);
   title('rastergram'); xlabel('time (ms)'); ylabel('cell index');
   % simulate model varying two parameters (Iapp and tauD in sPING)
   % warning: this may take up to a minute to complete:
   vary={
     'E'   ,'Iapp',[0 10 20];     % amplitude of tonic input to E-cells
     'I-&gt;E','tauD',[5 10 15]      % inhibition decay time constant from I to E
     };
   data=dsSimulate(s,'vary',vary);
   % plot firing rates calculated from spike monitor in both populations
   dsPlotFR(data,'variable','*_spikes','bin_size',30,'bin_shift',10);


 See also: dsGenerateModel, dsCheckModel, dsGetSolveFile, dsCheckData,
           dsVary2Modifications, dsCheckStudyinfo, dsCreateBatch

 Author: Jason Sherfey, PhD &lt;jssherfey@gmail.com&gt;
 Copyright (C) 2016 Jason Sherfey, Boston University, USA</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="dsAnalyze.html" class="code" title="function result = dsAnalyze(src,funcIn,varargin)">dsAnalyze</a>	DSANALYZE - Apply an analysis function to DynaSim data, optionally saving data</li><li><a href="dsImport.html" class="code" title="function [data,studyinfo] = dsImport(file,varargin)">dsImport</a>	DSIMPORT - load data into DynaSim formatted data structure.</li><li><a href="dsSimulate.html" class="code" title="function [data,studyinfo,result] = dsSimulate(model,varargin)">dsSimulate</a>	% data=dsSimulate(model,'option',value,...)</li><li><a href="../functions/internal/dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>	APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</li><li><a href="../functions/internal/dsCheckModel.html" class="code" title="function model = dsCheckModel(model, varargin)">dsCheckModel</a>	CHECKMODEL - Standardize model structure and auto-populate missing fields</li><li><a href="../functions/internal/dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="../functions/internal/dsCheckSolverOptions.html" class="code" title="function options = dsCheckSolverOptions(options)">dsCheckSolverOptions</a>	CHECKSOLVEROPTIONS - standardize simulation options appended to params.mat</li><li><a href="../functions/internal/dsCreateBatch.html" class="code" title="function [studyinfo, cmd] = dsCreateBatch(base_model,modifications_set,varargin)">dsCreateBatch</a>	CREATEBATCH - create and submit jobs to run sets of simulations or analyses.</li><li><a href="../functions/internal/dsDynasim2odefun.html" class="code" title="function [ODEFUN,IC,elem_names] = dsDynasim2odefun(model, varargin)">dsDynasim2odefun</a>	Purpose: prepare ODEFUN for use with built-in Matlab solvers.</li><li><a href="../functions/internal/dsExportData.html" class="code" title="function dsExportData(data,varargin)">dsExportData</a>	EXPORTDATA - export DynaSim data structure in various formats.</li><li><a href="../functions/internal/dsGetConfig.html" class="code" title="function varOutput = dsGetConfig(query)">dsGetConfig</a>	GETCONFIG - returns the value of the variable specificed as string in argument</li><li><a href="../functions/internal/dsGetOutputCounts.html" class="code" title="function [state_var_counts,monitor_counts] = dsGetOutputCounts(model)">dsGetOutputCounts</a>	GETOUTPUTCOUNTS - determine how many copies of each state variable and monitor will be produced by simulating the model.</li><li><a href="../functions/internal/dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>	GETSOLVEFILE - helper function that creates or retrieves the desired solver file.</li><li><a href="../functions/internal/dsModifications2Vary.html" class="code" title="function data = dsModifications2Vary(data,modifications,options,modifications_set,sim)">dsModifications2Vary</a>	Adds fields tmpdata.varied and tmpdata.(varied{1}) ...</li><li><a href="../functions/internal/dsOptions2Keyval.html" class="code" title="function keyval = dsOptions2Keyval(options)">dsOptions2Keyval</a>	OPTIONS2KEYVAL - Convert from options structure to a list of key/value pairs.</li><li><a href="../functions/internal/dsPropagateFunctions.html" class="code" title="function model = dsPropagateFunctions(model, varargin)">dsPropagateFunctions</a>	PROPAGATEFUNCTIONS - eliminate internal function calls from model ODEs, ICs, monitors, and conditionals.</li><li><a href="../functions/internal/dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>	PROPAGATEPARAMETERS - substitute parameter values or prepend parameter names with prefix across all model equations.</li><li><a href="../functions/internal/dsRemoveKeyval.html" class="code" title="function keyvals_out = dsRemoveKeyval(keyvals,keys)">dsRemoveKeyval</a>	REMOVEKEYVAL - remove keys from keyvals_in.</li><li><a href="../functions/internal/dsSetupStudy.html" class="code" title="function [studyinfo,options] = dsSetupStudy(base_model,varargin)">dsSetupStudy</a>	SETUPSTUDY - Initialize DynaSim studyinfo structure, prepare list of output file names, and create output directories</li><li><a href="../functions/internal/dsUpdateStudy.html" class="code" title="function studyinfo = dsUpdateStudy(study_dir,varargin)">dsUpdateStudy</a>	UPDATESTUDY - helper function to keep track of study metadata when anything is saved</li><li><a href="../functions/internal/dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a>	VARY2MODIFICATIONS - convert specification of things to vary into a set of modifications indicating how to vary the desired things.</li><li><a href="../functions/internal/unit-test/dsUnitSaveAutoGenTestDir.html" class="code" title="function dsUnitSaveAutoGenTestDir(argin, argout, dirIn, dirOut, localFn_flag)">dsUnitSaveAutoGenTestDir</a>	Inputs:</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="dsSimulate.html" class="code" title="function [data,studyinfo,result] = dsSimulate(model,varargin)">dsSimulate</a>	% data=dsSimulate(model,'option',value,...)</li><li><a href="dynasim.html" class="code" title="function dynasim(spec)">dynasim</a>	DynaSim GUI</li><li><a href="../functions/internal/dsProbeCellProperties.html" class="code" title="function data = dsProbeCellProperties(model,varargin)">dsProbeCellProperties</a>	data = dsProbeCellProperties(model,'option1',option1,...)</li><li><a href="../functions/internal/dsProbeFI.html" class="code" title="function data = dsProbeFI(model,varargin)">dsProbeFI</a>	% data=dsProbeFI(model,varargin)</li><li><a href="../functions/internal/unit-test/dsUnitMake_autogenData.html" class="code" title="">dsUnitMake_autogenData</a>	% Make DynaSim Autogen Files</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function tryFn(nargoutmain)</a></li><li><a href="#_sub2" class="code">function update_data</a></li><li><a href="#_sub3" class="code">function update_result</a></li><li><a href="#_sub4" class="code">function cleanup(status)</a></li><li><a href="#_sub5" class="code">function all_ICs=ProcessNumericICs</a></li><li><a href="#_sub6" class="code">function logicalOut = is_varied_mech_list()</a></li><li><a href="#_sub7" class="code">function removeStudyinfo()</a></li><li><a href="#_sub8" class="code">function renameMexFilesForUnitTesting()</a></li><li><a href="#_sub9" class="code">function [model,options]=extract_vary_statement(model,options)</a></li><li><a href="#_sub10" class="code">function options = backward_compatibility(options)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [data,studyinfo,result] = dsSimulate(model,varargin)</a>
0002 <span class="comment">%% data=dsSimulate(model,'option',value,...)</span>
0003 <span class="comment">% Purpose: manage simulation of a DynaSim model. This high-level function</span>
0004 <span class="comment">% offers many options to control the number of simulations, how the model is</span>
0005 <span class="comment">% optionally varied across simulations, and how the numerical integration</span>
0006 <span class="comment">% is performed. It can optionally save the simulated data and create/submit</span>
0007 <span class="comment">% simulation jobs to a compute cluster.</span>
0008 <span class="comment">% Inputs:</span>
0009 <span class="comment">%   model: DynaSim model structure or equations (see dsGenerateModel and</span>
0010 <span class="comment">%          dsCheckModel for more details)</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%   solver options (provided as key/value pairs: 'option1',value1,'option2',value2,...):</span>
0013 <span class="comment">%     'solver'      : solver for numerical integration (see dsGetSolveFile)</span>
0014 <span class="comment">%                     {'euler','rk2','rk4', or any built-in matlab solver} (default: 'rk4')</span>
0015 <span class="comment">%     'tspan'       : time limits of simulation [begin,end] (default: [0 100]) [ms]</span>
0016 <span class="comment">%                     note: units must be consistent with dt and model equations</span>
0017 <span class="comment">%     'dt'          : time step used for DynaSim solvers (default: .01) [ms]</span>
0018 <span class="comment">%     'downsample_factor': downsampling applied during simulation (default: 1, no downsampling)</span>
0019 <span class="comment">%                     (only every downsample_factor-time point is stored in memory and/or written to disk)</span>
0020 <span class="comment">%     'ic'          : numeric array of initial conditions, one value per state</span>
0021 <span class="comment">%                     variable (default: all zeros). overrides definition in model structure</span>
0022 <span class="comment">%     'random_seed' : seed for random number generator (default: 'shuffle', set randomly) (usage: rng(options.random_seed))</span>
0023 <span class="comment">%     'compile_flag': whether to compile simulation using coder instead of</span>
0024 <span class="comment">%                     interpreting Matlab {0 or 1} (default: 0)</span>
0025 <span class="comment">%     'sparse_flag' : whether to convert numeric fixed variables to sparse matrices {0 or 1} (default: 0)</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%   options for running sets of simulations:</span>
0028 <span class="comment">%     'vary'        : (default: [], vary nothing): cell matrix specifying model</span>
0029 <span class="comment">%                     components to vary across simulations (see NOTE 1 and dsVary2Modifications)</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%   options to control saved data:</span>
0032 <span class="comment">%     'matCompatibility_flag': whether to save mat files in compatible mode, vs to prioritize &gt; 2GB VARs {0 or 1} (default: 1)</span>
0033 <span class="comment">%     'save_results_flag': whether to save results of analysis and plotting</span>
0034 <span class="comment">%     'save_data_flag': whether to save simulated data to disk after completion {0 or 1} (default: 0)</span>
0035 <span class="comment">%     'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)</span>
0036 <span class="comment">%     'study_dir'     : relative or absolute path to output directory (default: current directory)</span>
0037 <span class="comment">%     'prefix'        : string to prepend to all output file names (default: 'study')</span>
0038 <span class="comment">%     'disk_flag'     : whether to write to disk during simulation instead of storing in memory {0 or 1} (default: 0)</span>
0039 <span class="comment">%     'precision'     : {'single','double'} precision of simulated data saved to disk (default: 'single')</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%   options for cluster computing:</span>
0042 <span class="comment">%     'cluster_flag'  : whether to run simulations on a cluster submitted</span>
0043 <span class="comment">%                     using qsub (see dsCreateBatch) {0 or 1} (default: 0)</span>
0044 <span class="comment">%     'sims_per_job'  : number of simulations to run per batch job (default: 1)</span>
0045 <span class="comment">%     'memory_limit'  : memory to allocate per batch job (default: '8G')</span>
0046 <span class="comment">%     'qsub_mode'     : whether to use SGE -t array for 1 qsub, mode: 'array'; or</span>
0047 <span class="comment">%                         qsub in csh for loop, mode: 'loop'. (default: 'loop').</span>
0048 <span class="comment">%     'one_solve_file_flag': only use 1 file of each time when solving (default: 0)</span>
0049 <span class="comment">%     'optimize_big_vary': Select best options for doing many sims {0 or 1} (default: 0)</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%   options for parallel computing: (requires Parallel Computing Toolbox)</span>
0052 <span class="comment">%     'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)</span>
0053 <span class="comment">%     'num_cores'     : number of cores to specify in the parallel pool</span>
0054 <span class="comment">%     *note: parallel computing has been disabled for debugging...</span>
0055 <span class="comment">%</span>
0056 <span class="comment">%   options for post-processing:</span>
0057 <span class="comment">%     'analysis_functions': cell array of analysis function handles</span>
0058 <span class="comment">%     'analysis_options'  : cell array of option cell arrays {'option1',value1,...}</span>
0059 <span class="comment">%     'plot_functions'    : cell array of plot function handles</span>
0060 <span class="comment">%     'plot_options'      : cell array of option cell arrays {'option1',value1,...}</span>
0061 <span class="comment">%</span>
0062 <span class="comment">%   other options:</span>
0063 <span class="comment">%     'verbose_flag'  : whether to display informative messages/logs (default: 0)</span>
0064 <span class="comment">%     'modifications' : how to modify DynaSim specification structure component before simulation (see dsApplyModifications)</span>
0065 <span class="comment">%     'experiment'    : function handle of experiment function (see NOTE 2)</span>
0066 <span class="comment">%     'experiment_options' : single cell array of key/value options for experiment function</span>
0067 <span class="comment">%     'optimization'  : function handle of optimization function (see NOTE 2)</span>
0068 <span class="comment">%     'debug_flag'    : set to debug mode</span>
0069 <span class="comment">%     'benchmark_flag': set to benchmark mode. will add tic/toc to sims.</span>
0070 <span class="comment">%</span>
0071 <span class="comment">% Outputs:</span>
0072 <span class="comment">%   DynaSim data structure:</span>
0073 <span class="comment">%     data.labels           : list of state variables and monitors recorded</span>
0074 <span class="comment">%     data.(state_variables): state variable data matrix [time x cells]</span>
0075 <span class="comment">%     data.(monitors)       : monitor data matrix [time x cells]</span>
0076 <span class="comment">%     data.time             : time vector [time x 1]</span>
0077 <span class="comment">%     data.simulator_options: simulator options used to generate simulated data</span>
0078 <span class="comment">%     data.model            : model used to generate simulated data</span>
0079 <span class="comment">%     [data.varied]         : list of varied model components (present only if anything was varied)</span>
0080 <span class="comment">%</span>
0081 <span class="comment">%   DynaSim studyinfo structure (only showing select fields, see dsCheckStudyinfo for more details)</span>
0082 <span class="comment">%     studyinfo.study_dir</span>
0083 <span class="comment">%     studyinfo.base_model (=[]): original model from which a set of simulations was derived</span>
0084 <span class="comment">%     studyinfo.base_simulator_options (=[])</span>
0085 <span class="comment">%     studyinfo.base_solve_file (='')</span>
0086 <span class="comment">%     studyinfo.simulations(k): metadata for each simulation in a set of simulations</span>
0087 <span class="comment">%                           .sim_id         : unique identifier in study</span>
0088 <span class="comment">%                           .modifications  : modifications made to the base model during this simulation</span>
0089 <span class="comment">%                           .data_file      : full filename of eventual output file</span>
0090 <span class="comment">%                           .batch_dir (=[]): directory where batch jobs were saved (if cluster_flag=1)</span>
0091 <span class="comment">%                           .job_file (=[]) : m-file batch job that runs this simulation (if cluster_flag=1)</span>
0092 <span class="comment">%                           .simulator_options: simulator options for this simulation</span>
0093 <span class="comment">%                           .solve_file     : full filename of m- or mex-file that numerically integrated the model</span>
0094 <span class="comment">%</span>
0095 <span class="comment">% NOTE 1: 'vary' indicates the variable to vary, the values</span>
0096 <span class="comment">% it should take, and the object whose variable should be varied.</span>
0097 <span class="comment">% Syntax: vary={object, variable, values; ...}. For instance, to vary</span>
0098 <span class="comment">% parameter 'gNa', taking on values 100 and 120, in population 'E', set</span>
0099 <span class="comment">% vary={'E','gNa',[100 120]}. To additionally vary 'gSYN' in the connection</span>
0100 <span class="comment">% mechanism from 'E' to 'I', set vary={'E','gNa',[100 120];'E-&gt;I','gSYN',[0 1]}.</span>
0101 <span class="comment">% Mechanism lists and equations can also be varied. (see dsVary2Modifications</span>
0102 <span class="comment">% for more details and examples).</span>
0103 <span class="comment">%</span>
0104 <span class="comment">% EXAMPLES:</span>
0105 <span class="comment">% Example 1: Lorenz equations with phase plot</span>
0106 <span class="comment">%   eqns={</span>
0107 <span class="comment">%     's=10; r=27; b=2.666';</span>
0108 <span class="comment">%     'dx/dt=s*(y-x)';</span>
0109 <span class="comment">%     'dy/dt=r*x-y-x*z';</span>
0110 <span class="comment">%     'dz/dt=-b*z+x*y';</span>
0111 <span class="comment">%   };</span>
0112 <span class="comment">%   data=dsSimulate(eqns,'tspan',[0 100],'ic',[1 2 .5]);</span>
0113 <span class="comment">%   plot(data.pop1_x,data.pop1_z); title('Lorenz equations'); xlabel('x'); ylabel('z')</span>
0114 <span class="comment">%</span>
0115 <span class="comment">% Example 2: Leaky integrate-and-fire with spike monitor</span>
0116 <span class="comment">%   eqns={</span>
0117 <span class="comment">%     'tau=10; R=10; E=-70; I=1.55; thresh=-55; reset=-75';</span>
0118 <span class="comment">%     'dV/dt=(E-V+R*I)/tau; if(V&gt;thresh)(V=reset)';</span>
0119 <span class="comment">%     'monitor V.spikes(thresh)';</span>
0120 <span class="comment">%   };</span>
0121 <span class="comment">%   data=dsSimulate(eqns,'tspan',[0 200],'ic',-75);</span>
0122 <span class="comment">%   data.pop1_V(data.pop1_V_spikes==1)=20; % insert spike</span>
0123 <span class="comment">%   plot(data.time,data.pop1_V); xlabel('time (ms)'); ylabel('V'); title('LIF with spikes')</span>
0124 <span class="comment">%</span>
0125 <span class="comment">% Example 3: Hodgkin-Huxley-type Intrinsically Bursting neuron</span>
0126 <span class="comment">%   eqns='dv/dt=5+@current; {iNaF,iKDR,iM}; gNaF=100; gKDR=5; gM=1.5; v(0)=-70';</span>
0127 <span class="comment">%   data=dsSimulate(eqns,'tspan',[0 200]);</span>
0128 <span class="comment">%   figure; plot(data.time,data.(data.labels{1}))</span>
0129 <span class="comment">%   xlabel('time (ms)'); ylabel('membrane potential (mV)'); title('Intrinsically Bursting neuron')</span>
0130 <span class="comment">%</span>
0131 <span class="comment">% Example 4: varying max Na+ conductance in Hodgkin-Huxley neuron</span>
0132 <span class="comment">%   eqns='dv/dt=@current+10; {iNa,iK}; v(0)=-60';</span>
0133 <span class="comment">%   data=dsSimulate(eqns,'vary',{'','gNa',[50 100 200]});</span>
0134 <span class="comment">%   % plot how mean firing rate varies with parameter</span>
0135 <span class="comment">%   dsPlotFR(data,'bin_size',30,'bin_shift',10); % bin_size and bin_shift in [ms]</span>
0136 <span class="comment">%</span>
0137 <span class="comment">% Example 5: simulate predefined Hodgkin-Huxley neuron with Iapp=10</span>
0138 <span class="comment">%   data = dsSimulate('HH','vary',{'HH','Iapp',10});</span>
0139 <span class="comment">%   figure; plot(data.time,data.HH_V);</span>
0140 <span class="comment">%</span>
0141 <span class="comment">% Example 6: Sparse Pyramidal-Interneuron-Network-Gamma rhythm with rastergram</span>
0142 <span class="comment">%   % define equations of cell model (same for E and I populations)</span>
0143 <span class="comment">%   eqns={</span>
0144 <span class="comment">%     'dv/dt=Iapp+@current/Cm+noise*randn(1,N_pop)*sqrt(dt)/dt';</span>
0145 <span class="comment">%     'monitor v.spikes, iGABAa.functions, iAMPA.functions'</span>
0146 <span class="comment">%   };</span>
0147 <span class="comment">%   % define specification for two-population network model</span>
0148 <span class="comment">%   s=[];</span>
0149 <span class="comment">%   s.populations(1).name='E';</span>
0150 <span class="comment">%   s.populations(1).size=80;</span>
0151 <span class="comment">%   s.populations(1).equations=eqns;</span>
0152 <span class="comment">%   s.populations(1).mechanism_list={'iNa','iK'};</span>
0153 <span class="comment">%   s.populations(1).parameters={'Iapp',5,'gNa',120,'gK',36,'Cm',1,'noise',4};</span>
0154 <span class="comment">%   s.populations(2).name='I';</span>
0155 <span class="comment">%   s.populations(2).size=20;</span>
0156 <span class="comment">%   s.populations(2).equations=eqns;</span>
0157 <span class="comment">%   s.populations(2).mechanism_list={'iNa','iK'};</span>
0158 <span class="comment">%   s.populations(2).parameters={'Iapp',0,'gNa',120,'gK',36,'Cm',1,'noise',4};</span>
0159 <span class="comment">%   s.connections(1).source='I';</span>
0160 <span class="comment">%   s.connections(1).target='E';</span>
0161 <span class="comment">%   s.connections(1).mechanism_list={'iGABAa'};</span>
0162 <span class="comment">%   s.connections(1).parameters={'tauD',10,'gSYN',.1,'netcon','ones(N_pre,N_post)'};</span>
0163 <span class="comment">%   s.connections(2).source='E';</span>
0164 <span class="comment">%   s.connections(2).target='I';</span>
0165 <span class="comment">%   s.connections(2).mechanism_list={'iAMPA'};</span>
0166 <span class="comment">%   s.connections(2).parameters={'tauD',2,'gSYN',.1,'netcon',ones(80,20)};</span>
0167 <span class="comment">%   % simulate model</span>
0168 <span class="comment">%   data=dsSimulate(s);</span>
0169 <span class="comment">%   % plot voltages and rastergram</span>
0170 <span class="comment">%   figure;</span>
0171 <span class="comment">%   subplot(2,1,1); % voltage traces</span>
0172 <span class="comment">%   plot(data.time,data.E_v,'b-',data.time,data.I_v,'r-')</span>
0173 <span class="comment">%   title('Sparse Pyramidal-Interneuron-Network-Gamma (sPING)'); ylabel('membrane potential (mV)');</span>
0174 <span class="comment">%   subplot(2,1,2); % rastergram</span>
0175 <span class="comment">%   E_spikes=nan(size(data.E_v_spikes)); E_spikes(data.E_v_spikes==1)=1;</span>
0176 <span class="comment">%   I_spikes=nan(size(data.I_v_spikes)); I_spikes(data.I_v_spikes==1)=1;</span>
0177 <span class="comment">%   plot(data.time,E_spikes+repmat(1:80,[length(data.time) 1]),'bo'); hold on</span>
0178 <span class="comment">%   plot(data.time,I_spikes+repmat(80+(1:20),[length(data.time) 1]),'ro'); axis([0 100 0 100]);</span>
0179 <span class="comment">%   title('rastergram'); xlabel('time (ms)'); ylabel('cell index');</span>
0180 <span class="comment">%   % simulate model varying two parameters (Iapp and tauD in sPING)</span>
0181 <span class="comment">%   % warning: this may take up to a minute to complete:</span>
0182 <span class="comment">%   vary={</span>
0183 <span class="comment">%     'E'   ,'Iapp',[0 10 20];     % amplitude of tonic input to E-cells</span>
0184 <span class="comment">%     'I-&gt;E','tauD',[5 10 15]      % inhibition decay time constant from I to E</span>
0185 <span class="comment">%     };</span>
0186 <span class="comment">%   data=dsSimulate(s,'vary',vary);</span>
0187 <span class="comment">%   % plot firing rates calculated from spike monitor in both populations</span>
0188 <span class="comment">%   dsPlotFR(data,'variable','*_spikes','bin_size',30,'bin_shift',10);</span>
0189 <span class="comment">%</span>
0190 <span class="comment">%</span>
0191 <span class="comment">% See also: dsGenerateModel, dsCheckModel, dsGetSolveFile, dsCheckData,</span>
0192 <span class="comment">%           dsVary2Modifications, dsCheckStudyinfo, dsCreateBatch</span>
0193 <span class="comment">%</span>
0194 <span class="comment">% Author: Jason Sherfey, PhD &lt;jssherfey@gmail.com&gt;</span>
0195 <span class="comment">% Copyright (C) 2016 Jason Sherfey, Boston University, USA</span>
0196 
0197 <span class="comment">% TODO: rename 'disk_flag' to something more descriptive</span>
0198 
0199 <span class="comment">% dependencies: dsWriteDynaSimSolver, dsWriteMatlabSolver, dsPropagateFunctions, dsCheckModel,</span>
0200 <span class="comment">% dsCheckOptions, dsOptions2Keyval, displayError, DynaSim2Odefun</span>
0201 
0202 <span class="comment">% &lt;-- temporarily removed from help section --&gt;</span>
0203 <span class="comment">% NOTE 2: special functions that recursively call dsSimulate:</span>
0204 <span class="comment">% - &quot;Experiments&quot; are ways of hacking the ODE system to incorporate additional</span>
0205 <span class="comment">% models (e.g., controlled inputs) and use them to simulate experimental</span>
0206 <span class="comment">% protocols by systematically varying Model Components across simulations in</span>
0207 <span class="comment">% prescribed ways. Technically, an Experiment could be any function that takes</span>
0208 <span class="comment">% a DynaSim model structure as its first input followed by key/value options.</span>
0209 <span class="comment">% Ideally, Experiments represent standardized procedural methods (experimental</span>
0210 <span class="comment">% protocols) for studying the modeled system. Experiment functions typically</span>
0211 <span class="comment">% involve applying a set of Modifications to a Base Model and varying the</span>
0212 <span class="comment">% modified model in prescribed ways.</span>
0213 <span class="comment">% - during &quot;Optimization&quot;, each iteration involves a single Study producing</span>
0214 <span class="comment">% modified models, their simulated data sets and analysis results (e.g.,</span>
0215 <span class="comment">% cost functions) that shape the Base Model for a subsequent iteration and</span>
0216 <span class="comment">% its Study. Hence, a closed-loop optimization protocol produces a set of</span>
0217 <span class="comment">% evolving Studies. Technically, an Optimization could be any function</span>
0218 <span class="comment">% that takes a DynaSim model structure as its first input followed by</span>
0219 <span class="comment">% key/value options. Optimization functions will typically involve</span>
0220 <span class="comment">% while-looping through multiple Studies and analyzing data sets to update</span>
0221 <span class="comment">% Model Components on each iteration until some stop condition is reached.</span>
0222 
0223 <span class="comment">%% 0.0 Outputs &amp; inputs.</span>
0224 <span class="comment">% Initialize outputs</span>
0225 data=[];
0226 studyinfo=[];
0227 
0228 <span class="comment">% check path</span>
0229 dynasim_path=fileparts(which(mfilename));
0230 onPath=~isempty(strfind(path,[dynasim_path, pathsep]));
0231 <span class="keyword">if</span> ~onPath
0232   <span class="keyword">if</span> 1
0233     fprintf(<span class="string">'adding dynasim and sub-directory to Matlab path: %s\n'</span>,dynasim_path);
0234   <span class="keyword">end</span>
0235   addpath(genpath(dynasim_path)); <span class="comment">% necessary b/c of changing directory for simulation</span>
0236 <span class="keyword">end</span>
0237 
0238 <span class="comment">% Check inputs</span>
0239 varargin = <a href="#_sub10" class="code" title="subfunction options = backward_compatibility(options)">backward_compatibility</a>(varargin);
0240 options=<a href="../functions/internal/dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="keyword">...</span>
0241   <span class="string">'tspan'</span>,[0 100],[],<span class="keyword">...</span><span class="comment">          % [beg,end] (units must be consistent with dt and equations)</span>
0242   <span class="string">'ic'</span>,[],[],<span class="keyword">...</span><span class="comment">                  % initial conditions (overrides definition in model structure; can input as IC structure or numeric array)</span>
0243   <span class="string">'solver'</span>,<span class="string">'rk4'</span>,{<span class="string">'euler'</span>,<span class="string">'rk1'</span>,<span class="string">'rk2'</span>,<span class="string">'rk4'</span>,<span class="string">'modified_euler'</span>,<span class="string">'rungekutta'</span>,<span class="string">'rk'</span>,<span class="keyword">...</span>
0244   <span class="string">'ode23'</span>,<span class="string">'ode45'</span>,<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>},<span class="keyword">...</span><span class="comment"> % DynaSim and built-in Matlab solvers</span>
0245   <span class="string">'matlab_solver_options'</span>,[],[],<span class="keyword">...</span><span class="comment"> % options from odeset for use with built-in Matlab solvers</span>
0246   <span class="string">'dt'</span>,.01,[],<span class="keyword">...</span><span class="comment">                 % time step used for fixed step DynaSim solvers</span>
0247   <span class="string">'downsample_factor'</span>,1,[],<span class="keyword">...</span><span class="comment">    % downsampling applied during simulation (only every downsample_factor-time point is stored in memory or written to disk)</span>
0248   <span class="string">'reduce_function_calls_flag'</span>,1,{0,1},<span class="keyword">...</span><span class="comment">   % whether to eliminate internal (anonymous) function calls</span>
0249   <span class="string">'save_parameters_flag'</span>,1,{0,1},<span class="keyword">...</span>
0250   <span class="string">'random_seed'</span>,<span class="string">'shuffle'</span>,[],<span class="keyword">...</span><span class="comment">        % seed for random number generator (usage: rng(random_seed))</span>
0251   <span class="string">'data_file'</span>,<span class="string">'data.csv'</span>,[],<span class="keyword">...</span><span class="comment"> % name of data file if disk_flag=1</span>
0252   <span class="string">'precision'</span>,<span class="string">'single'</span>,{<span class="string">'single'</span>,<span class="string">'double'</span>},<span class="keyword">...</span>
0253   <span class="string">'logfid'</span>,1,[],<span class="keyword">...</span>
0254   <span class="string">'store_model_flag'</span>,1,{0,1},<span class="keyword">...</span><span class="comment">  % whether to store model structure with data</span>
0255   <span class="string">'verbose_flag'</span>,0,{0,1},<span class="keyword">...</span>
0256   <span class="string">'modifications'</span>,[],[],<span class="keyword">...</span><span class="comment">       % *DynaSim modifications structure</span>
0257   <span class="string">'vary'</span>,[],[],<span class="keyword">...</span><span class="comment">                % specification of things to vary or custom modifications_set</span>
0258   <span class="string">'experiment'</span>,[],[],<span class="keyword">...</span><span class="comment">          % experiment function. func(model,args)</span>
0259   <span class="string">'experiment_options'</span>,[],[],<span class="keyword">...</span>
0260   <span class="string">'optimization'</span>,[],[],<span class="keyword">...</span>
0261   <span class="string">'cluster_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment">      % whether to run simulations on a cluster</span>
0262   <span class="string">'sims_per_job'</span>,1,[],<span class="keyword">...</span><span class="comment"> % how many sims to run per batch job</span>
0263   <span class="string">'memory_limit'</span>,<span class="string">'8G'</span>,[],<span class="keyword">...</span><span class="comment"> % how much memory to allocate per batch job</span>
0264   <span class="string">'qsub_mode'</span>,<span class="string">'loop'</span>,{<span class="string">'loop'</span>,<span class="string">'array'</span>},<span class="keyword">...</span><span class="comment"> % whether to submit jobs as an array using qsub -t or in a for loop</span>
0265   <span class="string">'one_solve_file_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % use only 1 solve file of each type, but can't vary mechs yet</span>
0266   <span class="string">'parallel_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment">     % whether to run simulations in parallel (using parfor)</span>
0267   <span class="string">'num_cores'</span>,4,[],<span class="keyword">...</span><span class="comment"> % # cores for parallel processing (SCC supports 1-12)</span>
0268   <span class="string">'compile_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % exist('codegen')==6, whether to compile using coder instead of interpreting Matlab</span>
0269   <span class="string">'sparse_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % whether to sparsify fixed variables before simulation</span>
0270   <span class="string">'disk_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment">            % whether to write to disk during simulation instead of storing in memory</span>
0271   <span class="string">'matCompatibility_flag'</span>,1,{0,1},<span class="keyword">...</span><span class="comment">  % whether to save mat files in compatible mode, vs to prioritize &gt; 2GB VARs</span>
0272   <span class="string">'save_data_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment">  % whether to save simulated data</span>
0273   <span class="string">'save_results_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment">  % whether to save results from simulated data</span>
0274   <span class="string">'project_dir'</span>,pwd,[],<span class="keyword">...</span>
0275   <span class="string">'study_dir'</span>,[],[],<span class="keyword">...</span><span class="comment"> % study directory</span>
0276   <span class="string">'prefix'</span>,<span class="string">'study'</span>,[],<span class="keyword">...</span><span class="comment"> % prefix prepended to all output files</span>
0277   <span class="string">'overwrite_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % whether to overwrite existing data</span>
0278   <span class="string">'solve_file'</span>,[],[],<span class="keyword">...</span><span class="comment"> % m- or mex-file solving the system</span>
0279   <span class="string">'sim_id'</span>,[],[],<span class="keyword">...</span><span class="comment"> % sim id in an existing study</span>
0280   <span class="string">'studyinfo'</span>,[],[],<span class="keyword">...</span>
0281   <span class="string">'email'</span>,[],[],<span class="keyword">...</span><span class="comment"> % email to send notification upon study completion</span>
0282   <span class="string">'analysis_functions'</span>,[],[],<span class="keyword">...</span>
0283   <span class="string">'analysis_options'</span>,[],[],<span class="keyword">...</span>
0284   <span class="string">'plot_functions'</span>,[],[],<span class="keyword">...</span>
0285   <span class="string">'plot_options'</span>,[],[],<span class="keyword">...</span>
0286   <span class="string">'optimize_big_vary'</span>,0,{0,1},<span class="keyword">...</span>
0287   <span class="string">'mex_dir_flag'</span>,1,{0,1},<span class="keyword">...</span><span class="comment"> % Flag to tell whether or not to search in mex_dir for pre-compiled solve files (solve*_mex*).</span>
0288   <span class="string">'mex_dir'</span>,[],[],<span class="keyword">...</span><span class="comment"> % Directory to search for pre-compiled mex files. Can be relative to 'study_dir' or absolute path.</span>
0289   <span class="string">'in_parfor_loop_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % if inside parfor loop</span>
0290   <span class="string">'debug_flag'</span>,0,{0,1},<span class="keyword">...</span>
0291   <span class="string">'auto_gen_test_data_flag'</span>,0,{0,1},<span class="keyword">...</span>
0292   <span class="string">'unit_test_flag'</span>,0,{0,1},<span class="keyword">...</span>
0293   <span class="string">'benchmark_flag'</span>,0,{0,1},<span class="keyword">...</span>
0294   },false);
0295 <span class="comment">% more options: remove_solve_dir, remove_batch_dir, post_downsample_factor</span>
0296 
0297 <span class="comment">%% 0.1 Auto_gen_test_data_flag save argin (arguments passed to dsSimulate).</span>
0298 <span class="keyword">if</span> options.auto_gen_test_data_flag
0299   varargs = varargin;
0300   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0301   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0302   argin = [{model}, varargs]; <span class="comment">% specific to this function</span>
0303 <span class="keyword">end</span>
0304 
0305 <span class="comment">%% 0.2 Unit testing.</span>
0306 <span class="keyword">if</span> options.unit_test_flag
0307   options.study_dir = getAbsolutePath(options.study_dir);
0308 <span class="keyword">end</span>
0309 
0310 <span class="comment">%% 0.3 Prepare solve options.</span>
0311 
0312 <span class="keyword">if</span> options.compile_flag &amp;&amp; ~strcmp(reportUI,<span class="string">'matlab'</span>)
0313   fprintf(<span class="string">'Setting ''compile_flag'' to 0 in Octave.\n'</span>)
0314   options.compile_flag = 0;
0315 <span class="keyword">end</span>
0316 
0317 <span class="keyword">if</span> isempty(options.mex_dir)
0318     options.mex_dir = <a href="../functions/internal/dsGetConfig.html" class="code" title="function varOutput = dsGetConfig(query)">dsGetConfig</a>(<span class="string">'mex_path'</span>);
0319 <span class="keyword">end</span>
0320 
0321 <span class="keyword">if</span> options.compile_flag &amp;&amp; options.sparse_flag
0322   error(<span class="string">'The Matlab Coder toolbox does not support sparse matrices. Choose either ''compile_flag'' or ''sparse_flag''.'</span>);
0323 <span class="keyword">end</span>
0324 
0325 <span class="keyword">if</span> options.parallel_flag &amp;&amp; (strcmp(reportUI,<span class="string">'matlab'</span>) &amp;&amp; feature(<span class="string">'numCores'</span>) == 1 || ~strcmp(reportUI,<span class="string">'matlab'</span>) &amp;&amp; nproc() == 1)
0326   fprintf(<span class="string">'Setting ''parallel_flag'' to 0 since only 1 core detected on this machine.\n'</span>)
0327   options.parallel_flag = 0;
0328 <span class="keyword">end</span>
0329 
0330 <span class="keyword">if</span> options.compile_flag &amp;&amp; ~options.reduce_function_calls_flag
0331   fprintf(<span class="string">'Setting ''reduce_function_calls_flag'' to 1 for compatibility with ''compile_flag=1'' (coder does not support anonymous functions).\n'</span>);
0332   options.reduce_function_calls_flag=1;
0333 <span class="keyword">end</span>
0334 
0335 <span class="comment">% Make sure that data is either saved to disk, saved to variable, or plotted</span>
0336 <span class="keyword">if</span> (nargout==0 || options.cluster_flag) &amp;&amp; ~options.save_data_flag &amp;&amp; ~options.save_results_flag &amp;&amp; isempty(options.plot_functions)
0337   <span class="keyword">if</span> ~isempty(options.analysis_functions)
0338     fprintf(<span class="string">'Setting ''save_results_flag'' to 1 since output from dsSimulate is not stored in a variable and analysis functions specified.\n'</span>)
0339     options.save_results_flag = 1;
0340   <span class="keyword">else</span>
0341     fprintf(<span class="string">'Setting ''save_data_flag'' to 1 since output from dsSimulate is not stored in a variable and no plot or analysis functions specified.\n'</span>)
0342     options.save_data_flag = 1;
0343   <span class="keyword">end</span>
0344 <span class="keyword">end</span>
0345 
0346 <span class="keyword">if</span> options.cluster_flag &amp;&amp; ~options.save_data_flag
0347   options.save_results_flag=1;
0348   <span class="keyword">if</span> options.verbose_flag
0349     fprintf(<span class="string">'Setting ''save_results_flag'' to 1 for storing results of batch jobs for later access.\n'</span>);
0350   <span class="keyword">end</span>
0351 <span class="keyword">end</span>
0352 
0353 <span class="keyword">if</span> any(strcmp(options.solver, {<span class="string">'ode23'</span>,<span class="string">'ode45'</span>,<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>}))
0354   matlabSolverBool = 1;
0355 <span class="keyword">else</span>
0356   matlabSolverBool = 0;
0357 <span class="keyword">end</span>
0358 
0359 <span class="keyword">if</span> options.disk_flag &amp;&amp; matlabSolverBool
0360   fprintf(<span class="string">'Since using built-in solver, setting options.disk_flag=1.\n'</span>);
0361   options.disk_flag = 1;
0362 <span class="keyword">end</span>
0363 
0364 <span class="comment">% if ischar(options.study_dir) &amp;&amp; options.save_data_flag==0</span>
0365 <span class="comment">%   options.save_data_flag=1;</span>
0366 <span class="comment">%   if options.verbose_flag</span>
0367 <span class="comment">%     fprintf('Setting ''save_data_flag'' to 1 for storing results in study_dir: %s.\n',options.study_dir);</span>
0368 <span class="comment">%   end</span>
0369 <span class="comment">% end</span>
0370 
0371 <span class="comment">% Convert matlab solver options from key/value to struct using odeset if</span>
0372 <span class="comment">% necessary.</span>
0373 <span class="keyword">if</span> iscell(options.matlab_solver_options)
0374   options.matlab_solver_options = odeset(options.matlab_solver_options{:});
0375 <span class="keyword">end</span>
0376 
0377 <span class="comment">%% 0.4 Non-Batch checks.</span>
0378 <span class="keyword">if</span> isempty(options.sim_id) <span class="comment">% not in part of a batch sim</span>
0379   <span class="keyword">if</span> options.optimize_big_vary
0380     options.cluster_flag = 1;
0381     options.qsub_mode = <span class="string">'array'</span>;
0382     options.compile_flag = 1;
0383     options.downsample_factor = max(1/options.dt, options.downsample_factor); <span class="comment">% at most 1000Hz sampling</span>
0384     options.one_solve_file_flag = 1;
0385     options.sims_per_job = 2;
0386   <span class="keyword">end</span>
0387 
0388   <span class="comment">% check for one_solve_file_flag</span>
0389   <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; ~options.cluster_flag
0390     <span class="comment">% One file flag only for cluster</span>
0391     fprintf(<span class="string">'Since cluster_flag==0, setting options.one_solve_file_flag=0\n'</span>)
0392     options.one_solve_file_flag = 0;
0393     <span class="comment">% TODO: this is a temp setting until iss_90 is fully implemented</span>
0394   <span class="keyword">end</span>
0395 
0396   <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; ~options.overwrite_flag
0397     <span class="comment">% One file flag will overwrite</span>
0398     fprintf(<span class="string">'Since one_solve_file_flag==1, setting options.overwrite_flag=1\n'</span>)
0399     options.overwrite_flag = 1;
0400     <span class="comment">% TODO: this is a temp setting until iss_90 is fully implemented</span>
0401   <span class="keyword">end</span>
0402 
0403   <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; ~strcmp(options.qsub_mode, <span class="string">'array'</span>)
0404     <span class="comment">% One file flag needs array mode</span>
0405     fprintf(<span class="string">'Since one_solve_file_flag==1, setting options.qsub_mode=''array''\n'</span>)
0406     options.qsub_mode = <span class="string">'array'</span>;
0407     <span class="comment">% TODO: this is a temp setting until iss_90 is fully implemented</span>
0408   <span class="keyword">end</span>
0409 
0410   <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; options.parallel_flag
0411     <span class="comment">% One file flag can't do parallel_flag</span>
0412     fprintf(<span class="string">'Since one_solve_file_flag==1, setting options.parallel_flag=0\n'</span>)
0413     options.parallel_flag = 0;
0414     <span class="comment">% TODO: this is a temp setting until iss_90 is fully implemented</span>
0415   <span class="keyword">end</span>
0416 
0417   <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; isa(options.experiment,<span class="string">'function_handle'</span>)
0418     error(<span class="string">'one_solve_file_flag doesn''t work with experiments.'</span>)
0419   <span class="keyword">end</span>
0420 
0421   <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; ~options.save_parameters_flag
0422     fprintf(<span class="string">'Since one_solve_file_flag==1, setting options.save_parameters_flag=1\n'</span>)
0423     options.save_parameters_flag = 1;
0424     <span class="comment">% TODO: this is a temp setting until iss_90 is fully implemented</span>
0425   <span class="keyword">end</span>
0426 <span class="keyword">end</span> <span class="comment">% isempty(options.sim_id)</span>
0427 
0428 <span class="comment">%% 0.5 Prepare analysis functions and options.</span>
0429 <span class="keyword">if</span> ~isempty(options.analysis_functions)
0430   <span class="keyword">if</span> ~iscell(options.analysis_functions)
0431     <span class="comment">% convert function handle into cell array of function handles</span>
0432     options.analysis_functions={options.analysis_functions};
0433   <span class="keyword">end</span>
0434 
0435   <span class="keyword">if</span> any(~cellfun(@(x)isa(x,<span class="string">'function_handle'</span>),options.analysis_functions))
0436     error(<span class="string">'at least one analysis function was not provided as a function handle.'</span>);
0437   <span class="keyword">end</span>
0438 
0439   <span class="keyword">if</span> isempty(options.analysis_options)
0440     <span class="comment">% convert to empty option cell array</span>
0441     options.analysis_options={};
0442   <span class="keyword">end</span>
0443 
0444   <span class="keyword">if</span> ~iscell(options.analysis_options)
0445     error(<span class="string">'''analysis_options'' must be a cell array of options or option cell arrays'</span>);
0446   <span class="keyword">end</span>
0447 
0448   <span class="comment">% force to be a cell array of option cell arrays</span>
0449   <span class="keyword">if</span> isempty(options.analysis_options) || ischar(options.analysis_options{1}) <span class="comment">% first element is an option</span>
0450     options.analysis_options={options.analysis_options};
0451   <span class="keyword">end</span>
0452 
0453   <span class="comment">% make sure there is one option cell array per analysis function</span>
0454   <span class="keyword">if</span> length(options.analysis_options)==1 &amp;&amp; length(options.analysis_functions)&gt;1
0455     <span class="comment">% copy options for each analysis function</span>
0456     options.analysis_options=repmat(options.analysis_options,[1 length(options.analysis_functions)]);
0457   <span class="keyword">elseif</span> length(options.analysis_options) ~= length(options.analysis_functions)
0458     error(<span class="string">'there must be one option cell array per analysis function.'</span>);
0459   <span class="keyword">end</span>
0460 
0461 <span class="keyword">end</span>
0462 
0463 <span class="comment">%% 0.6 Prepare plot functions and options.</span>
0464 <span class="keyword">if</span> ~isempty(options.plot_functions)
0465   <span class="keyword">if</span> ~iscell(options.plot_functions)
0466     <span class="comment">% convert function handle into cell array of function handles</span>
0467     options.plot_functions={options.plot_functions};
0468   <span class="keyword">end</span>
0469 
0470   <span class="keyword">if</span> any(~cellfun(@(x)isa(x,<span class="string">'function_handle'</span>),options.plot_functions))
0471     error(<span class="string">'at least one plot function was not provided as a function handle.'</span>);
0472   <span class="keyword">end</span>
0473 
0474   <span class="keyword">if</span> isempty(options.plot_options)
0475     <span class="comment">% convert to empty option cell array</span>
0476     options.plot_options={};
0477   <span class="keyword">end</span>
0478 
0479   <span class="keyword">if</span> ~iscell(options.plot_options)
0480     error(<span class="string">'''plot_options'' must be a cell array of options or option cell arrays'</span>);
0481   <span class="keyword">end</span>
0482 
0483   <span class="comment">% force to be a cell array of option cell arrays</span>
0484   <span class="keyword">if</span> isempty(options.plot_options) || ischar(options.plot_options{1}) <span class="comment">% first element is an option</span>
0485     options.plot_options={options.plot_options};
0486   <span class="keyword">end</span>
0487 
0488   <span class="comment">% make sure there is one option cell array per plot function</span>
0489   <span class="keyword">if</span> length(options.plot_options)==1 &amp;&amp; length(options.plot_functions)&gt;1
0490     <span class="comment">% copy options for each plot function</span>
0491     options.plot_options=repmat(options.plot_options,[1 length(options.plot_functions)]);
0492   <span class="keyword">elseif</span> length(options.plot_options) ~= length(options.plot_functions)
0493     error(<span class="string">'there must be one option cell array per plot function.'</span>);
0494   <span class="keyword">end</span>
0495 <span class="keyword">end</span>
0496 
0497 <span class="comment">%% 1.0 Prepare model and study structures for simulation.</span>
0498 
0499 <span class="comment">% Handle special case of input equations with vary() statement.</span>
0500 [model,options] = <a href="#_sub9" class="code" title="subfunction [model,options]=extract_vary_statement(model,options)">extract_vary_statement</a>(model,options);
0501 
0502 <span class="comment">% Check/standardize model.</span>
0503 model = <a href="../functions/internal/dsCheckModel.html" class="code" title="function model = dsCheckModel(model, varargin)">dsCheckModel</a>(model, varargin{:}); <span class="comment">% handles conversion when input is a string w/ equations or a DynaSim specification structure</span>
0504 
0505 <span class="comment">%% 1.1 Apply modifications before simulation and optional further variation across simulations.</span>
0506 <span class="keyword">if</span> ~isempty(options.modifications)
0507   [model,options.modifications] = <a href="../functions/internal/dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>(model,options.modifications, varargin{:});
0508 <span class="keyword">end</span>
0509 
0510 <span class="comment">%% 1.2 Incorporate user-supplied initial conditions.</span>
0511 <span class="keyword">if</span> ~isempty(options.ic)
0512   <span class="keyword">if</span> isstruct(options.ic)
0513     <span class="comment">% TODO: create subfunc that converts numeric ICs to strings for</span>
0514     <span class="comment">% consistency (call here and in ProcessNumericICs &lt;-- use code already there)</span>
0515     <span class="comment">% user provided structure with ICs</span>
0516     warning(<span class="string">'off'</span>,<span class="string">'catstruct:DuplicatesFound'</span>);
0517     model.ICs=catstruct(model.ICs,options.ic);
0518   <span class="keyword">elseif</span> isnumeric(options.ic)
0519     <span class="comment">% user provided numeric array with one value per state variable per</span>
0520     <span class="comment">% cell with state variables ordered according to model.state_variables.</span>
0521     model.ICs=<a href="#_sub5" class="code" title="subfunction all_ICs=ProcessNumericICs">ProcessNumericICs</a>;
0522   <span class="keyword">end</span>
0523 <span class="keyword">end</span>
0524 
0525 <span class="comment">% expand set of things to vary across simulations</span>
0526 <span class="keyword">if</span> ~isempty(options.vary)
0527   modifications_set=<a href="../functions/internal/dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a>(options.vary,model);       <span class="comment">% Note: options.vary can also be itself a modifications set.</span>
0528 <span class="keyword">else</span>
0529   modifications_set={[]};
0530 <span class="keyword">end</span>
0531 
0532 <span class="comment">% check for one_solve_file_flag</span>
0533 <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; <a href="#_sub6" class="code" title="subfunction logicalOut = is_varied_mech_list()">is_varied_mech_list</a>()
0534   <span class="comment">% Can't vary mechs if using 1 file mode</span>
0535   error(<span class="string">'Can''t vary mechanism_list if using one_solve_file_flag'</span>)
0536 
0537   <span class="comment">% TODO: this is a temp setting until iss_90 is fully implemented</span>
0538 <span class="keyword">end</span>
0539 
0540 <span class="comment">%% 1.3 Handle parallel simulations.</span>
0541 <span class="comment">%% 1.3.1 Manage cluster computing.</span>
0542 <span class="comment">% whether to write jobs for distributed processing on cluster</span>
0543 <span class="keyword">if</span> options.cluster_flag
0544   <span class="comment">% add to model any parameters in 'vary' not explicit in current model</span>
0545   <span class="comment">%   approach: use dsApplyModifications(), it does that automatically</span>
0546   <span class="keyword">for</span> i = 1:length(modifications_set)
0547     <span class="keyword">if</span> ~isempty(modifications_set{i}) &amp;&amp; ~strcmp(modifications_set{i}{2},<span class="string">'mechanism_list'</span>) &amp;&amp; ~strcmp(modifications_set{i}{2},<span class="string">'equations'</span>)
0548       model = <a href="../functions/internal/dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>(model,modifications_set{i}, varargin{:});
0549       <span class="keyword">break</span>
0550     <span class="keyword">end</span>
0551   <span class="keyword">end</span>
0552   keyvals = <a href="../functions/internal/dsOptions2Keyval.html" class="code" title="function keyval = dsOptions2Keyval(options)">dsOptions2Keyval</a>(options);
0553   studyinfo = <a href="../functions/internal/dsCreateBatch.html" class="code" title="function [studyinfo, cmd] = dsCreateBatch(base_model,modifications_set,varargin)">dsCreateBatch</a>(model,modifications_set,<span class="string">'simulator_options'</span>,options,<span class="string">'process_id'</span>,options.sim_id,keyvals{:});
0554 
0555   <span class="keyword">if</span> options.one_solve_file_flag
0556     <span class="comment">% copy params.mat from project_dir to batchdirs</span>
0557     param_file_path = fullfile(options.project_dir, options.study_dir, <span class="string">'solve'</span>,<span class="string">'params.mat'</span>);
0558     [~,home]=system(<span class="string">'echo $HOME'</span>);
0559     batch_dir = fullfile(strtrim(home),<span class="string">'batchdirs'</span>,options.study_dir);
0560     batch_param_file_path = fullfile(batch_dir,<span class="string">'params.mat'</span>);
0561     [success,msg]=copyfile(param_file_path, batch_param_file_path);
0562   <span class="keyword">end</span>
0563 
0564   <span class="comment">%if options.overwrite_flag==0</span>
0565   <span class="comment">% check status of study</span>
0566   <span class="comment">%     [~,s]=dsMonitorStudy(studyinfo.study_dir,'verbose_flag',0,'process_id',options.sim_id);</span>
0567   <span class="comment">%     if s==1 % study finished</span>
0568   <span class="comment">%       if options.verbose_flag</span>
0569   <span class="comment">%         fprintf('Study already finished. Importing data...\n');</span>
0570   <span class="comment">%       end</span>
0571   <span class="comment">%       studyinfo=dsCheckStudyinfo(studyinfo.study_dir,'process_id',options.sim_id);</span>
0572   <span class="comment">%       data=dsImport(studyinfo,'process_id',options.sim_id);</span>
0573   <span class="comment">%     end</span>
0574   <span class="comment">%end</span>
0575 
0576   <span class="comment">%% auto_gen_test_data_flag argout</span>
0577   <span class="keyword">if</span> options.auto_gen_test_data_flag
0578     <span class="keyword">if</span> isfield(data, <span class="string">'simulator_options'</span>)
0579       data= rmfield(data, <span class="string">'simulator_options'</span>); <span class="comment">% specific to this function</span>
0580     <span class="keyword">end</span>
0581     <span class="keyword">if</span> ~isempty(studyinfo)
0582       studyinfo = []; <span class="comment">% specific to this function</span>
0583     <span class="keyword">end</span>
0584 
0585     argout = {data, studyinfo}; <span class="comment">% specific to this function</span>
0586 
0587     <span class="comment">% file output dir</span>
0588     <span class="comment">%   if ~isempty(studyinfo) &amp;&amp; ~isempty(studyinfo.study_dir)</span>
0589     <span class="comment">%     dirOut = studyinfo.study_dir;</span>
0590     <span class="comment">%   else</span>
0591     dirOut = options.study_dir;
0592     <span class="comment">%   end</span>
0593 
0594     <a href="#_sub7" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>(); <span class="comment">% remove studyinfo file</span>
0595     <a href="#_sub8" class="code" title="subfunction renameMexFilesForUnitTesting()">renameMexFilesForUnitTesting</a>(); <span class="comment">% rename mex files for unit testing</span>
0596 
0597     <a href="../functions/internal/unit-test/dsUnitSaveAutoGenTestDir.html" class="code" title="function dsUnitSaveAutoGenTestDir(argin, argout, dirIn, dirOut, localFn_flag)">dsUnitSaveAutoGenTestDir</a>(argin, argout, [], dirOut);
0598   <span class="keyword">end</span>
0599 
0600   <span class="comment">%% unit test</span>
0601   <span class="keyword">if</span> options.unit_test_flag
0602     <span class="comment">% remove fields that cause issues in unit testing</span>
0603     <span class="keyword">if</span> isfield(data, <span class="string">'simulator_options'</span>)
0604       data= rmfield(data, <span class="string">'simulator_options'</span>); <span class="comment">% specific to this function</span>
0605     <span class="keyword">end</span>
0606     <span class="keyword">if</span> ~isempty(studyinfo)
0607       studyinfo = [];
0608     <span class="keyword">end</span>
0609 
0610     <a href="#_sub7" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>(); <span class="comment">% remove studyinfo file</span>
0611     <a href="#_sub8" class="code" title="subfunction renameMexFilesForUnitTesting()">renameMexFilesForUnitTesting</a>(); <span class="comment">% rename mex files for unit testing</span>
0612   <span class="keyword">end</span>
0613 
0614   <span class="keyword">return</span>;
0615 <span class="keyword">end</span>
0616 
0617 <span class="comment">%% 1.3.2 Manage parallel computing on local machine.</span>
0618 <span class="comment">% TODO: debug local parallel sims, doesn't seem to be working right...</span>
0619 <span class="comment">% (however SCC cluster+parallel works)</span>
0620 <span class="keyword">if</span> options.parallel_flag
0621   <span class="comment">% prepare studyinfo</span>
0622   [studyinfo,options]=<a href="../functions/internal/dsSetupStudy.html" class="code" title="function [studyinfo,options] = dsSetupStudy(base_model,varargin)">dsSetupStudy</a>(model,<span class="string">'simulator_options'</span>,options,<span class="string">'modifications_set'</span>,modifications_set);
0623 
0624   <span class="keyword">if</span> options.compile_flag
0625     <span class="comment">% Ensure mex_dir is absolute</span>
0626     <span class="keyword">if</span> (ispc &amp;&amp; options.mex_dir(2) == <span class="string">':'</span>) || (~ispc &amp;&amp; options.mex_dir(1) == filesep)
0627       relMexPath = false;
0628     <span class="keyword">else</span>
0629       relMexPath = true;
0630     <span class="keyword">end</span>
0631 
0632     <span class="keyword">if</span> relMexPath <span class="comment">% then make absolute by prepending study_dir</span>
0633       options.mex_dir = fullfile(getAbsolutePath(studyinfo.study_dir), options.mex_dir);
0634     <span class="keyword">end</span>
0635 
0636     <span class="comment">% Create mex_dir if it does not yet exist</span>
0637     <span class="keyword">if</span> ~exist(options.mex_dir,<span class="string">'dir'</span>) &amp;&amp; ~options.cluster_flag &amp;&amp; options.mex_dir_flag
0638       mkdir(options.mex_dir);
0639     <span class="keyword">end</span>
0640   <span class="keyword">end</span>
0641 
0642   <span class="comment">% prepare options</span>
0643   options_temp = rmfield(options,{<span class="string">'vary'</span>,<span class="string">'modifications'</span>,<span class="string">'solve_file'</span>,<span class="string">'parallel_flag'</span>,<span class="string">'studyinfo'</span>,<span class="string">'in_parfor_loop_flag'</span>});
0644   keyvals=<a href="../functions/internal/dsOptions2Keyval.html" class="code" title="function keyval = dsOptions2Keyval(options)">dsOptions2Keyval</a>(options_temp);
0645 
0646   keyvals{find(strcmp(keyvals, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0647   <span class="keyword">if</span> options.auto_gen_test_data_flag || options.unit_test_flag
0648     keyvals{find(strcmp(keyvals, <span class="string">'unit_test_flag'</span>))+1} = 1; <span class="comment">% prevents time-stamped outputs</span>
0649   <span class="keyword">end</span>
0650 
0651   <span class="comment">% run embarrassingly-parallel simulations</span>
0652 
0653   <span class="comment">% Previous parallel code would overwrite the same params.mat file on each</span>
0654   <span class="comment">% parallel iteration, resulting in the same parameters being used for all</span>
0655   <span class="comment">% simulations.</span>
0656 
0657   <span class="comment">%   % List any core files - these should be deleted, as they are huge (debug)</span>
0658   <span class="comment">%   system (['ls ' fullfile(options.study_dir,'output*')],'-echo');</span>
0659   <span class="comment">%   system('find * -name &quot;core*&quot;','-echo');</span>
0660 
0661   clear data
0662 
0663   <span class="comment">% note that parfor currently acts just as a regular for in Octave</span>
0664   parfor sim=1:length(modifications_set)
0665     data(sim)=<a href="dsSimulate.html" class="code" title="function [data,studyinfo,result] = dsSimulate(model,varargin)">dsSimulate</a>(model, <span class="string">'modifications'</span>, modifications_set{sim}, keyvals{:},<span class="keyword">...</span>
0666         <span class="string">'studyinfo'</span>, studyinfo, <span class="string">'sim_id'</span>,sim, <span class="string">'in_parfor_loop_flag'</span>, 1);  <span class="comment">% My modification; now specifies a separate study directory for each sim.</span>
0667     <span class="comment">%disp(sim);</span>
0668   <span class="keyword">end</span>
0669 
0670   <span class="comment">% Clean up files leftover from sim</span>
0671   <span class="comment">% Unfortunately we can't remove the folders due to locked .nfs files.</span>
0672   <span class="comment">% Need to do this manually later...</span>
0673 
0674   <span class="keyword">if</span> strcmp(reportUI,<span class="string">'matlab'</span>) <span class="comment">% parfor currently acts just as a regular for in Octave</span>
0675     <span class="comment">% Delete any core files in parent directory</span>
0676     delete(fullfile(options.study_dir,<span class="string">'core*'</span>));
0677 
0678     <span class="comment">% Verify all core files are deleted</span>
0679     [~,result] = system(<span class="string">'find * -name &quot;core*&quot;'</span>,<span class="string">'-echo'</span>);
0680     <span class="keyword">if</span> ~isempty(result); fprintf(strcat(result,<span class="string">'\n'</span>)); warning(<span class="string">'Core files found. Consider deleting to free up space'</span>); <span class="keyword">end</span>
0681   <span class="keyword">end</span>
0682 
0683   <span class="comment">% TODO: sort data sets by things varied in modifications_set</span>
0684   <span class="comment">% TODO: Figure out how to delete locked .nfs files</span>
0685 
0686   <span class="keyword">if</span> options.verbose_flag
0687     fprintf(<span class="string">'\nParallel simulations complete.\n\n'</span>)
0688   <span class="keyword">end</span>
0689 
0690   <span class="comment">%% auto_gen_test_data_flag argout</span>
0691   <span class="keyword">if</span> options.auto_gen_test_data_flag
0692     <span class="keyword">if</span> isfield(data, <span class="string">'simulator_options'</span>)
0693       data= rmfield(data, <span class="string">'simulator_options'</span>); <span class="comment">% specific to this function</span>
0694     <span class="keyword">end</span>
0695     <span class="keyword">if</span> ~isempty(studyinfo)
0696       studyinfo = []; <span class="comment">% specific to this function</span>
0697     <span class="keyword">end</span>
0698 
0699     argout = {data, studyinfo}; <span class="comment">% specific to this function</span>
0700 
0701     <span class="comment">% file output dir</span>
0702     <span class="comment">%   if ~isempty(studyinfo) &amp;&amp; ~isempty(studyinfo.study_dir)</span>
0703     <span class="comment">%     dirOut = studyinfo.study_dir;</span>
0704     <span class="comment">%   else</span>
0705     dirOut = options.study_dir;
0706     <span class="comment">%   end</span>
0707 
0708     <a href="#_sub7" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>(); <span class="comment">% remove studyinfo file</span>
0709     <a href="#_sub8" class="code" title="subfunction renameMexFilesForUnitTesting()">renameMexFilesForUnitTesting</a>(); <span class="comment">% rename mex files for unit testing</span>
0710 
0711     <a href="../functions/internal/unit-test/dsUnitSaveAutoGenTestDir.html" class="code" title="function dsUnitSaveAutoGenTestDir(argin, argout, dirIn, dirOut, localFn_flag)">dsUnitSaveAutoGenTestDir</a>(argin, argout, [], dirOut);
0712   <span class="keyword">end</span>
0713 
0714   <span class="comment">%% unit test</span>
0715   <span class="keyword">if</span> options.unit_test_flag
0716     <span class="comment">% remove fields that cause issues in unit testing</span>
0717     <span class="keyword">if</span> isfield(data, <span class="string">'simulator_options'</span>)
0718       data= rmfield(data, <span class="string">'simulator_options'</span>); <span class="comment">% specific to this function</span>
0719     <span class="keyword">end</span>
0720     <span class="keyword">if</span> ~isempty(studyinfo)
0721       studyinfo = [];
0722     <span class="keyword">end</span>
0723 
0724     <a href="#_sub7" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>(); <span class="comment">% remove studyinfo file</span>
0725     <a href="#_sub8" class="code" title="subfunction renameMexFilesForUnitTesting()">renameMexFilesForUnitTesting</a>(); <span class="comment">% rename mex files for unit testing</span>
0726   <span class="keyword">end</span>
0727 
0728   <span class="keyword">return</span>
0729 <span class="keyword">end</span> <span class="comment">%parallel_flag</span>
0730 
0731 <span class="comment">%% 1.4 prepare study_dir and studyinfo if saving data</span>
0732 <span class="keyword">if</span> isempty(options.studyinfo)
0733   [studyinfo,options] = <a href="../functions/internal/dsSetupStudy.html" class="code" title="function [studyinfo,options] = dsSetupStudy(base_model,varargin)">dsSetupStudy</a>(model,<span class="string">'modifications_set'</span>,modifications_set,<span class="string">'simulator_options'</span>,options,<span class="string">'process_id'</span>,options.sim_id);
0734 <span class="keyword">else</span> <span class="comment">% in parfor loop and/or cluster job</span>
0735   studyinfo = options.studyinfo;
0736 <span class="keyword">end</span>
0737 
0738 <span class="keyword">if</span> options.compile_flag
0739   <span class="comment">% Ensure mex_dir is absolute</span>
0740   <span class="keyword">if</span> (ispc &amp;&amp; options.mex_dir(2) == <span class="string">':'</span>) || (~ispc &amp;&amp; options.mex_dir(1) == filesep)
0741     relMexPath = false;
0742   <span class="keyword">else</span>
0743     relMexPath = true;
0744   <span class="keyword">end</span>
0745 
0746   <span class="keyword">if</span> relMexPath <span class="comment">% then make absolute by prepending study_dir</span>
0747     <span class="keyword">if</span> ~isempty(studyinfo) &amp;&amp; ~isempty(studyinfo.study_dir)
0748       options.mex_dir = fullfile(getAbsolutePath(studyinfo.study_dir), options.mex_dir);
0749     <span class="keyword">else</span>
0750 
0751       options.mex_dir = fullfile(getAbsolutePath(options.study_dir), options.mex_dir);
0752     <span class="keyword">end</span>
0753   <span class="keyword">end</span>
0754 
0755   <span class="comment">% Create mex_dir if it does not yet exist</span>
0756   <span class="keyword">if</span> ~exist(options.mex_dir,<span class="string">'dir'</span>) &amp;&amp; ~options.cluster_flag &amp;&amp; options.mex_dir_flag
0757     mkdir(options.mex_dir);
0758   <span class="keyword">end</span>
0759 <span class="keyword">end</span>
0760 
0761 <span class="comment">% put solver blocks in try statement to catch and handle errors/cleanup</span>
0762 cwd=pwd; <span class="comment">% record current directory</span>
0763 
0764 data_index=0;
0765 tmpdata = [];
0766 
0767 <span class="keyword">if</span> ~options.debug_flag
0768   <span class="keyword">try</span>
0769     <a href="#_sub1" class="code" title="subfunction tryFn(nargoutmain)">tryFn</a>(nargout)
0770   <span class="keyword">catch</span> err <span class="comment">% error handling</span>
0771     <span class="keyword">if</span> options.compile_flag &amp;&amp; ~isempty(options.solve_file) &amp;&amp; ~options.one_solve_file_flag
0772 
0773       <span class="keyword">if</span> options.verbose_flag
0774         fprintf(<span class="string">'Removing failed compiled solve file: %s\n'</span>,options.solve_file);
0775       <span class="keyword">end</span>
0776 
0777       delete([options.solve_file <span class="string">'*'</span>]);
0778     <span class="keyword">end</span>
0779 
0780     displayError(err);
0781 
0782     <span class="comment">% update studyinfo</span>
0783     <span class="keyword">if</span> options.save_data_flag &amp;&amp; ~options.one_solve_file_flag
0784       studyinfo=<a href="../functions/internal/dsUpdateStudy.html" class="code" title="function studyinfo = dsUpdateStudy(study_dir,varargin)">dsUpdateStudy</a>(studyinfo.study_dir,<span class="string">'process_id'</span>,sim_id,<span class="string">'status'</span>,<span class="string">'failed'</span>,<span class="string">'verbose_flag'</span>,options.verbose_flag);
0785       data=studyinfo;
0786     <span class="keyword">end</span>
0787     <a href="#_sub4" class="code" title="subfunction cleanup(status)">cleanup</a>(<span class="string">'error'</span>);
0788 
0789     rethrow(err)
0790   <span class="keyword">end</span>
0791 <span class="keyword">else</span>
0792   <a href="#_sub1" class="code" title="subfunction tryFn(nargoutmain)">tryFn</a>(nargout) <span class="comment">% outside of try block if options.debug_flag</span>
0793 <span class="keyword">end</span>
0794 
0795 <span class="keyword">if</span> options.verbose_flag
0796   fprintf(<span class="string">'\nSimulations complete.\n\n'</span>)
0797 <span class="keyword">end</span>
0798 
0799 <span class="keyword">if</span> ~options.in_parfor_loop_flag <span class="comment">% if not inside of parfor loop</span>
0800   <span class="comment">%% auto_gen_test_data_flag argout</span>
0801   <span class="keyword">if</span> options.auto_gen_test_data_flag
0802     <span class="keyword">if</span> isfield(data, <span class="string">'simulator_options'</span>)
0803       data = rmfield(data, <span class="string">'simulator_options'</span>); <span class="comment">% specific to this function</span>
0804     <span class="keyword">end</span>
0805     <span class="keyword">if</span> ~isempty(studyinfo)
0806       studyinfo = []; <span class="comment">% specific to this function</span>
0807     <span class="keyword">end</span>
0808 
0809     argout = {data, studyinfo}; <span class="comment">% specific to this function</span>
0810 
0811     <span class="comment">% file output dir</span>
0812     <span class="comment">%   if ~isempty(studyinfo) &amp;&amp; ~isempty(studyinfo.study_dir)</span>
0813     <span class="comment">%     dirOut = studyinfo.study_dir;</span>
0814     <span class="comment">%   else</span>
0815     dirOut = options.study_dir;
0816     <span class="comment">%   end</span>
0817 
0818     <a href="#_sub7" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>(); <span class="comment">% remove studyinfo file</span>
0819     <a href="#_sub8" class="code" title="subfunction renameMexFilesForUnitTesting()">renameMexFilesForUnitTesting</a>(); <span class="comment">% rename mex files for unit testing</span>
0820 
0821     <a href="../functions/internal/unit-test/dsUnitSaveAutoGenTestDir.html" class="code" title="function dsUnitSaveAutoGenTestDir(argin, argout, dirIn, dirOut, localFn_flag)">dsUnitSaveAutoGenTestDir</a>(argin, argout, [], dirOut);
0822   <span class="keyword">end</span>
0823 
0824   <span class="comment">%% unit test</span>
0825   <span class="keyword">if</span> options.unit_test_flag
0826     <span class="comment">% remove fields that cause issues in unit testing</span>
0827     <span class="keyword">if</span> isfield(data, <span class="string">'simulator_options'</span>)
0828       data= rmfield(data, <span class="string">'simulator_options'</span>); <span class="comment">% specific to this function</span>
0829     <span class="keyword">end</span>
0830     <span class="keyword">if</span> ~isempty(studyinfo)
0831       studyinfo = [];
0832     <span class="keyword">end</span>
0833 
0834     <a href="#_sub7" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>(); <span class="comment">% remove studyinfo file</span>
0835     <a href="#_sub8" class="code" title="subfunction renameMexFilesForUnitTesting()">renameMexFilesForUnitTesting</a>(); <span class="comment">% rename mex files for unit testing</span>
0836   <span class="keyword">end</span>
0837 <span class="keyword">end</span> <span class="comment">% in_parfor_loop_flag</span>
0838 
0839 <span class="comment">% ---------------------------------------------</span>
0840 <span class="comment">% TODO:</span>
0841 <span class="comment">% - create helper function that handles log files (creation, standardized format,...)</span>
0842 <span class="comment">% ---------------------------------------------</span>
0843 
0844 
0845 
0846 <span class="comment">%% -------------------------</span>
0847 <span class="comment">% NESTED FUNCTIONS</span>
0848 <span class="comment">% -------------------------</span>
0849   <a name="_sub1" href="#_subfunctions" class="code">function tryFn(nargoutmain)</a>
0850     <span class="comment">% functions:             outputs:</span>
0851     <span class="comment">% dsWriteDynaSimSolver  m-file for DynaSim solver</span>
0852     <span class="comment">% dsWriteMatlabSolver   m-file for Matlab solver (including @odefun)</span>
0853     <span class="comment">% dsPrepareMEX          mex-file for m-file</span>
0854 
0855     <span class="comment">%% 1.5 loop over simulations, possibly varying things</span>
0856     base_model=model;
0857 
0858     <span class="keyword">for</span> sim=1:length(modifications_set)
0859       <span class="keyword">if</span> ~strcmp(pwd,cwd) <span class="comment">% move back to original directory before potentially regenerating to make sure the model files used are the same</span>
0860         cd(cwd);
0861       <span class="keyword">end</span>
0862 
0863       <span class="comment">% get index for this simulation</span>
0864       <span class="keyword">if</span> ~isempty(options.sim_id)
0865         sim_ind=find([studyinfo.simulations.sim_id]==options.sim_id);
0866         sim_id=options.sim_id;
0867       <span class="keyword">else</span>
0868         sim_ind=sim;
0869         sim_id=sim;
0870       <span class="keyword">end</span>
0871 
0872       <span class="keyword">if</span> options.save_data_flag
0873         <span class="comment">% check if output data already exists. load if so and skip simulation</span>
0874         data_file=studyinfo.simulations(sim_ind).data_file;
0875         <span class="keyword">if</span> exist(data_file,<span class="string">'file'</span>) &amp;&amp; ~options.overwrite_flag
0876           <span class="keyword">if</span> 1<span class="comment">%options.verbose_flag</span>
0877             <span class="comment">% note: this is important, should always display</span>
0878             fprintf(<span class="string">'Loading data from %s\n'</span>,data_file);
0879           <span class="keyword">end</span>
0880           tmpdata=<a href="dsImport.html" class="code" title="function [data,studyinfo] = dsImport(file,varargin)">dsImport</a>(data_file,<span class="string">'process_id'</span>,sim_id);
0881           <a href="#_sub2" class="code" title="subfunction update_data">update_data</a>; <span class="comment">% concatenate data structures across simulations</span>
0882           <span class="keyword">continue</span>; <span class="comment">% skip to next simulation</span>
0883         <span class="keyword">end</span>
0884       <span class="keyword">end</span>
0885 
0886       <span class="comment">% apply modifications for this point in search space</span>
0887       <span class="keyword">if</span> ~isempty(modifications_set{sim})
0888         model=<a href="../functions/internal/dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>(base_model,modifications_set{sim}, varargin{:});
0889       <span class="keyword">end</span>
0890 
0891       <span class="comment">% update studyinfo</span>
0892       <span class="keyword">if</span> options.save_data_flag
0893         <span class="comment">%studyinfo=dsUpdateStudy(studyinfo.study_dir,'process_id',sim_id,'status','started','model',model,'simulator_options',options,'verbose_flag',options.verbose_flag);</span>
0894       <span class="keyword">end</span>
0895 
0896       <span class="comment">%% Experiment</span>
0897       <span class="keyword">if</span> isa(options.experiment,<span class="string">'function_handle'</span>)
0898         <span class="comment">% EXPERIMENT (wrapping around a set of simulations)</span>
0899         <span class="keyword">if</span> options.cluster_flag &amp;&amp; options.compile_flag
0900           warning(<span class="string">'compiled solver is not available for experiments on the cluster. Simulation will be run in Matlab.'</span>);
0901         <span class="keyword">end</span>
0902 
0903         <span class="comment">% from varargin...</span>
0904         <span class="comment">% remove 'experiment', 'modifications', 'vary', 'cluster_flag' to avoid undesired recursive action in experiment function</span>
0905         <span class="comment">% remove 'save_data_flag' to prevent individual simulations from being saved during experiment</span>
0906         keyvals=<a href="../functions/internal/dsRemoveKeyval.html" class="code" title="function keyvals_out = dsRemoveKeyval(keyvals,keys)">dsRemoveKeyval</a>(varargin,{<span class="string">'experiment'</span>,<span class="string">'cluster_flag'</span>,<span class="string">'vary'</span>,<span class="string">'modifications'</span>,<span class="string">'save_data_flag'</span>});
0907 
0908         <span class="keyword">if</span> ~isempty(options.experiment_options)
0909           <span class="comment">% user-supplied experiment options override any found in dsSimulate options</span>
0910           keyvals=<a href="../functions/internal/dsRemoveKeyval.html" class="code" title="function keyvals_out = dsRemoveKeyval(keyvals,keys)">dsRemoveKeyval</a>(keyvals,options.experiment_options(1:2:end));
0911           keyvals=cat(2,keyvals,options.experiment_options);
0912         <span class="keyword">end</span>
0913 
0914         tmpdata=feval(options.experiment,model,keyvals{:});
0915       <span class="keyword">else</span>
0916         <span class="comment">%% NOT AN EXPERIMENT (single simulation)</span>
0917         <span class="comment">%% 2.0 prepare solver function (solve_ode.m/mex)</span>
0918         <span class="comment">% - Matlab solver: create @odefun with vectorized state variables</span>
0919         <span class="comment">% - DynaSim solver: write solve_ode.m and params.mat  (based on dnsimulator())</span>
0920         <span class="comment">% check if model solver needs to be created</span>
0921         <span class="comment">% (i.e., if is first simulation or a search space varying mechanism list)</span>
0922 
0923         <span class="keyword">if</span> sim==1 || ( ~isempty(modifications_set{1}) &amp;&amp; <a href="#_sub6" class="code" title="subfunction logicalOut = is_varied_mech_list()">is_varied_mech_list</a>() )
0924           <span class="comment">% prepare file that solves the model system</span>
0925           <span class="keyword">if</span> isempty(options.solve_file) || (~exist(options.solve_file,<span class="string">'file'</span>) &amp;&amp;<span class="keyword">...</span>
0926               ~exist([options.solve_file <span class="string">'.mexa64'</span>],<span class="string">'file'</span>) &amp;&amp;<span class="keyword">...</span>
0927               ~exist([options.solve_file <span class="string">'.mexa32'</span>],<span class="string">'file'</span>) &amp;&amp;<span class="keyword">...</span>
0928               ~exist([options.solve_file <span class="string">'.mexmaci64'</span>],<span class="string">'file'</span>))
0929             options.solve_file = <a href="../functions/internal/dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>(model,studyinfo,options); <span class="comment">% store name of solver file in options struct</span>
0930           <span class="keyword">end</span>
0931 
0932           <span class="comment">% TODO: consider providing better support for studies that produce different m-files per sim (e.g., varying mechanism_list)</span>
0933 
0934           <span class="keyword">if</span> options.verbose_flag
0935             fprintf(<span class="string">'\nSIMULATING MODEL:\n'</span>);
0936             fprintf(<span class="string">'Solving system using %s\n'</span>,options.solve_file);
0937           <span class="keyword">end</span>
0938         <span class="keyword">else</span>
0939           <span class="comment">% use previous solve_file</span>
0940         <span class="keyword">end</span>
0941         [fpath,fname,fext]=fileparts(options.solve_file);
0942 
0943         <span class="comment">%% 3.0 integrate model with solver of choice and prepare output data</span>
0944         <span class="comment">% - matlab solver: solve @odefun with feval and solver_options</span>
0945         <span class="comment">% - DynaSim solver: run solve_ode.m or create/run MEX</span>
0946         <span class="comment">% move to directory with solver file</span>
0947 
0948         <span class="keyword">if</span> options.verbose_flag
0949           fprintf(<span class="string">'Changing directory to %s\n'</span>,fpath);
0950         <span class="keyword">end</span>
0951 
0952         cd(fpath);
0953 
0954         <span class="comment">% save parameters there</span>
0955         warning(<span class="string">'off'</span>,<span class="string">'catstruct:DuplicatesFound'</span>);
0956         p = catstruct(<a href="../functions/internal/dsCheckSolverOptions.html" class="code" title="function options = dsCheckSolverOptions(options)">dsCheckSolverOptions</a>(options),model.parameters);
0957 
0958         <span class="keyword">if</span> matlabSolverBool
0959           <span class="comment">% add IC to p for use in matlab solver</span>
0960           <span class="keyword">if</span> isempty(options.ic)
0961             [~, p.ic]=<a href="../functions/internal/dsDynasim2odefun.html" class="code" title="function [ODEFUN,IC,elem_names] = dsDynasim2odefun(model, varargin)">dsDynasim2odefun</a>(  <a href="../functions/internal/dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>( <a href="../functions/internal/dsPropagateFunctions.html" class="code" title="function model = dsPropagateFunctions(model, varargin)">dsPropagateFunctions</a>(model, varargin{:}), varargin{:} ), <span class="string">'odefun_output'</span>,<span class="string">'func_body'</span>, varargin{:}  );
0962           <span class="keyword">else</span>
0963             p.ic = options.ic;
0964           <span class="keyword">end</span>
0965 
0966           <span class="comment">% add matlab_solver_options to p</span>
0967           <span class="keyword">if</span> ~isempty(options.matlab_solver_options)
0968             p.matlab_solver_options = options.matlab_solver_options;
0969           <span class="keyword">end</span>
0970         <span class="keyword">end</span>
0971 
0972         param_file = fullfile(fpath,<span class="string">'params.mat'</span>);
0973         <span class="keyword">if</span> options.verbose_flag
0974           fprintf(<span class="string">'Saving model parameters: %s\n'</span>,param_file);
0975         <span class="keyword">end</span>
0976         <span class="comment">%pause(.01);</span>
0977 
0978         <span class="comment">%% Solve System</span>
0979         <span class="keyword">if</span> options.disk_flag  <span class="comment">% ### data stored on disk during simulation ###</span>
0980           sim_start_time=tic;
0981           <span class="keyword">if</span> ~options.one_solve_file_flag
0982             save(param_file,<span class="string">'p'</span>,<span class="string">'-v7'</span>); <span class="comment">% save params immediately before solving</span>
0983           <span class="keyword">end</span>
0984           csv_data_file=feval(fname);  <span class="comment">% returns name of file storing the simulated data</span>
0985           duration=toc(sim_start_time);
0986 
0987           <span class="keyword">if</span> nargout&gt;0 || options.save_data_flag
0988             tmpdata=<a href="dsImport.html" class="code" title="function [data,studyinfo] = dsImport(file,varargin)">dsImport</a>(csv_data_file,<span class="string">'process_id'</span>,sim_id); <span class="comment">% eg, data.csv</span>
0989           <span class="keyword">end</span>
0990         <span class="keyword">else</span>                  <span class="comment">% ### data stored in memory during simulation ###</span>
0991           <span class="comment">% create list of output variables to capture</span>
0992           output_variables=cat(2,<span class="string">'time'</span>,model.state_variables);
0993 
0994           <span class="keyword">if</span> ~isempty(model.monitors)
0995             output_variables=cat(2,output_variables,fieldnames(model.monitors)');
0996           <span class="keyword">end</span>
0997 
0998           <span class="keyword">if</span> ~isempty(model.fixed_variables)
0999             fields=fieldnames(model.fixed_variables)';
1000             output_variables=cat(2,output_variables,fields);
1001             num_fixed_variables=length(fields);
1002           <span class="keyword">else</span>
1003             num_fixed_variables=0;
1004           <span class="keyword">end</span>
1005 
1006           <span class="comment">% run simulation</span>
1007           <span class="keyword">if</span> options.verbose_flag
1008             fprintf(<span class="string">'\nRunning simulation %g/%g (solver=''%s'', dt=%g, tspan=[%g %g]) ...\n'</span>,sim,length(modifications_set),options.solver,options.dt,options.tspan);
1009           <span class="keyword">end</span>
1010           sim_start_time=tic;
1011 
1012           outputs=cell(1,length(output_variables)); <span class="comment">% preallocate for PCT compatibility</span>
1013 
1014           <span class="keyword">if</span> ~options.one_solve_file_flag
1015             save(param_file,<span class="string">'p'</span>,<span class="string">'-v7'</span>); <span class="comment">% save params immediately before solving</span>
1016           <span class="keyword">end</span>
1017 
1018           <span class="comment">% feval solve file</span>
1019           <span class="keyword">if</span> ~options.one_solve_file_flag
1020             [outputs{1:length(output_variables)}]=feval(fname);
1021           <span class="keyword">else</span>
1022             <span class="comment">% pass sim_id for slicing params</span>
1023             [outputs{1:length(output_variables)}]=feval(fname, sim_id);
1024           <span class="keyword">end</span>
1025 
1026           duration=toc(sim_start_time);
1027 
1028 
1029           <span class="comment">% prepare DynaSim data structure</span>
1030           <span class="comment">% organize simulated data in data structure (move time to last)</span>
1031           tmpdata.labels=output_variables([2:length(output_variables)-num_fixed_variables 1]);
1032           <span class="keyword">for</span> i=1:length(output_variables)
1033             <span class="keyword">if</span> ~isempty(model.fixed_variables) &amp;&amp; isfield(model.fixed_variables,output_variables{i})
1034               <span class="comment">% store fixed variables in model substructure</span>
1035               model.fixed_variables.(output_variables{i})=outputs{i};
1036             <span class="keyword">else</span>
1037               <span class="comment">% store state variables and monitors as data fields</span>
1038               tmpdata.(output_variables{i})=outputs{i};
1039             <span class="keyword">end</span>
1040 
1041             outputs{i}=[]; <span class="comment">% clear assigned outputs from memory</span>
1042           <span class="keyword">end</span>
1043         <span class="keyword">end</span>
1044 
1045         <span class="keyword">if</span> options.verbose_flag
1046           fprintf(<span class="string">'Elapsed time: %g seconds.\n'</span>,duration);
1047         <span class="keyword">end</span>
1048 
1049         <span class="comment">% add metadata to tmpdata</span>
1050         tmpdata.simulator_options=options; <span class="comment">% store simulator controls</span>
1051 
1052         <span class="keyword">if</span> options.store_model_flag==1  <span class="comment">% optionally store the simulated model</span>
1053           tmpdata.model=model;
1054         <span class="keyword">end</span>
1055       <span class="keyword">end</span>
1056 
1057       tmpdata = <a href="../functions/internal/dsModifications2Vary.html" class="code" title="function data = dsModifications2Vary(data,modifications,options,modifications_set,sim)">dsModifications2Vary</a>(tmpdata,options.modifications,options,modifications_set,sim);
1058 
1059       <span class="keyword">if</span> (options.auto_gen_test_data_flag || options.unit_test_flag) &amp;&amp; isfield(tmpdata, <span class="string">'simulator_options'</span>)
1060         tmpdata= rmfield(tmpdata, <span class="string">'simulator_options'</span>);
1061       <span class="keyword">end</span>
1062 
1063       <span class="comment">% save single data set and update studyinfo</span>
1064       <span class="keyword">if</span> options.save_data_flag
1065         <a href="../functions/internal/dsExportData.html" class="code" title="function dsExportData(data,varargin)">dsExportData</a>(tmpdata,<span class="string">'filename'</span>,data_file,<span class="string">'format'</span>,<span class="string">'mat'</span>,<span class="string">'matCompatibility_flag'</span>,options.matCompatibility_flag,<span class="string">'verbose_flag'</span>,options.verbose_flag);
1066         <span class="comment">%studyinfo=dsUpdateStudy(studyinfo.study_dir,'process_id',sim_id,'status','finished','duration',duration,'solve_file',options.solve_file,'email',options.email,'verbose_flag',options.verbose_flag,'model',model,'simulator_options',options);</span>
1067       <span class="keyword">end</span>
1068 
1069       <span class="comment">% do post-simulation analysis and plotting</span>
1070       <span class="keyword">if</span> ~isempty(options.analysis_functions) || ~isempty(options.plot_functions)
1071         <span class="keyword">if</span> options.save_data_flag || options.save_results_flag
1072           <span class="comment">% do analysis and plotting while saving results</span>
1073           siminfo=studyinfo.simulations(sim_ind);
1074           <span class="keyword">for</span> f=1:length(siminfo.result_functions)
1075             tmpresult=<a href="dsAnalyze.html" class="code" title="function result = dsAnalyze(src,funcIn,varargin)">dsAnalyze</a>(tmpdata,siminfo.result_functions{f},<span class="string">'result_file'</span>,siminfo.result_files{f},<span class="string">'save_data_flag'</span>,1,<span class="string">'save_results_flag'</span>,1,siminfo.result_options{f}{:},<span class="string">'parallel_flag'</span>,options.parallel_flag);
1076 
1077             <span class="comment">% since the plots are saved, close all generated figures</span>
1078             <span class="keyword">if</span> all(ishandle(tmpresult))
1079               close(tmpresult);
1080             <span class="keyword">end</span>
1081           <span class="keyword">end</span>
1082         <span class="keyword">else</span>
1083           <span class="comment">% do analysis and plotting without saving results</span>
1084           <span class="keyword">if</span> ~isempty(options.analysis_functions) &amp;&amp; nargoutmain &gt; 2
1085             <span class="keyword">for</span> f=1:length(options.analysis_functions)
1086               tmpresult=<a href="dsAnalyze.html" class="code" title="function result = dsAnalyze(src,funcIn,varargin)">dsAnalyze</a>(tmpdata,options.analysis_functions{f},<span class="string">'result_file'</span>,[],<span class="string">'save_data_flag'</span>,0,<span class="string">'save_results_flag'</span>,options.save_results_flag,options.analysis_options{f}{:},<span class="string">'parallel_flag'</span>,options.parallel_flag);
1087             <span class="keyword">end</span>
1088           <span class="keyword">end</span>
1089 
1090           <span class="keyword">if</span> ~isempty(options.plot_functions)
1091             <span class="keyword">for</span> f=1:length(options.plot_functions)
1092               <a href="dsAnalyze.html" class="code" title="function result = dsAnalyze(src,funcIn,varargin)">dsAnalyze</a>(tmpdata,options.plot_functions{f},<span class="string">'result_file'</span>,[],<span class="string">'save_data_flag'</span>,0,<span class="string">'save_results_flag'</span>,options.save_results_flag,options.plot_options{f}{:},<span class="string">'parallel_flag'</span>,options.parallel_flag);
1093             <span class="keyword">end</span>
1094           <span class="keyword">end</span>
1095         <span class="keyword">end</span>
1096       <span class="keyword">end</span>
1097 
1098       <span class="keyword">if</span> nargoutmain&gt;0
1099         <a href="#_sub2" class="code" title="subfunction update_data">update_data</a>; <span class="comment">% concatenate data structures across simulations</span>
1100       <span class="keyword">end</span>
1101 
1102       <span class="keyword">if</span> nargoutmain&gt;2
1103         <a href="#_sub3" class="code" title="subfunction update_result">update_result</a>;
1104       <span class="keyword">end</span>
1105     <span class="keyword">end</span> <span class="comment">% end loop over sims</span>
1106 
1107     <a href="#_sub4" class="code" title="subfunction cleanup(status)">cleanup</a>(<span class="string">'success'</span>);
1108   <span class="keyword">end</span> <span class="comment">%tryfn</span>
1109 
1110   <a name="_sub2" href="#_subfunctions" class="code">function update_data</a>
1111     <span class="comment">% store tmpdata</span>
1112     <span class="keyword">if</span> sim==1
1113       <span class="comment">% replicate first data set as preallocation for all</span>
1114       data=repmat(tmpdata,[1 length(modifications_set)]);
1115       data_index=length(tmpdata);
1116     <span class="keyword">else</span>
1117       inds=data_index+(1:length(tmpdata)); <span class="comment">% support multiple data sets returned by experiments</span>
1118       data(inds)=tmpdata;
1119       data_index=inds(end);
1120     <span class="keyword">end</span>
1121   <span class="keyword">end</span>
1122 
1123   <a name="_sub3" href="#_subfunctions" class="code">function update_result</a>
1124     <span class="comment">% store tmpdata</span>
1125     <span class="keyword">if</span> sim==1
1126       <span class="comment">% replicate first data set as preallocation for all</span>
1127       result=repmat(tmpresult,[1 length(modifications_set)]);
1128       result_index=length(tmpresult);
1129     <span class="keyword">else</span>
1130       inds=data_index+(1:length(tmpresult)); <span class="comment">% support multiple data sets returned by experiments</span>
1131       result(inds)=tmpresult;
1132       result_index=inds(end);
1133     <span class="keyword">end</span>
1134   <span class="keyword">end</span>
1135 
1136   <a name="_sub4" href="#_subfunctions" class="code">function cleanup(status)</a>
1137     <span class="comment">% remove temporary files and optionally store info for debugging</span>
1138     <span class="comment">% ...</span>
1139     <span class="comment">% return to original directory</span>
1140     <span class="keyword">if</span> options.verbose_flag
1141       fprintf(<span class="string">'Changing directory to %s\n'</span>,cwd);
1142     <span class="keyword">end</span>
1143     cd(cwd);
1144     <span class="keyword">switch</span> status
1145       <span class="keyword">case</span> <span class="string">'success'</span>
1146         <span class="comment">% ...</span>
1147         <span class="comment">% TODO: consider removing solve folder if nothing being saved</span>
1148       <span class="keyword">case</span> <span class="string">'error'</span>
1149         <span class="comment">% ... error logs</span>
1150     <span class="keyword">end</span>
1151   <span class="keyword">end</span>
1152 
1153   <a name="_sub5" href="#_subfunctions" class="code">function all_ICs=ProcessNumericICs</a>
1154     <span class="comment">% first, figure out how many IC values we need (i.e., how many state</span>
1155     <span class="comment">% variables we need across all cells).</span>
1156     var_names=model.state_variables;
1157     [nvals_per_var,monitor_counts]=<a href="../functions/internal/dsGetOutputCounts.html" class="code" title="function [state_var_counts,monitor_counts] = dsGetOutputCounts(model)">dsGetOutputCounts</a>(model);
1158     num_state_variables=sum(nvals_per_var);
1159     <span class="comment">% check that the correct number of IC values was provided</span>
1160     <span class="keyword">if</span> length(options.ic)~=num_state_variables
1161       error(<span class="string">'incorrect number of initial conditions. %g values are needed for %g state variables across %g cells'</span>,num_state_variables,length(model.state_variables),sum(pop_sizes));
1162     <span class="keyword">end</span>
1163     <span class="comment">% organize user-supplied ICs into array for each state variable (assume</span>
1164     cnt=0; all_ICs=[];
1165     <span class="keyword">for</span> i=1:length(var_names)
1166       ICs=options.ic(cnt+(1:nvals_per_var(i)));
1167       <span class="comment">% store ICs as string for writing solve_ode and consistent evaluation</span>
1168       all_ICs.(var_names{i})=sprintf(<span class="string">'[%s]'</span>,num2str(ICs));
1169       cnt=cnt+nvals_per_var(i);
1170     <span class="keyword">end</span>
1171   <span class="keyword">end</span>
1172 
1173   <a name="_sub6" href="#_subfunctions" class="code">function logicalOut = is_varied_mech_list()</a>
1174     <span class="keyword">if</span> ~isempty(modifications_set{1})
1175       logicalOut = any(cellfun(@(x) strcmp(x{2},<span class="string">'mechanism_list'</span>),modifications_set));
1176     <span class="keyword">else</span>
1177       logicalOut = false;
1178     <span class="keyword">end</span>
1179   <span class="keyword">end</span>
1180 
1181   <a name="_sub7" href="#_subfunctions" class="code">function removeStudyinfo()</a>
1182     <span class="comment">% Problem: studyinfo file has many timestamps and absolute paths</span>
1183     <span class="comment">% Solution: remove studyinfo file</span>
1184     studyinfoFile = fullfile(options.study_dir, <span class="string">'studyinfo.mat'</span>);
1185     <span class="keyword">if</span> exist(studyinfoFile, <span class="string">'file'</span>)
1186       delete(studyinfoFile)
1187     <span class="keyword">end</span>
1188   <span class="keyword">end</span>
1189 
1190   <a name="_sub8" href="#_subfunctions" class="code">function renameMexFilesForUnitTesting()</a>
1191     <span class="comment">% Problem: different systems make different mex files, and mex files are</span>
1192     <span class="comment">%          different from simulation to simulation on same computer</span>
1193     <span class="comment">% Solution: rename extension to a general one, mex4unittest, and skip these</span>
1194     <span class="comment">%           files when testing</span>
1195 
1196     studyDirFiles = rls(options.study_dir);
1197     studyDirFiles = studyDirFiles(~cellfun(@isempty, strfind(studyDirFiles, <span class="string">'.mex'</span>)));
1198     <span class="keyword">for</span> k = 1:length(studyDirFiles)
1199       thisFile = studyDirFiles{k};
1200       renamedFile = regexprep(thisFile, <span class="string">'\.mex.+'</span>, <span class="string">'.mex4unittest'</span>);
1201       movefile(thisFile, renamedFile);
1202     <span class="keyword">end</span>
1203   <span class="keyword">end</span>
1204 
1205 <span class="keyword">end</span> <span class="comment">%main fn</span>
1206 
1207 
1208 <span class="comment">%% Subfunctions</span>
1209 <a name="_sub9" href="#_subfunctions" class="code">function [model,options]=extract_vary_statement(model,options)</a>
1210 <span class="comment">% Purpose: extract vary statement, remove from model, and set options.vary</span>
1211 <span class="keyword">if</span> ischar(model) &amp;&amp; any(regexp(model,<span class="string">';\s*vary\(.*\)'</span>,<span class="string">'once'</span>))
1212   <span class="comment">% extract vary statement</span>
1213   str=regexp(model,<span class="string">';\s*(vary\(.*\);?)'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
1214 
1215   <span class="comment">% remove from model</span>
1216   model=strrep(model,str{1},<span class="string">''</span>);
1217 
1218   <span class="comment">% set options</span>
1219   var=regexp(str{1},<span class="string">'\((.*)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>); <span class="comment">% variable</span>
1220   val=regexp(str{1},<span class="string">'=(.*)\)'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>); <span class="comment">% values</span>
1221   options.vary={<span class="string">'pop1'</span>,var{1},eval(val{1})};
1222 <span class="keyword">end</span>
1223 <span class="keyword">end</span>
1224 
1225 <a name="_sub10" href="#_subfunctions" class="code">function options = backward_compatibility(options)</a>
1226 <span class="comment">% option_names: (old_name, new_name; ...}</span>
1227 option_names = {<span class="keyword">...</span>
1228   <span class="string">'override'</span>,<span class="string">'modifications'</span>;
1229   <span class="string">'timelimits'</span>,<span class="string">'tspan'</span>;
1230   <span class="string">'time_limits'</span>,<span class="string">'tspan'</span>;
1231   <span class="string">'IC'</span>,<span class="string">'ic'</span>;
1232   <span class="string">'verbose'</span>,<span class="string">'verbose_flag'</span>;
1233   <span class="string">'SOLVER'</span>,<span class="string">'solver'</span>;
1234   <span class="string">'nofunctions'</span>,<span class="string">'reduce_function_calls_flag'</span>;
1235   <span class="string">'dsfact'</span>,<span class="string">'downsample_factor'</span>;
1236   <span class="string">'memlimit'</span>,<span class="string">'memory_limit'</span>;
1237   };
1238 
1239 <span class="keyword">if</span> any(ismember(option_names(:,1),options(1:2:end)))
1240   <span class="keyword">for</span> i=1:size(option_names,1)
1241     <span class="comment">% check if any options have this old name</span>
1242     <span class="keyword">if</span> ismember(option_names{i,1},options(1:2:end))
1243       ind=find(ismember(options(1:2:end),option_names{i,1}));
1244 
1245       <span class="comment">% replace old option name by new option name</span>
1246       options{2*ind-1}=option_names{i,2};
1247     <span class="keyword">end</span>
1248   <span class="keyword">end</span>
1249 <span class="keyword">end</span>
1250 
1251 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Tue 12-Dec-2017 11:32:10 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>