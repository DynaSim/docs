<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of calcCellProperties</title>
  <meta name="keywords" content="calcCellProperties">
  <meta name="description" content="CALCCELLPROPERTIES - calculates the intrinsic electrophysiological properties of all cells in one or more populations">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html functions --><!-- menu.html +ds -->
<h1>calcCellProperties
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>CALCCELLPROPERTIES - calculates the intrinsic electrophysiological properties of all cells in one or more populations</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function stats = calcCellProperties(data, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">CALCCELLPROPERTIES - calculates the intrinsic electrophysiological properties of all cells in one or more populations

 This is designed to be used in conjunction with the experiment
 ds.probeCellProperties which removes all connections from a model and produces
 a data array of simulated data in response to a series of hyperpolarizing and
 depolarizing pulses. This function is based on the DNSim experiment
 &quot;cell_pulses&quot;.

 Usage:
   stats = ds.calcCellProperties(data,'option1',option1,...)

 Inputs:
   - data: array of DynaSim data structures returned by ds.probeCellProperties

 Outputs:
   - stats.(pop).(measure) [1 x num_cells] (averaged over repetitions)
   - measures (intrinsic properties):
       RMP, V_thresh, R_in, tau_m, FI_slope, CV, AR24, AR_coefficient
       FR_min (threshrate), FR_min2 (steprate?), FR_max (steprate?)
     - AP morphology: AP_amp, AP_dur (spikewidth), AP_taur, AP_taud
                      Ih_relsag, Ih_abssag, hump, AHP_amp, AHP_dur
                      AHP_time2trough, ISI_median, AR23, AR13, ISI1,
                      min_ISI_median, ISI_step_median

 Algorithm walkthrough:
   From Iinj=0:
   RMP = (avg over 50-100% step | Iinj=0)

   From largest hyperpolarizing step:
   Ih Sag = (Vend-Vmin)/|RMP-Vend|
       where Vmin=(min voltage during T sec hyperpolarizing step)
             Vend=(V at end of hyperpolarizing step)
   Ih abs sag = (Vend-Vmin)

   From last subthreshold step:
   Hump = (Vmax-Vend)/|RMP-Vend|
       where Vmax=(max voltage during depolarizing step preceding spike)
             Vend=(V at end of step)

   Across hyperpolarizing subthreshold steps:
   Rin = Input resistence (I/V slope) [4]
   taum = Membrane time constant: time for voltage relaxation to (1/e)Vmax
     where Vmax=max deflection from baseline on hyperpolarizing steps
     note: avg taum's over small drives that keep active currents silent (eg, 5-15pA)

   Across suprathreshold steps with at least two spikes:
   FI slope [Hz/nA]: slope of f/I curve (firing freq vs injected current 0-140pA) (see [2])

   Across suprathreshold steps &gt;=60pA above first step with at least two spikes:
   AR coefficient: (slope of AR/I) where per step AR=ISI(1)/ISI(end)
   Note: AR = Adaptation ratio
   ISI_step_median = median ISI on step 60pA above first step w/ 2 spikes
   FR_step = mean FR on step 60pA above first step w/ 2 spikes
   ARif = max AR across steps &gt;=60pA above first step w/ 2 spikes

   From first suprathreshold T sec step:
   FRmin (threshrate) = (# spikes)/T

   From first suprathreshold T sec step with at least two spikes:
   FRmin2 (steprate?) = (# spikes)/T

   From first spike of first suprathreshold step: AP morphology
   Vthresh = V( crossing(dV/dt,20mV/ms) ) %10mV/ms) )
   AP_amp = (Vpeak-Vthresh)
   AP_taur = (time to rise from 10% to 90% between Vthresh and Vpeak)
   AP_taud = (time to decay from 10% to 90% between Vpeak and Vthresh)
   AP_dur (spikewidth) = (time between rising and falling (Vthresh+APamp/2) = (Vthresh+Vpeak)/2)
   AHP_amp = (Vbaseline-Vmin) where Vmin taken during repolarizing phase
   AHP_dur (AHP duration, half-width) = time between half-peak amplitude of AHP 
                                     = (time between falling and rising (Vbaseline+AHPamp/2))
   AHP_time2trough = (time between falling Vbaseline and AHPamp)
   ADPamp? ADPdur?

   From suprathreshold step 20pA above first step with at least two spikes:
   CV(ISIs over 30-100% step)

   From last suprathreshold T sec step (or step at amp=max (eg, 140pA)):
   FR_max (steprate?): (# spikes)/T
   min_ISI_median
   max_ISI
   AR24 = ISI(2)/ISI(4)

 References for methods used:
   [1] Steffensen, Scott C., et al. &quot;Electrophysiological characterization of
     GABAergic neurons in the ventral tegmental area.&quot; The Journal of
     neuroscience 18.19 (1998): 8003-8015.
   [2] Van Aerde, Karlijn I., et al. &quot;Flexible spike timing of layer 5 neurons
     during dynamic beta oscillation shifts in rat prefrontal cortex.&quot; The
     Journal of physiology 587.21 (2009): 5177-5196.
   [3] Connors, BW, MJ Gutnick, DA Prince. &quot;Electrophysiological properties of
     neocortical neurons in vitro.&quot; Journal of Neurophysiology 48.6 (1982):
     1302-1320.
   [4] Povysheva, Nadezhda V., et al. &quot;Parvalbumin-positive basket
     interneurons in monkey and rat prefrontal cortex.&quot; Journal of
     neurophysiology 100.4 (2008): 2348-2360.
   [5] Gonz?lez-Burgos, Guillermo, et al. &quot;Functional properties of fast
     spiking interneurons and their synaptic connections with pyramidal cells in
     primate dorsolateral prefrontal cortex.&quot; Journal of Neurophysiology 93.2
     (2005): 942-953.
   [6] Gorelova, Natalia, Jeremy K. Seamans, and Charles R. Yang. &quot;Mechanisms
     of dopamine activation of fast-spiking interneurons that exert inhibition
     in rat prefrontal cortex.&quot; Journal of neurophysiology 88.6 (2002):
     3150-3166.

 Example:
   data = ds.probeCellProperties(model)
   stats = ds.calcCellProperties(data)

 See also: ds.<a href="probeCellProperties.html" class="code" title="function data = probeCellProperties(model,varargin)">probeCellProperties</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="strrep.html" class="code" title="function str = strrep(str,oldstr,newstr,lpad,rpad, varargin)">strrep</a>	STRREP - replace full words by new character strings, ignoring matches that appear as sub-strings.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function stats = calcCellProperties(data, varargin)</a>
0002 <span class="comment">%CALCCELLPROPERTIES - calculates the intrinsic electrophysiological properties of all cells in one or more populations</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% This is designed to be used in conjunction with the experiment</span>
0005 <span class="comment">% ds.probeCellProperties which removes all connections from a model and produces</span>
0006 <span class="comment">% a data array of simulated data in response to a series of hyperpolarizing and</span>
0007 <span class="comment">% depolarizing pulses. This function is based on the DNSim experiment</span>
0008 <span class="comment">% &quot;cell_pulses&quot;.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Usage:</span>
0011 <span class="comment">%   stats = ds.calcCellProperties(data,'option1',option1,...)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% Inputs:</span>
0014 <span class="comment">%   - data: array of DynaSim data structures returned by ds.probeCellProperties</span>
0015 <span class="comment">%</span>
0016 <span class="comment">% Outputs:</span>
0017 <span class="comment">%   - stats.(pop).(measure) [1 x num_cells] (averaged over repetitions)</span>
0018 <span class="comment">%   - measures (intrinsic properties):</span>
0019 <span class="comment">%       RMP, V_thresh, R_in, tau_m, FI_slope, CV, AR24, AR_coefficient</span>
0020 <span class="comment">%       FR_min (threshrate), FR_min2 (steprate?), FR_max (steprate?)</span>
0021 <span class="comment">%     - AP morphology: AP_amp, AP_dur (spikewidth), AP_taur, AP_taud</span>
0022 <span class="comment">%                      Ih_relsag, Ih_abssag, hump, AHP_amp, AHP_dur</span>
0023 <span class="comment">%                      AHP_time2trough, ISI_median, AR23, AR13, ISI1,</span>
0024 <span class="comment">%                      min_ISI_median, ISI_step_median</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Algorithm walkthrough:</span>
0027 <span class="comment">%   From Iinj=0:</span>
0028 <span class="comment">%   RMP = (avg over 50-100% step | Iinj=0)</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%   From largest hyperpolarizing step:</span>
0031 <span class="comment">%   Ih Sag = (Vend-Vmin)/|RMP-Vend|</span>
0032 <span class="comment">%       where Vmin=(min voltage during T sec hyperpolarizing step)</span>
0033 <span class="comment">%             Vend=(V at end of hyperpolarizing step)</span>
0034 <span class="comment">%   Ih abs sag = (Vend-Vmin)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%   From last subthreshold step:</span>
0037 <span class="comment">%   Hump = (Vmax-Vend)/|RMP-Vend|</span>
0038 <span class="comment">%       where Vmax=(max voltage during depolarizing step preceding spike)</span>
0039 <span class="comment">%             Vend=(V at end of step)</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%   Across hyperpolarizing subthreshold steps:</span>
0042 <span class="comment">%   Rin = Input resistence (I/V slope) [4]</span>
0043 <span class="comment">%   taum = Membrane time constant: time for voltage relaxation to (1/e)Vmax</span>
0044 <span class="comment">%     where Vmax=max deflection from baseline on hyperpolarizing steps</span>
0045 <span class="comment">%     note: avg taum's over small drives that keep active currents silent (eg, 5-15pA)</span>
0046 <span class="comment">%</span>
0047 <span class="comment">%   Across suprathreshold steps with at least two spikes:</span>
0048 <span class="comment">%   FI slope [Hz/nA]: slope of f/I curve (firing freq vs injected current 0-140pA) (see [2])</span>
0049 <span class="comment">%</span>
0050 <span class="comment">%   Across suprathreshold steps &gt;=60pA above first step with at least two spikes:</span>
0051 <span class="comment">%   AR coefficient: (slope of AR/I) where per step AR=ISI(1)/ISI(end)</span>
0052 <span class="comment">%   Note: AR = Adaptation ratio</span>
0053 <span class="comment">%   ISI_step_median = median ISI on step 60pA above first step w/ 2 spikes</span>
0054 <span class="comment">%   FR_step = mean FR on step 60pA above first step w/ 2 spikes</span>
0055 <span class="comment">%   ARif = max AR across steps &gt;=60pA above first step w/ 2 spikes</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%   From first suprathreshold T sec step:</span>
0058 <span class="comment">%   FRmin (threshrate) = (# spikes)/T</span>
0059 <span class="comment">%</span>
0060 <span class="comment">%   From first suprathreshold T sec step with at least two spikes:</span>
0061 <span class="comment">%   FRmin2 (steprate?) = (# spikes)/T</span>
0062 <span class="comment">%</span>
0063 <span class="comment">%   From first spike of first suprathreshold step: AP morphology</span>
0064 <span class="comment">%   Vthresh = V( crossing(dV/dt,20mV/ms) ) %10mV/ms) )</span>
0065 <span class="comment">%   AP_amp = (Vpeak-Vthresh)</span>
0066 <span class="comment">%   AP_taur = (time to rise from 10% to 90% between Vthresh and Vpeak)</span>
0067 <span class="comment">%   AP_taud = (time to decay from 10% to 90% between Vpeak and Vthresh)</span>
0068 <span class="comment">%   AP_dur (spikewidth) = (time between rising and falling (Vthresh+APamp/2) = (Vthresh+Vpeak)/2)</span>
0069 <span class="comment">%   AHP_amp = (Vbaseline-Vmin) where Vmin taken during repolarizing phase</span>
0070 <span class="comment">%   AHP_dur (AHP duration, half-width) = time between half-peak amplitude of AHP</span>
0071 <span class="comment">%                                     = (time between falling and rising (Vbaseline+AHPamp/2))</span>
0072 <span class="comment">%   AHP_time2trough = (time between falling Vbaseline and AHPamp)</span>
0073 <span class="comment">%   ADPamp? ADPdur?</span>
0074 <span class="comment">%</span>
0075 <span class="comment">%   From suprathreshold step 20pA above first step with at least two spikes:</span>
0076 <span class="comment">%   CV(ISIs over 30-100% step)</span>
0077 <span class="comment">%</span>
0078 <span class="comment">%   From last suprathreshold T sec step (or step at amp=max (eg, 140pA)):</span>
0079 <span class="comment">%   FR_max (steprate?): (# spikes)/T</span>
0080 <span class="comment">%   min_ISI_median</span>
0081 <span class="comment">%   max_ISI</span>
0082 <span class="comment">%   AR24 = ISI(2)/ISI(4)</span>
0083 <span class="comment">%</span>
0084 <span class="comment">% References for methods used:</span>
0085 <span class="comment">%   [1] Steffensen, Scott C., et al. &quot;Electrophysiological characterization of</span>
0086 <span class="comment">%     GABAergic neurons in the ventral tegmental area.&quot; The Journal of</span>
0087 <span class="comment">%     neuroscience 18.19 (1998): 8003-8015.</span>
0088 <span class="comment">%   [2] Van Aerde, Karlijn I., et al. &quot;Flexible spike timing of layer 5 neurons</span>
0089 <span class="comment">%     during dynamic beta oscillation shifts in rat prefrontal cortex.&quot; The</span>
0090 <span class="comment">%     Journal of physiology 587.21 (2009): 5177-5196.</span>
0091 <span class="comment">%   [3] Connors, BW, MJ Gutnick, DA Prince. &quot;Electrophysiological properties of</span>
0092 <span class="comment">%     neocortical neurons in vitro.&quot; Journal of Neurophysiology 48.6 (1982):</span>
0093 <span class="comment">%     1302-1320.</span>
0094 <span class="comment">%   [4] Povysheva, Nadezhda V., et al. &quot;Parvalbumin-positive basket</span>
0095 <span class="comment">%     interneurons in monkey and rat prefrontal cortex.&quot; Journal of</span>
0096 <span class="comment">%     neurophysiology 100.4 (2008): 2348-2360.</span>
0097 <span class="comment">%   [5] Gonz?lez-Burgos, Guillermo, et al. &quot;Functional properties of fast</span>
0098 <span class="comment">%     spiking interneurons and their synaptic connections with pyramidal cells in</span>
0099 <span class="comment">%     primate dorsolateral prefrontal cortex.&quot; Journal of Neurophysiology 93.2</span>
0100 <span class="comment">%     (2005): 942-953.</span>
0101 <span class="comment">%   [6] Gorelova, Natalia, Jeremy K. Seamans, and Charles R. Yang. &quot;Mechanisms</span>
0102 <span class="comment">%     of dopamine activation of fast-spiking interneurons that exert inhibition</span>
0103 <span class="comment">%     in rat prefrontal cortex.&quot; Journal of neurophysiology 88.6 (2002):</span>
0104 <span class="comment">%     3150-3166.</span>
0105 <span class="comment">%</span>
0106 <span class="comment">% Example:</span>
0107 <span class="comment">%   data = ds.probeCellProperties(model)</span>
0108 <span class="comment">%   stats = ds.calcCellProperties(data)</span>
0109 <span class="comment">%</span>
0110 <span class="comment">% See also: ds.probeCellProperties</span>
0111 
0112 <span class="comment">% Check inputs</span>
0113 options=ds.checkOptions(varargin,{<span class="keyword">...</span>
0114   <span class="string">'spike_threshold'</span>,1e-5,[],<span class="keyword">...</span>
0115   <span class="string">'skip_time'</span>,10,[],<span class="keyword">...</span><span class="comment"> % time [ms] to exclude from detection</span>
0116   <span class="string">'plot_flag'</span>,0,{0,1},<span class="keyword">...</span>
0117   <span class="string">'equivalent_cells_flag'</span>,0,[],<span class="keyword">...</span><span class="comment"> % if true, only process one cell per pop</span>
0118   <span class="string">'auto_gen_test_data_flag'</span>,0,{0,1},<span class="keyword">...</span>
0119   },false);
0120 
0121 <span class="comment">%% auto_gen_test_data_flag argin</span>
0122 <span class="keyword">if</span> options.auto_gen_test_data_flag
0123   varargs = varargin;
0124   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0125   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0126   argin = [{data}, varargs]; <span class="comment">% specific to this function</span>
0127 <span class="keyword">end</span>
0128 
0129 data=ds.checkData(data, varargin{:});
0130 model=data(1).model;
0131 time=data(1).time;
0132 num_times=length(time);
0133 
0134 <span class="comment">% extract experiment parameters</span>
0135 experiment_options=data(1).simulator_options.experiment_options;
0136 
0137 <span class="comment">% stimulus timing</span>
0138 onset=experiment_options.onset; <span class="comment">%model.parameters.([pop_names{1} '_onset']);</span>
0139 offset=experiment_options.offset; <span class="comment">%model.parameters.([pop_names{1} '_offset']);</span>
0140 tsel=find(time&gt;=onset&amp;time&lt;=offset);
0141 
0142 <span class="comment">% assume exactly one simulation per amplitude</span>
0143 <span class="comment">% if num_steps ~= length(data)</span>
0144 <span class="comment">%   error('there can only be one simulation per stimulus amplitude');</span>
0145 <span class="comment">% end</span>
0146 
0147 <span class="comment">% extract population info</span>
0148 pop_names={model.specification.populations.name};
0149 num_pops=length(pop_names);
0150 
0151 <span class="comment">% set num_cells=1 if equivalent_cells_flag</span>
0152 <span class="keyword">if</span> experiment_options.equivalent_cells_flag==1
0153   pop_sizes=ones(1,num_pops);
0154 <span class="keyword">else</span>
0155   pop_sizes=[model.specification.populations.size];
0156 <span class="keyword">end</span>
0157 
0158 <span class="comment">% sort data by [data.(pop1)_TONIC] and sort amplitudes</span>
0159 [amplitudes,I]=sort([data.([pop_names{1} <span class="string">'_TONIC'</span>])]);
0160 data=data(I);
0161 num_steps=length(amplitudes);
0162 
0163 <span class="comment">% get list of variables to analyze</span>
0164 [vars,vars_pop]=ds.selectVariables(data(1).labels, varargin{:});
0165 
0166 <span class="comment">% assume only one variable per population</span>
0167 <span class="keyword">if</span> length(unique(vars_pop))&gt;num_pops
0168   [vars;vars_pop]
0169   error(<span class="string">'there can only be one variable per population.'</span>);
0170 <span class="keyword">end</span>
0171 
0172 <span class="comment">% collect pulses</span>
0173 <span class="comment">% input=zeros(num_times,num_steps);</span>
0174 <span class="comment">% for s=1:num_steps</span>
0175 <span class="comment">%   input(:,s)=data(s).([pop_names{1} '_pulse'])(:,1);</span>
0176 <span class="comment">% end</span>
0177 
0178 CF = (1e-6)/(1e-8);   <span class="comment">% pA/um^2 =&gt; uA/cm^2. note: 1um2=1e-8cm2, 1pA=1e-6uA</span>
0179 amplitudes_pA=amplitudes*experiment_options.membrane_area/CF;
0180 
0181 <span class="comment">% initialize stats structure</span>
0182 stats.experiment_options=experiment_options;
0183 stats.amplitudes=amplitudes;
0184 stats.time=time;
0185 stats.cell_results={}; <span class="comment">% list of field names storing results for each cell</span>
0186 stats.pop_results={};  <span class="comment">% list of field names storing results for each population</span>
0187 
0188 <span class="comment">% analyze each population</span>
0189 <span class="keyword">for</span> p=1:num_pops
0190   <span class="comment">% extract info for this population</span>
0191   pop=pop_names{p};
0192   this_var=vars{strcmp(vars_pop,pop)};
0193   num_cells=pop_sizes(p);
0194   <span class="comment">% preallocate intrinsic property measures (each will be an average over repetitions)</span>
0195   stats.(pop).RMP     =nan(1,num_cells);
0196   stats.(pop).V_thresh=nan(1,num_cells);
0197   stats.(pop).R_in    =nan(1,num_cells);
0198   stats.(pop).tau_m   =nan(1,num_cells);
0199   stats.(pop).FI_slope=nan(1,num_cells);
0200   stats.(pop).CV      =nan(1,num_cells);
0201   stats.(pop).ISI_median=nan(1,num_cells);
0202   stats.(pop).ISI_step_median=nan(1,num_cells);
0203   stats.(pop).min_ISI_median=nan(1,num_cells);
0204   stats.(pop).max_ISI=nan(1,num_cells);
0205   stats.(pop).AR13    =nan(1,num_cells);
0206   stats.(pop).AR23    =nan(1,num_cells);
0207   stats.(pop).AR24    =nan(1,num_cells);
0208   stats.(pop).ARif    =nan(1,num_cells);
0209   stats.(pop).AR_coeff=nan(1,num_cells);
0210   stats.(pop).ISI1    =nan(1,num_cells);
0211   stats.(pop).FR_min  =nan(1,num_cells);
0212   stats.(pop).FR_min2 =nan(1,num_cells);
0213   stats.(pop).FR_step =nan(1,num_cells);
0214   stats.(pop).FR_max  =nan(1,num_cells);
0215   stats.(pop).AP_amp  =nan(1,num_cells);
0216   stats.(pop).AP_dur  =nan(1,num_cells);
0217   stats.(pop).AP_taur =nan(1,num_cells);
0218   stats.(pop).AP_taud =nan(1,num_cells);
0219   stats.(pop).Ih_relsag  =nan(1,num_cells);
0220   stats.(pop).Ih_abssag=nan(1,num_cells);
0221   stats.(pop).hump    =nan(1,num_cells);
0222   stats.(pop).AHP_amp =nan(1,num_cells);
0223   stats.(pop).AHP_dur =nan(1,num_cells);
0224   stats.(pop).AHP_time2trough=nan(1,num_cells);
0225   <span class="comment">% determine whether cells are spiking or not on each step</span>
0226   spike_times=cell(num_steps,num_cells);
0227   <span class="keyword">for</span> c=1:num_cells
0228     <span class="keyword">for</span> s=1:num_steps
0229       <span class="comment">% select trace for this (pop,cell,step)</span>
0230       X=data(s).(this_var)(tsel,c);
0231       <span class="comment">% get spikes in this cell during step</span>
0232       spike_inds=1+find((X(2:end)&gt;=options.spike_threshold &amp; X(1:end-1)&lt;options.spike_threshold));
0233       spike_times{s,c}=time(tsel(spike_inds));
0234     <span class="keyword">end</span>
0235     num_spikes=cellfun(@numel,spike_times(:,c));
0236     is_spiking=(num_spikes&gt;0); <span class="comment">% {0:subthreshold,1:suprathreshold}</span>
0237 
0238     <span class="comment">% Calculate measures of cell intrinsic properties</span>
0239     <span class="comment">% 1) calculate RMP (avg over repetitions) From steps with amp=0</span>
0240     <span class="comment">% RMP = (avg over 50-100% step | Iinj=0)</span>
0241     step_sel=find(amplitudes==0); <span class="comment">% select all simulations with amp=0</span>
0242     time_sel=tsel(round(.5*numel(tsel)):end); <span class="comment">% select 50-100% of step</span>
0243     rmp=0;
0244     <span class="keyword">for</span> s=1:length(step_sel)
0245       rmp=rmp+nanmean(data(step_sel(s)).(this_var)(time_sel,c));
0246     <span class="keyword">end</span>
0247     stats.(pop).RMP(c)=rmp/length(step_sel);
0248 
0249     <span class="comment">% 2) calculate Ih_relsag (avg over repetitions) From largest hyperpolarizing step</span>
0250     <span class="comment">% Ih Sag = (Vend-Vmin)/|RMP-Vend|</span>
0251     <span class="comment">%     where Vmin=(min voltage during T sec hyperpolarizing step)</span>
0252     <span class="comment">%           Vend=(V at end of hyperpolarizing step)</span>
0253     step_sel=find(amplitudes==min(amplitudes) &amp; amplitudes&lt;0);
0254     sag=0; abssag=0;
0255     <span class="keyword">for</span> s=1:length(step_sel)
0256       V=data(step_sel(s)).(this_var)(:,c);
0257       bl=V(tsel(1)-1);   <span class="comment">% baseline value is point immediately before stim onset</span>
0258       Vend=V(tsel(end)); <span class="comment">% final point</span>
0259       Vmin=min(V(tsel)); <span class="comment">% minimum point of sag</span>
0260       sag=sag+((Vend-Vmin)/abs(bl-Vend));
0261       abssag=abssag+(Vend-Vmin);
0262       <span class="comment">%figure; plot(time,V); line(xlim,[Vmin Vmin]); line(xlim,[Vend Vend]); line(xlim,[bl bl]);</span>
0263     <span class="keyword">end</span>
0264     stats.(pop).Ih_relsag(c)=sag/length(step_sel);
0265     stats.(pop).Ih_abssag(c)=abssag/length(step_sel);
0266 
0267     <span class="comment">% 3) calculate hump (avg over repetitions) From last subthreshold step</span>
0268     <span class="comment">% Hump = (Vmax-Vend)/|RMP-Vend|</span>
0269     <span class="comment">%     where Vmax=(max voltage during depolarizing step preceding spike)</span>
0270     <span class="comment">%           Vend=(V at end of step)</span>
0271     step_sel=max(1,find(num_spikes&gt;0,1,<span class="string">'first'</span>)-1);
0272     <span class="keyword">if</span> ~isempty(step_sel)
0273       V=data(step_sel).(this_var)(:,c);
0274       bl=V(tsel(1)-1);   <span class="comment">% baseline value is point immediately before stim onset</span>
0275       Vend=V(tsel(end)); <span class="comment">% final point</span>
0276       Vmax=max(V(tsel)); <span class="comment">% maximum point of hump</span>
0277       stats.(pop).hump(c)=((Vmax-Vend)/abs(bl-Vend));
0278     <span class="keyword">end</span>
0279     
0280     <span class="comment">% 4) calculate (R_in,tau_m) (from avg over repetitions) Across hyperpolarizing subthreshold steps</span>
0281     <span class="comment">% Rin = Input resistence (I/V slope) [4]</span>
0282     <span class="comment">% taum = Membrane time constant: time for voltage relaxation to (1/e)Vmax</span>
0283     <span class="comment">%   where Vmax=max deflection from baseline on hyperpolarizing steps</span>
0284     <span class="comment">%   note: avg taum's over small drives that keep active currents silent (eg, 5-15pA)</span>
0285     step_sel=find(num_spikes==0 &amp; amplitudes'&lt;0);
0286     amps=amplitudes(step_sel);
0287     uamps=unique(amps);
0288     nuamps=length(uamps);
0289     Veq=nan(1,nuamps);
0290     taum=nan(1,nuamps);
0291     time_sel=tsel(round(.5*numel(tsel)):end); <span class="comment">% select 50-100% of step</span>
0292     <span class="comment">% loop over unique amplitudes</span>
0293     <span class="keyword">for</span> a=1:nuamps
0294       asel=find(amps==uamps(a)); <span class="comment">% indices to subthreshold amps with this value</span>
0295       <span class="comment">% loop over repetitions of the same amplitude</span>
0296       veq=0; tau=0;
0297       <span class="keyword">for</span> l=1:length(asel)
0298         step=step_sel(asel(l)); <span class="comment">% index to this simulation</span>
0299         X=data(step).(this_var)(:,c);
0300         <span class="comment">% store mean voltage over 50-100% step</span>
0301         veq=veq+nanmean(X(time_sel));
0302         <span class="comment">% calc membrane time constant based on this step (time to Vmax(1/e))</span>
0303         bl=X(tsel(1)-1); <span class="comment">% baseline value is point immediately before stim onset</span>
0304         V=X-bl; <span class="comment">% shift baseline to V=0</span>
0305         <span class="keyword">if</span> uamps(a)&lt;0
0306           V=abs(V); <span class="comment">% invert values so that deflection is positive</span>
0307         <span class="keyword">end</span>
0308         Vmax=V(tsel(end)); <span class="comment">% max is final point during stim period before offset</span>
0309         Vthresh=Vmax*(1/exp(1)); <span class="comment">% voltage at 1/e</span>
0310         Vdecay=V(tsel(end):end); <span class="comment">% voltage decay after stim offset</span>
0311         tthresh=time(tsel(end)+find(Vdecay&lt;Vthresh,1,<span class="string">'first'</span>)-1); <span class="comment">% time at which decay crosses 1/e</span>
0312         tau=tau+(tthresh-offset); <span class="comment">% time to drop to 1/e after stim offset</span>
0313       <span class="keyword">end</span>
0314       Veq(a)=veq/length(asel);
0315       <span class="keyword">if</span> any(tau)
0316         taum(a)=tau/length(asel);
0317       <span class="keyword">end</span>
0318     <span class="keyword">end</span>
0319     <span class="comment">% calc R_in (from slope of amp/Veq)</span>
0320     <span class="keyword">if</span> any(~isnan(Veq))
0321       sel=~isnan(Veq);
0322       P=polyfit(uamps(sel),Veq(sel),1);
0323       stats.(pop).R_in(c)=P(1);
0324     <span class="keyword">end</span>
0325     <span class="keyword">if</span> any(~isnan(taum))
0326       stats.(pop).tau_m(c)=taum(find(~isnan(taum),1,<span class="string">'first'</span>));<span class="comment">%1);%nanmedian(taum);</span>
0327     <span class="keyword">end</span>
0328 
0329     <span class="comment">% 5) calculate FI_slope (from avg over repetitions) Across suprathreshold steps with at least two spikes</span>
0330     <span class="comment">% FI slope: slope of f/I curve (firing freq vs injected current 0-140pA) (see [2])</span>
0331 <span class="comment">%     step_sel=find(num_spikes&gt;1 &amp; amplitudes'&gt;0);</span>
0332 <span class="comment">%     amps=amplitudes(step_sel);</span>
0333 <span class="comment">%     uamps=unique(amps);</span>
0334 <span class="comment">%     nuamps=length(uamps);</span>
0335 <span class="comment">%     FR=nan(1,nuamps);</span>
0336 <span class="comment">%     % loop over unique amplitudes</span>
0337 <span class="comment">%     for a=1:nuamps</span>
0338 <span class="comment">%       asel=find(amps==uamps(a)); % indices to subthreshold amps with this value</span>
0339 <span class="comment">%       % loop over repetitions of the same amplitude</span>
0340 <span class="comment">%       fr=0;</span>
0341 <span class="comment">%       for l=1:length(asel)</span>
0342 <span class="comment">%         step=step_sel(asel(l)); % index to this simulation</span>
0343 <span class="comment">%         fr=fr+(num_spikes(step)/((offset-onset)/1000));</span>
0344 <span class="comment">%       end</span>
0345 <span class="comment">%       FR(a)=fr/length(asel); % [Hz]</span>
0346 <span class="comment">%     end</span>
0347 <span class="comment">%     % calc FI_slope</span>
0348 <span class="comment">%     if any(~isnan(FR))</span>
0349 <span class="comment">%       sel=~isnan(FR);</span>
0350 <span class="comment">%       amps_nA=uamps(sel)*experiment_options.membrane_area/CF/1000;</span>
0351 <span class="comment">%       P=polyfit(amps_nA,FR(sel),1);</span>
0352 <span class="comment">%       stats.(pop).FI_slope(c)=P(1); % [Hz/nA]</span>
0353 <span class="comment">%       figure; plot(amps_nA,FR(sel)); xlabel('amps [nA]'); ylabel('FR [Hz]');</span>
0354 <span class="comment">%       [num_spikes(step_sel) amplitudes(step_sel)']</span>
0355 <span class="comment">%     end</span>
0356 
0357     <span class="comment">% 6) calculate ARs (avg over repetitions) &amp; AR_coefficient Across</span>
0358     <span class="comment">%    suprathreshold steps &gt;=60pA above first step with at least two spikes</span>
0359     <span class="comment">% AR coefficient: (slope of AR/I) where per step AR=ISI(1)/ISI(end)</span>
0360     thresh_step=find(num_spikes&gt;1,1,<span class="string">'first'</span>);
0361     <span class="keyword">if</span> any(thresh_step)
0362       step_sel=find(amplitudes_pA&gt;(amplitudes_pA(thresh_step)+60));
0363     <span class="keyword">else</span>
0364       step_sel=[];
0365     <span class="keyword">end</span>
0366     <span class="keyword">if</span> any(step_sel)
0367       amps=amplitudes(step_sel);
0368       uamps=unique(amps);
0369       nuamps=length(uamps);
0370       AR=nan(1,nuamps);
0371       FR=nan(1,nuamps);
0372       <span class="comment">% loop over unique amplitudes</span>
0373       <span class="keyword">for</span> a=1:nuamps
0374         asel=find(amps==uamps(a)); <span class="comment">% indices to subthreshold amps with this value</span>
0375         <span class="comment">% loop over repetitions of the same amplitude</span>
0376         ar=0; denom=0;
0377         fr=0;
0378         <span class="keyword">for</span> l=1:length(asel)
0379           step=step_sel(asel(l)); <span class="comment">% index to this simulation</span>
0380           fr=fr+(num_spikes(step)/((offset-onset)/1000));
0381           ISI=diff(spike_times{step,c});
0382           <span class="keyword">if</span> length(ISI)&gt;1
0383             denom=denom+1;
0384   <span class="comment">%           if length(ISI)&gt;2</span>
0385   <span class="comment">%             ar=ar+(ISI(2)/ISI(end));</span>
0386   <span class="comment">%           else</span>
0387               ar=ar+(ISI(1)/ISI(end));
0388   <span class="comment">%           end</span>
0389           <span class="keyword">end</span>
0390         <span class="keyword">end</span>
0391         AR(a)=ar/denom;
0392         FR(a)=fr/length(asel); <span class="comment">% [Hz]</span>
0393       <span class="keyword">end</span>
0394       <span class="comment">% calc ISI_median at 60pA above threshold</span>
0395       spikes=spike_times{step_sel(1),c};
0396       ISI=diff(spikes);
0397       stats.(pop).ISI_step_median(c)=median(ISI);
0398       <span class="comment">% store FR at 60pA above threshold</span>
0399       stats.(pop).FR_step(c)=FR(1); <span class="comment">% FR at 60pA above threshold</span>
0400       stats.(pop).ARif(c)=nanmax(AR); <span class="comment">% nanmean, nanmedian</span>
0401       <span class="comment">% calculate AR_coefficient</span>
0402       <span class="keyword">if</span> any(~isnan(AR))
0403         sel=~isnan(AR);
0404         P=polyfit(uamps(sel),AR(sel),1);
0405         stats.(pop).AR_coeff(c)=P(1);
0406         <span class="comment">%figure; plot(uamps(sel),AR(sel)); xlabel('amps'); ylabel('AR');</span>
0407       <span class="keyword">end</span>
0408       <span class="comment">% calc FI_slope</span>
0409       <span class="keyword">if</span> any(~isnan(FR))
0410         sel=~isnan(FR);
0411         amps_nA=uamps(sel)*experiment_options.membrane_area/CF/1000;
0412         P=polyfit(amps_nA,FR(sel),1);
0413         stats.(pop).FI_slope(c)=P(1); <span class="comment">% [Hz/nA]</span>
0414         <span class="comment">%figure; plot(amps_nA,FR(sel)); xlabel('amps [nA]'); ylabel('FR [Hz]');</span>
0415         <span class="comment">%[num_spikes(step_sel) amplitudes(step_sel)']</span>
0416       <span class="keyword">end</span>
0417     <span class="keyword">end</span>
0418     
0419     <span class="comment">% 7) calculate FR_min From first suprathreshold T sec step</span>
0420     <span class="comment">% FRmin (threshrate) = (# spikes)/T</span>
0421     step_sel=find(num_spikes&gt;0,1,<span class="string">'first'</span>);
0422     <span class="keyword">if</span> any(step_sel)
0423       stats.(pop).FR_min(c)=num_spikes(step_sel)/((offset-onset)/1000);
0424     <span class="keyword">end</span>
0425     
0426     <span class="comment">% 8) calculate FR_min2 From first suprathreshold T sec step with at least two spikes</span>
0427     <span class="comment">% FRmin2 (steprate?) = (# spikes)/T</span>
0428     step_sel=find(num_spikes&gt;1,1,<span class="string">'first'</span>);
0429     <span class="keyword">if</span> any(step_sel)
0430       stats.(pop).FR_min2(c)=num_spikes(step_sel)/((offset-onset)/1000);
0431       stats.(pop).ISI1(c)=(spike_times{step_sel,c}(2)-spike_times{step_sel,c}(1));
0432     <span class="keyword">end</span>
0433 
0434     <span class="comment">% 9) calculate CV (avg over repetitions) From suprathreshold step 20pA above first step with at least two spikes</span>
0435     <span class="comment">% CV(ISIs over 30-100% step)</span>
0436     tmin=time(tsel(round(.3*numel(tsel)))); <span class="comment">% time at 30% through step</span>
0437     thresh_step=find(num_spikes&gt;1,1,<span class="string">'first'</span>);
0438     <span class="keyword">if</span> any(thresh_step)
0439       step_sel=find(amplitudes_pA&gt;(amplitudes_pA(thresh_step)+20));
0440     <span class="keyword">else</span>
0441       step_sel=[];
0442     <span class="keyword">end</span>
0443     <span class="keyword">if</span> any(step_sel)
0444       spikes=spike_times{step_sel,c};
0445       spikes=spikes(spikes&gt;tmin);
0446       ISI=diff(spikes);
0447       <span class="keyword">if</span> any(ISI)
0448         stats.(pop).CV(c)=std(ISI)/mean(ISI);
0449       <span class="keyword">end</span>
0450       spikes=spike_times{step_sel,c};
0451       ISI=diff(spikes);
0452       stats.(pop).ISI_median(c)=median(ISI);
0453       stats.(pop).max_ISI(c)=max(ISI);
0454     <span class="keyword">end</span>
0455 
0456     <span class="comment">% 10) calculate (FRmax,AR24) From last suprathreshold T sec step</span>
0457     <span class="comment">% FRmax (steprate?): (# spikes)/T</span>
0458     <span class="comment">% AR24 = ISI(2)/ISI(4)</span>
0459     step_sel=find(num_spikes&gt;4,1,<span class="string">'last'</span>);
0460     <span class="keyword">if</span> any(step_sel)
0461       spikes=spike_times{step_sel,c};
0462       ISIs=diff(spikes)/1000;
0463       finst=1./(ISIs);
0464       stats.(pop).AR24(c)=finst(2)/finst(4);
0465 <span class="comment">%       stats.(pop).AR23(c)=ISIs(2)/ISIs(3);</span>
0466 <span class="comment">%       stats.(pop).AR13(c)=ISIs(1)/ISIs(3);</span>
0467       stats.(pop).FR_max(c)=num_spikes(step_sel)/((offset-onset)/1000);
0468       stats.(pop).min_ISI_median(c)=median(diff(spikes));
0469     <span class="keyword">end</span>
0470     step_sel=find(num_spikes&gt;3,1,<span class="string">'first'</span>);
0471     <span class="keyword">if</span> any(step_sel)
0472       spikes=spike_times{step_sel,c};
0473       ISIs=diff(spikes)/1000;
0474       stats.(pop).AR23(c)=ISIs(2)/ISIs(3);
0475       stats.(pop).AR13(c)=ISIs(1)/ISIs(3);
0476     <span class="keyword">end</span>
0477 
0478     <span class="comment">% 11) calculate AP morphology From first spike of first suprathreshold step with at least two spikes</span>
0479     step_sel=find(num_spikes&gt;0,1,<span class="string">'first'</span>);
0480     <span class="keyword">if</span> any(step_sel)
0481       X=double(data(step_sel).(this_var)(:,c));
0482       spks=spike_times{step_sel,c};
0483       spk_1=spks(1); <span class="comment">% time of first spike</span>
0484       <span class="keyword">if</span> length(spks)&gt;1
0485         spk_2=spks(2); <span class="comment">% time of second spike</span>
0486       <span class="keyword">else</span>
0487         spk_2=inf;
0488       <span class="keyword">end</span>
0489       pad=100; <span class="comment">% ms, time before and after spike detection (make longer than expected AHP)</span>
0490       spk_beg=max(spk_1-pad,onset);
0491       spk_end=min(spk_1+pad,spk_2); <span class="comment">% make sure spike interval excludes the following spike</span>
0492       spk_beg_i=nearest(time,spk_beg);
0493       spk_end_i=nearest(time,spk_end);
0494       spk_inds=spk_beg_i:spk_end_i; <span class="comment">% indices for this spike</span>
0495       t=time(spk_inds); <span class="comment">% times around spike</span>
0496       V=X(spk_inds);  <span class="comment">% trace around spike</span>
0497       <span class="comment">% Vthresh = V( crossing(dV/dt,10mV/ms) )</span>
0498       dVdt=diff(V)/(t(2)-t(1));
0499       dVdt=smooth(dVdt,round(1/(t(2)-t(1)))); <span class="comment">% 1ms smoothing</span>
0500       thresh_ind=find(dVdt&gt;20,1,<span class="string">'first'</span>);<span class="comment">%crossing(dVdt,t,10);</span>
0501       Vthresh=V(thresh_ind(1));
0502       <span class="comment">% APamp = (Vpeak-Vthresh)</span>
0503       [pk,loc]=findpeaks(V,<span class="string">'NPeaks'</span>,1);
0504       Vpeak=V(loc);<span class="comment">%max(V);</span>
0505       Vpeak_i=loc;<span class="comment">%find(V==Vpeak,1,'first');</span>
0506       APamp=Vpeak-Vthresh;
0507       V10=Vthresh+.1*APamp; <span class="comment">% 10% from Vthresh to Vpeak</span>
0508       V90=Vthresh+.9*APamp; <span class="comment">% 90% from Vthresh to Vpeak</span>
0509       <span class="comment">% depolarizing rising phase</span>
0510       V10_i_r=1+find(V(2:end)&gt;=V10 &amp; V(1:end-1)&lt;V10); <span class="comment">% first</span>
0511       V90_i_r=1+find(V(2:end)&gt;=V90 &amp; V(1:end-1)&lt;V90); <span class="comment">% second</span>
0512       <span class="comment">% APtaur = (time to rise from 10% to 90% between Vthresh and Vpeak)</span>
0513       <span class="keyword">if</span> any(V10_i_r) &amp;&amp; any(V90_i_r)
0514         APtaur=t(V90_i_r(1))-t(V10_i_r(1));
0515       <span class="keyword">else</span>
0516         APtaur=nan;
0517       <span class="keyword">end</span>
0518       <span class="comment">% repolarizing falling phase</span>
0519       V10_i_d=1+find(V(1:end-1)&gt;=V10 &amp; V(2:end)&lt;V10); <span class="comment">% second</span>
0520       V90_i_d=1+find(V(1:end-1)&gt;=V90 &amp; V(2:end)&lt;V90); <span class="comment">% first</span>
0521       <span class="keyword">if</span> numel(V10_i_d)&gt;1 &amp;&amp; numel(V10_i_d)&gt;1
0522         V10_i_d=V10_i_d(end);
0523         V90_i_d=V90_i_d(end);
0524       <span class="keyword">end</span>
0525       <span class="keyword">if</span> isempty(V10_i_d)
0526         <span class="comment">% set to the minimum point of the repolarizing phase</span>
0527         V10=min(V(Vpeak_i:end));
0528         V10_i_d=find(V(Vpeak_i:end)==V10)+Vpeak_i-1;
0529       <span class="keyword">end</span>
0530       <span class="comment">% APtaud = (time to decay from 10% to 90% between Vpeak and Vthresh)</span>
0531       <span class="keyword">if</span> any(V10_i_d) &amp;&amp; any(V90_i_d)
0532         APtaud=t(V10_i_d(1))-t(V90_i_d(1));
0533       <span class="keyword">else</span>
0534         APtaud=nan;
0535       <span class="keyword">end</span>
0536       <span class="comment">% APdur (spikewidth) = (time between rising and falling (Vthresh+APamp/2) = (Vthresh+Vpeak)/2)</span>
0537       V50=Vthresh+.5*APamp;
0538       V50_i_r=1+find(V(2:end)&gt;=V50 &amp; V(1:end-1)&lt;V50);
0539       V50_i_d=1+find(V(1:end-1)&gt;=V50 &amp; V(2:end)&lt;V50);
0540       <span class="keyword">if</span> any(V50_i_d) &amp;&amp; any(V50_i_r)
0541         APdur=t(V50_i_d(1))-t(V50_i_r(1));
0542       <span class="keyword">else</span>
0543         APdur=nan;
0544       <span class="keyword">end</span>
0545       <span class="comment">% AHPamp = (Vbaseline-Vmin) where Vmin taken during repolarizing phase</span>
0546       <span class="comment">%bl=X(spk_inds(1)-1); % baseline voltage</span>
0547       bl=mean(V);
0548       <span class="comment">% find trough: look for first peak in the inverted post-spike trace</span>
0549       [pk,loc]=findpeaks(-smooth(V(V10_i_d:end),100),<span class="string">'NPeaks'</span>,1);
0550       ahp_trough_i=V10_i_d+loc-1;
0551       Vmin=V(ahp_trough_i);
0552       <span class="comment">%Vmin=-findpeaks(-V(V10_i_d:end),'NPeaks',1);</span>
0553       <span class="comment">%Vmin=max(findpeaks(-V(V10_i_d:end)));</span>
0554       <span class="comment">%Vmin=min(V(V10_i_d:end));</span>
0555       AHPamp=abs(bl-Vmin);
0556       <span class="comment">% AHPdur (AHP duration, half-width) = time between half-peak amplitude of AHP</span>
0557       <span class="comment">%                                   = (time between falling and rising (Vbaseline+AHPamp/2))</span>
0558       ahp_V50=bl+.5*AHPamp;
0559       ahp_V50_i_d=1+find(V(1:end-1)&gt;=ahp_V50 &amp; V(2:end)&lt;ahp_V50); <span class="comment">% first</span>
0560       ahp_V50_i_d(ahp_V50_i_d&lt;V10_i_d)=[]; <span class="comment">% remove crossings before repolarization</span>
0561       ahp_V50_i_r=1+find(V(2:end)&gt;=ahp_V50 &amp; V(1:end-1)&lt;ahp_V50); <span class="comment">% second</span>
0562       <span class="keyword">if</span> any(ahp_V50_i_d)
0563         ahp_V50_i_r(ahp_V50_i_r&lt;ahp_V50_i_d(1))=[]; <span class="comment">% remove crossings before start of AHP</span>
0564       <span class="keyword">end</span>
0565       <span class="keyword">if</span> any(ahp_V50_i_r) &amp;&amp; any(ahp_V50_i_d)
0566         AHPdur=t(ahp_V50_i_r(1))-t(ahp_V50_i_d(1));
0567       <span class="keyword">else</span>
0568         AHPdur=nan;
0569       <span class="keyword">end</span>
0570       <span class="comment">% AHP_time2trough = (time between falling Vbaseline and Vmin)</span>
0571 <span class="comment">%       ahp_bl_i_d=1+find(V(1:end-1)&gt;=ahp_V50 &amp; V(2:end)&lt;ahp_V50); % first</span>
0572 <span class="comment">%       ahp_bl_i_d(ahp_bl_i_d&lt;V10_i_d)=[]; % remove crossings before repolarization</span>
0573       <span class="comment">%ahp_trough_i=find(V==Vmin);</span>
0574       <span class="comment">%ahp_trough_i(ahp_trough_i&lt;V10_i_d)=[]; % remove crossings before start</span>
0575       <span class="keyword">if</span> any(V10_i_d)
0576         AHPtime2trough=t(ahp_trough_i(1))-t(Vpeak_i);<span class="comment">%t(V10_i_d(1));</span>
0577         <span class="keyword">if</span> options.plot_flag
0578           figure; plot(t,V); 
0579           line(xlim,[V10 V10]); line(xlim,[Vmin Vmin]);
0580           line([t(ahp_trough_i(1)) t(ahp_trough_i(1))],ylim);
0581           line([t(Vpeak_i) t(Vpeak_i)],ylim,<span class="string">'color'</span>,<span class="string">'r'</span>);
0582         <span class="keyword">end</span>
0583       <span class="keyword">else</span>
0584         AHPtime2trough=nan;
0585       <span class="keyword">end</span>
0586       <span class="keyword">if</span> options.plot_flag
0587         figure; plot(t,V); 
0588         line(xlim,[bl bl]); 
0589         line(xlim,[Vthresh Vthresh]);
0590         line(xlim,[Vpeak Vpeak]);
0591         line(xlim,[V10 V10]); 
0592         line([t(V10_i_r(1)) t(V10_i_r(1))],ylim);
0593         line([t(V10_i_d(1)) t(V10_i_d(1))],ylim);
0594         line(xlim,[V50 V50]);
0595         line(xlim,[V90 V90]);
0596         line(xlim,[ahp_V50 ahp_V50],<span class="string">'color'</span>,<span class="string">'r'</span>); 
0597         line([t(ahp_V50_i_r(1)) t(ahp_V50_i_r(1))],ylim,<span class="string">'color'</span>,<span class="string">'r'</span>);
0598         line([t(ahp_V50_i_d(1)) t(ahp_V50_i_d(1))],ylim,<span class="string">'color'</span>,<span class="string">'r'</span>);
0599       <span class="keyword">end</span>
0600       stats.(pop).V_thresh(c)=Vthresh;
0601       stats.(pop).AP_amp(c)=APamp;
0602       stats.(pop).AP_taur(c)=APtaur;
0603       stats.(pop).AP_taud(c)=APtaud;
0604       stats.(pop).AP_dur(c)=APdur;
0605       stats.(pop).AHP_amp(c)=AHPamp;
0606       stats.(pop).AHP_dur(c)=AHPdur;
0607       stats.(pop).AHP_time2trough(c)=AHPtime2trough;
0608     <span class="keyword">end</span>
0609   <span class="keyword">end</span>
0610   <span class="comment">% collect data for this population across simulations</span>
0611   <span class="comment">% note: each simulation has a different input amplitude</span>
0612   X=zeros(num_steps,num_times,num_cells);
0613   <span class="keyword">for</span> s=1:num_steps
0614     X(s,:,:)=data(s).(this_var);
0615   <span class="keyword">end</span>
0616   <span class="comment">% calculate simple means</span>
0617   means=nanmean(X(:,tsel,:),2); <span class="comment">% average over select times</span>
0618   <span class="comment">% store means in stats structure</span>
0619   stats.([this_var <span class="string">'_mean_per_amp'</span>])=squeeze(means);
0620   stats.([this_var <span class="string">'_pop_mean_per_amp'</span>])=nanmean(means,3);
0621   stats.([this_var <span class="string">'_pop_mean_per_time'</span>])=nanmean(X,3);
0622 <span class="keyword">end</span>
0623 
0624 <span class="keyword">if</span> options.plot_flag
0625   v=1;
0626   figure(<span class="string">'position'</span>,[180 330 1450 530])
0627   subplot(2,2,1); <span class="comment">% V(t)</span>
0628   plot(time,stats.([vars{v} <span class="string">'_pop_mean_per_time'</span>]));
0629   xlabel(<span class="string">'time [ms]'</span>); ylabel([<span class="string">'&lt;'</span> <a href="strrep.html" class="code" title="function str = strrep(str,oldstr,newstr,lpad,rpad, varargin)">strrep</a>(vars{v},<span class="string">'_'</span>,<span class="string">'\_'</span>) <span class="string">', pop&gt;'</span>]);
0630   legend(cellfun(@(x)[<span class="string">'I='</span> num2str(x)],num2cell(amplitudes),<span class="string">'uni'</span>,0));
0631   subplot(2,2,3); <span class="comment">% I(t)</span>
0632   <span class="comment">%plot(time,input); xlabel('time [ms]'); ylabel('I(t)');</span>
0633   <span class="comment">%legend(cellfun(@(x)['I=' num2str(x)],num2cell(amplitudes),'uni',0));</span>
0634   subplot(2,2,2); <span class="comment">% I/V</span>
0635   plot(amplitudes,stats.([vars{v} <span class="string">'_mean_per_amp'</span>])); hold on
0636   plot(amplitudes,stats.([vars{v} <span class="string">'_pop_mean_per_amp'</span>]),<span class="string">'k-'</span>,<span class="string">'linewidth'</span>,5);
0637   xlabel(<span class="string">'amplitude'</span>); ylabel([<span class="string">'&lt;'</span> <a href="strrep.html" class="code" title="function str = strrep(str,oldstr,newstr,lpad,rpad, varargin)">strrep</a>(vars{v},<span class="string">'_'</span>,<span class="string">'\_'</span>) <span class="string">', time&gt;'</span>]);
0638 <span class="keyword">end</span>
0639 
0640 <span class="comment">%% auto_gen_test_data_flag argout</span>
0641 <span class="keyword">if</span> options.auto_gen_test_data_flag
0642   argout = {stats}; <span class="comment">% specific to this function</span>
0643   
0644   ds.unit.saveAutoGenTestData(argin, argout);
0645 <span class="keyword">end</span>
0646 
0647 <span class="keyword">end</span>
0648 
0649 
0650 <span class="comment">% check how Tallie calculated:</span>
0651 <span class="comment">% - threshrate (mean spike rate on tonic depol just above threshold)</span>
0652 <span class="comment">% - steprate (mean spike rate on final? step depol)</span>
0653 <span class="comment">% - AHP 5-20ms (Q: mean post-spike AHP amplitude over 5-20ms after trough?)</span>
0654 <span class="comment">% - SpikeAmp (same as [4])</span>
0655 <span class="comment">% - SpikeWidth (Spike width at half height) (same as [4])</span>
0656 <span class="comment">% - RMP</span>
0657 
0658 <span class="comment">% AHPtau (AHP duration, half-width) = time between half-peak amplitude of AHP</span>
0659 
0660 <span class="comment">% From Iinj=0:</span>
0661 <span class="comment">% RMP: resting membrane potential [mV] = avg V over step 150-500ms</span>
0662 
0663 <span class="comment">% From first spike:</span>
0664 <span class="comment">% Vthresh (spike threshold) [4]: level of voltage deflection exceeding 20mV/1ms %10mV/1ms</span>
0665 <span class="comment">% Peak amplitude [4]: (peak - threshold value)</span>
0666 <span class="comment">% Spike rise time [4]: time to rise from 10% to 90% of peak amplitude</span>
0667 <span class="comment">% Spike decay time [4]: time to decay from 10% to 90% of the amplitude b/w peak and spike threshold</span>
0668 <span class="comment">% Spike duration (half-width) [1,4]: &quot;time between half-peak amplitude for the falling and rising edges&quot;</span>
0669 
0670 <span class="comment">% Other measures from [4]:</span>
0671 <span class="comment">% Sag (Ih?) = (Vmin-Vend)/|RMP-Vend|</span>
0672 <span class="comment">%     where Vmin=(min voltage during 500ms hyperpolarizing step)</span>
0673 <span class="comment">%           Vend=(V at end of hyperpolarizing step)</span>
0674 <span class="comment">% Hump = (Vmax-Vend)/|RMP-Vend|</span>
0675 <span class="comment">%     where Vmax=(max voltage during depolarizing step preceding spike)</span>
0676 <span class="comment">%           Vend=(V at end of step)</span>
0677 <span class="comment">% Adaptation ratio AR = ISI1/ISIend = f(step amplitude)</span>
0678 <span class="comment">% AR coefficient = slope of (step amp, AR) for amp &gt; 60pA above spike threshold</span>
0679 <span class="comment">% Coefficient of variation CV of ISIs was measured from spikes during</span>
0680 <span class="comment">%   150-500ms at depolarizing pulse 20pA above spike threshold</span>
0681 
0682 <span class="comment">% Measures from [2]:</span>
0683 <span class="comment">% FR: calculate from total spikes elicited by 1sec current injection at 140pA (see [2])</span>
0684 <span class="comment">% AR24: Adaptation ratio: ratio of inst. freq of 2nd and 4th spike intervals in train (see [2])</span></pre></div>
<hr><address>Generated on Thu 18-May-2017 08:41:34 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>