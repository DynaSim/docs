<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of applyModifications</title>
  <meta name="keywords" content="applyModifications">
  <meta name="description" content="APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html functions --><!-- menu.html +ds -->
<h1>applyModifications
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [output,modifications] = applyModifications(model, modifications, varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure

 ds.applyModifications returns the same kind of structure with
 modifications applied. In all cases it first modifies the specification
 (model.specification if input is a model structure). Then it returns
 the modified specification or regenerates the model using the new
 specification.

 Inputs:
   - model: DynaSim model or specification structure
     - see ds.checkModel and ds.checkSpecification for details
   - modifications: modifications to make to specification structure
       {X,Y,Z; X,Y,Z; ...}
       X = population name or connection source-&gt;target
       Y = thing to modify ('name', 'size', or parameter name)
       set Y=Z if Y = name, size, or value
       Note: (X1,X2) or (Y1,Y2): modify these simultaneously in the same way

 Outputs:
   - TODO

 Examples:
   - modifying population size and parameters:
       modifications={'E','size',5; 'E','gNa',120};
       model=ds.applyModifications(model,modifications);

   - modifying mechanism_list:
       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','-iNa'});
       m.populations.mechanism_list
       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','+iCa'});
       m.populations.mechanism_list
       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','mechanism_list','+(iCa,iCan,CaBuffer)'});
       m.populations.mechanism_list

   - modifying equations (using special &quot;cat()&quot; operator or direct substitution)
       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','equations','cat(dv/dt,+I)'});
       m.populations.equations
       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','cat(I(t),+sin(2*pi*t))'});
       m.populations.equations
       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','dv/dt=10+@current'});
       m.populations.equations
       m.populations.mechanism_list

   - modifying equations with reserved keywords &quot;ODEn&quot; and &quot;FUNCTIONn&quot;
     - Note:
       'ODEn' = reserved keyword referencing the n-th ODE in equations
       'ODE' = aliases ODE1
       similarly: 'FUNCTIONn' and 'FUNCTION'

       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...
                            {'pop1','equations','cat(ODE,+I)'});
       m.populations.equations
       m=ds.applyModifications('dv/dt=10+@current; du/dt=-u; {iNa,iK}',...
                            {'pop1','equations','cat(ODE2,+I)'});
       m.populations.equations
       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...
                            {'pop1','equations','cat(FUNCTION,+sin(2*pi*t))'});
       m.populations.equations

 See also: ds.<a href="generateModel.html" class="code" title="function [model,name_map] = generateModel(specification, varargin)">generateModel</a>, dsSimulate, ds.<a href="vary2Modifications.html" class="code" title="function modifications_set = vary2Modifications(vary,model)">vary2Modifications</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="strrep.html" class="code" title="function str = strrep(str,oldstr,newstr,lpad,rpad, varargin)">strrep</a>	STRREP - replace full words by new character strings, ignoring matches that appear as sub-strings.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function modifications = standardize_modifications(modifications,specification, varargin)</a></li><li><a href="#_sub2" class="code">function spec = modify_specification(spec,mods, varargin)</a></li><li><a href="#_sub3" class="code">function modifications=backward_compatibility(modifications)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [output,modifications] = applyModifications(model, modifications, varargin)</a>
0002 <span class="comment">%APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% ds.applyModifications returns the same kind of structure with</span>
0005 <span class="comment">% modifications applied. In all cases it first modifies the specification</span>
0006 <span class="comment">% (model.specification if input is a model structure). Then it returns</span>
0007 <span class="comment">% the modified specification or regenerates the model using the new</span>
0008 <span class="comment">% specification.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% Inputs:</span>
0011 <span class="comment">%   - model: DynaSim model or specification structure</span>
0012 <span class="comment">%     - see ds.checkModel and ds.checkSpecification for details</span>
0013 <span class="comment">%   - modifications: modifications to make to specification structure</span>
0014 <span class="comment">%       {X,Y,Z; X,Y,Z; ...}</span>
0015 <span class="comment">%       X = population name or connection source-&gt;target</span>
0016 <span class="comment">%       Y = thing to modify ('name', 'size', or parameter name)</span>
0017 <span class="comment">%       set Y=Z if Y = name, size, or value</span>
0018 <span class="comment">%       Note: (X1,X2) or (Y1,Y2): modify these simultaneously in the same way</span>
0019 <span class="comment">%</span>
0020 <span class="comment">% Outputs:</span>
0021 <span class="comment">%   - TODO</span>
0022 <span class="comment">%</span>
0023 <span class="comment">% Examples:</span>
0024 <span class="comment">%   - modifying population size and parameters:</span>
0025 <span class="comment">%       modifications={'E','size',5; 'E','gNa',120};</span>
0026 <span class="comment">%       model=ds.applyModifications(model,modifications);</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%   - modifying mechanism_list:</span>
0029 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0030 <span class="comment">%                            {'pop1','mechanism_list','-iNa'});</span>
0031 <span class="comment">%       m.populations.mechanism_list</span>
0032 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0033 <span class="comment">%                            {'pop1','mechanism_list','+iCa'});</span>
0034 <span class="comment">%       m.populations.mechanism_list</span>
0035 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0036 <span class="comment">%                            {'pop1','mechanism_list','+(iCa,iCan,CaBuffer)'});</span>
0037 <span class="comment">%       m.populations.mechanism_list</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%   - modifying equations (using special &quot;cat()&quot; operator or direct substitution)</span>
0040 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0041 <span class="comment">%                            {'pop1','equations','cat(dv/dt,+I)'});</span>
0042 <span class="comment">%       m.populations.equations</span>
0043 <span class="comment">%       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0044 <span class="comment">%                            {'pop1','equations','cat(I(t),+sin(2*pi*t))'});</span>
0045 <span class="comment">%       m.populations.equations</span>
0046 <span class="comment">%       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0047 <span class="comment">%                            {'pop1','equations','dv/dt=10+@current'});</span>
0048 <span class="comment">%       m.populations.equations</span>
0049 <span class="comment">%       m.populations.mechanism_list</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%   - modifying equations with reserved keywords &quot;ODEn&quot; and &quot;FUNCTIONn&quot;</span>
0052 <span class="comment">%     - Note:</span>
0053 <span class="comment">%       'ODEn' = reserved keyword referencing the n-th ODE in equations</span>
0054 <span class="comment">%       'ODE' = aliases ODE1</span>
0055 <span class="comment">%       similarly: 'FUNCTIONn' and 'FUNCTION'</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; {iNa,iK}',...</span>
0058 <span class="comment">%                            {'pop1','equations','cat(ODE,+I)'});</span>
0059 <span class="comment">%       m.populations.equations</span>
0060 <span class="comment">%       m=ds.applyModifications('dv/dt=10+@current; du/dt=-u; {iNa,iK}',...</span>
0061 <span class="comment">%                            {'pop1','equations','cat(ODE2,+I)'});</span>
0062 <span class="comment">%       m.populations.equations</span>
0063 <span class="comment">%       m=ds.applyModifications('dv/dt=I(t)+@current; I(t)=10; {iNa,iK}',...</span>
0064 <span class="comment">%                            {'pop1','equations','cat(FUNCTION,+sin(2*pi*t))'});</span>
0065 <span class="comment">%       m.populations.equations</span>
0066 <span class="comment">%</span>
0067 <span class="comment">% See also: ds.generateModel, dsSimulate, ds.vary2Modifications</span>
0068 
0069 <span class="comment">%% localfn output</span>
0070 <span class="keyword">if</span> ~nargin
0071   output = localfunctions;
0072   <span class="keyword">return</span>
0073 <span class="keyword">end</span>
0074 
0075 <span class="comment">%% auto_gen_test_data_flag argin</span>
0076 options = ds.checkOptions(varargin,{<span class="string">'auto_gen_test_data_flag'</span>,0,{0,1}},false);
0077 <span class="keyword">if</span> options.auto_gen_test_data_flag
0078   varargs = varargin;
0079   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0080   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0081   argin = [{model},{modifications}, varargs]; <span class="comment">% specific to this function</span>
0082 <span class="keyword">end</span>
0083 
0084 <span class="comment">%%</span>
0085 <span class="comment">% check for modifications</span>
0086 <span class="keyword">if</span> isempty(modifications)
0087   <span class="comment">% nothing to do</span>
0088   output = model;
0089   <span class="keyword">return</span>;
0090 <span class="keyword">end</span>
0091 
0092 <span class="comment">% check input type</span>
0093 <span class="keyword">if</span> ~isfield(model,<span class="string">'state_variables'</span>)
0094   ismodel = 0;
0095 <span class="keyword">else</span>
0096   ismodel = 1;
0097 <span class="keyword">end</span>
0098 
0099 <span class="comment">% check specification</span>
0100 <span class="keyword">if</span> ismodel
0101   specification=ds.checkSpecification(model.specification, varargin{:});
0102 <span class="keyword">else</span>
0103   specification=ds.checkSpecification(model, varargin{:});
0104 <span class="keyword">end</span>
0105 
0106 <span class="comment">% update specification with whatever is in modifications</span>
0107 modifications = <a href="#_sub1" class="code" title="subfunction modifications = standardize_modifications(modifications,specification, varargin)">standardize_modifications</a>(modifications,specification,varargin{:});
0108 <span class="keyword">if</span> ismodel <span class="comment">% TODO: test this</span>
0109   specification = <a href="#_sub2" class="code" title="subfunction spec = modify_specification(spec,mods, varargin)">modify_specification</a>(specification,modifications,varargin{:});
0110 <span class="keyword">end</span>
0111 
0112 <span class="comment">% update model if input was a model structure</span>
0113 <span class="keyword">if</span> ismodel
0114   output=ds.generateModel(specification);
0115 <span class="keyword">else</span>
0116   output = specification;
0117 <span class="keyword">end</span>
0118 
0119 
0120 <span class="comment">%% auto_gen_test_data_flag argout</span>
0121 <span class="keyword">if</span> options.auto_gen_test_data_flag
0122   argout = {output, modifications}; <span class="comment">% specific to this function</span>
0123   
0124   ds.unit.saveAutoGenTestData(argin, argout);
0125 <span class="keyword">end</span>
0126 
0127 <span class="keyword">end</span>
0128 
0129 <a name="_sub1" href="#_subfunctions" class="code">function modifications = standardize_modifications(modifications,specification, varargin)</a>
0130 <span class="comment">% convert all modifications into 3-column cell matrix format</span>
0131 <span class="comment">% (namespace,variable,value)</span>
0132 
0133 <span class="comment">% 1. modifications structure</span>
0134 <span class="comment">% 2. partial specification structure</span>
0135 
0136 <span class="comment">%% auto_gen_test_data_flag argin</span>
0137 options = ds.checkOptions(varargin,{<span class="string">'auto_gen_test_data_flag'</span>,0,{0,1}},false);
0138 <span class="keyword">if</span> options.auto_gen_test_data_flag
0139   varargs = varargin;
0140   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0141   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0142   argin = [{modifications},{specification}, varargs]; <span class="comment">% specific to this function</span>
0143 <span class="keyword">end</span>
0144 
0145 <span class="keyword">if</span> isstruct(modifications)
0146   <span class="comment">% TODO</span>
0147   <span class="comment">% convert structure to cell matrix</span>
0148   <span class="comment">% ...</span>
0149 <span class="keyword">end</span>
0150 
0151 <span class="comment">% check backward compatibility</span>
0152 modifications=<a href="#_sub3" class="code" title="subfunction modifications=backward_compatibility(modifications)">backward_compatibility</a>(modifications);
0153 
0154 <span class="comment">% check for empty object specification</span>
0155 missing_objects=find(cellfun(@isempty,modifications(:,1)));
0156 <span class="keyword">if</span> any(missing_objects)
0157   <span class="comment">% set to default population name</span>
0158   <span class="keyword">for</span> i=1:length(missing_objects)
0159     modifications{missing_objects(i),1}=specification.populations(1).name;<span class="comment">%'pop1';</span>
0160   <span class="keyword">end</span>
0161 <span class="keyword">end</span>
0162 
0163 <span class="comment">% support modifying multiple elements (of namespace or variable) simultaneously</span>
0164 <span class="comment">% approach -- add extra entry for each thing to modify</span>
0165 <span class="comment">% eg) expand {'(E,I)','Cm',2} to {'E','Cm',2; 'I','Cm',2}</span>
0166 <span class="comment">% note: should be able to support {'(E,I)','(EK,EK2)',-80}</span>
0167 <span class="keyword">if</span> any(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'^\(.*\)$'</span>))) || <span class="keyword">...</span>
0168    any(~cellfun(@isempty,regexp(modifications(:,2),<span class="string">'^\(.*\)$'</span>)))
0169  
0170   <span class="comment">% loop over modifications</span>
0171   modifications_={};
0172   <span class="keyword">for</span> i=1:size(modifications,1)
0173     <span class="comment">% check namespace for ()</span>
0174     namespaces=regexp(modifications{i,1},<span class="string">'[\w\.\-&lt;&gt;]+'</span>,<span class="string">'match'</span>);
0175     
0176     <span class="comment">% check variable for ()</span>
0177     variables=regexp(modifications{i,2},<span class="string">'[\w\.-]+'</span>,<span class="string">'match'</span>);
0178     
0179     <span class="comment">% check size of values matches number of namespaces, variables</span>
0180     <span class="keyword">if</span> isscalar(modifications{i,3}) <span class="comment">% in case number of values is one</span>
0181         modifications{i,3} = repmat(modifications{i,3},length(variables),length(namespaces));
0182     <span class="keyword">elseif</span> size(modifications{i,3},1) ~= length(variables) || size(modifications{i,3},2) ~= length(namespaces)
0183         <span class="comment">% in case values is number of variables x 1</span>
0184         <span class="keyword">if</span> size(modifications{i,3},1) == length(variables) &amp;&amp; size(modifications{i,3},2) == 1
0185             modifications{i,3} = repmat(modifications{i,3},1,length(namespaces));
0186         <span class="comment">% in case values is 1 x number of namespaces</span>
0187         <span class="keyword">elseif</span> size(modifications{i,3},2) == length(namespaces) &amp;&amp; size(modifications{i,3},1) == 1
0188             modifications{i,3} = repmat(modifications{i,3},length(variables),1);
0189         <span class="comment">% TODO: char inputs</span>
0190         <span class="comment">% elseif ischar(modifications{i,3})</span>
0191           <span class="comment">% string input</span>
0192         <span class="keyword">else</span>
0193             error([<span class="string">'Numerical values varied over must be in array format,'</span>,<span class="keyword">...</span>
0194                 <span class="string">'where dimensions 1, 2, and 3 correspond to mechanisms, values, and populations varied over.'</span>])
0195         <span class="keyword">end</span>
0196     <span class="keyword">end</span>
0197     
0198     <span class="comment">% expand list of modifications</span>
0199     <span class="keyword">for</span> j=1:length(namespaces)
0200       <span class="keyword">for</span> k=1:length(variables)
0201         modifications_(end+1,1:3)={namespaces{j},variables{k},modifications{i,3}(k,j)};
0202       <span class="keyword">end</span>
0203     <span class="keyword">end</span>
0204   <span class="keyword">end</span>
0205   modifications=modifications_;
0206 <span class="keyword">end</span>
0207 
0208 <span class="comment">%% auto_gen_test_data_flag argout</span>
0209 <span class="keyword">if</span> options.auto_gen_test_data_flag
0210   argout = {modifications}; <span class="comment">% specific to this function</span>
0211   
0212   ds.unit.saveAutoGenTestDataLocalFn(argin, argout); <span class="comment">% localfn</span>
0213 <span class="keyword">end</span>
0214 
0215 <span class="keyword">end</span>
0216 
0217 
0218 <a name="_sub2" href="#_subfunctions" class="code">function spec = modify_specification(spec,mods, varargin)</a>
0219 <span class="comment">%% auto_gen_test_data_flag argin</span>
0220 options = ds.checkOptions(varargin,{<span class="string">'auto_gen_test_data_flag'</span>,0,{0,1}},false);
0221 <span class="keyword">if</span> options.auto_gen_test_data_flag
0222   varargs = varargin;
0223   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0224   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0225   argin = [{spec},{mods}, varargs]; <span class="comment">% specific to this function</span>
0226 <span class="keyword">end</span>
0227 
0228 precision=8; <span class="comment">% number of digits allowed for user-supplied values</span>
0229 predefined_variables={<span class="string">'name'</span>,<span class="string">'size'</span>,<span class="string">'parameters'</span>,<span class="string">'mechanism_list'</span>,<span class="string">'equations'</span>};
0230 pop_names={spec.populations.name};
0231 <span class="keyword">if</span> ~isempty(spec.connections)
0232   con_names=arrayfun(@(x)[x.source <span class="string">'-&gt;'</span> x.target],spec.connections,<span class="string">'uni'</span>,0);
0233 <span class="keyword">else</span>
0234   con_names=[];
0235 <span class="keyword">end</span>
0236 
0237 <span class="comment">% loop over modifications to apply</span>
0238 <span class="keyword">for</span> i=1:size(mods,1)
0239   obj=mods{i,1}; <span class="comment">% population name or connection source-target</span>
0240   fld=mods{i,2}; <span class="comment">% population name, size, or parameter name</span>
0241   
0242   <span class="keyword">if</span> ~ischar(obj)
0243     error(<span class="string">'modification must be applied to population name or connection source-target'</span>);
0244   <span class="keyword">end</span>
0245   
0246   <span class="keyword">if</span> ~ischar(fld) <span class="comment">%|| ~ismember(fld,{'name','size','parameters','mechanism_list','equations'})</span>
0247     error(<span class="string">'modification must be applied to population ''name'',''size'',or a parameter referenced by its name'</span>);
0248   <span class="keyword">end</span>
0249   
0250   <span class="comment">% standardize connection object: convert target&lt;-source to source-&gt;target</span>
0251   <span class="keyword">if</span> any(strfind(obj,<span class="string">'&lt;-'</span>))
0252     ind=strfind(obj,<span class="string">'&lt;-'</span>);
0253     obj=[obj(ind(1)+2:end) <span class="string">'-&gt;'</span> obj(1:ind(1)-1)];
0254   <span class="keyword">end</span>
0255   
0256   val=mods{i,3}; <span class="comment">% value for population name or size, or parameter to modify</span>
0257   <span class="keyword">if</span> ismember(obj,pop_names)
0258     type=<span class="string">'populations'</span>;
0259     names=pop_names;
0260   <span class="keyword">elseif</span> ismember(obj,con_names)
0261     type=<span class="string">'connections'</span>;
0262     names=con_names;
0263   <span class="keyword">else</span>
0264     warning(<span class="string">'name of object to modify not found in populations or connections.'</span>);
0265     <span class="keyword">continue</span>
0266   <span class="keyword">end</span>
0267   
0268   index=ismember(names,obj);
0269   
0270   <span class="keyword">if</span> strcmp(fld,<span class="string">'mechanism_list'</span>)
0271     <span class="comment">% support --</span>
0272     <span class="comment">% 'E'    'mechanism_list'    '(iNa,iK)'</span>
0273     <span class="comment">% 'E'    'mechanism_list'    '-(iNa,iK)'</span>
0274     <span class="comment">% 'E'    'mechanism_list'    '+(iK)'</span>
0275     <span class="comment">% 'E'    'mechanism_list'    '+iK'</span>
0276     <span class="comment">% 'E'    'mechanism_list'    'iK'</span>
0277     
0278     elems=regexp(val,<span class="string">'[\w@]+'</span>,<span class="string">'match'</span>);
0279     
0280     <span class="keyword">if</span> strcmp(val(1),<span class="string">'+'</span>)
0281       <span class="comment">% add mechanisms to existing list</span>
0282       spec.(type)(index).mechanism_list=unique(cat(2,spec.(type)(index).mechanism_list,elems),<span class="string">'stable'</span>);
0283     <span class="keyword">elseif</span> strcmp(val(1),<span class="string">'-'</span>)
0284       <span class="comment">% remove mechanisms from existing list</span>
0285       spec.(type)(index).mechanism_list=setdiff(spec.(type)(index).mechanism_list,elems,<span class="string">'stable'</span>);
0286     <span class="keyword">else</span>
0287       <span class="comment">% redefine mechanism list</span>
0288       spec.(type)(index).mechanism_list=elems;
0289     <span class="keyword">end</span>
0290   <span class="keyword">elseif</span> strcmp(fld,<span class="string">'equations'</span>) &amp;&amp; ~isempty(regexp(val,<span class="string">'^cat('</span>,<span class="string">'once'</span>))
0291     <span class="comment">% process special case: cat(TARGET,EXPRESSION)</span>
0292     eqns=spec.(type)(index).equations;
0293     args=regexp(val,<span class="string">'cat\((.+)\)'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0294     ind=find(args{1}==<span class="string">','</span>,1,<span class="string">'first'</span>);
0295     target=args{1}(1:ind-1);
0296     expression=args{1}(ind+1:end);
0297 <span class="comment">%     args=regexp(args{1},',','split');</span>
0298 <span class="comment">%     target=args{1};</span>
0299 <span class="comment">%     expression=args{2};</span>
0300     <span class="comment">% support keywords: ODEn, ODE=ODE1, FUNCTIONn, FUNCTION=FUNCTION1</span>
0301     <span class="keyword">if</span> strncmp(<span class="string">'ODE'</span>,target,3)
0302       <span class="comment">% support target = ODEn and ODE=ODE1</span>
0303       <span class="comment">% replace target by n-th ODE LHS</span>
0304       lines=cellfun(@strtrim,strsplit(eqns,<span class="string">';'</span>),<span class="string">'uni'</span>,0); <span class="comment">% split equations into statements</span>
0305       lines=lines(~cellfun(@isempty,lines)); <span class="comment">% eliminate empty elements</span>
0306       pattern=<span class="string">'^((\w+'')|(d\w+/dt))\s*='</span>; <span class="comment">% pattern for ODEs</span>
0307       inds=regexp(lines,pattern,<span class="string">'once'</span>); <span class="comment">% indices to ODE statements</span>
0308       inds=find(~cellfun(@isempty,inds));
0309       <span class="comment">% get index to the ODE statement to modify</span>
0310       <span class="keyword">if</span> strcmp(target,<span class="string">'ODE'</span>)
0311         ind=inds(1);
0312       <span class="keyword">else</span>
0313         n=str2num(target(4:end));
0314         ind=inds(n);
0315       <span class="keyword">end</span>
0316       <span class="comment">% get LHS of ODE</span>
0317       <span class="comment">%LHS=regexp(lines{ind},'^(.+)=','tokens','once');</span>
0318       LHS=regexp(lines{ind},<span class="string">'^([^=]+)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0319       target=LHS{1};
0320     <span class="keyword">elseif</span> strncmp(<span class="string">'FUNCTION'</span>,target,8)
0321       <span class="comment">% support target = FUNCTIONn and FUNCTION=FUNCTION1</span>
0322       <span class="comment">% replace target by n-th FUNCTION LHS</span>
0323       lines=cellfun(@strtrim,strsplit(eqns,<span class="string">';'</span>),<span class="string">'uni'</span>,0); <span class="comment">% split equations into statements</span>
0324       lines=lines(~cellfun(@isempty,lines)); <span class="comment">% eliminate empty elements</span>
0325       pattern=<span class="string">'^\w+\([a-zA-Z][\w,]*\)\s*='</span>; <span class="comment">% pattern for functions</span>
0326       inds=regexp(lines,pattern,<span class="string">'once'</span>); <span class="comment">% indices to function statements</span>
0327       inds=find(~cellfun(@isempty,inds));
0328       
0329       <span class="comment">% get index to the function statement to modify</span>
0330       <span class="keyword">if</span> strcmp(target,<span class="string">'FUNCTION'</span>)
0331         ind=inds(1);
0332       <span class="keyword">else</span>
0333         n=str2num(target(9:end));
0334         ind=inds(n);
0335       <span class="keyword">end</span>
0336       <span class="comment">% get LHS of ODE</span>
0337       <span class="comment">%LHS=regexp(lines{ind},'^(.+)=','tokens','once');</span>
0338       LHS=regexp(lines{ind},<span class="string">'^([^=]+)='</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0339       target=LHS{1};
0340     <span class="keyword">end</span>
0341     <span class="comment">% add escape character for using regular expression to match function statements</span>
0342     target=<a href="strrep.html" class="code" title="function str = strrep(str,oldstr,newstr,lpad,rpad, varargin)">strrep</a>(target,<span class="string">'('</span>,<span class="string">'\('</span>);
0343     target=<a href="strrep.html" class="code" title="function str = strrep(str,oldstr,newstr,lpad,rpad, varargin)">strrep</a>(target,<span class="string">')'</span>,<span class="string">'\)'</span>);
0344     
0345     <span class="comment">% modify equations</span>
0346     old=regexp(eqns,[target <span class="string">'\s*=[^;]+'</span>],<span class="string">'match'</span>);
0347     <span class="keyword">if</span> ~isempty(old)
0348       eqns=<a href="strrep.html" class="code" title="function str = strrep(str,oldstr,newstr,lpad,rpad, varargin)">strrep</a>(eqns,old{1},[old{1} expression]);
0349       spec.(type)(index).equations=eqns;
0350     <span class="keyword">end</span>
0351   <span class="keyword">elseif</span> ismember(fld,predefined_variables) <span class="comment">% not a single parameter to modify</span>
0352     spec.(type)(index).(fld)=val;
0353     <span class="keyword">if</span> strcmp(type,<span class="string">'populations'</span>) &amp;&amp; strcmp(fld,<span class="string">'name'</span>)
0354       <span class="comment">% update name in connections</span>
0355       <span class="keyword">for</span> j=1:length(spec.connections)
0356         <span class="keyword">if</span> strcmp(pop_names{index},spec.connections(j).source)
0357           spec.connections(j).source=val;
0358         <span class="keyword">end</span>
0359         
0360         <span class="keyword">if</span> strcmp(pop_names{index},spec.connections(j).target)
0361           spec.connections(j).target=val;
0362         <span class="keyword">end</span>
0363       <span class="keyword">end</span>
0364     <span class="keyword">end</span>
0365   <span class="keyword">else</span> <span class="comment">% modify a single parameter in the populations.parameters cell array</span>
0366     param_names=spec.(type)(index).parameters(1:2:end);
0367     <span class="keyword">if</span> isempty(spec.(type)(index).parameters)
0368       <span class="comment">% no parameters set; start cell array of parameters</span>
0369       spec.(type)(index).parameters={fld,val};<span class="comment">%toString(val2,precision)};</span>
0370     <span class="keyword">elseif</span> ismember(fld,param_names)
0371       <span class="comment">% parameter found in list; update its value</span>
0372       val_pos=2*find(ismember(param_names,fld));
0373       spec.(type)(index).parameters{val_pos}=val;<span class="comment">%toString(val2,precision);</span>
0374     <span class="keyword">else</span>
0375       <span class="comment">% parameter not in existing list; append to end</span>
0376       spec.(type)(index).parameters{end+1}=fld;
0377       spec.(type)(index).parameters{end+1}=val;<span class="comment">%toString(val2,precision);</span>
0378     <span class="keyword">end</span>
0379   <span class="keyword">end</span>
0380 <span class="keyword">end</span>
0381 
0382 <span class="comment">%% auto_gen_test_data_flag argout</span>
0383 <span class="keyword">if</span> options.auto_gen_test_data_flag
0384   argout = {spec}; <span class="comment">% specific to this function</span>
0385   
0386   ds.unit.saveAutoGenTestDataLocalFn(argin, argout); <span class="comment">% localfn</span>
0387 <span class="keyword">end</span>
0388 
0389 <span class="keyword">end</span>
0390 
0391 
0392 <a name="_sub3" href="#_subfunctions" class="code">function modifications=backward_compatibility(modifications)</a>
0393 <span class="comment">% convert 2-column specification to 3-column specification with empty object name</span>
0394 <span class="keyword">if</span> size(modifications,2)==2
0395   tmp={};
0396   <span class="keyword">for</span> i=1:size(modifications,1)
0397     tmp{i,1}=<span class="string">''</span>;
0398     tmp{i,2}=modifications{i,1};
0399     tmp{i,3}=modifications{i,2};
0400   <span class="keyword">end</span>
0401   modifications=tmp;
0402 <span class="keyword">end</span>
0403 
0404 <span class="comment">% convert 4-column specification to 3-column</span>
0405 <span class="keyword">if</span> size(modifications,2)==4
0406   <span class="keyword">for</span> i=1:size(modifications,1)
0407     <span class="keyword">if</span> strcmp(modifications{i,2},<span class="string">'parameters'</span>)
0408       <span class="comment">% shift parameter name to 2nd column</span>
0409       modifications{i,2}=modifications{i,3};
0410       
0411       <span class="comment">% shift parameter value to 3rd column</span>
0412       modifications{i,3}=modifications{i,4};
0413     <span class="keyword">end</span>
0414   <span class="keyword">end</span>
0415   
0416   <span class="comment">% remove fourth column</span>
0417   modifications=modifications(:,1:3);
0418 <span class="keyword">end</span>
0419 
0420 <span class="comment">% convert connection reference source-target to source-&gt;target</span>
0421 <span class="keyword">if</span> any(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'\w-\w'</span>)))
0422   <span class="comment">% find elements to adjust</span>
0423   inds=find(~cellfun(@isempty,regexp(modifications(:,1),<span class="string">'\w-\w'</span>)));
0424   <span class="keyword">for</span> i=1:length(inds)
0425     modifications{inds(i),1}=<a href="strrep.html" class="code" title="function str = strrep(str,oldstr,newstr,lpad,rpad, varargin)">strrep</a>(modifications{inds(i),1},<span class="string">'-'</span>,<span class="string">'-&gt;'</span>);
0426   <span class="keyword">end</span>
0427 <span class="keyword">end</span>
0428 
0429 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Fri 28-Apr-2017 18:39:28 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>