<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of createBatch</title>
  <meta name="keywords" content="createBatch">
  <meta name="description" content="CREATEBATCH - create and submit jobs to run sets of simulations or analyses.">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html functions --><!-- menu.html +ds -->
<h1>createBatch
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>CREATEBATCH - create and submit jobs to run sets of simulations or analyses.</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function [studyinfo, cmd] = createBatch(base_model,modifications_set,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">CREATEBATCH - create and submit jobs to run sets of simulations or analyses.

 Usage:
   studyinfo=ds.createBatch(model,varargin)

 Inputs:
   - DynaSim model (see ds.generateModel)
   - modifications_set (as returned by ds.vary2Modifications())
     - options:
       'compile_flag'  : whether to compile simulation using coder instead of
                         interpreting Matlab {0 or 1} (default: 0)
       'verbose_flag'  : whether to display informative messages/logs (default: 0)
       'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)
     - options for cluster computing:
       'sims_per_job'  : number of simulations to run per cluster job (default: 1)
       'memory_limit'  : memory to allocate per cluster job (default: '8G')
       'batch_dir'     : where to save job scripts
       'qsub_mode'     : whether to use SGE -t array for 1 qsub, mode: 'array'; or
                         qsub in csh for loop, mode: 'loop'. (default: 'loop').
     - options for parallel computing: (requires Parallel Computing Toolbox)
       - Note: parallel computing has been DISABLED for debugging...
       'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)
       'num_cores'     : number of cores to specify in the parallel pool

 Outputs:
   - DynaSim studyinfo (see ds.checkStudyinfo for schema info)

 Dependencies: ds.setupStudy, ds.updateStudy

 See also: ds.<a href="generateModel.html" class="code" title="function [model,name_map] = generateModel(specification, varargin)">generateModel</a>, dsSimulate, ds.<a href="checkStudyinfo.html" class="code" title="function studyinfo = checkStudyinfo(studyinfo, varargin)">checkStudyinfo</a>, ds.<a href="vary2Modifications.html" class="code" title="function modifications_set = vary2Modifications(vary,model)">vary2Modifications</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function WriteSimJob(sim_ids,job_file)</a></li><li><a href="#_sub2" class="code">function removeStudyinfo()</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [studyinfo, cmd] = createBatch(base_model,modifications_set,varargin)</a>
0002 <span class="comment">%CREATEBATCH - create and submit jobs to run sets of simulations or analyses.</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Usage:</span>
0005 <span class="comment">%   studyinfo=ds.createBatch(model,varargin)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%   - DynaSim model (see ds.generateModel)</span>
0009 <span class="comment">%   - modifications_set (as returned by ds.vary2Modifications())</span>
0010 <span class="comment">%     - options:</span>
0011 <span class="comment">%       'compile_flag'  : whether to compile simulation using coder instead of</span>
0012 <span class="comment">%                         interpreting Matlab {0 or 1} (default: 0)</span>
0013 <span class="comment">%       'verbose_flag'  : whether to display informative messages/logs (default: 0)</span>
0014 <span class="comment">%       'overwrite_flag': whether to overwrite existing data files {0 or 1} (default: 0)</span>
0015 <span class="comment">%     - options for cluster computing:</span>
0016 <span class="comment">%       'sims_per_job'  : number of simulations to run per cluster job (default: 1)</span>
0017 <span class="comment">%       'memory_limit'  : memory to allocate per cluster job (default: '8G')</span>
0018 <span class="comment">%       'batch_dir'     : where to save job scripts</span>
0019 <span class="comment">%       'qsub_mode'     : whether to use SGE -t array for 1 qsub, mode: 'array'; or</span>
0020 <span class="comment">%                         qsub in csh for loop, mode: 'loop'. (default: 'loop').</span>
0021 <span class="comment">%     - options for parallel computing: (requires Parallel Computing Toolbox)</span>
0022 <span class="comment">%       - Note: parallel computing has been DISABLED for debugging...</span>
0023 <span class="comment">%       'parallel_flag' : whether to use parfor to run simulations {0 or 1} (default: 0)</span>
0024 <span class="comment">%       'num_cores'     : number of cores to specify in the parallel pool</span>
0025 <span class="comment">%</span>
0026 <span class="comment">% Outputs:</span>
0027 <span class="comment">%   - DynaSim studyinfo (see ds.checkStudyinfo for schema info)</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Dependencies: ds.setupStudy, ds.updateStudy</span>
0030 <span class="comment">%</span>
0031 <span class="comment">% See also: ds.generateModel, dsSimulate, ds.checkStudyinfo, ds.vary2Modifications</span>
0032 
0033 <span class="comment">% check inputs</span>
0034 options=ds.checkOptions(varargin,{<span class="keyword">...</span>
0035   <span class="string">'compile_flag'</span>,0,{0,1},<span class="keyword">...</span>
0036   <span class="string">'parallel_flag'</span>,0,{0,1},<span class="keyword">...</span>
0037   <span class="string">'num_cores'</span>,4,[],<span class="keyword">...</span><span class="comment"> % # cores for parallel processing (SCC supports 1-12)</span>
0038   <span class="string">'sims_per_job'</span>,1,[],<span class="keyword">...</span><span class="comment"> % how many sims to run per cluster job</span>
0039   <span class="string">'memory_limit'</span>,<span class="string">'8G'</span>,[],<span class="keyword">...</span><span class="comment"> % how much memory to allocate per cluster job</span>
0040   <span class="string">'batch_dir'</span>,[],[],<span class="keyword">...</span>
0041   <span class="string">'simulator_options'</span>,[],[],<span class="keyword">...</span>
0042   <span class="string">'verbose_flag'</span>,0,{0,1},<span class="keyword">...</span>
0043   <span class="string">'overwrite_flag'</span>,0,{0,1},<span class="keyword">...</span>
0044   <span class="string">'process_id'</span>,[],[],<span class="keyword">...</span><span class="comment"> % process identifier for loading studyinfo if necessary</span>
0045   <span class="string">'qsub_mode'</span>,<span class="string">'loop'</span>,{<span class="string">'loop'</span>,<span class="string">'array'</span>},<span class="keyword">...</span><span class="comment"> % whether to submit jobs as an array using qsub -t or in a for loop</span>
0046   <span class="string">'one_solve_file_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % use only 1 solve file of each type, but can't vary mechs yet</span>
0047   <span class="string">'solver'</span>,<span class="string">'rk4'</span>,{<span class="string">'euler'</span>,<span class="string">'rk1'</span>,<span class="string">'rk2'</span>,<span class="string">'rk4'</span>,<span class="string">'modified_euler'</span>,<span class="string">'rungekutta'</span>,<span class="string">'rk'</span>,<span class="string">'ode23'</span>,<span class="string">'ode45'</span>,<span class="keyword">...</span>
0048     <span class="string">'ode1'</span>,<span class="string">'ode2'</span>,<span class="string">'ode3'</span>,<span class="string">'ode4'</span>,<span class="string">'ode5'</span>,<span class="string">'ode8'</span>,<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>},<span class="keyword">...</span><span class="comment"> % DynaSim and built-in Matlab solvers</span>
0049   <span class="string">'auto_gen_test_data_flag'</span>,0,{0,1},<span class="keyword">...</span>
0050   <span class="string">'unit_test_flag'</span>,0,{0,1},<span class="keyword">...</span>
0051   },false);
0052 
0053 <span class="comment">%% auto_gen_test_data_flag argin</span>
0054 <span class="keyword">if</span> options.auto_gen_test_data_flag
0055   varargs = varargin;
0056   varargs{find(strcmp(varargs, <span class="string">'auto_gen_test_data_flag'</span>))+1} = 0;
0057   varargs(end+1:end+2) = {<span class="string">'unit_test_flag'</span>,1};
0058   argin = [{base_model},{modifications_set}, varargs]; <span class="comment">% specific to this function</span>
0059 <span class="keyword">end</span>
0060 
0061 <span class="comment">%% main fn</span>
0062 <span class="comment">% Set up studyinfo structure, study directory and output file names</span>
0063 <span class="comment">%[studyinfo,options.simulator_options]=ds.setupStudy(base_model,modifications_set,options.simulator_options);</span>
0064 [studyinfo,options.simulator_options]=ds.setupStudy(base_model,<span class="string">'modifications_set'</span>,modifications_set,<span class="string">'simulator_options'</span>,options.simulator_options,<span class="string">'process_id'</span>,options.process_id);
0065 study_file=fullfile(studyinfo.study_dir,<span class="string">'studyinfo.mat'</span>);
0066 num_simulations=length(modifications_set);
0067 
0068 <span class="comment">% check whether study has already completed</span>
0069 <span class="comment">% if options.overwrite_flag==0</span>
0070   [~,s]=ds.monitorStudy(studyinfo.study_dir,<span class="string">'verbose_flag'</span>,0,<span class="string">'process_id'</span>,options.process_id);
0071   <span class="keyword">if</span> s==1 <span class="comment">% study finished</span>
0072     <span class="keyword">if</span> options.verbose_flag
0073       fprintf(<span class="string">'Study already finished. Not creating new batch.\n'</span>);
0074     <span class="keyword">end</span>
0075     
0076     studyinfo=ds.checkStudyinfo(studyinfo.study_dir,<span class="string">'process_id'</span>,options.process_id, varargin{:});
0077     
0078     <span class="keyword">return</span>;
0079   <span class="keyword">end</span>
0080 <span class="comment">% end</span>
0081 
0082 <span class="comment">% Check if attempting to compile Experiment</span>
0083 <span class="keyword">if</span> isa(options.simulator_options.experiment,<span class="string">'function_handle'</span>) &amp;&amp; options.compile_flag
0084   options.compile_flag=0;
0085   options.simulator_options.compile_flag=0;
0086   wprintf(<span class="string">'solver compilation is not available for experiments run on the cluster.'</span>);
0087 <span class="keyword">end</span>
0088 
0089 <span class="comment">% create base solve_file (m- or MEX-file)</span>
0090 solve_file = ds.getSolveFile(base_model,studyinfo,options.simulator_options);
0091 
0092 <span class="comment">% add appropriate MEX extension if compiled</span>
0093 <span class="comment">%   NOTE: the extension depends on whether a 32-bit or 64-bit machine is used</span>
0094 <span class="keyword">if</span> options.compile_flag
0095   <span class="comment">% get directory where solve_file is located and the file name</span>
0096   [fpath,fname]=fileparts(solve_file);
0097   
0098   <span class="comment">% get list of files in solve directory</span>
0099   D=dir(fpath);
0100   
0101   <span class="comment">% get extension of files with matching names</span>
0102   tmp=regexp({D.name},[fname <span class="string">'\.(\w+)$'</span>],<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0103   tmp=unique([tmp{:}]);
0104   
0105   <span class="comment">% append extension to solve_file if regular mex (not non supported matlab solver mex)</span>
0106   <span class="keyword">if</span> ~any(strcmp(options.solver, {<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>})) <span class="comment">% not mex supported)</span>
0107     full_solve_file=[solve_file <span class="string">'.'</span> tmp{1}];
0108   
0109     <span class="comment">% remove '_mex' suffix from solve_file for compatibility with ds.getSolveFile()</span>
0110     solve_file=regexp(solve_file,<span class="string">'(.+)_mex$'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0111     solve_file=solve_file{1};
0112   <span class="keyword">else</span>
0113     full_solve_file=solve_file;
0114   <span class="keyword">end</span>
0115 <span class="keyword">else</span>
0116   full_solve_file=solve_file;
0117 <span class="keyword">end</span>
0118 studyinfo.base_solve_file=solve_file;
0119 
0120 <span class="comment">% set name of batch_dir for this study</span>
0121 <span class="comment">% get study-specific timestamp</span>
0122 <span class="comment">% timestamp = datestr(studyinfo.study_id,'yyyymmddHHMMSS');</span>
0123 
0124 <span class="comment">% get home directory of the current user</span>
0125 [o,home]=system(<span class="string">'echo $HOME'</span>);
0126 
0127 <span class="comment">% create batch directory</span>
0128 [study_dir_path,study_dir_name,study_dir_suffix]=fileparts(studyinfo.study_dir);
0129 study_dir_name=[study_dir_name study_dir_suffix];
0130 <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0131   batch_dir = fullfile(strtrim(home),<span class="string">'batchdirs'</span>,study_dir_name);
0132   <span class="comment">%batch_dir = fullfile(strtrim(home),'batchdirs',['Batch' timestamp]);</span>
0133 <span class="keyword">else</span>
0134   [~, rel_study_dir] = fileparts(studyinfo.study_dir);
0135   batch_dir = fullfile(rel_study_dir,<span class="string">'batchdirs'</span>,study_dir_name);
0136 <span class="keyword">end</span>
0137 
0138 <span class="keyword">if</span> options.verbose_flag
0139   fprintf(<span class="string">'\nPREPARING BATCH:\n'</span>);
0140 <span class="keyword">end</span>
0141 
0142 <span class="comment">% create batch_dir to hold m-file jobs and more for this study</span>
0143 <span class="keyword">if</span> ~exist(batch_dir,<span class="string">'dir'</span>)
0144   <span class="keyword">if</span> options.verbose_flag
0145     fprintf(<span class="string">'Creating batch jobs directory: %s\n'</span>,batch_dir);
0146   <span class="keyword">end</span>
0147   mkdir(batch_dir);
0148 <span class="keyword">end</span>
0149 
0150 <span class="comment">% copy study_file to batchdir</span>
0151 [success,msg]=copyfile(study_file,batch_dir);
0152 <span class="keyword">if</span> ~success
0153   error(msg)
0154 <span class="keyword">end</span>
0155 
0156 <span class="comment">% locate DynaSim toolbox</span>
0157 dynasim_path = ds.getRootPath(); <span class="comment">% root is one level up from directory containing this function</span>
0158 dynasim_functions=fullfile(dynasim_path,<span class="string">'functions'</span>);
0159 
0160 <span class="comment">% locate mechanism files</span>
0161 [mech_paths,mech_files]=ds.locateModelFiles(base_model);
0162 
0163 <span class="comment">% add paths to studyinfo structure</span>
0164 studyinfo.paths.dynasim_functions = dynasim_functions;
0165 studyinfo.paths.mechanisms = mech_paths;
0166 studyinfo.paths.batch_dir = batch_dir;
0167 
0168 <span class="comment">% edit simulator_options so that subsequent single simulations do not create further batches</span>
0169 options.simulator_options.parallel_flag = 0;
0170 options.simulator_options.cluster_flag = 0;
0171 options.simulator_options.verbose_flag = 1; <span class="comment">% turn on verbose for cluster logs (stdout)</span>
0172 
0173 <span class="comment">% create jobs (k)</span>
0174 jobs={};
0175 skip_sims=[];
0176 sim_cnt=0;
0177 num_jobs=ceil(num_simulations/options.sims_per_job);
0178 
0179 <span class="keyword">if</span> options.verbose_flag &amp;&amp; ~options.one_solve_file_flag
0180   fprintf(<span class="string">'Creating %g cluster jobs in batch directory for %g simulations...\n'</span>,num_jobs,num_simulations);
0181 <span class="keyword">end</span>
0182 
0183 <span class="keyword">if</span> ~options.one_solve_file_flag
0184   <span class="keyword">for</span> k = 1:num_jobs
0185     job_file=fullfile(batch_dir,sprintf(<span class="string">'sim_job%g.m'</span>,k));
0186     sim_ids=sim_cnt+(1:options.sims_per_job);
0187     sim_ids=sim_ids(sim_ids&lt;=num_simulations);
0188     sim_cnt=sim_cnt+options.sims_per_job;
0189     
0190     <span class="comment">% only run simulations if data_file does not exist (unless overwrite_flag=1)</span>
0191     proc_sims=[]; <span class="comment">% simulations to run in this job</span>
0192     <span class="keyword">for</span> j=1:length(sim_ids)
0193       <span class="comment">%if ~exist(studyinfo.simulations(sim_ids(j)).data_file,'file') || options.overwrite_flag</span>
0194       <span class="keyword">if</span> (options.simulator_options.save_data_flag &amp;&amp; ~exist(studyinfo.simulations(sim_ids(j)).data_file,<span class="string">'file'</span>)) || <span class="keyword">...</span>
0195           (options.simulator_options.save_results_flag &amp;&amp; ~exist(studyinfo.simulations(sim_ids(j)).result_files{1},<span class="string">'file'</span>)) || <span class="keyword">...</span>
0196           options.overwrite_flag
0197         proc_sims=[proc_sims sim_ids(j)];
0198       <span class="keyword">end</span>
0199     <span class="keyword">end</span>
0200     
0201     <span class="keyword">if</span> isempty(proc_sims)
0202       skip_sims=[skip_sims sim_ids];
0203       <span class="keyword">continue</span>; <span class="comment">% skip this job</span>
0204     <span class="keyword">else</span>
0205       skip_sims=[skip_sims setdiff(sim_ids,proc_sims)];
0206     <span class="keyword">end</span>
0207     
0208     <a href="#_sub1" class="code" title="subfunction WriteSimJob(sim_ids,job_file)">WriteSimJob</a>(proc_sims,job_file); <span class="comment">% create job script</span>
0209     
0210     jobs{end+1}=job_file;
0211     
0212     <span class="comment">% add job_file to studyinfo</span>
0213     <span class="keyword">for</span> j=1:length(proc_sims)
0214       studyinfo.simulations(proc_sims(j)).job_file=job_file;
0215     <span class="keyword">end</span>
0216       
0217   <span class="keyword">end</span> <span class="comment">%for</span>
0218 <span class="keyword">else</span> <span class="comment">%one_solve_file_flag</span>
0219   job_file=fullfile(batch_dir, <span class="string">'sim_job.m'</span>); <span class="comment">%always use this file</span>
0220   
0221   <a href="#_sub1" class="code" title="subfunction WriteSimJob(sim_ids,job_file)">WriteSimJob</a>([], job_file); <span class="comment">% create job script</span>
0222   
0223   <span class="comment">% TODO: compile job_file</span>
0224 <span class="comment">%   if options.compile_flag</span>
0225 <span class="comment">%     job_file = ds.prepareMEX(job_file, options); %compile the job file</span>
0226 <span class="comment">%   end</span>
0227   
0228   <span class="comment">% add job_file to studyinfo</span>
0229   [studyinfo.simulations.job_file] = deal(job_file); <span class="comment">%same job file for all sims</span>
0230 <span class="keyword">end</span> <span class="comment">%if</span>
0231 
0232 <span class="comment">% TODO: have job scripts create lock for each sim; then, check for lock</span>
0233 <span class="comment">%   file in this function and skip simulations if they're already running</span>
0234 <span class="comment">%   (similar to skipping if data_file already exists).</span>
0235 
0236 <span class="comment">% exit if there are no simulations to run</span>
0237 <span class="keyword">if</span> numel(skip_sims)==num_simulations
0238   <span class="keyword">if</span> options.verbose_flag
0239     fprintf(<span class="string">'Data exists for all simulations in study. nothing to do.\n'</span>);
0240   <span class="keyword">end</span>
0241   
0242   <span class="keyword">return</span>;
0243 <span class="keyword">end</span>
0244 
0245 <span class="comment">% create script_filename (list of vars or jobs)</span>
0246 <span class="keyword">if</span> strcmp(options.qsub_mode, <span class="string">'loop'</span>)
0247   script_filename = fullfile(batch_dir,<span class="string">'scriptlist.txt'</span>);
0248   <span class="keyword">if</span> options.verbose_flag
0249     fprintf(<span class="string">'Creating file listing jobs in batch directory: %s\n'</span>,script_filename);
0250   <span class="keyword">end</span>
0251 <span class="keyword">end</span>
0252 
0253 <span class="comment">% write to file</span>
0254 <span class="keyword">if</span> strcmp(options.qsub_mode, <span class="string">'loop'</span>)
0255   fScript=fopen(script_filename,<span class="string">'wt'</span>);
0256   
0257   <span class="keyword">for</span> j=1:length(jobs)
0258     [~,thisFilename]=fileparts(jobs{j});
0259     fprintf(fScript,<span class="string">'%s\n'</span>,thisFilename);
0260   <span class="keyword">end</span>
0261   
0262   fclose(fScript);
0263 <span class="keyword">end</span>
0264 
0265 <span class="keyword">if</span> ~options.one_solve_file_flag
0266   <span class="comment">% copy solve_file to each sim-specific solve sub-directory: &lt;study_dir&gt;/solve/sim&lt;k&gt;/&lt;solve_file&gt;</span>
0267   <span class="comment">%   and set sim-specific studyinfo</span>
0268   <span class="keyword">if</span> options.verbose_flag
0269     fprintf(<span class="string">'Creating distinct solver sub-directories for %g simulations...\n'</span>,num_simulations);
0270   <span class="keyword">end</span>
0271   <span class="comment">%[solve_path,solve_name,solve_ext]=fileparts(solve_file);</span>
0272   [solve_path,solve_name,solve_ext]=fileparts(full_solve_file);
0273 
0274   <span class="comment">% prepare studyinfo with simulation-specific metadata</span>
0275   <span class="keyword">for</span> sim=1:num_simulations
0276     <span class="keyword">if</span> ismember(sim,skip_sims)
0277       <span class="keyword">continue</span>; <span class="comment">% do nothing with this simulation</span>
0278     <span class="keyword">end</span>
0279 
0280     this_solve_path=fullfile(solve_path,[<span class="string">'sim'</span> num2str(sim)]);
0281 
0282     <span class="keyword">if</span> ~exist(this_solve_path,<span class="string">'dir'</span>)
0283       <span class="comment">%if options.verbose_flag</span>
0284       <span class="comment">%  fprintf('creating solver sub-directory for simulation #%g: %s\n',sim,this_solve_path);</span>
0285       <span class="comment">%end</span>
0286       mkdir(this_solve_path);
0287     <span class="keyword">end</span>
0288 
0289     [success,msg]=copyfile(full_solve_file,this_solve_path); <span class="comment">% creates solve sub-directory and copies the base solve file to it</span>
0290 
0291     <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0292 
0293     <span class="comment">% set studyinfo solve_file to use for this simulation</span>
0294     this_solve_file=fullfile(this_solve_path,[solve_name solve_ext]);
0295     studyinfo.simulations(sim).solve_file=this_solve_file;
0296     studyinfo.simulations(sim).batch_dir=batch_dir;
0297     studyinfo.simulations(sim).simulator_options=options.simulator_options;
0298 
0299     <span class="comment">% set solve_file for this simulation (will be passed to dsSimulate as an option)</span>
0300     <span class="keyword">if</span> isa(options.simulator_options.experiment,<span class="string">'function_handle'</span>)
0301       studyinfo.simulations(sim).simulator_options.solve_file=[];
0302     <span class="keyword">else</span>
0303       studyinfo.simulations(sim).simulator_options.solve_file=this_solve_file;
0304     <span class="keyword">end</span>
0305 
0306     <span class="comment">% set vary to [] to avoid each sim expanding to a new set</span>
0307     studyinfo.simulations(sim).simulator_options.vary=[];
0308     studyinfo.simulations(sim).simulator_options.sim_id=studyinfo.simulations(sim).sim_id;
0309     studyinfo.simulations(sim).error_log=<span class="string">''</span>;
0310     
0311     <span class="comment">% copy studyinfo to batch_dir for each simulation</span>
0312     <span class="comment">%this_study_file=fullfile(batch_dir,sprintf('studyinfo_%g.mat',sim));</span>
0313     <span class="comment">%save(this_study_file,'studyinfo');</span>
0314     
0315     <span class="comment">% copy studyinfo file to batch_dir for each simulation</span>
0316     <span class="keyword">for</span> sim=1:num_simulations
0317       this_study_file=fullfile(batch_dir,sprintf(<span class="string">'studyinfo_%g.mat'</span>,sim));
0318       
0319       <span class="keyword">if</span> sim==1
0320         save(this_study_file,<span class="string">'studyinfo'</span>);
0321         first_study_file=this_study_file;
0322       <span class="keyword">else</span>
0323         <span class="comment">% use copyfile() after saving first b/c &gt;10x faster than save()</span>
0324         [success,msg]=copyfile(first_study_file,this_study_file);
0325         
0326         <span class="keyword">if</span> ~success, error(msg); <span class="keyword">end</span>
0327       <span class="keyword">end</span>
0328     <span class="keyword">end</span>
0329 
0330   <span class="keyword">end</span> <span class="comment">%sim</span>
0331 <span class="keyword">else</span> <span class="comment">%one_solve_file_flag</span>
0332   <span class="comment">% set studyinfo solve_file to use for this simulation</span>
0333   [studyinfo.simulations.solve_file] = deal(full_solve_file);
0334   [studyinfo.simulations.batch_dir] = deal(batch_dir);
0335   [studyinfo.simulations.simulator_options] = deal(options.simulator_options);
0336 
0337   <span class="comment">% set vary to [] to avoid each sim expanding to a new set</span>
0338   <span class="keyword">for</span> iSim = 1:num_simulations
0339     studyinfo.simulations(iSim).simulator_options.vary = [];
0340     studyinfo.simulations(iSim).simulator_options.sim_id = studyinfo.simulations(iSim).sim_id;
0341   <span class="keyword">end</span>
0342   [studyinfo.simulations.error_log] = deal(<span class="string">''</span>);
0343  
0344   <span class="comment">% copy studyinfo file to batch_dir since more information now</span>
0345   batch_study_file = fullfile(batch_dir,<span class="string">'studyinfo.mat'</span>);
0346   save(batch_study_file,<span class="string">'studyinfo'</span>);
0347 <span class="keyword">end</span>
0348 
0349 <span class="comment">% update studyinfo on disk</span>
0350 ds.studyinfoIO(studyinfo,study_file,options.simulator_options.sim_id,options.verbose_flag);
0351 
0352 <span class="comment">% TODO: remove old lock files ..</span>
0353 
0354 <span class="comment">% check for qsub on system</span>
0355 [status,result]=system(<span class="string">'which qsub'</span>);
0356 
0357 <span class="keyword">if</span> options.auto_gen_test_data_flag || options.unit_test_flag
0358   status = 0;
0359   result = 1;
0360 <span class="keyword">end</span>
0361 
0362 <span class="keyword">if</span> isempty(result)
0363   [~,host] = system(<span class="string">'hostname'</span>);
0364   fprintf(<span class="string">'qsub not found on host (%s).\n'</span>,strtrim(host));
0365   fprintf(<span class="string">'Jobs NOT submitted to cluster queue.\n'</span>);
0366 <span class="keyword">else</span> <span class="comment">% on cluster with qsub</span>
0367   <span class="comment">% submit jobs (e.g., fScripjobs_memlimit batch_dir 32G)</span>
0368   <span class="comment">% check status of study</span>
0369   [~,s]=ds.monitorStudy(studyinfo.study_dir,<span class="string">'verbose_flag'</span>,0);
0370   
0371   <span class="keyword">if</span> s~=1 <span class="comment">% study not finished</span>
0372     <span class="comment">% submit jobs using shell script</span>
0373     <span class="keyword">if</span> options.auto_gen_test_data_flag || options.unit_test_flag
0374       batch_dir = rel_study_dir;
0375     <span class="keyword">end</span>
0376     
0377     [batch_dir_path,batch_dir_name,batch_suffix]=fileparts(batch_dir);
0378     batch_dir_name=[batch_dir_name batch_suffix];
0379     
0380     <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0381       dsFnPath = fileparts(mfilename(<span class="string">'fullpath'</span>));
0382     <span class="keyword">else</span>
0383       dsFnPath = <span class="string">'dsFnPath'</span>;
0384     <span class="keyword">end</span>
0385     
0386     <span class="keyword">if</span> options.parallel_flag
0387       cmd=sprintf(<span class="string">'qmatjobs_pct %s %s %g'</span>,batch_dir_name,options.memory_limit,options.num_cores);
0388       <span class="comment">%status=system('which qmatjobs_pct');</span>
0389     <span class="keyword">else</span>
0390       <span class="keyword">if</span> strcmp(options.qsub_mode, <span class="string">'array'</span>) &amp;&amp; ~options.one_solve_file_flag
0391         <span class="comment">% TODO: remove old error and output files; put e and o in their own dirs</span>
0392         cmd = sprintf(<span class="string">'echo ''%s/qmatjob_array %s sim_job'' | qsub -V -hard -l ''h_vmem=%s'' -wd %s -N %s_sim_job -t 1-%i'</span>,<span class="keyword">...</span>
0393           dsFnPath, batch_dir, options.memory_limit, batch_dir, batch_dir_name, num_jobs);
0394       <span class="keyword">elseif</span> strcmp(options.qsub_mode, <span class="string">'array'</span>) &amp;&amp; options.one_solve_file_flag
0395         [~, job_filename] = fileparts(job_file); <span class="comment">%remove path and extension</span>
0396         cmd = sprintf(<span class="string">'echo ''%s/qmatjob_array_one_file %s %s'' | qsub -V -hard -l ''h_vmem=%s'' -wd %s -N %s_sim_job -t 1-%i:%i'</span>,<span class="keyword">...</span>
0397           dsFnPath, batch_dir, job_filename, options.memory_limit, batch_dir, batch_dir_name, num_simulations, options.sims_per_job);
0398         <span class="comment">% NOTE: using num_simulations, not num_jobs, since the job_file will</span>
0399         <span class="comment">%   determine it's own sims to run</span>
0400       <span class="keyword">elseif</span> strcmp(options.qsub_mode, <span class="string">'loop'</span>)
0401         cmd = sprintf(<span class="string">'qmatjobs_memlimit_loop %s %s'</span>,batch_dir_name,options.memory_limit);
0402       <span class="keyword">end</span>
0403       <span class="comment">%status=system('which qmatjobs_memlimit');</span>
0404     <span class="keyword">end</span>
0405     
0406     <span class="comment">% add shell script to linux path if not already there</span>
0407     <span class="comment">%if status~=0</span>
0408       setenv(<span class="string">'PATH'</span>, [getenv(<span class="string">'PATH'</span>) <span class="string">':'</span> dynasim_functions <span class="string">':'</span> fullfile(dynasim_functions, <span class="string">'+ds'</span>)]);
0409     <span class="comment">%end</span>
0410     
0411     <span class="keyword">if</span> options.verbose_flag
0412       fprintf(<span class="string">'Submitting cluster jobs with shell command: &quot;%s&quot;\n'</span>,cmd);
0413     <span class="keyword">end</span>
0414     
0415     <span class="keyword">if</span> ~options.auto_gen_test_data_flag &amp;&amp; ~options.unit_test_flag
0416       [status,result]=system(cmd);
0417     <span class="keyword">end</span>
0418     
0419     <span class="keyword">if</span> status &gt; 0
0420       <span class="keyword">if</span> options.verbose_flag
0421         fprintf(<span class="string">'Submit command failed: &quot;%s&quot;\n'</span>,cmd);
0422         disp(result);
0423       <span class="keyword">end</span>
0424       <span class="keyword">return</span>;
0425     <span class="keyword">else</span>
0426       <span class="keyword">if</span> options.verbose_flag
0427         fprintf(<span class="string">'Submit command status: \n'</span>);
0428         disp(result);
0429       <span class="keyword">end</span>
0430     <span class="keyword">end</span>
0431     
0432     <span class="keyword">if</span> options.verbose_flag
0433       <span class="comment">%fprintf('%g jobs successfully submitted!\ntip: use ds.monitorStudy(''%s'') or ds.monitorStudy(studyinfo) to track status of cluster jobs.\n',num_jobs,studyinfo.study_dir);</span>
0434       fprintf(<span class="string">'%g jobs successfully submitted!\n'</span>,num_jobs);
0435     <span class="keyword">end</span>
0436   <span class="keyword">elseif</span> s==1 <span class="comment">% study is finished</span>
0437     <span class="keyword">if</span> options.verbose_flag
0438       fprintf(<span class="string">'Study already finished. not submitting jobs.\n'</span>);
0439     <span class="keyword">end</span>
0440   <span class="keyword">end</span>
0441 <span class="keyword">end</span>
0442 
0443 <span class="comment">%% auto_gen_test_data_flag argout</span>
0444 <span class="keyword">if</span> options.auto_gen_test_data_flag
0445   dirIn = studyinfo.study_dir;
0446   <a href="#_sub2" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>()
0447   
0448   <span class="keyword">if</span> ~isempty(studyinfo)
0449     studyinfo = [];
0450   <span class="keyword">end</span>
0451   argout = {studyinfo, cmd}; <span class="comment">% specific to this function</span>
0452 
0453   ds.unit.saveAutoGenTestDir(argin, argout, [], dirIn);
0454 <span class="keyword">end</span>
0455 
0456 <span class="comment">%% unit test</span>
0457 <span class="keyword">if</span> options.unit_test_flag
0458   <span class="comment">% remove fields that cause issues in unit testing</span>
0459   <a href="#_sub2" class="code" title="subfunction removeStudyinfo()">removeStudyinfo</a>()
0460   <span class="keyword">if</span> ~isempty(studyinfo)
0461     studyinfo = [];
0462   <span class="keyword">end</span>
0463 <span class="keyword">end</span>
0464 
0465 
0466 
0467 <span class="comment">%% NESTED FUNCTIONS</span>
0468   <a name="_sub1" href="#_subfunctions" class="code">function WriteSimJob(sim_ids,job_file)</a>
0469     <span class="comment">% purpose: write m-file to job_file to run simulations of sim_ids</span>
0470     
0471     <span class="comment">% create job file</span>
0472     fjob=fopen(job_file,<span class="string">'wt'</span>);
0473     
0474     <span class="comment">% load studyinfo using helper function to avoid busy file errors</span>
0475     <span class="comment">%fprintf(fjob,'studyinfo=ds.checkStudyinfo(''%s'',''process_id'',%g);\n',study_file,sim_ids(1), varargin{:});</span>
0476     <span class="comment">%fprintf(fjob,'load(''%s'',''studyinfo'');\n',study_file);</span>
0477     
0478     [~, job_filename] = fileparts(job_file); <span class="comment">%remove path and extension</span>
0479     
0480     <span class="keyword">if</span> ~options.one_solve_file_flag
0481       <span class="comment">% function declaration</span>
0482       fprintf(fjob, <span class="string">'function %s\n\n'</span>, job_filename);
0483       
0484       <span class="comment">% set IDs of simulations to run</span>
0485       fprintf(fjob,<span class="string">'SimIDs=[%s]\n'</span>,num2str(sim_ids));
0486     <span class="keyword">else</span> <span class="comment">%only 1 file</span>
0487       <span class="comment">% function declaration</span>
0488       fprintf(fjob, <span class="string">'function %s(simIDstart, simIDstep, simIDlast)\n\n'</span>, job_filename);
0489       
0490       <span class="keyword">if</span> options.compile_flag
0491         fprintf(fjob, <span class="string">'assert(isa(simIDstart, ''double''));\n'</span>);
0492         fprintf(fjob, <span class="string">'assert(isa(simIDstep, ''double''));\n'</span>);
0493         fprintf(fjob, <span class="string">'assert(isa(simIDlast, ''double''));\n'</span>);
0494       <span class="keyword">end</span>
0495       
0496       <span class="comment">% set IDs of simulations to run</span>
0497       fprintf(fjob,<span class="string">'SimIDs = simIDstart:min(simIDlast,simIDstart+simIDstep-1);\n'</span>);
0498     <span class="keyword">end</span>
0499     
0500     <span class="comment">% loop over and run simulations in this job</span>
0501     <span class="keyword">if</span> options.parallel_flag
0502       <span class="comment">% set parallel computing options</span>
0503       <span class="comment">%fprintf(fjob,'started=0;\npool=gcp(''nocreate'');\n');</span>
0504       <span class="comment">%fprintf(fjob,'if isempty(pool), parpool(%g); started=1; end\n',options.num_cores);</span>
0505       fprintf(fjob,<span class="string">'c=parcluster;\nsaveAsProfile(c,''local_%g'');\nparpool(c,%g);\n'</span>,k,options.num_cores);
0506       
0507       <span class="comment">% use parfor loop</span>
0508       fprintf(fjob,<span class="string">'parfor s=1:length(SimIDs)\n'</span>);
0509     <span class="keyword">else</span>
0510       <span class="comment">% use for loop</span>
0511       fprintf(fjob,<span class="string">'for s=1:length(SimIDs)\n'</span>);
0512     <span class="keyword">end</span>
0513     
0514     fprintf(fjob,<span class="string">'\tSimID=SimIDs(s);\n'</span>);
0515     
0516     <span class="comment">% each job should have try-catch to capture studyinfo.simulations(k).error_log</span>
0517     fprintf(fjob,<span class="string">'\ttry\n'</span>);
0518     
0519     <span class="comment">% load studyinfo for this simulation</span>
0520     <span class="keyword">if</span> ~options.one_solve_file_flag
0521       fprintf(fjob,<span class="string">'\t\tload(fullfile(''%s'',sprintf(''studyinfo_%%g.mat'',SimID)),''studyinfo'');\n'</span>,batch_dir);
0522     <span class="keyword">else</span>
0523       fprintf(fjob,<span class="string">'\t\tload(fullfile(''%s'',''studyinfo.mat''),''studyinfo'');\n'</span>,batch_dir);
0524     <span class="keyword">end</span>
0525     <span class="comment">% compare paths between compute machine and studyinfo startup</span>
0526     fprintf(fjob,<span class="string">'\t\t[valid,message]=ds.checkHostPaths(studyinfo);\n'</span>);
0527     
0528     <span class="keyword">if</span> ~options.one_solve_file_flag
0529       fprintf(fjob,<span class="string">'\t\tif ~valid\n\t\t  lasterr(message);\n\t\t  for s=1:length(SimIDs), ds.updateStudy(studyinfo.study_dir,''sim_id'',SimIDs(s),''status'',''failed''); end\n\t\t  continue;\n\t\tend\n'</span>);
0530     <span class="keyword">end</span>
0531     
0532     <span class="comment">% simulate model with proper modifications and options</span>
0533     fprintf(fjob,<span class="string">'\t\tsiminfo=studyinfo.simulations(SimID);\n'</span>);
0534     fprintf(fjob,<span class="string">'\t\toptions=rmfield(siminfo.simulator_options,{''modifications'',''studyinfo'',''analysis_functions'',''plot_functions'',''sim_id''});\n'</span>);
0535     fprintf(fjob,<span class="string">'\t\tkeyvals=ds.options2Keyval(options);\n'</span>);
0536     fprintf(fjob,<span class="string">'\t\tfprintf(''-----------------------------------------------------\\n'');\n'</span>);
0537     fprintf(fjob,<span class="string">'\t\tfprintf(''Processing simulation %%g (%%g of %%g in this job)...\\n'',SimID,s,length(SimIDs));\n'</span>);
0538     fprintf(fjob,<span class="string">'\t\tfprintf(''-----------------------------------------------------\\n'');\n'</span>);
0539     fprintf(fjob,<span class="string">'\t\tdata=dsSimulate(studyinfo.base_model,''modifications'',siminfo.modifications,''studyinfo'',studyinfo,''sim_id'',SimID,keyvals{:});\n'</span>);
0540     fprintf(fjob,<span class="string">'\t\tfor i=1:length(siminfo.result_functions)\n'</span>);
0541     fprintf(fjob,<span class="string">'\t\t\tdsAnalyze(data,siminfo.result_functions{i},''result_file'',siminfo.result_files{i},''save_data_flag'',1,siminfo.result_options{i}{:});\n'</span>);
0542     fprintf(fjob,<span class="string">'\t\tend\n'</span>);
0543     
0544     <span class="comment">% add error handling</span>
0545     fprintf(fjob,<span class="string">'\tcatch err\n'</span>);
0546     
0547     <span class="comment">%fprintf(fjob,'\t\ttry delete(fullfile(studyinfo.study_dir,[''.locked_'' num2str(SimID)])); end\n');</span>
0548     fprintf(fjob,<span class="string">'\t\tdisplayError(err);\n'</span>);
0549     fprintf(fjob,<span class="string">'\tend\n'</span>);
0550     
0551     <span class="comment">% end loop over simulations in this job</span>
0552     fprintf(fjob,<span class="string">'end\n'</span>);
0553     <span class="keyword">if</span> options.parallel_flag
0554       <span class="comment">%fprintf(fjob,'if started, delete(gcp); end\n');</span>
0555       fprintf(fjob,<span class="string">'delete(gcp)\n'</span>);
0556     <span class="keyword">end</span>
0557     
0558     <span class="comment">% exit script</span>
0559     [status,result]=system(<span class="string">'which qsub'</span>);
0560     <span class="keyword">if</span> ~isempty(result) <span class="comment">% on cluster</span>
0561       fprintf(fjob,<span class="string">'exit\n'</span>);
0562     <span class="keyword">end</span>
0563     
0564     <span class="comment">% close job file</span>
0565     fclose(fjob);
0566   <span class="keyword">end</span> <span class="comment">% WriteSimJob</span>
0567 
0568   <a name="_sub2" href="#_subfunctions" class="code">function removeStudyinfo()</a>
0569     <span class="comment">% Problem: studyinfo files have many timestamps and absolute paths</span>
0570     <span class="comment">% Solution: remove studyinfo files</span>
0571     
0572     studyDirFiles = rls(studyinfo.study_dir);
0573     studyinfoFiles = studyDirFiles(~cellfun(@isempty, strfind(studyDirFiles, <span class="string">'studyinfo'</span>)));
0574     <span class="keyword">for</span> k = 1:length(studyinfoFiles)
0575       thisFile = studyinfoFiles{k};
0576       delete(thisFile)
0577     <span class="keyword">end</span>
0578   <span class="keyword">end</span>
0579 
0580 <span class="keyword">end</span> <span class="comment">% main fn</span>
0581 
0582 <span class="comment">% -------------------</span>
0583 <span class="comment">% in ds.createBatch():</span>
0584 <span class="comment">% -------------------</span>
0585 <span class="comment">% create solve_file</span>
0586 <span class="comment">% for each sim k</span>
0587 <span class="comment">%   copy to this_solve_file = /solve/sim&lt;k&gt;/solve_file</span>
0588 <span class="comment">%   set studyinfo.simulations(k).solve_file=this_solve_file</span>
0589 <span class="comment">% ...</span>
0590 <span class="comment">% in sim job.m:</span>
0591 <span class="comment">% dsSimulate(model{k},'solve_file',solve_file{k},...)</span>
0592 <span class="comment">% where solve_file{k}=studyinfo.simulations(k).solve_file</span></pre></div>
<hr><address>Generated on Fri 28-Apr-2017 19:07:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>