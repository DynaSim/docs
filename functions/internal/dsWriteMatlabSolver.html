<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of dsWriteMatlabSolver</title>
  <meta name="keywords" content="dsWriteMatlabSolver">
  <meta name="description" content="WRITEMATLABSOLVER - write m-file that numerically inteegrates the model">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html &copy; 2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
  <script type="text/javascript">
    if (top.frames.length == 0) { top.location = "../../index.html"; };
  </script>
</head>
<body>
<a name="_top"></a>
<!-- ../menu.html functions --><!-- menu.html internal -->
<h1>dsWriteMatlabSolver
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>WRITEMATLABSOLVER - write m-file that numerically inteegrates the model</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function solve_ode_filepath = dsWriteMatlabSolver(model,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment">WRITEMATLABSOLVER - write m-file that numerically inteegrates the model

 Usage:
   filepath = dsWriteMatlabSolver(model,varargin)

 Inputs:
   - model: DynaSim model structure (see dsGenerateModel)
   - options:
     'tspan'         : units must be consistent with dt and equations
                       {[beg,end]} (default: [0 100])
     'ic'            : initial conditions; this overrides definition in model structure
     'solver'        : built-in Matlab solvers
                         {'ode23','ode45','ode113','ode15s','ode23s','ode23t','ode23tb'}
     'matlab_solver_options': options from odeset for use with built-in Matlab solvers
     'dt'            :  time step used for fixed step DSSim solvers (default: 0.01)
     'modifications' : DynaSim modifications structure
     'reduce_function_calls_flag': whether to eliminate internal function
                                   calls {0 or 1} (default: 1)
     'coder_flag'    : whether to compile using coder instead of interpreting
                       Matlab (default: exist('codegen')==6 TODO is this correct?
                       what does this mean?)
     'downsample_factor': downsampling applied during simulation. Only every
                          downsample_factor-time point is stored in memory or
                          written to disk (default: 1)
     'random_seed'   : seed for random number generator (usage:
                       rng(random_seed)) (default: now)

 Outputs:
   - filepath (solve_ode.m)
   - odefun_filepath (solve_ode_odefun.m)

 Dependencies: dsCheckOptions, dsCheckModel

 See also: dsSimulate, <a href="dsDynasim2odefun.html" class="code" title="function [ODEFUN,IC,elem_names] = dsDynasim2odefun(model, varargin)">dsDynasim2odefun</a></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>	APPLYMODIFICATIONS - Apply modifications to DynaSim specification or model structure</li><li><a href="dsCheckModel.html" class="code" title="function model = dsCheckModel(model, varargin)">dsCheckModel</a>	CHECKMODEL - Standardize model structure and auto-populate missing fields</li><li><a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>	CHECKOPTIONS - organize key/value pairs in structure with default or user-supplied values according to a schema</li><li><a href="dsCheckSolverOptions.html" class="code" title="function options = dsCheckSolverOptions(options)">dsCheckSolverOptions</a>	CHECKSOLVEROPTIONS - standardize simulation options appended to params.mat</li><li><a href="dsDynasim2odefun.html" class="code" title="function [ODEFUN,IC,elem_names] = dsDynasim2odefun(model, varargin)">dsDynasim2odefun</a>	Purpose: prepare ODEFUN for use with built-in Matlab solvers.</li><li><a href="dsPrepareMEX.html" class="code" title="function mexfileOutput = dsPrepareMEX(mfileInput, varargin)">dsPrepareMEX</a>	PREPAREMEX - take an m-file path and compile it using the Matlab coder.</li><li><a href="dsPropagateFunctions.html" class="code" title="function model = dsPropagateFunctions(model, varargin)">dsPropagateFunctions</a>	PROPAGATEFUNCTIONS - eliminate internal function calls from model ODEs, ICs, monitors, and conditionals.</li><li><a href="dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>	PROPAGATEPARAMETERS - substitute parameter values or prepend parameter names with prefix across all model equations.</li><li><a href="dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a>	VARY2MODIFICATIONS - convert specification of things to vary into a set of modifications indicating how to vary the desired things.</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="dsGetSolveFile.html" class="code" title="function solve_file = dsGetSolveFile(model,studyinfo,varargin)">dsGetSolveFile</a>	GETSOLVEFILE - helper function that creates or retrieves the desired solver file.</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function solve_ode_filepath = dsWriteMatlabSolver(model,varargin)</a>
0002 <span class="comment">%WRITEMATLABSOLVER - write m-file that numerically inteegrates the model</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% Usage:</span>
0005 <span class="comment">%   filepath = dsWriteMatlabSolver(model,varargin)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% Inputs:</span>
0008 <span class="comment">%   - model: DynaSim model structure (see dsGenerateModel)</span>
0009 <span class="comment">%   - options:</span>
0010 <span class="comment">%     'tspan'         : units must be consistent with dt and equations</span>
0011 <span class="comment">%                       {[beg,end]} (default: [0 100])</span>
0012 <span class="comment">%     'ic'            : initial conditions; this overrides definition in model structure</span>
0013 <span class="comment">%     'solver'        : built-in Matlab solvers</span>
0014 <span class="comment">%                         {'ode23','ode45','ode113','ode15s','ode23s','ode23t','ode23tb'}</span>
0015 <span class="comment">%     'matlab_solver_options': options from odeset for use with built-in Matlab solvers</span>
0016 <span class="comment">%     'dt'            :  time step used for fixed step DSSim solvers (default: 0.01)</span>
0017 <span class="comment">%     'modifications' : DynaSim modifications structure</span>
0018 <span class="comment">%     'reduce_function_calls_flag': whether to eliminate internal function</span>
0019 <span class="comment">%                                   calls {0 or 1} (default: 1)</span>
0020 <span class="comment">%     'coder_flag'    : whether to compile using coder instead of interpreting</span>
0021 <span class="comment">%                       Matlab (default: exist('codegen')==6 TODO is this correct?</span>
0022 <span class="comment">%                       what does this mean?)</span>
0023 <span class="comment">%     'downsample_factor': downsampling applied during simulation. Only every</span>
0024 <span class="comment">%                          downsample_factor-time point is stored in memory or</span>
0025 <span class="comment">%                          written to disk (default: 1)</span>
0026 <span class="comment">%     'random_seed'   : seed for random number generator (usage:</span>
0027 <span class="comment">%                       rng(random_seed)) (default: now)</span>
0028 <span class="comment">%</span>
0029 <span class="comment">% Outputs:</span>
0030 <span class="comment">%   - filepath (solve_ode.m)</span>
0031 <span class="comment">%   - odefun_filepath (solve_ode_odefun.m)</span>
0032 <span class="comment">%</span>
0033 <span class="comment">% Dependencies: dsCheckOptions, dsCheckModel</span>
0034 <span class="comment">%</span>
0035 <span class="comment">% See also: dsSimulate, dsDynasim2odefun</span>
0036 
0037 <span class="comment">% Check inputs</span>
0038 options=<a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="keyword">...</span>
0039   <span class="string">'ic'</span>,[],[],<span class="keyword">...</span><span class="comment">                  % initial conditions (overrides definition in model structure)</span>
0040   <span class="string">'tspan'</span>,[0 100],[],<span class="keyword">...</span><span class="comment">          % [beg,end] (units must be consistent with dt and equations)</span>
0041   <span class="string">'dt'</span>,.01,[],<span class="keyword">...</span><span class="comment">                 % time step used for fixed step DynaSim solvers</span>
0042   <span class="string">'downsample_factor'</span>,1,[],<span class="keyword">...</span><span class="comment">    % downsampling applied after simulation (only every downsample_factor-time point is returned)</span>
0043   <span class="string">'random_seed'</span>,<span class="string">'shuffle'</span>,[],<span class="keyword">...</span><span class="comment">        % seed for random number generator (usage: rng(random_seed))</span>
0044   <span class="string">'solver'</span>,<span class="string">'ode45'</span>,{<span class="string">'ode23'</span>,<span class="string">'ode45'</span>,<span class="string">'ode113'</span>,<span class="string">'ode15s'</span>,<span class="string">'ode23s'</span>,<span class="string">'ode23t'</span>,<span class="string">'ode23tb'</span>},<span class="keyword">...</span><span class="comment"> % built-in Matlab solvers</span>
0045   <span class="string">'solver_type'</span>,<span class="string">'matlab'</span>,{<span class="string">'matlab'</span>, <span class="string">'matlab_no_mex'</span>},<span class="keyword">...</span><span class="comment"> % if compile_flag==1, will decide whether to mex solve_file or odefun_file</span>
0046   <span class="string">'matlab_solver_options'</span>,[],[],<span class="keyword">...</span><span class="comment"> % options from odeset for use with built-in Matlab solvers</span>
0047   <span class="string">'reduce_function_calls_flag'</span>,1,{0,1},<span class="keyword">...</span><span class="comment">   % whether to eliminate internal (anonymous) function calls</span>
0048   <span class="string">'save_parameters_flag'</span>,1,{0,1},<span class="keyword">...</span>
0049   <span class="string">'filename'</span>,[],[],<span class="keyword">...</span><span class="comment">         % name of solver file that integrates model</span>
0050   <span class="string">'fileID'</span>,1,[],<span class="keyword">...</span>
0051   <span class="string">'compile_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % whether to prepare script for being compiled using coder instead of interpreting Matlab</span>
0052   <span class="string">'verbose_flag'</span>,1,{0,1},<span class="keyword">...</span>
0053   <span class="string">'one_solve_file_flag'</span>,0,{0,1},<span class="keyword">...</span><span class="comment"> % use only 1 solve file of each type, but can't vary mechs yet</span>
0054   <span class="string">'benchmark_flag'</span>,0,{0,1},<span class="keyword">...</span>
0055   },false);
0056 
0057 <span class="comment">% Check inputs</span>
0058 model=<a href="dsCheckModel.html" class="code" title="function model = dsCheckModel(model, varargin)">dsCheckModel</a>(model, varargin{:});
0059 
0060 <span class="comment">% convert matlab solver options from key/value to struct using odeset if necessary</span>
0061 <span class="keyword">if</span> iscell(options.matlab_solver_options) &amp;&amp; ~isempty(options.matlab_solver_options)
0062   options.matlab_solver_options = odeset(options.matlab_solver_options{:});
0063 <span class="keyword">end</span>
0064 
0065 <span class="comment">%% 1.0 Get ode_fun</span>
0066 
0067 <span class="comment">% create function that calls feval(@solver,...) and has subfunction</span>
0068 <span class="comment">% defining odefun (including optional conditionals)...</span>
0069 
0070 propagatedModel = <a href="dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>( <a href="dsPropagateFunctions.html" class="code" title="function model = dsPropagateFunctions(model, varargin)">dsPropagateFunctions</a>(model, varargin{:}), varargin{:} );
0071 propagatedModel = <a href="dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>(propagatedModel, <span class="string">'param_type'</span>, <span class="string">'fixed_variables'</span>, varargin{:});
0072 [odefun,IC,elem_names] = <a href="dsDynasim2odefun.html" class="code" title="function [ODEFUN,IC,elem_names] = dsDynasim2odefun(model, varargin)">dsDynasim2odefun</a>(propagatedModel, <span class="string">'odefun_output'</span>,<span class="string">'func_body'</span>, varargin{:});
0073 
0074 
0075 <span class="comment">%% 2.0 prepare model info</span>
0076 parameter_prefix=<span class="string">'p.'</span>;<span class="comment">%'pset.p.';</span>
0077 <span class="comment">% state_variables=model.state_variables;</span>
0078 
0079 <span class="comment">% 1.1 eliminate internal (anonymous) function calls from model equations</span>
0080 <span class="comment">% if options.reduce_function_calls_flag==1</span>
0081   model=<a href="dsPropagateFunctions.html" class="code" title="function model = dsPropagateFunctions(model, varargin)">dsPropagateFunctions</a>(model, varargin{:});
0082 <span class="comment">% end</span>
0083 
0084 <span class="comment">% 1.1 prepare parameters</span>
0085 <span class="keyword">if</span> options.save_parameters_flag
0086   <span class="comment">% add parameter struct prefix to parameters in model equations</span>
0087   model=<a href="dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>(model,<span class="string">'action'</span>,<span class="string">'prepend'</span>,<span class="string">'prop_prefix'</span>,parameter_prefix, varargin{:});
0088   
0089   <span class="comment">% set and capture numeric seed value</span>
0090   <span class="keyword">if</span> options.compile_flag==1
0091     <span class="comment">% todo: make seed string (eg, 'shuffle') from param struct work with coder (options.compile_flag=1)</span>
0092     <span class="comment">% (currently raises error: &quot;String input must be constant&quot;)</span>
0093     <span class="comment">% workaround: (shuffle here and get numeric seed for MEX-compatible params.mat)</span>
0094     rng(options.random_seed);
0095     options.random_seed=getfield(rng,<span class="string">'Seed'</span>);  <span class="comment">% &lt;-- current active seed</span>
0096   <span class="keyword">end</span>
0097   
0098   <span class="comment">% set parameter file name (save with m-file)</span>
0099   [fpath,fname,fext]=fileparts2(options.filename);
0100   odefun_filename = [fname <span class="string">'_odefun'</span>];
0101   param_file_name = fullfile(fpath,<span class="string">'params.mat'</span>);
0102   
0103   <span class="comment">% save parameters to disk</span>
0104   warning(<span class="string">'off'</span>,<span class="string">'catstruct:DuplicatesFound'</span>);
0105   
0106   <span class="comment">% make p struct</span>
0107   p=catstruct(<a href="dsCheckSolverOptions.html" class="code" title="function options = dsCheckSolverOptions(options)">dsCheckSolverOptions</a>(options),model.parameters);
0108   
0109   <span class="comment">% add IC to p</span>
0110   <span class="comment">%   NOTE: will get done again in simulateModel</span>
0111   <span class="keyword">if</span> isempty(options.ic)
0112     p.ic = IC;
0113   <span class="keyword">else</span> <span class="comment">%if overridden from options</span>
0114     p.ic = options.ic;
0115   <span class="keyword">end</span>
0116   
0117   <span class="comment">% add matlab_solver_options to p</span>
0118   <span class="keyword">if</span> ~isempty(options.matlab_solver_options)
0119     p.matlab_solver_options = options.matlab_solver_options;
0120   <span class="keyword">end</span>
0121   
0122   <span class="keyword">if</span> options.one_solve_file_flag
0123     <span class="comment">% fill p flds that were varied with vectors of length = nSims</span>
0124     
0125     vary=<a href="dsCheckOptions.html" class="code" title="function [parms, params_unspecified ] = dsCheckOptions(options, options_schema, strict)">dsCheckOptions</a>(varargin,{<span class="string">'vary'</span>,[],[],},false);
0126     vary = vary.vary;
0127 
0128     mod_set = <a href="dsVary2Modifications.html" class="code" title="function modifications_set = dsVary2Modifications(vary,model)">dsVary2Modifications</a>(vary);
0129     <span class="comment">% The first 2 cols of modifications_set are idenitical to vary, it just</span>
0130     <span class="comment">% has the last column distributed out to the number of sims</span>
0131     
0132     
0133     <span class="comment">% Get param names</span>
0134     iMod = 1;
0135     <span class="comment">% Split extra entries in first 2 cols of mods, so each row is a single pop and param</span>
0136     [~, first_mod_set] = <a href="dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>([],mod_set{iMod}, varargin{:});
0137 
0138     <span class="comment">% replace '-&gt;' with '_'</span>
0139     first_mod_set(:,1) = strrep(first_mod_set(:,1), <span class="string">'-&gt;'</span>, <span class="string">'_'</span>);
0140 
0141     <span class="comment">% add col of underscores</span>
0142     first_mod_set = cat(2,first_mod_set(:,1), repmat({<span class="string">'_'</span>},size(first_mod_set,1), 1), first_mod_set(:,2:end));
0143     nParamMods = size(first_mod_set, 1);
0144     
0145     <span class="comment">% get param names</span>
0146     mod_params = cell(nParamMods,1);
0147     <span class="keyword">for</span> iRow = 1:nParamMods
0148       mod_params{iRow} = [first_mod_set{iRow,1:3}];
0149 
0150       <span class="comment">%check if variable in namespace</span>
0151       <span class="keyword">if</span> ~any(strcmp(model.namespaces(:,2), mod_params{iRow}))
0152         <span class="comment">% find correct entry based on param and pop</span>
0153         nsInd = logical(~cellfun(@isempty, strfind(model.namespaces(:,2), [first_mod_set{iRow,1} <span class="string">'_'</span>])) .* <span class="keyword">...</span>
0154           ~cellfun(@isempty, strfind(model.namespaces(:,2), first_mod_set{iRow,3})));
0155         
0156         assert(sum(nsInd) == 1)
0157         
0158         <span class="comment">% add mech names using namespace</span>
0159         mod_params{iRow} = model.namespaces{nsInd,2};
0160       <span class="keyword">end</span>
0161     <span class="keyword">end</span>
0162 
0163     <span class="comment">% Get param values for each sim</span>
0164     param_values = nan(nParamMods, length(mod_set));
0165     <span class="keyword">for</span> iMod = 1:length(mod_set)
0166       <span class="comment">% Split extra entries in first 2 cols of mods, so each row is a single pop and param</span>
0167       [~, mod_set{iMod}] = <a href="dsApplyModifications.html" class="code" title="function [output,modifications] = dsApplyModifications(model, modifications, varargin)">dsApplyModifications</a>([],mod_set{iMod}, varargin{:});
0168       
0169       <span class="comment">% Get scalar values as vector</span>
0170       param_values(:, iMod) = [mod_set{iMod}{:,3}];
0171     <span class="keyword">end</span>
0172     
0173     <span class="comment">% Assign value vectors to params</span>
0174     <span class="keyword">for</span> iParam = 1:nParamMods
0175       p.(mod_params{iParam}) = param_values(iParam,:);
0176     <span class="keyword">end</span>
0177   <span class="keyword">end</span> <span class="comment">% one_solve_file_flag</span>
0178   
0179   
0180   <span class="keyword">if</span> options.verbose_flag
0181     fprintf(<span class="string">'saving params.mat\n'</span>);
0182   <span class="keyword">end</span>
0183   save(param_file_name,<span class="string">'p'</span>);
0184 <span class="keyword">else</span>
0185   <span class="comment">% insert parameter values into model expressions</span>
0186   model=<a href="dsPropagateParameters.html" class="code" title="function model = dsPropagateParameters(model,varargin)">dsPropagateParameters</a>(model,<span class="string">'action'</span>,<span class="string">'substitute'</span>, varargin{:});
0187 <span class="keyword">end</span>
0188 
0189 <span class="comment">% 1.2 prepare list of outputs (state variables and monitors)</span>
0190 tmp=cellfun(@(x)[x <span class="string">','</span>],model.state_variables,<span class="string">'uni'</span>,0);
0191 tmp=[tmp{:}];
0192 output_string=tmp(1:end-1);
0193 
0194 <span class="keyword">if</span> ~isempty(model.monitors)
0195   tmp=cellfun(@(x)[x <span class="string">','</span>],fieldnames(model.monitors),<span class="string">'uni'</span>,0);
0196   tmp=[tmp{:}];
0197   output_string=[output_string <span class="string">','</span> tmp(1:end-1)];
0198 <span class="keyword">end</span>
0199 
0200 <span class="keyword">if</span> ~isempty(model.fixed_variables)
0201   tmp=cellfun(@(x)[x <span class="string">','</span>],fieldnames(model.fixed_variables),<span class="string">'uni'</span>,0);
0202   tmp=[tmp{:}];
0203   output_string=[output_string <span class="string">','</span> tmp(1:end-1)];
0204 <span class="keyword">end</span>
0205 
0206 output_string=[<span class="string">'[T,'</span> output_string <span class="string">']'</span>]; <span class="comment">% state vars, monitors, time vector</span>
0207 
0208 <span class="comment">% HACK to get IC to work</span>
0209 <span class="keyword">if</span> options.downsample_factor == 1
0210   <span class="keyword">for</span> fieldNameC = fieldnames(model.ICs)'
0211     model.ICs.(fieldNameC{1}) = regexprep(model.ICs.(fieldNameC{1}), <span class="string">'_t0'</span>, <span class="string">'(1,:)'</span>);
0212   <span class="keyword">end</span>
0213 <span class="keyword">end</span>
0214 
0215 
0216 <span class="comment">%% 3.0 write m-file solver</span>
0217 <span class="comment">% 2.1 create mfile</span>
0218 <span class="keyword">if</span> ~isempty(options.filename)
0219   <span class="keyword">if</span> options.verbose_flag
0220     fprintf(<span class="string">'Creating solver file: %s\n'</span>,options.filename);
0221   <span class="keyword">end</span>
0222   
0223   fid=fopen(options.filename,<span class="string">'wt'</span>);
0224 <span class="keyword">else</span>
0225   fid=options.fileID;
0226 <span class="keyword">end</span>
0227 
0228 <span class="comment">% get abs file path</span>
0229 solve_ode_filepath = fopen(fid);
0230 
0231 <span class="keyword">if</span> ~options.one_solve_file_flag
0232   fprintf(fid,<span class="string">'function %s=solve_ode\n'</span>,output_string);
0233 <span class="keyword">else</span>
0234   fprintf(fid,<span class="string">'function %s=solve_ode(simID)\n'</span>,output_string);
0235 <span class="keyword">end</span>
0236 
0237 <span class="comment">% Benchmark tic</span>
0238 <span class="keyword">if</span> options.benchmark_flag
0239   fprintf(fid, <span class="string">'tic;'</span>);
0240 <span class="keyword">end</span>
0241 
0242 <span class="comment">% 2.3 load parameters</span>
0243 <span class="keyword">if</span> options.save_parameters_flag
0244   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0245   fprintf(fid,<span class="string">'%% Parameters:\n'</span>);
0246   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0247   fprintf(fid,<span class="string">'params = load(''params.mat'',''p'');\n'</span>);
0248   
0249   <span class="keyword">if</span> options.one_solve_file_flag &amp;&amp; options.compile_flag
0250     fprintf(fid,<span class="string">'pVecs = params.p;\n'</span>);
0251   <span class="keyword">else</span>
0252      fprintf(fid,<span class="string">'p = params.p;\n'</span>);
0253   <span class="keyword">end</span>
0254 <span class="keyword">end</span>
0255 
0256 <span class="keyword">if</span> options.one_solve_file_flag
0257   <span class="comment">% loop through p and for any vector, take simID index of it (ignores tspan)</span>
0258   <span class="keyword">if</span> ~options.compile_flag
0259     fprintf(fid,<span class="string">'\n%% For vector params, select index for this simID\n'</span>);
0260     fprintf(fid,<span class="string">'flds = fields(rmfield(p,''tspan''));\n'</span>); <span class="comment">% remove tspan</span>
0261     fprintf(fid,<span class="string">'for fld = flds''\n'</span>);
0262     fprintf(fid,<span class="string">'  fld = fld{1};\n'</span>);
0263     fprintf(fid,<span class="string">'  if isnumeric(p.(fld)) &amp;&amp; length(p.(fld)) &gt; 1\n'</span>);
0264     fprintf(fid,<span class="string">'    p.(fld) = p.(fld)(simID);\n'</span>);
0265     fprintf(fid,<span class="string">'  end\n'</span>);
0266     fprintf(fid,<span class="string">'end\n\n'</span>);
0267   <span class="keyword">else</span> <span class="comment">%compile_flag</span>
0268     <span class="comment">% slice scalar from vector params</span>
0269     <span class="keyword">for</span> iParam = 1:nParamMods
0270       fprintf(fid,<span class="string">'p.%s = pVecs.%s(simID);\n'</span>, mod_params{iParam}, mod_params{iParam});
0271     <span class="keyword">end</span>
0272     
0273     <span class="comment">% take scalar from scalar params</span>
0274     [~,sharedFlds] = intersect(fields(p), mod_params);
0275     scalar_params = fields(p);
0276     scalar_params(sharedFlds) = [];
0277     nScalarParams = length(scalar_params);
0278     <span class="keyword">for</span> iParam = 1:nScalarParams
0279       fprintf(fid,<span class="string">'p.%s = pVecs.%s;\n'</span>, scalar_params{iParam}, scalar_params{iParam});
0280     <span class="keyword">end</span>
0281   <span class="keyword">end</span>
0282 <span class="keyword">end</span>
0283 
0284 <span class="comment">% write tspan, dt, and downsample_factor</span>
0285 <span class="keyword">if</span> options.save_parameters_flag
0286   fprintf(fid,<span class="string">'downsample_factor = %sdownsample_factor;\n'</span>,parameter_prefix);
0287   fprintf(fid,<span class="string">'dt = %sdt;\n'</span>,parameter_prefix);
0288   fprintf(fid,<span class="string">'T = (%stspan(1):downsample_factor*dt:%stspan(2))'';\n'</span>,parameter_prefix,parameter_prefix);
0289 <span class="keyword">else</span>
0290   fprintf(fid,<span class="string">'tspan=[%g %g];\ndt = %g;\ndownsample_factor = %g;\n'</span>,options.tspan,options.dt,options.downsample_factor);
0291   fprintf(fid,<span class="string">'T = (tspan(1):downsample_factor*dt:tspan(2))'';\n'</span>);
0292 <span class="keyword">end</span>
0293   <span class="comment">% NOTE: T is different here since we take into account downsampling</span>
0294 
0295 <span class="comment">% write calculation of time vector and derived parameters: ntime, nsamp</span>
0296 <span class="comment">% fprintf(fid,'ntime = length(T);\nnsamp = length(1:downsample_factor*dt:ntime);\n');</span>
0297 
0298 <span class="comment">% 2.4 evaluate fixed variables</span>
0299 <span class="keyword">if</span> ~isempty(model.fixed_variables)
0300   fprintf(fid,<span class="string">'\n%% ------------------------------------------------------------\n'</span>);
0301   fprintf(fid,<span class="string">'%% Fixed variables:\n'</span>);
0302   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0303   names=fieldnames(model.fixed_variables);
0304   expressions=struct2cell(model.fixed_variables);
0305   <span class="keyword">for</span> i=1:length(names)
0306     fprintf(fid,<span class="string">'%s = %s;\n'</span>,names{i},expressions{i});
0307   <span class="keyword">end</span>
0308 <span class="keyword">end</span>
0309 
0310 <span class="comment">% 2.5 evaluate function handles</span>
0311 <span class="keyword">if</span> ~isempty(model.functions) &amp;&amp; options.reduce_function_calls_flag==0
0312   fprintf(fid,<span class="string">'\n%% ------------------------------------------------------------\n'</span>);
0313   fprintf(fid,<span class="string">'%% Functions:\n'</span>);
0314   fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0315   names=fieldnames(model.functions);
0316   expressions=struct2cell(model.functions);
0317   <span class="keyword">for</span> i=1:length(names)
0318     fprintf(fid,<span class="string">'%s = %s;\n'</span>,names{i},expressions{i});
0319   <span class="keyword">end</span>
0320 <span class="keyword">end</span>
0321 
0322 <span class="comment">% 2.6 prepare storage</span>
0323 fprintf(fid,<span class="string">'\n%% ------------------------------------------------------------\n'</span>);
0324 fprintf(fid,<span class="string">'%% Initial conditions:\n'</span>);
0325 fprintf(fid,<span class="string">'%% ------------------------------------------------------------\n'</span>);
0326 
0327 <span class="comment">% 2.2 set random seed</span>
0328 fprintf(fid,<span class="string">'%% seed the random number generator\n'</span>);
0329 <span class="keyword">if</span> options.save_parameters_flag
0330   fprintf(fid,<span class="string">'rng(%srandom_seed);\n'</span>,parameter_prefix);
0331 <span class="keyword">else</span>  
0332   <span class="keyword">if</span> ischar(options.random_seed)
0333     fprintf(fid,<span class="string">'rng(''%s'');\n'</span>,options.random_seed);
0334   <span class="keyword">elseif</span> isnumeric(options.random_seed)
0335     fprintf(fid,<span class="string">'rng(%g);\n'</span>,options.random_seed);
0336   <span class="keyword">end</span>
0337 <span class="keyword">end</span>
0338 
0339 <span class="comment">%% Numerical integration</span>
0340 <span class="comment">% write code to do numerical integration</span>
0341 fprintf(fid,<span class="string">'%% ###########################################################\n'</span>);
0342 fprintf(fid,<span class="string">'%% Numerical integration:\n'</span>);
0343 fprintf(fid,<span class="string">'%% ###########################################################\n'</span>);
0344 
0345 <span class="keyword">if</span> options.compile_flag &amp;&amp; strcmp(options.solver_type,<span class="string">'matlab_no_mex'</span>)
0346   odefun_str_name = odefun_filename;
0347   
0348   <span class="keyword">if</span> options.compile_flag
0349     odefun_str_name = [odefun_str_name <span class="string">'_mex'</span>]; <span class="comment">% switch to mex version</span>
0350   <span class="keyword">end</span>
0351 <span class="keyword">else</span>
0352   odefun_str_name = <span class="string">'odefun'</span>;
0353 <span class="keyword">end</span>
0354 
0355 <span class="keyword">if</span> ~isempty(options.matlab_solver_options)
0356   fprintf(fid,<span class="string">'[T,data] = %s(@%s, T, p.ic, p.matlab_solver_options);\n'</span>, options.solver, odefun_str_name);
0357 <span class="keyword">else</span>
0358   fprintf(fid,<span class="string">'[T,data] = %s(@%s, T, p.ic);\n'</span>, options.solver, odefun_str_name);
0359 <span class="keyword">end</span>
0360 
0361 <span class="comment">%% Get vars from odefun output</span>
0362 fprintf(fid,<span class="string">'\n%%Extract linear data into original state variables\n'</span>);
0363 
0364 <span class="comment">% evaluate ICs to get (# elems) per state var and set up generic state var X</span>
0365 num_vars=length(model.state_variables);
0366 state_var_index=0;
0367 <span class="keyword">for</span> i=1:num_vars
0368   var=model.state_variables{i};
0369   
0370   <span class="comment">% check ICs for use of inital state_var value and put in proper starting value</span>
0371   <span class="keyword">if</span> regexp(model.ICs.(var), <span class="string">'_last'</span>)
0372     stateVars = regexp(model.ICs.(var), <span class="string">'([\w_]+)_last'</span>, <span class="string">'tokens'</span>);
0373     model.ICs.(var) = regexprep(model.ICs.(var), <span class="string">'_last'</span>, <span class="string">''</span>);
0374     
0375     <span class="keyword">for</span> iSVar = 1:length(stateVars)
0376       thisSvar = stateVars{iSVar}{1};
0377       model.ICs.(var) = regexprep(model.ICs.(var), thisSvar, model.ICs.(thisSvar));
0378     <span class="keyword">end</span>
0379   <span class="keyword">end</span>
0380   
0381   <span class="comment">% evaluate ICs to get (# elems) per state var</span>
0382   num_elems=length(eval([model.ICs.(var) <span class="string">';'</span>]));
0383   
0384   <span class="comment">% set state var indices a variables for generic state vector X</span>
0385   data_inds = state_var_index + [1,num_elems];
0386   
0387   assert(strcmp(elem_names{data_inds(1)}, var)) <span class="comment">%current elem should be same as var</span>
0388   
0389   fprintf(fid,<span class="string">'%s = data(:, %i:%i);\n'</span>, var, data_inds(1), data_inds(end));
0390   
0391   state_var_index = state_var_index + num_elems;
0392 <span class="keyword">end</span>
0393 
0394 <span class="comment">%% Monitors</span>
0395 <span class="keyword">if</span> ~isempty(model.monitors)
0396   fprintf(fid,<span class="string">'\n%%Calculate monitors from params and state vars\n'</span>);
0397   monitor_names = fields(model.monitors);
0398   <span class="keyword">for</span> iMon = 1:length(monitor_names)
0399     thisMonName = monitor_names{iMon};
0400     thisMonFcn = regexp(model.functions.(thisMonName),<span class="string">'@\([a-zA-Z][\w,]*\)\s*(.*)'</span>,<span class="string">'tokens'</span>,<span class="string">'once'</span>);
0401     thisMonFcn = thisMonFcn{1};
0402     fprintf(fid,<span class="string">'%s = %s;\n'</span>, thisMonName, thisMonFcn);
0403   <span class="keyword">end</span>
0404 <span class="keyword">end</span>
0405 
0406 <span class="comment">%% Benchmark toc</span>
0407 <span class="keyword">if</span> options.benchmark_flag
0408   fprintf(fid, <span class="string">'fprintf(''Sim Time: %%g seconds\\n'', toc);'</span>);
0409 <span class="keyword">end</span>
0410 
0411 <span class="comment">%% end solve function</span>
0412 fprintf(fid,<span class="string">'\nend\n\n'</span>);
0413 
0414 <span class="comment">%% ODEFUN</span>
0415 <span class="keyword">if</span> options.compile_flag &amp;&amp; strcmp(options.solver_type,<span class="string">'matlab_no_mex'</span>) <span class="comment">% save ode function as separate m-file for mex compilation</span>
0416   <span class="comment">%open file</span>
0417   odefun_filepath = fullfile(fpath, [odefun_filename fext]);
0418   odefun_fid = fopen(odefun_filepath,<span class="string">'wt'</span>);
0419   
0420   <span class="comment">%write to file</span>
0421   fprintf(odefun_fid,<span class="string">'function dydt = %s(t,X)\n'</span>, odefun_filename);
0422   fprintf(odefun_fid,[<span class="string">'dydt = [\n\n'</span> odefun <span class="string">'\n]'';\n'</span>]); <span class="comment">% make row into col vector</span>
0423   fprintf(odefun_fid,<span class="string">'end\n'</span>);
0424   
0425   <span class="comment">%close file</span>
0426   fclose(odefun_fid);
0427   
0428   <span class="comment">%% mex compile odefun</span>
0429   options.codegen_args = {0,IC};
0430   <a href="dsPrepareMEX.html" class="code" title="function mexfileOutput = dsPrepareMEX(mfileInput, varargin)">dsPrepareMEX</a>(odefun_filepath, options);
0431   
0432 <span class="keyword">else</span> <span class="comment">% use subfunction</span>
0433   fprintf(fid,<span class="string">'\n%% ###########################################################\n'</span>);
0434   fprintf(fid,<span class="string">'%% SUBFUNCTIONS\n'</span>);
0435   fprintf(fid,<span class="string">'%% ###########################################################\n\n'</span>);
0436   
0437   <span class="comment">% make sub function (no shared variables with main function workspace for max performance)</span>
0438   fprintf(fid,<span class="string">'function dydt = odefun(t,X)\n'</span>);
0439   fprintf(fid,[<span class="string">'dydt = [\n\n'</span> odefun <span class="string">'\n]'';\n'</span>]); <span class="comment">% make row into col vector</span>
0440   fprintf(fid,<span class="string">'end\n'</span>);
0441 <span class="keyword">end</span>
0442 
0443 <span class="keyword">if</span> ~strcmp(solve_ode_filepath,<span class="string">'&quot;stdout&quot;'</span>)
0444   fclose(fid);
0445   <span class="comment">% wait for file before continuing to simulation</span>
0446   <span class="keyword">while</span> ~exist(solve_ode_filepath,<span class="string">'file'</span>)
0447     pause(.01);
0448   <span class="keyword">end</span>
0449 <span class="keyword">end</span>
0450 
0451 <span class="keyword">end</span> <span class="comment">%function</span>
0452 <span class="comment">%% END MAIN FUNC</span></pre></div>
<hr><address>Generated on Fri 23-Jun-2017 18:15:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" target="_parent">m2html</a></strong> &copy; 2005</address>
</body>
</html>